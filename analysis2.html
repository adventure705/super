<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOUTUBE ì±„ë„ ì‹¬ì¸µ ë¶„ì„ê¸°</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: #383b6e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #e94560; }

        body { font-family: 'Inter', sans-serif; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        #videoListTableBody td { vertical-align: middle; }
        
        /* ìº˜ë¦°ë” ì…€ ìŠ¤íƒ€ì¼ */
        .calendar-cell {
            width: 100%; padding: 4px; text-align: center; font-size: 0.75rem; height: 40px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: 1px solid #383b6e; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;
        }

        /* Shorts ìŠ¤í¬ë¡¤ */
        .shorts-scroll-container { position: relative; }
        .shorts-content { overflow-x: auto; scroll-behavior: smooth; white-space: nowrap; padding-bottom: 10px; }
        
        /* ìŠ¤í¬ë¡¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (CSS ì§ì ‘ ì •ì˜) */
        .scroll-button {
            position: absolute;
            z-index: 20;
            border-radius: 9999px;
            padding: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.125rem;
            width: 40px;
            height: 40px;
            top: 50%;
            transform: translateY(-50%);
        }
        @media (min-width: 768px) { .scroll-button { display: flex; } }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-btn { 
            flex: 1;
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            color: rgba(248, 248, 248, 0.4);
            transition: all 0.3s;
            border-radius: 0.75rem 0.75rem 0 0;
            background-color: #10101a; 
            border-bottom: 4px solid transparent;
            font-size: 0.875rem;
            cursor: pointer;
        }
        @media (min-width: 640px) {
            .tab-btn { font-size: 1rem; }
        }
        .tab-btn:hover {
            background-color: #1f1f2e;
            color: rgba(248, 248, 248, 0.8);
        }
        .tab-btn.active { 
            color: #ffffff !important;
            background-color: #e94560 !important; 
            border-bottom-color: #e94560 !important;
            box-shadow: 0 -4px 15px -3px rgba(233, 69, 96, 0.4);
        }
        .tab-container {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid #282a4d;
            margin-bottom: 1.5rem;
        }

        /* ë³„ì  ìƒ‰ìƒ */
        .star-filled { color: #fbbf24; }
        .star-empty { color: #4b5563; }

        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .note-input {
            width: 100%;
            background-color: #1a1a2e;
            border: 1px solid #383b6e;
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: #f8f8f8;
            font-size: 0.875rem;
            transition: border-color 0.2s;
            margin-bottom: 0.5rem;
        }
        .note-input:focus {
            outline: none;
            border-color: #e94560;
        }
        .note-label {
            display: block;
            font-size: 0.75rem;
            color: rgba(248, 248, 248, 0.6);
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        .note-section-title {
            color: #e94560;
            font-weight: 700;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid rgba(233, 69, 96, 0.3);
            padding-bottom: 0.25rem;
        }

        /* ëª¨ë‹¬ */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 100;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #1a1a2e; padding: 2rem; border-radius: 1rem;
            max-width: 90%; max-height: 90%; overflow-y: auto;
        }
        
        /* ì •ë ¬ í—¤ë” ì»¤ì„œ */
        .sortable-header { cursor: pointer; user-select: none; transition: color 0.2s; }
        .sortable-header:hover { color: #e94560; }
        
        /* ìƒì„¸ ì„¤ëª… í–‰ ì• ë‹ˆë©”ì´ì…˜ */
        .detail-row { transition: all 0.3s ease-in-out; }

        /* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 17px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* Top ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #scrollToTopBtn {
            transition: opacity 0.3s, transform 0.3s;
        }
        #scrollToTopBtn:active {
            transform: scale(0.9);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': '#1a1a2e',
                        'primary-accent': '#e94560', // Red/Pink Accent
                        'text-light': '#f8f8f8',
                        'card-bg': '#282a4d',
                        'success-status': '#6aff7b',
                        'warning-star': '#fbbf24',
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-bg-dark text-text-light min-h-screen transition-colors duration-500 relative">

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div id="toast">í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</div>

    <!-- Top ë²„íŠ¼ -->
    <button id="scrollToTopBtn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
            class="fixed bottom-6 right-6 p-3 bg-primary-accent text-white rounded-full shadow-lg hover:bg-primary-accent/80 opacity-0 pointer-events-none z-50 flex items-center justify-center w-12 h-12 md:w-14 md:h-14">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <!-- API ì„¤ì • ëª¨ë‹¬ -->
    <div id="apiSettingsModal" class="modal hidden">
        <div class="modal-content w-full md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-bold mb-4 text-primary-accent border-b border-primary-accent/50 pb-2">API í‚¤ ì„¤ì • (ê³µìœ ë¨)</h2>
            <p class="text-xs text-text-light/50 mb-4">ì…ë ¥í•œ API í‚¤ëŠ” í´ë¼ìš°ë“œì— ì €ì¥ë˜ì–´ ëª¨ë“  ê¸°ê¸°ì—ì„œ ê³µìœ ë©ë‹ˆë‹¤.</p>
            
            <div id="firebaseStatusMsg" class="mb-4 text-xs text-text-light/50 bg-bg-dark p-2 rounded">
                Firebase ìƒíƒœ: ì—°ê²° í™•ì¸ ì¤‘...
            </div>

            <!-- Firebase Config Manual Input (Fallback) -->
            <div id="firebaseConfigSection" class="bg-card-bg p-4 rounded-lg mb-6 shadow-lg border border-red-500/30 hidden">
                <h3 class="text-sm font-semibold mb-2 text-red-400">âš ï¸ Firebase ì„¤ì • ë¡œë“œ ì‹¤íŒ¨</h3>
                <p class="text-xs text-text-light/70 mb-2">firebase-config.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì— ì„¤ì •ì„ ì§ì ‘ ë¶™ì—¬ë„£ê³  [ì„¤ì • ì ìš©]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                <textarea id="manualConfigInput" placeholder='{"apiKey": "...", "authDomain": "...", ...}' class="w-full p-2 rounded bg-bg-dark border border-card-bg text-text-light text-xs font-mono h-24 mb-2"></textarea>
                <button onclick="applyManualConfig()" class="w-full py-2 bg-primary-accent text-white font-bold rounded hover:bg-primary-accent/80 transition text-sm">ì„¤ì • ì ìš© ë° ì¬ì‹œë„</button>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- YouTube API Key Section -->
                <div>
                    <div class="bg-card-bg p-4 rounded-lg mb-4 shadow-lg border border-primary-accent/20">
                        <h3 class="text-sm font-bold mb-2 text-primary-accent">ğŸ“º YouTube Data API Key</h3>
                        <input type="text" id="newYoutubeKeyName" placeholder="í‚¤ ì´ë¦„ (ì˜ˆ: ê¸°ë³¸ í‚¤)" class="w-full p-2 mb-2 rounded bg-bg-dark border border-card-bg text-text-light text-xs focus:border-primary-accent outline-none">
                        <input type="password" id="newYoutubeKeyValue" placeholder="AIza..." class="w-full p-2 mb-2 rounded bg-bg-dark border border-card-bg text-text-light text-xs focus:border-primary-accent outline-none">
                        <div class="flex gap-2">
                            <button id="saveYoutubeKeyBtn" onclick="saveKey('youtube')" type="button" class="flex-1 py-1.5 bg-success-status text-bg-dark font-bold rounded text-xs hover:bg-success-status/80 transition">ì €ì¥</button>
                            <button id="cancelYoutubeEditBtn" onclick="resetEditMode('youtube')" type="button" class="flex-1 py-1.5 bg-gray-600 text-white font-bold rounded text-xs hover:bg-gray-500 transition hidden">ì·¨ì†Œ</button>
                        </div>
                    </div>
                    <div id="youtubeKeyList" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>
                </div>

                <!-- Gemini API Key Section -->
                <div>
                    <div class="bg-card-bg p-4 rounded-lg mb-4 shadow-lg border border-blue-400/20">
                        <h3 class="text-sm font-bold mb-2 text-blue-400">âœ¨ Gemini API Key</h3>
                        <input type="text" id="newGeminiKeyName" placeholder="í‚¤ ì´ë¦„ (ì˜ˆ: ë¶„ì„ìš©)" class="w-full p-2 mb-2 rounded bg-bg-dark border border-card-bg text-text-light text-xs focus:border-blue-400 outline-none">
                        <input type="password" id="newGeminiKeyValue" placeholder="AIza..." class="w-full p-2 mb-2 rounded bg-bg-dark border border-card-bg text-text-light text-xs focus:border-blue-400 outline-none">
                        <div class="flex gap-2">
                            <button id="saveGeminiKeyBtn" onclick="saveKey('gemini')" type="button" class="flex-1 py-1.5 bg-blue-500 text-white font-bold rounded text-xs hover:bg-blue-600 transition">ì €ì¥</button>
                            <button id="cancelGeminiEditBtn" onclick="resetEditMode('gemini')" type="button" class="flex-1 py-1.5 bg-gray-600 text-white font-bold rounded text-xs hover:bg-gray-500 transition hidden">ì·¨ì†Œ</button>
                        </div>
                    </div>
                    <div id="geminiKeyList" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>
                </div>
            </div>
            
            <button onclick="document.getElementById('apiSettingsModal').classList.add('hidden')" class="w-full mt-4 py-3 bg-card-bg border border-text-light/10 rounded-lg text-text-light hover:bg-card-bg/80 transition font-medium">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- í—¤ë” -->
    <header id="top" class="p-4 bg-card-bg shadow-lg sticky top-0 z-20 flex justify-between items-center rounded-b-lg">
        <h1 class="text-lg md:text-xl font-extrabold text-primary-accent truncate w-full text-center">YOUTUBE ì±„ë„ ì‹¬ì¸µ ë¶„ì„ê¸°</h1>
        <button onclick="document.getElementById('apiSettingsModal').classList.remove('hidden')" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-xs md:text-sm bg-bg-dark px-3 py-1.5 rounded-full border border-primary-accent text-primary-accent hover:bg-primary-accent hover:text-white transition whitespace-nowrap">âš™ï¸ API ì„¤ì •</button>
    </header>

    <main class="container mx-auto p-3 sm:p-6 lg:p-10">

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-container">
            <button id="tab-analyze" onclick="switchTab('analyze')" class="tab-btn active">
                <span class="mr-1 md:mr-2">ğŸ”</span> ë¶„ì„ ë° ê²€ìƒ‰
            </button>
            <button id="tab-saved" onclick="switchTab('saved')" class="tab-btn">
                <span class="mr-1 md:mr-2">ğŸ“‚</span> ì €ì¥ëœ ì±„ë„
            </button>
        </div>

        <!-- íƒ­ 1: ë¶„ì„ ë° ê²°ê³¼ -->
        <div id="content-analyze">
            <!-- ì…ë ¥ íŒ¨ë„ (ID í™•ì¸) -->
            <section id="searchPanel" class="bg-card-bg p-4 md:p-6 rounded-xl shadow-2xl mb-8">
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="text" id="channelId" placeholder="ì±„ë„ ID, í•¸ë“¤(@), ë˜ëŠ” ì±„ë„ëª… (ì˜ˆ: @Google, MrBeast)" class="flex-grow p-3 rounded-lg bg-bg-dark border border-card-bg focus:border-primary-accent text-text-light outline-none transition placeholder-text-light/30">
                    <button id="analyzeButton" onclick="startAnalysis()" class="w-full md:w-auto py-3 px-6 bg-primary-accent text-white font-bold rounded-lg hover:bg-primary-accent/80 transition shadow-lg whitespace-nowrap flex justify-center items-center">
                        <span id="buttonText">ë¶„ì„ ì‹œì‘</span>
                    </button>
                </div>
                <p id="statusMessage" class="mt-4 text-center text-sm font-medium animate-pulse"></p>
            </section>

            <!-- ë¶„ì„ ê²°ê³¼ -->
            <section id="resultsSection" class="hidden animate-fade-in-up">
                
                <!-- ì±„ë„ ì •ë³´ -->
                <div id="channelInfo" class="grid md:grid-cols-2 gap-6 mb-8"></div>

                <!-- í†µê³„ ì¹´ë“œ -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-4">
                    <div class="bg-card-bg p-5 rounded-xl shadow-xl"><p class="text-3xl font-bold text-success-status" id="statSubscribers">0</p><p class="text-sm mt-1 text-text-light/70">êµ¬ë…ì</p></div>
                    <div class="bg-card-bg p-5 rounded-xl shadow-xl"><p class="text-3xl font-bold text-success-status" id="statViews">0</p><p class="text-sm mt-1 text-text-light/70">ì´ ì¡°íšŒìˆ˜</p></div>
                    <div class="bg-card-bg p-5 rounded-xl shadow-xl"><p class="text-3xl font-bold text-success-status" id="statVideos">0</p><p class="text-sm mt-1 text-text-light/70">ì´ ì˜ìƒ</p></div>
                </div>

                <!-- 90ì¼ í†µê³„ -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-8">
                    <div class="bg-card-bg p-4 rounded-xl border border-primary-accent/30"><p class="text-xl font-bold text-primary-accent" id="avgViews90Days">0</p><p class="text-xs mt-1 text-text-light/60">90ì¼ í‰ê·  ì¡°íšŒìˆ˜</p></div>
                    <div class="bg-card-bg p-4 rounded-xl border border-primary-accent/30"><p class="text-xl font-bold text-primary-accent" id="avgLikes90Days">0</p><p class="text-xs mt-1 text-text-light/60">90ì¼ í‰ê·  ì¢‹ì•„ìš”</p></div>
                    <div class="bg-card-bg p-4 rounded-xl border border-primary-accent/30"><p class="text-xl font-bold text-primary-accent" id="avgComments90Days">0</p><p class="text-xs mt-1 text-text-light/60">90ì¼ í‰ê·  ëŒ“ê¸€</p></div>
                </div>

                <!-- ë²¤ì¹˜ë§ˆí‚¹ ê°€ì´ë“œ -->
                <div class="bg-card-bg p-4 md:p-6 rounded-xl shadow-xl mb-10">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-primary-accent">ğŸ› ï¸ ì‹¬ì¸µ ë²¤ì¹˜ë§ˆí‚¹ ê°€ì´ë“œ</h2>
                    <p class="text-xs md:text-sm text-text-light/80 mb-6">ì„±ê³µì ì¸ ì±„ë„ ìš´ì˜ì„ ìœ„í•œ í•µì‹¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.</p>
                    <div class="grid md:grid-cols-2 gap-6 text-sm text-text-light/80">
                         <div class="bg-bg-dark/50 p-4 rounded shadow-inner">
                            <h3 class="font-bold text-success-status mb-2">ğŸ’¡ ì½˜í…ì¸  ê¸°íšë ¥</h3>
                            <ul class="list-disc ml-4 space-y-1"><li>í‚¬ëŸ¬ ì½˜í…ì¸  ì‹ë³„</li><li>í¬ë§· ë° ê¸¸ì´ ìµœì í™”</li><li>ì˜ìƒ êµ¬ì¡°(ê¸°ìŠ¹ì „ê²°)</li><li>ì°¨ë³„í™” í¬ì¸íŠ¸</li></ul>
                         </div>
                         <div class="bg-bg-dark/50 p-4 rounded shadow-inner">
                            <h3 class="font-bold text-success-status mb-2">ğŸ¬ ì‹œê°/í¸ì§‘ ìŠ¤íƒ€ì¼</h3>
                            <ul class="list-disc ml-4 space-y-1"><li>ì¸ë„¤ì¼ ì „ëµ(ìƒ‰ìƒ/ë¬¸êµ¬)</li><li>í¸ì§‘ í˜¸í¡ ë° ì»· ì „í™˜</li><li>ì‚¬ìš´ë“œ ë° í˜¸ìŠ¤íŠ¸ í†¤ì•¤ë§¤ë„ˆ</li></ul>
                         </div>
                    </div>
                </div>

                <!-- [NEW] ì±„ë„ ì‹¬ì¸µ ë¶„ì„ ë…¸íŠ¸ -->
                <div class="bg-card-bg p-6 rounded-xl shadow-xl mb-10 border border-primary-accent/20 relative">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                        <h2 class="text-2xl font-bold text-primary-accent">ğŸ“ ì±„ë„ ì‹¬ì¸µ ë¶„ì„ ë…¸íŠ¸</h2>
                        <div class="flex gap-2">
                            <button onclick="analyzeChannelWithGemini()" id="geminiAnalyzeBtn" class="py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition text-sm flex items-center gap-2">
                                <span>ğŸ¤– Geminië¡œ ìë™ ë¶„ì„</span>
                            </button>
                            <button onclick="saveChannelNote()" class="py-2 px-4 bg-success-status text-bg-dark font-bold rounded-lg hover:bg-success-status/80 transition text-sm">ğŸ’¾ ë…¸íŠ¸ ì €ì¥</button>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- 1. ì±„ë„ ì¢…í•© ì˜ê²¬ -->
                        <div>
                            <h3 class="note-section-title"># ì±„ë„ ì¢…í•© ì˜ê²¬</h3>
                            <label class="note-label">ì¢…í•© ìš”ì•½</label>
                            <textarea id="note_summary" class="note-input h-20" placeholder="ì±„ë„ì˜ í•µì‹¬ íŠ¹ì§• ìš”ì•½"></textarea>
                            <label class="note-label">ì¶”ì²œ í¬ì¸íŠ¸</label>
                            <input type="text" id="note_pros" class="note-input" placeholder="ê°•ì , ë°°ìš¸ ì ">
                            <label class="note-label">ìš°ë ¤ í¬ì¸íŠ¸</label>
                            <input type="text" id="note_cons" class="note-input" placeholder="ì•½ì , ê°œì„  í•„ìš” ì ">
                        </div>

                        <!-- 2. ì½˜í…ì¸  -->
                        <div>
                            <h3 class="note-section-title"># ì½˜í…ì¸ </h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="note-label">ì¥ë¥´/ì¹´í…Œê³ ë¦¬</label>
                                    <input type="text" id="note_genre" class="note-input" placeholder="ì˜ˆ: ë·°í‹°, ì˜ˆëŠ¥">
                                </div>
                                <div>
                                    <label class="note-label">í†¤ì•¤ë§¤ë„ˆ</label>
                                    <input type="text" id="note_tone" class="note-input" placeholder="ì˜ˆ: ì°¨ë¶„í•¨, í…ì…˜ë†’ìŒ">
                                </div>
                            </div>
                            <label class="note-label">ì—°ì¶œ ë° í¸ì§‘ ìŠ¤íƒ€ì¼</label>
                            <textarea id="note_style" class="note-input h-12" placeholder="ìë§‰ ìŠ¤íƒ€ì¼, ì»· í¸ì§‘ íŠ¹ì§• ë“±"></textarea>
                            <label class="note-label">ì£¼ì œ ë° ì†Œì¬</label>
                            <input type="text" id="note_topic" class="note-input" placeholder="ì£¼ë¡œ ë‹¤ë£¨ëŠ” ì†Œì¬">
                        </div>

                        <!-- 3. íŒ¬ë¤ ë° ë¸Œëœë“œ -->
                        <div>
                            <h3 class="note-section-title"># íŒ¬ë¤ ë° ë¸Œëœë“œ ì•ˆì •ì„±</h3>
                            <label class="note-label">ì£¼ìš” ì‹œì²­ì (ì¶”ì •)</label>
                            <input type="text" id="note_audience" class="note-input" placeholder="ì˜ˆ: 2030 ì§ì¥ì¸ ì—¬ì„±">
                            <label class="note-label">ì±„ë„ ì‹ ë¢°ë„</label>
                            <textarea id="note_trust" class="note-input h-16" placeholder="ê´‘ê³  ì§„í–‰ ì‹œ ì•ˆì •ì„±, ë…¼ë€ ì—¬ë¶€ ë“±"></textarea>
                        </div>

                        <!-- 4. ê´‘ê³  ì „ëµ -->
                        <div>
                            <h3 class="note-section-title"># ê´‘ê³  ì „ëµ</h3>
                            <label class="note-label">ì í•© ê´‘ê³  ë„ë©”ì¸</label>
                            <input type="text" id="note_ad_domain" class="note-input" placeholder="ì˜ˆ: í™”ì¥í’ˆ, íŒ¨ì…˜ ì•±">
                            <label class="note-label">ì¶”ì²œ ìº í˜ì¸ ìœ í˜•</label>
                            <input type="text" id="note_ad_type" class="note-input" placeholder="ì˜ˆ: ë¸Œëœë””ë“œ, ë‹¨ìˆœ PPL">
                        </div>

                        <!-- 5. í¼í¬ë¨¼ìŠ¤ (ìë™ + ìˆ˜ë™) -->
                        <div class="md:col-span-2 bg-bg-dark/30 p-4 rounded-lg">
                            <h3 class="note-section-title"># í¼í¬ë¨¼ìŠ¤</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-3 text-sm">
                                <div class="bg-bg-dark p-2 rounded border border-card-bg">
                                    <span class="text-text-light/50 block text-xs">í‰ê·  ì¡°íšŒìˆ˜ (90ì¼)</span>
                                    <span id="note_auto_views" class="font-bold text-success-status">-</span>
                                </div>
                                <div class="bg-bg-dark p-2 rounded border border-card-bg">
                                    <span class="text-text-light/50 block text-xs">ì°¸ì—¬ë„ (ëŒ“ê¸€/ì¡°íšŒìˆ˜)</span>
                                    <span id="note_auto_engagement" class="font-bold text-primary-accent">-</span>
                                </div>
                            </div>
                            <label class="note-label">ê´‘ê³  ì˜ìƒ ì„±ê³¼ (ì§ì ‘ ë¶„ì„)</label>
                            <input type="text" id="note_ad_perf" class="note-input" placeholder="ê¸°ì¡´ ê´‘ê³  ì˜ìƒë“¤ì˜ ì¡°íšŒìˆ˜ ì¶”ì´ ë“±">
                            <label class="note-label">ì‹œì²­ì ì°¸ì—¬ë„ ìƒì„¸ ë©”ëª¨</label>
                            <textarea id="note_engagement_memo" class="note-input h-12" placeholder="ëŒ“ê¸€ ë¶„ìœ„ê¸°, ë°˜ì‘ ë“±"></textarea>
                        </div>
                    </div>
                </div>

                <!-- ìº˜ë¦°ë” -->
                <h3 class="text-xl font-semibold mb-4 border-b border-primary-accent/50 pb-2 flex justify-between items-center">
                    <span>ğŸ“… ì—…ë¡œë“œ ë¹ˆë„</span>
                    <button id="resetFilterBtn" class="ml-2 text-xs bg-bg-dark px-3 py-1 rounded hidden text-text-light border border-text-light/20 hover:bg-card-bg" onclick="resetVideoFilter()">í•„í„° í•´ì œ</button>
                </h3>
                <div id="calendarContainer" class="bg-card-bg p-4 rounded-xl shadow-xl mb-10 overflow-x-auto">
                    <div id="calendarNavHeader" class="flex justify-between items-center mb-4 px-2 min-w-[300px]"></div>
                    <div id="calendarBody" class="grid grid-cols-7 gap-1 min-w-[300px]"></div>
                </div>

                <!-- Shorts ë¯¸ë¦¬ë³´ê¸° -->
                <h3 class="text-xl font-semibold mb-4 border-b border-primary-accent/50 pb-2 flex flex-col sm:flex-row justify-between items-center gap-2">
                    <span>ğŸ”¥ ìµœì‹  Shorts (1ë¶„ ì´í•˜)</span>
                    <div class="flex gap-2 text-sm items-center">
                        <select id="shortsSortBy" onchange="updateShortsSort()" class="bg-bg-dark border border-text-light/20 rounded p-1 text-text-light text-xs focus:outline-none focus:border-primary-accent">
                            <option value="publishedAt">ìµœì‹ ìˆœ</option>
                            <option value="viewCount">ì¡°íšŒìˆ˜ìˆœ</option>
                            <option value="likeCount">ì¢‹ì•„ìš”ìˆœ</option>
                            <option value="commentCount">ëŒ“ê¸€ìˆœ</option>
                        </select>
                        <button id="shortsSortDirBtn" onclick="toggleShortsSortDir()" class="bg-bg-dark border border-text-light/20 rounded p-1 px-2 text-text-light hover:bg-card-bg text-xs">
                            â¬‡ï¸
                        </button>
                    </div>
                </h3>
                <div id="shortsContainer" class="shorts-scroll-container group relative py-4 px-10 bg-card-bg rounded-xl shadow-inner mb-10 hidden">
                    <!-- ì™¼ìª½ ë²„íŠ¼ -->
                    <button class="scroll-button left-2 bg-primary-accent text-white hover:bg-primary-accent/80" style="left: 0.5rem;" onclick="scrollShorts(-300)">â—€</button>
                    
                    <div id="shortsContent" class="shorts-content flex space-x-4 px-1 overflow-x-auto scrollbar-hide"></div>
                    
                    <!-- ì˜¤ë¥¸ìª½ ë²„íŠ¼ -->
                    <button class="scroll-button right-2 bg-primary-accent text-white hover:bg-primary-accent/80" style="right: 0.5rem; left: auto;" onclick="scrollShorts(300)">â–¶</button>
                </div>

                <!-- ë¹„ë””ì˜¤ ë¦¬ìŠ¤íŠ¸ & í•„í„° & ë‹¤ìš´ë¡œë“œ -->
                <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                    <h3 class="text-xl font-semibold">
                        ì „ì²´ ë¹„ë””ì˜¤ (<span id="totalVideosCount">0</span>ê°œ)
                    </h3>
                    <div class="flex gap-2 items-center flex-wrap w-full md:w-auto justify-end">
                        <!-- í•„í„° ë“œë¡­ë‹¤ìš´ -->
                        <div class="relative group">
                            <button class="px-4 py-2 bg-card-bg border border-text-light/20 rounded text-sm hover:bg-card-bg/80 text-text-light flex items-center">
                                ğŸ” í•„í„° ì„¤ì •
                            </button>
                            <div class="absolute right-0 mt-2 w-64 bg-bg-dark border border-text-light/20 rounded-lg shadow-2xl p-4 hidden group-hover:block z-50">
                                <h4 class="text-xs font-bold text-primary-accent mb-2">ì˜ìƒ ê¸¸ì´</h4>
                                <div class="space-y-1 mb-3">
                                    <label class="flex items-center space-x-2 text-sm text-text-light cursor-pointer"><input type="checkbox" class="filter-type" value="Short" checked onchange="renderVideoList()"> <span>ìˆí¼ (1ë¶„â†“)</span></label>
                                    <label class="flex items-center space-x-2 text-sm text-text-light cursor-pointer"><input type="checkbox" class="filter-type" value="Mid" checked onchange="renderVideoList()"> <span>ë¯¸ë“œí¼ (1~3ë¶„)</span></label>
                                    <label class="flex items-center space-x-2 text-sm text-text-light cursor-pointer"><input type="checkbox" class="filter-type" value="Long" checked onchange="renderVideoList()"> <span>ë¡±í¼ (3ë¶„â†‘)</span></label>
                                </div>
                                <h4 class="text-xs font-bold text-primary-accent mb-2">L/V ë“±ê¸‰ (ì¢‹ì•„ìš” ë¹„ìœ¨)</h4>
                                <div class="grid grid-cols-5 gap-1 text-center mb-3 text-text-light">
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-like" value="1" checked onchange="renderVideoList()"><br><span class="text-xs">1â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-like" value="2" checked onchange="renderVideoList()"><br><span class="text-xs">2â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-like" value="3" checked onchange="renderVideoList()"><br><span class="text-xs">3â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-like" value="4" checked onchange="renderVideoList()"><br><span class="text-xs">4â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-like" value="5" checked onchange="renderVideoList()"><br><span class="text-xs">5â˜…</span></label>
                                </div>
                                <h4 class="text-xs font-bold text-primary-accent mb-2 mt-3">C/V ë“±ê¸‰ (ëŒ“ê¸€ ë¹„ìœ¨)</h4>
                                <div class="grid grid-cols-5 gap-1 text-center mb-3 text-text-light">
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-comment" value="1" checked onchange="renderVideoList()"><br><span class="text-xs">1â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-comment" value="2" checked onchange="renderVideoList()"><br><span class="text-xs">2â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-comment" value="3" checked onchange="renderVideoList()"><br><span class="text-xs">3â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-comment" value="4" checked onchange="renderVideoList()"><br><span class="text-xs">4â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-comment" value="5" checked onchange="renderVideoList()"><br><span class="text-xs">5â˜…</span></label>
                                </div>
                            </div>
                        </div>
                        <button id="downloadCsvBtn" class="px-4 py-2 bg-success-status text-bg-dark font-bold rounded text-sm hover:bg-success-status/80" onclick="exportToCSV()" disabled>â¬‡ï¸ CSV</button>
                    </div>
                </div>

                <!-- í…Œì´ë¸” (í’€ ì»¬ëŸ¼) -->
                <div class="overflow-x-auto bg-card-bg rounded-xl shadow-2xl">
                    <table class="min-w-full divide-y divide-bg-dark table-fixed">
                        <thead class="bg-bg-dark">
                            <tr>
                                <th class="px-2 py-3 text-left text-xs font-medium text-text-light/70 uppercase w-12">No</th>
                                <!-- ì œëª© ì—´ ë„ˆë¹„ í™•ì¥ -->
                                <th class="px-2 py-3 text-left text-xs font-medium text-text-light/70 uppercase w-64 md:w-80 lg:w-96 sortable-header" onclick="setVideoSort('title')">ì œëª© â†•</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-text-light/70 uppercase w-24 sortable-header" onclick="setVideoSort('publishedAt')">ê²Œì‹œì¼ â†•</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-text-light/70 uppercase w-20 sortable-header" onclick="setVideoSort('viewCount')">ì¡°íšŒìˆ˜ â†•</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-text-light/70 uppercase w-16 sortable-header" onclick="setVideoSort('durationSeconds')">ê¸¸ì´ â†•</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-text-light/70 uppercase w-16 sortable-header" onclick="setVideoSort('durationCategory')">ë¶„ë¥˜ â†•</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-text-light/70 uppercase w-24 sortable-header" onclick="setVideoSort('likeRatio')">L/V(5â˜…) â†•</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-text-light/70 uppercase w-24 sortable-header" onclick="setVideoSort('commentRatio')">C/V(5â˜…) â†•</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-text-light/70 uppercase w-20 sortable-header" onclick="setVideoSort('likeCount')">ì¢‹ì•„ìš” â†•</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-text-light/70 uppercase w-20 sortable-header" onclick="setVideoSort('commentCount')">ëŒ“ê¸€ â†•</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-text-light/70 uppercase w-16">ë”ë³´ê¸°</th>
                            </tr>
                        </thead>
                        <tbody id="videoListTableBody" class="divide-y divide-card-bg/50 text-sm"></tbody>
                    </table>
                    <p id="noVideosMessage" class="hidden text-center text-text-light/50 py-10">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </section>
        </div>

        <!-- íƒ­ 2: ì €ì¥ëœ ëª©ë¡ (ID í™•ì¸) -->
        <div id="content-saved" class="hidden">
            <section class="mb-12">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xs text-text-light/50 ml-auto">í—¤ë”ë¥¼ í´ë¦­í•˜ì—¬ ì •ë ¬í•˜ì„¸ìš”</span>
                </div>
                <div class="overflow-x-auto bg-card-bg rounded-xl shadow-xl">
                    <table class="min-w-full divide-y divide-bg-dark">
                        <thead class="bg-bg-dark">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-text-light/70 uppercase sortable-header min-w-[200px]" onclick="setSavedSort('title')">ì±„ë„ ì •ë³´ â†•</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-text-light/70 uppercase sortable-header min-w-[100px]" onclick="setSavedSort('subscribers')">êµ¬ë…ì â†•</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-text-light/70 uppercase sortable-header min-w-[120px]" onclick="setSavedSort('lastUpdated')">ì—…ë°ì´íŠ¸ â†•</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-text-light/70 uppercase min-w-[100px]">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="savedChannelsListBody" class="divide-y divide-bg-dark/50 text-sm"></tbody>
                    </table>
                    <p id="emptySavedListMsg" class="text-center py-8 text-text-light/30 hidden">ì €ì¥ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </section>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, onSnapshot, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Vars ---
        const API_BASE_URL = 'https://www.googleapis.com/youtube/v3/';
        let db, auth, masterUserId, currentApiKey = '';
        let geminiKey = '';
        let editingKeyName = null; 
        let editingKeyType = null;
        
        let globalApiSettings = { youtube: [], gemini: [] };
        
        function setStatus(msg, isError) {
            const el = document.getElementById('statusMessage');
            if (el) {
                el.textContent = msg;
                el.className = `mt-4 text-center text-sm font-medium ${isError ? 'text-primary-accent' : 'text-success-status'}`;
            }
        }
        window.setStatus = setStatus;

        let allVideosData = [];
        let channelMetadata = null;
        let savedChannelsData = [];
        
        // Sorting States
        let videoSortState = { key: 'publishedAt', dir: 'desc' };
        let savedSortState = { key: 'lastUpdated', dir: 'desc' };
        let shortsSortState = { key: 'publishedAt', dir: 'desc' };

        let currentCalendarDate = null;
        let currentFilterDate = null;
        let monthlyCalendarData = {};
        let availableMonths = [];
        let expandedRowId = null;

        // --- Utilities ---
        function sanitizeData(obj) {
            if (obj === undefined) return null;
            if (obj === null) return null;
            if (Array.isArray(obj)) return obj.map(sanitizeData);
            if (typeof obj === 'object') {
                const newObj = {};
                for (const key in obj) {
                    newObj[key] = sanitizeData(obj[key]);
                }
                return newObj;
            }
            return obj;
        }

        function formatNumber(num) { 
            return num ? new Intl.NumberFormat('ko-KR').format(num) : '0'; 
        }

        function parseDuration(pt) {
            if (!pt) return 0;
            const match = pt.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            if (!match) return 0;
            const h = (parseInt(match[1]) || 0);
            const m = (parseInt(match[2]) || 0);
            const s = (parseInt(match[3]) || 0);
            return h * 3600 + m * 60 + s;
        }

        function formatTime(sec) {
            const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
            return h>0 ? `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}` : `${m}:${s.toString().padStart(2,'0')}`;
        }

        function getColorForCategory(cat) {
            if (cat === 'Short') return 'text-primary-accent'; 
            if (cat === 'Mid') return 'text-text-light/80';    
            if (cat === 'Long') return 'text-success-status';  
            return '';
        }

        function renderStars(rating) {
            let html = '';
            for(let i=0; i<5; i++) {
                html += i < rating ? '<span class="star-filled">â˜…</span>' : '<span class="star-empty">â˜†</span>';
            }
            return html;
        }

        // --- Key Management Functions ---
        window.renderKeys = (type) => {
            const containerId = type === 'youtube' ? 'youtubeKeyList' : 'geminiKeyList';
            const keys = globalApiSettings[type] || [];
            
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            
            const activeKey = keys.find(k => k.active);
            if (type === 'youtube') currentApiKey = activeKey ? activeKey.value : '';
            if (type === 'gemini') geminiKey = activeKey ? activeKey.value : '';

            keys.forEach(k => {
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-2 rounded text-xs text-text-light border ${k.active ? 'border-primary-accent bg-bg-dark' : 'border-transparent bg-bg-dark/30'}`;
                div.innerHTML = `
                    <div class="flex flex-col overflow-hidden mr-2">
                        <span class="font-bold truncate text-primary-accent">${k.name}</span>
                        <span class="text-[10px] text-text-light/50 truncate">${k.active ? 'ì‚¬ìš© ì¤‘' : 'ë¹„í™œì„±'}</span>
                    </div>
                    <div class="flex gap-1 flex-shrink-0">
                        ${!k.active ? `<button onclick="activateKey('${type}', '${k.name}')" class="px-2 py-1 bg-card-bg border border-text-light/20 rounded hover:text-white">ì„ íƒ</button>` : ''}
                        <button onclick="editKey('${type}', '${k.name}', '${k.value}')" class="px-2 py-1 text-text-light/50 hover:text-primary-accent">âœï¸</button>
                        <button onclick="deleteKey('${type}', '${k.name}')" class="px-2 py-1 text-text-light/50 hover:text-red-500">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(div);
            });
        };

        window.saveKey = async (type) => {
            const btnId = type === 'youtube' ? 'saveYoutubeKeyBtn' : 'saveGeminiKeyBtn';
            const btn = document.getElementById(btnId);
            const originalText = btn.innerText;
            
            try {
                // UI Feedback
                btn.disabled = true;
                btn.innerText = "ì €ì¥ ì¤‘...";

                const nameInput = type === 'youtube' ? 'newYoutubeKeyName' : 'newGeminiKeyName';
                const valInput = type === 'youtube' ? 'newYoutubeKeyValue' : 'newGeminiKeyValue';

                const name = document.getElementById(nameInput).value.trim();
                const val = document.getElementById(valInput).value.trim();

                if (!name || !val) {
                    alert('ì´ë¦„ê³¼ í‚¤ ê°’ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                if (!db) {
                    alert('ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    return;
                }

                let keys = [...(globalApiSettings[type] || [])];

                if (editingKeyName && editingKeyType === type) {
                    const idx = keys.findIndex(k => k.name === editingKeyName);
                    if (idx !== -1) keys[idx].value = val;
                    resetEditMode(type);
                } else {
                    if (keys.some(k => k.name === name)) {
                        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.');
                        return;
                    }
                    keys.push({ name, value: val, active: keys.length === 0 });
                }

                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'api_settings', 'keys');
                await setDoc(docRef, { [type]: keys }, { merge: true });
                document.getElementById(nameInput).value = '';
                document.getElementById(valInput).value = '';
                
                // Optimistic update
                globalApiSettings[type] = keys;
                window.renderKeys(type);
                
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } catch(e) {
                console.error("Save Error:", e);
                alert(`ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        };

        window.activateKey = async (type, name) => {
            if (!db) return;
            let keys = [...(globalApiSettings[type] || [])];
            keys.forEach(k => k.active = (k.name === name));
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'api_settings', 'keys');
                await setDoc(docRef, { [type]: keys }, { merge: true });
            } catch(e) {
                alert('í™œì„±í™” ì‹¤íŒ¨: ' + e.message);
            }
        };

        window.deleteKey = async (type, name) => {
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            if (!db) return;
            let keys = [...(globalApiSettings[type] || [])];
            keys = keys.filter(k => k.name !== name);
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'api_settings', 'keys');
                await setDoc(docRef, { [type]: keys }, { merge: true });
            } catch(e) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
            }
        };

        window.editKey = (type, name, val) => {
            const nameInput = type === 'youtube' ? 'newYoutubeKeyName' : 'newGeminiKeyName';
            const valInput = type === 'youtube' ? 'newYoutubeKeyValue' : 'newGeminiKeyValue';
            const saveBtn = type === 'youtube' ? 'saveYoutubeKeyBtn' : 'saveGeminiKeyBtn';
            const cancelBtn = type === 'youtube' ? 'cancelYoutubeEditBtn' : 'cancelGeminiEditBtn';

            document.getElementById(nameInput).value = name;
            document.getElementById(valInput).value = val;
            document.getElementById(nameInput).disabled = true;

            editingKeyName = name;
            editingKeyType = type;

            document.getElementById(saveBtn).textContent = "ìˆ˜ì •";
            document.getElementById(cancelBtn).classList.remove('hidden');
        };

        window.resetEditMode = (type) => {
            const nameInput = type === 'youtube' ? 'newYoutubeKeyName' : 'newGeminiKeyName';
            const valInput = type === 'youtube' ? 'newYoutubeKeyValue' : 'newGeminiKeyValue';
            const saveBtn = type === 'youtube' ? 'saveYoutubeKeyBtn' : 'saveGeminiKeyBtn';
            const cancelBtn = type === 'youtube' ? 'cancelYoutubeEditBtn' : 'cancelGeminiEditBtn';

            editingKeyName = null;
            editingKeyType = null;

            document.getElementById(nameInput).value = '';
            document.getElementById(valInput).value = '';
            document.getElementById(nameInput).disabled = false;
            document.getElementById(saveBtn).textContent = "ì €ì¥";
            document.getElementById(cancelBtn).classList.add('hidden');
        };

        // --- Core Logic Functions ---
        function calculateEngagementRatings(videos) {
            if (!videos.length) return;
            const assignStars = (list, keyRatio, keyRating) => {
                const sorted = list.map(v => v[keyRatio]).sort((a, b) => a - b);
                const len = sorted.length;
                if (len === 0) return;
                const p20 = sorted[Math.floor(len * 0.2)];
                const p40 = sorted[Math.floor(len * 0.4)];
                const p60 = sorted[Math.floor(len * 0.6)];
                const p80 = sorted[Math.floor(len * 0.8)];
                list.forEach(v => {
                    const val = v[keyRatio];
                    if (val >= p80) v[keyRating] = 5;
                    else if (val >= p60) v[keyRating] = 4;
                    else if (val >= p40) v[keyRating] = 3;
                    else if (val >= p20) v[keyRating] = 2;
                    else v[keyRating] = 1;
                });
            };
            assignStars(videos, 'likeRatio', 'likeRating');
            assignStars(videos, 'commentRatio', 'commentRating');
        }

        function calc90DayStats(videos) {
            const d = new Date(); d.setDate(d.getDate()-90);
            const recent = videos.filter(v => new Date(v.publishedAt) >= d);
            if (!recent.length) return { avgViews:0, avgLikes:0, avgComments:0 };
            const sum = k => recent.reduce((a,b) => a + (b[k]||0), 0);
            return {
                avgViews: Math.round(sum('viewCount')/recent.length),
                avgLikes: Math.round(sum('likeCount')/recent.length),
                avgComments: Math.round(sum('commentCount')/recent.length)
            };
        }

        function generateCalendarData(videos) {
            const data = {};
            videos.forEach(v => {
                const m = v.publishedAt.slice(0, 7);
                if (!data[m]) data[m] = new Map();
                const date = v.publishedAt.slice(0, 10);
                data[m].set(date, (data[m].get(date)||0)+1);
            });
            availableMonths = Object.keys(data).sort().reverse();
            return data;
        }

        // --- API Helpers ---
        async function fetchChannelData(query) {
            if (query.startsWith('UC') && query.length > 20) {
                 const url = `${API_BASE_URL}channels?part=snippet,contentDetails,statistics,brandingSettings&id=${query}&key=${currentApiKey}`;
                 const res = await checkResponse(await fetch(url));
                 if (res.items && res.items.length > 0) return res;
            }

            let handle = query;
            if (!handle.startsWith('@') && !handle.startsWith('UC')) {
                handle = '@' + handle; 
            }

            if (handle.startsWith('@')) {
                const url = `${API_BASE_URL}channels?part=snippet,contentDetails,statistics,brandingSettings&forHandle=${encodeURIComponent(handle)}&key=${currentApiKey}`;
                const res = await checkResponse(await fetch(url));
                if (res.items && res.items.length > 0) return res;
            }

            if (!query.startsWith('UC')) {
                const searchUrl = `${API_BASE_URL}search?part=snippet&type=channel&q=${encodeURIComponent(query)}&key=${currentApiKey}`;
                const searchRes = await checkResponse(await fetch(searchUrl));
                
                if (searchRes.items && searchRes.items.length > 0) {
                    const channelId = searchRes.items[0].snippet.channelId;
                    const url = `${API_BASE_URL}channels?part=snippet,contentDetails,statistics,brandingSettings&id=${channelId}&key=${currentApiKey}`;
                    return checkResponse(await fetch(url));
                }
            }

            return { items: [] }; 
        }

        async function fetchAllVideos(uploadsId) {
            let videos = [];
            let nextPageToken = '';
            let maxPages = 10; 
            
            do {
                const url = `${API_BASE_URL}playlistItems?part=snippet&playlistId=${uploadsId}&maxResults=50&pageToken=${nextPageToken}&key=${currentApiKey}`;
                const data = await checkResponse(await fetch(url));
                
                const items = data.items.map(item => ({
                    videoId: item.snippet.resourceId.videoId,
                    title: item.snippet.title,
                    description: item.snippet.description,
                    publishedAt: item.snippet.publishedAt,
                    thumbnail: item.snippet.thumbnails.default?.url || ''
                }));
                videos = videos.concat(items);
                
                nextPageToken = data.nextPageToken;
                maxPages--;
            } while (nextPageToken && maxPages > 0);
            
            return videos;
        }

        async function fetchVideoStats(videoIds) {
            let statsMap = {};
            for (let i = 0; i < videoIds.length; i += 50) {
                const chunk = videoIds.slice(i, i + 50).join(',');
                const url = `${API_BASE_URL}videos?part=statistics,contentDetails,snippet&id=${chunk}&key=${currentApiKey}`;
                const data = await checkResponse(await fetch(url));
                
                if (data.items) {
                    data.items.forEach(item => {
                        statsMap[item.id] = {
                            viewCount: parseInt(item.statistics.viewCount || 0),
                            likeCount: parseInt(item.statistics.likeCount || 0),
                            commentCount: parseInt(item.statistics.commentCount || 0),
                            duration: item.contentDetails.duration,
                            tags: item.snippet.tags || []
                        };
                    });
                }
            }
            return statsMap;
        }

        function mergeVideoData(videos, statsMap) {
            return videos.map(v => {
                const stat = statsMap[v.videoId] || { viewCount: 0, likeCount: 0, commentCount: 0, duration: 'PT0S', tags: [] };
                const durationSec = parseDuration(stat.duration);
                
                let durCat = 'Mid';
                if (durationSec <= 60) durCat = 'Short';
                else if (durationSec >= 180) durCat = 'Long';

                const likeRatio = stat.viewCount > 0 ? (stat.likeCount / stat.viewCount) * 100 : 0;
                const commentRatio = stat.viewCount > 0 ? (stat.commentCount / stat.viewCount) * 100 : 0;

                return {
                    ...v,
                    ...stat,
                    durationSeconds: durationSec,
                    durationCategory: durCat,
                    likeRatio,
                    commentRatio
                };
            });
        }
        
        // Export CSV
        window.exportToCSV = () => {
             if (!allVideosData.length) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
             let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM
             csvContent += "Title,Published,Views,Likes,Comments,Duration(Sec),Type,Link\n";
             
             allVideosData.forEach(v => {
                 const title = v.title.replace(/,/g, " "); // simple escape
                 csvContent += `${title},${v.publishedAt},${v.viewCount},${v.likeCount},${v.commentCount},${v.durationSeconds},${v.durationCategory},https://youtu.be/${v.videoId}\n`;
             });
             
             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", `channel_analysis_${channelMetadata.id}.csv`);
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
        }

        // Saved Channel Actions
        window.refreshChannel = (id) => {
            document.getElementById('channelId').value = id;
            startAnalysis(true);
        };

        window.deleteSavedChannel = async (id) => {
            if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            if (db && masterUserId) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', id));
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channel_list', id));
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch(e) {
                    console.error(e);
                    alert('ì‚­ì œ ì‹¤íŒ¨');
                }
            }
        };

        async function loadChannelFromCache(id) {
            if (db) {
                setStatus('ìƒì„¸ ë°ì´í„° ë¡œë”© ì¤‘...', false);
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'channels', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        allVideosData = data.videos || [];
                        channelMetadata = data.metadata;
                        const stats90 = data.stats90 || { avgViews: 0, avgLikes: 0, avgComments: 0 };
                        loadNoteData(data.analysisNote || {});
                        renderAnalysisUI(stats90);
                        switchTab('analyze');
                        setStatus(`ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${channelMetadata.title}`, false);
                    } else {
                        // ìƒì„¸ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ëª©ë¡ì—ì„œë¼ë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ì¬ë¶„ì„ ìœ ë„
                        alert('ìƒì„¸ ë¹„ë””ì˜¤ ë°ì´í„°ê°€ ìºì‹œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•©ë‹ˆë‹¤.');
                        refreshChannel(id);
                    }
                } catch(e) {
                    console.error("Load failed:", e);
                    setStatus('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', true);
                }
            }
        }

        // --- Note Functions & Gemini ---
        function loadNoteData(note) {
            document.getElementById('note_summary').value = note.summary || '';
            document.getElementById('note_pros').value = note.pros || '';
            document.getElementById('note_cons').value = note.cons || '';
            document.getElementById('note_genre').value = note.genre || '';
            document.getElementById('note_tone').value = note.tone || '';
            document.getElementById('note_style').value = note.style || '';
            document.getElementById('note_topic').value = note.topic || '';
            document.getElementById('note_audience').value = note.audience || '';
            document.getElementById('note_trust').value = note.trust || '';
            document.getElementById('note_ad_domain').value = note.ad_domain || '';
            document.getElementById('note_ad_type').value = note.ad_type || '';
            document.getElementById('note_ad_perf').value = note.ad_perf || '';
            document.getElementById('note_engagement_memo').value = note.engagement_memo || '';
        }

        window.saveChannelNote = async () => {
            if (!db || !masterUserId || !channelMetadata) {
                alert('ë¶„ì„ëœ ì±„ë„ì´ ì—†ê±°ë‚˜ ì €ì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const noteData = {
                summary: document.getElementById('note_summary').value,
                pros: document.getElementById('note_pros').value,
                cons: document.getElementById('note_cons').value,
                genre: document.getElementById('note_genre').value,
                tone: document.getElementById('note_tone').value,
                style: document.getElementById('note_style').value,
                topic: document.getElementById('note_topic').value,
                audience: document.getElementById('note_audience').value,
                trust: document.getElementById('note_trust').value,
                ad_domain: document.getElementById('note_ad_domain').value,
                ad_type: document.getElementById('note_ad_type').value,
                ad_perf: document.getElementById('note_ad_perf').value,
                engagement_memo: document.getElementById('note_engagement_memo').value
            };
            try {
                const channelRef = doc(db, 'artifacts', appId, 'public', 'data', 'channels', channelMetadata.id);
                await setDoc(channelRef, { analysisNote: noteData }, { merge: true });
                alert('ë…¸íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) {
                console.error(e);
                alert('ë…¸íŠ¸ ì €ì¥ ì‹¤íŒ¨');
            }
        };

        // --- Gemini Integration ---
        async function analyzeChannelWithGemini(isAuto = false) {
            if (!geminiKey) {
                if (!isAuto) alert('Gemini API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            if (!channelMetadata) {
                if (!isAuto) alert('ë¨¼ì € ì±„ë„ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = document.getElementById('geminiAnalyzeBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>ğŸ¤– ë¶„ì„ ì¤‘...</span>';
            btn.disabled = true;

            try {
                const topVideos = allVideosData
                    .sort((a, b) => parseInt(b.viewCount) - parseInt(a.viewCount))
                    .slice(0, 10)
                    .map(v => `${v.title} (ì¡°íšŒìˆ˜: ${v.viewCount}, ì¢‹ì•„ìš”: ${v.likeCount})`);
                
                const recentVideos = allVideosData
                    .sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt))
                    .slice(0, 5)
                    .map(v => v.title);

                const prompt = `
                    You are a professional YouTube Marketing Analyst. Analyze this channel based on the provided data.
                    
                    Channel: ${channelMetadata.title}
                    Description: ${channelMetadata.description}
                    Subscribers: ${channelMetadata.subscribers}
                    
                    Top 10 Videos by Views:
                    ${topVideos.join('\n')}
                    
                    Recent 5 Videos:
                    ${recentVideos.join('\n')}
                    
                    Please provide a JSON response with the following keys (values in Korean):
                    {
                        "summary": "Comprehensive summary of the channel's identity and performance",
                        "pros": "Key strengths (comma separated)",
                        "cons": "Potential weaknesses or risks (comma separated)",
                        "genre": "Main genre/category",
                        "tone": "Tone and manner",
                        "style": "Editing and directing style",
                        "topic": "Main topics covered",
                        "audience": "Estimated target audience demographics",
                        "trust": "Channel credibility",
                        "ad_domain": "Suitable industries for advertising",
                        "ad_type": "Recommended ad campaign types",
                        "ad_perf": "Estimated ad performance",
                        "engagement_memo": "Analysis of viewer engagement"
                    }
                    Return ONLY the JSON.
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                let text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const result = JSON.parse(text);
                loadNoteData(result);
                if (!isAuto) alert('Gemini ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (e) {
                console.error(e);
                if (!isAuto) alert(`Gemini ë¶„ì„ ì‹¤íŒ¨: ${e.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        window.analyzeChannelWithGemini = analyzeChannelWithGemini;

        // --- Standard Functions ---
        async function checkResponse(response) {
            if (!response.ok) {
                const errorBody = await response.json();
                const errorMessage = errorBody.error ? errorBody.error.message : response.statusText;
                throw new Error(`API ì˜¤ë¥˜: ${response.status} - ${errorMessage}`);
            }
            return response.json();
        }

        async function startAnalysis(isRefresh = false) {
            const input = document.getElementById('channelId').value.trim();
            
            if (!currentApiKey) {
                alert('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. [API ì„¤ì •] ë©”ë‰´ì—ì„œ í‚¤ë¥¼ ì¶”ê°€í•˜ê³  í™œì„±í™”í•´ì£¼ì„¸ìš”.');
                return setStatus('API í‚¤ í•„ìš”', true);
            }
            if (!input) {
                alert('ì±„ë„ IDë‚˜ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return setStatus('ID ì…ë ¥ í•„ìš”', true);
            }

            setStatus('ë°ì´í„° ìˆ˜ì§‘ ì¤‘...', false);
            document.getElementById('analyzeButton').disabled = true;
            document.getElementById('buttonText').textContent = 'ë¶„ì„ ì¤‘...';

            try {
                const chData = await fetchChannelData(input);
                
                if (!chData || !chData.items || !chData.items.length) {
                    throw new Error('ì±„ë„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ID ë˜ëŠ” Handle í™•ì¸ í•„ìš”)');
                }

                const chItem = chData.items[0];
                const meta = {
                    id: chItem.id,
                    title: chItem.snippet.title,
                    description: chItem.snippet.description,
                    subscribers: chItem.statistics.subscriberCount,
                    totalViews: chItem.statistics.viewCount,
                    totalVideos: chItem.statistics.videoCount,
                    thumbnail: chItem.snippet.thumbnails.default?.url || '', 
                    publishedAt: chItem.snippet.publishedAt,
                    country: chItem.snippet.country || 'N/A'
                };

                const uploadsId = chItem.contentDetails.relatedPlaylists.uploads;
                let videos = await fetchAllVideos(uploadsId);
                const vidIds = videos.map(v => v.videoId);
                const stats = await fetchVideoStats(vidIds);
                
                videos = mergeVideoData(videos, stats);
                calculateEngagementRatings(videos);
                
                const stats90 = calc90DayStats(videos);
                
                // [FIX] ë°ì´í„° ì €ì¥ ë¡œì§ ê°œì„  (ë°ì´í„° ì •ì œ ì¶”ê°€)
                if (db && masterUserId) {
                    // ì €ì¥ ì „ undefined ì œê±° (Firestore ì˜¤ë¥˜ ë°©ì§€)
                    const safeMeta = sanitizeData(meta);
                    const safeStats = sanitizeData(stats90);
                    const safeVideos = sanitizeData(videos); // ë¹„ë””ì˜¤ ëª©ë¡ì€ ë³„ë„ ë¬¸ì„œì—ë§Œ ì €ì¥

                    try {
                        // 1. ìƒì„¸ ë°ì´í„° ì €ì¥ (channels ì»¬ë ‰ì…˜)
                        const saveRef = doc(db, 'artifacts', appId, 'public', 'data', 'channels', meta.id);
                        await setDoc(saveRef, {
                            metadata: safeMeta, videos: safeVideos, stats90: safeStats, lastUpdated: new Date().toISOString()
                        }, { merge: true }); 
                        
                        // 2. ëª©ë¡ìš© ìš”ì•½ ë°ì´í„° ì €ì¥ (channel_list ì»¬ë ‰ì…˜) - ë¹„ë””ì˜¤ ë¦¬ìŠ¤íŠ¸ ì œì™¸í•˜ì—¬ ê°€ë³ê²Œ ìœ ì§€
                        const listRef = doc(db, 'artifacts', appId, 'public', 'data', 'channel_list', meta.id);
                        await setDoc(listRef, {
                            metadata: safeMeta, stats90: safeStats, lastUpdated: new Date().toISOString()
                        });
                        console.log("Data saved successfully to Firestore.");
                        
                    } catch (saveError) {
                        console.error("Firestore Save Error:", saveError);
                        alert(`ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: ${saveError.message}`);
                    }
                } else {
                    setStatus('ë¶„ì„ ì™„ë£Œ (ë¡œì»¬ ëª¨ë“œ - ì €ì¥ ì•ˆë¨)', false);
                }

                channelMetadata = meta;
                allVideosData = videos;
                renderAnalysisUI(stats90);
                
                if (geminiKey) {
                    analyzeChannelWithGemini(true);
                }

                if (isRefresh) {
                    try {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'channels', meta.id);
                        const docSnap = await getDoc(docRef);
                        if(docSnap.exists()) loadNoteData(docSnap.data().analysisNote || {});
                    } catch(e){}
                } else {
                    loadNoteData({});
                }
                setStatus('ë¶„ì„ ì™„ë£Œ', false);

            } catch (e) {
                console.error(e);
                setStatus(`ì˜¤ë¥˜: ${e.message}`, true);
            } finally {
                document.getElementById('analyzeButton').disabled = false;
                document.getElementById('buttonText').textContent = 'ë¶„ì„ ì‹œì‘';
            }
        }
        window.startAnalysis = startAnalysis;

        function renderAnalysisUI(stats90) {
            document.getElementById('resultsSection').classList.remove('hidden');
            
            document.getElementById('channelInfo').innerHTML = `
                <div class="flex p-4 bg-bg-dark rounded-lg">
                    <img src="${channelMetadata.thumbnail}" class="w-20 h-20 md:w-24 md:h-24 rounded-full border-4 border-primary-accent mr-4 flex-shrink-0">
                    <div class="overflow-hidden">
                        <h2 class="text-xl md:text-2xl font-bold truncate">${channelMetadata.title}</h2>
                        <p class="text-sm text-text-light/60 truncate">ID: ${channelMetadata.id} / ${channelMetadata.country}</p>
                        <p class="text-sm text-text-light/60">ê°œì„¤: ${new Date(channelMetadata.publishedAt).toLocaleDateString()}</p>
                    </div>
                </div>
                <div class="p-4 bg-bg-dark rounded-lg text-sm text-text-light/80 overflow-y-auto max-h-32 whitespace-pre-wrap">${channelMetadata.description}</div>
            `;

            document.getElementById('statSubscribers').textContent = formatNumber(channelMetadata.subscribers);
            document.getElementById('statViews').textContent = formatNumber(channelMetadata.totalViews);
            document.getElementById('statVideos').textContent = formatNumber(channelMetadata.totalVideos);
            
            document.getElementById('avgViews90Days').textContent = formatNumber(stats90.avgViews);
            document.getElementById('avgLikes90Days').textContent = formatNumber(stats90.avgLikes);
            document.getElementById('avgComments90Days').textContent = formatNumber(stats90.avgComments);

            document.getElementById('note_auto_views').textContent = formatNumber(stats90.avgViews);
            const engagement = stats90.avgViews > 0 ? ((stats90.avgLikes + stats90.avgComments) / stats90.avgViews * 100).toFixed(2) + '%' : '0%';
            document.getElementById('note_auto_engagement').textContent = engagement;

            monthlyCalendarData = generateCalendarData(allVideosData);
            currentCalendarDate = availableMonths[0];
            
            renderCalendar(); 
            renderShorts();   
            renderVideoList(); 
        }

        // --- Shorts Sort Logic ---
        function updateShortsSort() {
            shortsSortState.key = document.getElementById('shortsSortBy').value;
            renderShorts();
        }
        window.updateShortsSort = updateShortsSort;

        function toggleShortsSortDir() {
            shortsSortState.dir = shortsSortState.dir === 'desc' ? 'asc' : 'desc';
            document.getElementById('shortsSortDirBtn').textContent = shortsSortState.dir === 'desc' ? 'â¬‡ï¸' : 'â¬†ï¸';
            renderShorts();
        }
        window.toggleShortsSortDir = toggleShortsSortDir;

        // --- Render Helpers ---

        function renderCalendar() {
            const container = document.getElementById('calendarBody');
            const nav = document.getElementById('calendarNavHeader');
            container.innerHTML = '';
            
            if (!monthlyCalendarData[currentCalendarDate]) {
                nav.innerHTML = 'ë°ì´í„° ì—†ìŒ';
                return;
            }

            const [y, m] = currentCalendarDate.split('-');
            nav.innerHTML = `
                <button onclick="changeMonth(1)" class="p-1 hover:bg-white/10 rounded text-text-light">â—€</button>
                <span class="font-bold text-text-light">${y}ë…„ ${m}ì›”</span>
                <button onclick="changeMonth(-1)" class="p-1 hover:bg-white/10 rounded text-text-light">â–¶</button>
            `;

            const firstDay = new Date(y, m-1, 1).getDay();
            const lastDate = new Date(y, m, 0).getDate();
            
            for(let i=0; i<firstDay; i++) container.appendChild(document.createElement('div'));
            
            const map = monthlyCalendarData[currentCalendarDate];
            for(let d=1; d<=lastDate; d++) {
                const dateKey = `${y}-${m}-${String(d).padStart(2,'0')}`;
                const count = map.get(dateKey)||0;
                const cell = document.createElement('div');
                cell.className = `calendar-cell ${count ? 'bg-primary-accent/50 text-white font-bold' : 'text-text-light/30'}`;
                if (currentFilterDate === dateKey) cell.classList.add('ring-2', 'ring-success-status');
                cell.innerHTML = `<span>${d}</span>${count ? `<span class="text-[10px]">${count}</span>` : ''}`;
                cell.onclick = () => {
                    currentFilterDate = dateKey;
                    document.getElementById('resetFilterBtn').classList.remove('hidden');
                    renderCalendar();
                    renderVideoList();
                };
                container.appendChild(cell);
            }
        }
        window.renderCalendar = renderCalendar;

        function renderShorts() {
            const container = document.getElementById('shortsContent');
            container.innerHTML = '';
            
            let shorts = allVideosData.filter(v => v.durationCategory === 'Short');
            
            // Sort
            shorts.sort((a, b) => {
                const key = shortsSortState.key;
                let valA = a[key], valB = b[key];
                
                // Numeric or Date convert
                if (key === 'publishedAt') {
                    valA = new Date(valA).getTime();
                    valB = new Date(valB).getTime();
                } else {
                    valA = Number(valA);
                    valB = Number(valB);
                }

                if (valA < valB) return shortsSortState.dir === 'asc' ? -1 : 1;
                if (valA > valB) return shortsSortState.dir === 'asc' ? 1 : -1;
                return 0;
            });

            if (shorts.length === 0) {
                document.getElementById('shortsContainer').classList.add('hidden');
                return;
            }
            document.getElementById('shortsContainer').classList.remove('hidden');

            shorts.forEach(s => {
                const el = document.createElement('div');
                el.className = 'inline-block w-40 md:w-48 bg-bg-dark rounded-lg overflow-hidden shadow-lg flex-shrink-0 border border-card-bg hover:border-primary-accent transition';
                el.innerHTML = `
                    <div class="relative pb-[177%]">
                        <a href="https://youtu.be/${s.videoId}" target="_blank">
                            <img src="https://img.youtube.com/vi/${s.videoId}/mqdefault.jpg" class="absolute h-full w-full object-cover">
                        </a>
                        <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 to-transparent p-2">
                            <p class="text-xs font-bold text-white truncate">${s.title}</p>
                            <p class="text-[10px] text-text-light/80">ğŸ‘ï¸ ${formatNumber(s.viewCount)} â€¢ ğŸ‘ ${formatNumber(s.likeCount)}</p>
                            <p class="text-[10px] text-text-light/60">${s.publishedAt.split('T')[0]}</p>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }
        window.renderShorts = renderShorts;

        function renderVideoList() {
            const tbody = document.getElementById('videoListTableBody');
            tbody.innerHTML = '';

            const durationFilters = Array.from(document.querySelectorAll('.filter-type:checked')).map(c => c.value);
            const likeFilters = Array.from(document.querySelectorAll('.filter-like:checked')).map(c => parseInt(c.value));
            const commentFilters = Array.from(document.querySelectorAll('.filter-comment:checked')).map(c => parseInt(c.value));
            
            let filtered = allVideosData.filter(v => {
                if (currentFilterDate && !v.publishedAt.startsWith(currentFilterDate)) return false;
                if (!durationFilters.includes(v.durationCategory)) return false;
                const lRate = v.likeRating || 1;
                if (!likeFilters.includes(lRate)) return false;
                const cRate = v.commentRating || 1;
                if (!commentFilters.includes(cRate)) return false;
                return true;
            });

            document.getElementById('totalVideosCount').textContent = formatNumber(filtered.length);
            if (filtered.length === 0) {
                document.getElementById('noVideosMessage').classList.remove('hidden');
                return;
            }
            document.getElementById('noVideosMessage').classList.add('hidden');
            document.getElementById('downloadCsvBtn').disabled = false;

            filtered.sort((a, b) => {
                const key = videoSortState.key;
                let valA = a[key], valB = b[key];
                if (['viewCount','likeCount','commentCount','durationSeconds','likeRatio','commentRatio','likeRating','commentRating'].includes(key)) {
                    valA = Number(valA); valB = Number(valB);
                }
                if (valA < valB) return videoSortState.dir === 'asc' ? -1 : 1;
                if (valA > valB) return videoSortState.dir === 'asc' ? 1 : -1;
                return 0;
            });

            filtered.slice(0, 200).forEach((v, idx) => {
                const rowId = `row-${idx}`;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-bg-dark/30 border-t border-bg-dark/50';
                
                const catColor = getColorForCategory(v.durationCategory);
                const lStar = v.likeRating || 1;
                const cStar = v.commentRating || 1;

                tr.innerHTML = `
                    <td class="px-2 py-3 text-text-light/50 text-center">${idx + 1}</td>
                    <td class="px-2 py-3 font-medium min-w-[200px] break-words whitespace-normal">
                        <div class="flex flex-col">
                            <span class="leading-tight">${v.title}</span>
                            <button onclick="copyToClipboard('https://youtu.be/${v.videoId}')" class="text-primary-accent hover:text-white flex-shrink-0 mt-1 text-xs self-start" title="ë§í¬ ë³µì‚¬">ğŸ”— ë§í¬ë³µì‚¬</button>
                        </div>
                    </td>
                    <td class="px-2 py-3 text-right text-xs text-text-light/60">${v.publishedAt.split('T')[0]}</td>
                    <td class="px-2 py-3 text-right text-success-status font-bold">${formatNumber(v.viewCount)}</td>
                    <td class="px-2 py-3 text-right text-xs">${formatTime(v.durationSeconds)}</td>
                    <td class="px-2 py-3 text-center text-xs font-bold ${catColor}">${v.durationCategory}</td>
                    <td class="px-2 py-3 text-center text-xs whitespace-nowrap" title="${v.likeRatio.toFixed(2)}%">
                        <div class="flex justify-center">${renderStars(lStar)}</div>
                    </td>
                    <td class="px-2 py-3 text-center text-xs whitespace-nowrap" title="${v.commentRatio.toFixed(2)}%">
                        <div class="flex justify-center">${renderStars(cStar)}</div>
                    </td>
                    <td class="px-2 py-3 text-right text-text-light/60 text-xs">${formatNumber(v.likeCount)}</td>
                    <td class="px-2 py-3 text-right text-text-light/60 text-xs">${formatNumber(v.commentCount)}</td>
                    <td class="px-2 py-3 text-center">
                        <button id="btn-${idx}" onclick="toggleDetailRow('${idx}')" class="text-xs bg-bg-dark px-2 py-1 rounded border border-text-light/10 hover:bg-primary-accent hover:text-white transition">â–¼</button>
                    </td>
                `;
                tbody.appendChild(tr);

                const trDetail = document.createElement('tr');
                trDetail.id = `detail-${idx}`;
                trDetail.className = 'detail-row hidden bg-bg-dark/40';
                trDetail.innerHTML = `
                    <td colspan="11" class="p-4 text-xs text-text-light/80">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold text-primary-accent mb-2">ğŸ“Œ íƒœê·¸</h4>
                                <div class="flex flex-wrap gap-1 max-h-32 overflow-y-auto">
                                    ${v.tags.length ? v.tags.map(t => `<span class="bg-card-bg px-2 py-1 rounded text-text-light/70">#${t}</span>`).join('') : '<span class="text-text-light/30">íƒœê·¸ ì—†ìŒ</span>'}
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-primary-accent mb-2">ğŸ“ ì„¤ëª…</h4>
                                <div class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-bg-dark/50 p-2 rounded border border-card-bg/50">${v.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(trDetail);
            });
        }
        window.renderVideoList = renderVideoList;

        function setVideoSort(key) {
            if (videoSortState.key === key) {
                videoSortState.dir = videoSortState.dir === 'asc' ? 'desc' : 'asc';
            } else {
                videoSortState.key = key;
                videoSortState.dir = 'desc';
            }
            renderVideoList();
        }
        window.setVideoSort = setVideoSort;

        function toggleDetailRow(id) {
            const row = document.getElementById(`detail-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            if (row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                btn.textContent = 'â–²';
            } else {
                row.classList.add('hidden');
                btn.textContent = 'â–¼';
            }
        }
        window.toggleDetailRow = toggleDetailRow;

        function scrollShorts(val) {
            document.getElementById('shortsContent').scrollBy({ left: val, behavior: 'smooth' });
        }
        window.scrollShorts = scrollShorts;

        function changeMonth(dir) {
            const idx = availableMonths.indexOf(currentCalendarDate);
            if (availableMonths[idx+dir]) {
                currentCalendarDate = availableMonths[idx+dir];
                renderCalendar();
            }
        }
        window.changeMonth = changeMonth;

        function resetVideoFilter() {
            currentFilterDate = null;
            document.getElementById('resetFilterBtn').classList.add('hidden');
            renderCalendar();
            renderVideoList();
        }
        window.resetVideoFilter = resetVideoFilter;

        function copyToClipboard(text) {
            const temp = document.createElement('textarea');
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            const toast = document.getElementById("toast");
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }
        window.copyToClipboard = copyToClipboard;

        // Expose applyManualConfig
        window.applyManualConfig = window.applyManualConfig; 

        // --- Tabs Logic ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById(`tab-${tabName}`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // [Fix] ê²€ìƒ‰ì°½ ì‚¬ë¼ì§ ë°©ì§€: display ì†ì„± ê°•ì œ ì¡°ì • ë° ì•ˆì „í•œ í´ë˜ìŠ¤ í† ê¸€
            const analyzeContent = document.getElementById('content-analyze');
            const savedContent = document.getElementById('content-saved');
            const searchPanel = document.getElementById('searchPanel');

            if (tabName === 'analyze') {
                if (analyzeContent) analyzeContent.classList.remove('hidden');
                if (savedContent) savedContent.classList.add('hidden');
                // ê²€ìƒ‰ íŒ¨ë„ ê°•ì œ í‘œì‹œ
                if (searchPanel) searchPanel.style.display = 'block';
            } else {
                if (analyzeContent) analyzeContent.classList.add('hidden');
                if (savedContent) savedContent.classList.remove('hidden');
            }
        }
        window.switchTab = switchTab;
    </script>
</body>
</html>
