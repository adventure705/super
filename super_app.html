<!DOCTYPE html>
<html lang="ko" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super App: All-in-One Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#121212',
                            sidebar: '#1e1e1e',
                            card: '#252525',
                            border: '#333333',
                            hover: '#3a3a3a',
                            text: '#e0e0e0',
                            muted: '#a0a0a0'
                        },
                        brand: {
                            primary: '#ef4444',
                            hover: '#dc2626'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .content-area-height {
            height: calc(100vh - 64px);
        }

        @media (max-width: 768px) {
            .content-area-height {
                height: calc(100vh - 56px);
            }
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-dark-bg text-dark-text overflow-hidden">

    <div class="flex h-screen w-full">
        <!-- Sidebar (Desktop) -->
        <aside
            class="hidden md:flex flex-col w-64 bg-dark-sidebar border-r border-dark-border transition-all duration-300">
            <div class="flex items-center justify-center h-16 border-b border-dark-border">
                <h1 class="text-xl font-bold text-brand-primary"><i class="fab fa-youtube mr-2"></i>Super Tool</h1>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1 px-2" id="desktop-menu"></ul>
            </nav>
            <div class="border-t border-dark-border p-4">
                <button onclick="app.openSettings()"
                    class="flex items-center w-full px-4 py-3 text-sm font-medium text-dark-muted hover:bg-dark-hover hover:text-white rounded-lg transition-colors">
                    <i class="fas fa-cog w-5 h-5 mr-3"></i> API ì„¤ì •
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
            <header
                class="md:hidden flex items-center justify-between h-14 bg-dark-sidebar border-b border-dark-border px-4 z-20">
                <h1 class="text-lg font-bold text-brand-primary">Super Tool</h1>
                <button onclick="app.toggleMobileMenu()" class="text-white focus:outline-none">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </header>

            <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"
                onclick="app.toggleMobileMenu()"></div>
            <div id="mobile-sidebar"
                class="fixed inset-y-0 left-0 w-64 bg-dark-sidebar border-r border-dark-border z-40 transform -translate-x-full transition-transform duration-300 md:hidden">
                <div class="flex items-center justify-between h-14 border-b border-dark-border px-4">
                    <h1 class="text-lg font-bold text-white">ë©”ë‰´</h1>
                    <button onclick="app.toggleMobileMenu()" class="text-gray-400 hover:text-white"><i
                            class="fas fa-times"></i></button>
                </div>
                <nav class="flex-1 overflow-y-auto py-4">
                    <ul class="space-y-1 px-2" id="mobile-menu-list"></ul>
                </nav>
                <div class="border-t border-dark-border p-4">
                    <button onclick="app.openSettings(); app.toggleMobileMenu();"
                        class="flex items-center w-full px-4 py-3 text-sm font-medium text-dark-muted hover:bg-dark-hover hover:text-white rounded-lg transition-colors">
                        <i class="fas fa-cog w-5 h-5 mr-3"></i> API ì„¤ì •
                    </button>
                </div>
            </div>

            <main class="flex-1 overflow-auto bg-dark-bg p-4 md:p-8 relative" id="main-content">
                <div class="flex flex-col items-center justify-center h-full text-center text-dark-muted">
                    <i class="fas fa-rocket text-6xl mb-4 text-brand-primary opacity-50"></i>
                    <h2 class="text-2xl font-bold text-white mb-2">í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                    <p>ì™¼ìª½ ë©”ë‰´ì—ì„œ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                </div>
            </main>

            <div id="status-bar"
                class="absolute bottom-4 right-8 bg-dark-card border border-dark-border px-3 py-1 rounded-full text-xs text-dark-muted opacity-0 transition-opacity duration-500 pointer-events-none">
                <i class="fas fa-sync fa-spin mr-1"></i> ë™ê¸°í™” ì¤‘...
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm">
        <div class="bg-dark-sidebar w-full max-w-2xl rounded-xl shadow-2xl border border-dark-border transform transition-all scale-95 opacity-0"
            id="settings-modal-content">
            <div class="flex justify-between items-center p-6 border-b border-dark-border">
                <h2 class="text-xl font-bold text-white"><i class="fas fa-key mr-2 text-brand-primary"></i>í†µí•© ì„¤ì •</h2>
                <div class="flex gap-2">
                    <span id="auth-status"
                        class="text-xs px-2 py-1 rounded bg-green-900 text-green-300 border border-green-700">ìµëª…
                        ë¡œê·¸ì¸ë¨</span>
                    <button onclick="app.closeSettings()" class="text-gray-400 hover:text-white transition-colors"><i
                            class="fas fa-times text-xl"></i></button>
                </div>
            </div>

            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-white mb-4 border-l-4 border-brand-primary pl-3">API í‚¤ ê´€ë¦¬</h3>
                    <p class="text-sm text-dark-muted mb-4">ëª¨ë“  ê¸°ëŠ¥ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•  API í‚¤ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. í‚¤ë¥¼ í™œì„±í™”/ë¹„í™œì„±í™”í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                    <div class="space-y-4" id="api-keys-list"></div>
                    <div class="mt-4 pt-4 border-t border-dark-border space-y-3">
                        <div class="flex gap-3">
                            <select id="new-key-type"
                                class="bg-dark-card border border-dark-border text-white text-sm rounded-lg p-2.5 focus:ring-brand-primary focus:border-brand-primary w-1/3">
                                <option value="youtube">Youtube API</option>
                                <option value="gemini">Gemini API</option>
                                <option value="translate">Translate API</option>
                            </select>
                            <input type="text" id="new-key-name"
                                class="bg-dark-card border border-dark-border text-white text-sm rounded-lg p-2.5 focus:ring-brand-primary focus:border-brand-primary flex-1"
                                placeholder="í‚¤ ì´ë¦„ (ì˜ˆ: ë©”ì¸ ê³„ì •)">
                        </div>
                        <div class="flex gap-3">
                            <input type="text" id="new-key-value"
                                class="bg-dark-card border border-dark-border text-white text-sm rounded-lg p-2.5 focus:ring-brand-primary focus:border-brand-primary flex-1"
                                placeholder="API í‚¤ ê°’ (sk-...)">
                            <button id="save-key-btn" onclick="app.addApiKey()"
                                class="bg-brand-primary hover:bg-brand-hover text-white font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors whitespace-nowrap"
                                style="min-width: 80px;">ì¶”ê°€</button>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4 border-l-4 border-blue-500 pl-3">ë°ì´í„° ê´€ë¦¬</h3>
                    <div class="bg-dark-card p-4 rounded-lg border border-dark-border">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-300">ì´ ì €ì¥ëœ ë°ì´í„°:</span>
                            <span class="text-sm font-mono text-brand-primary" id="total-data-count">-</span>
                        </div>
                        <p class="text-xs text-dark-muted">ëª¨ë“  ë°ì´í„°ëŠ” 'global_data' ì»¬ë ‰ì…˜ì— í†µí•© ê´€ë¦¬ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // --- CONFIG ---
        const MASTER_DOC_ID = 'master_settings';
        const DATA_COLLECTION = 'global_data';

        const MODULES = [
            { id: 'home', name: 'í™ˆ', icon: 'fas fa-home' },
            { id: 'keyword', name: 'í‚¤ì›Œë“œ ê²€ìƒ‰', icon: 'fas fa-search' },
            { id: 'channel', name: 'ì±„ë„ ë¶„ì„', icon: 'fas fa-tv' },
            { id: 'analysis', name: 'ì˜ìƒ ë¶„ì„', icon: 'fas fa-chart-line' },
            { id: 'comment', name: 'ëŒ“ê¸€ ë¶„ì„', icon: 'fas fa-comments' },
            { id: 'estimate', name: 'ìˆ˜ìµ ì˜ˆì¸¡', icon: 'fas fa-coins' },
        ];

        // --- APP CORE ---
        const app = {
            db: null,
            state: {
                apiKeys: [],
                currentModule: null
            },

            async init() {
                await this.initFirebase();
                this.renderSidebar();
                this.setupEventListeners();
                this.listenToSettings();
            },

            async initFirebase() {
                try {
                    const r = await fetch('firebase-config.json');
                    if (!r.ok) throw new Error("No config");
                    const config = await r.json();
                    firebase.initializeApp(config);
                    this.db = firebase.firestore();
                    await firebase.auth().signInAnonymously();
                    console.log("Firebase Connected");
                    document.getElementById('auth-status').innerText = "Ver: Single User Mode";
                } catch (e) {
                    console.error("Firebase Init Fail", e);
                    alert("Firebase ì„¤ì • ë¡œë“œ ì‹¤íŒ¨. firebase-config.jsonì„ í™•ì¸í•˜ì„¸ìš”.");
                }
            },

            renderSidebar() {
                const mkItem = (m) => `
                    <li>
                        <button onclick="app.loadModule('${m.id}')" id="btn-${m.id}" class="flex items-center w-full px-4 py-3 text-sm font-medium text-dark-muted hover:bg-dark-hover hover:text-white rounded-lg transition-colors group">
                            <i class="${m.icon} w-5 h-5 mr-3 text-gray-500 group-hover:text-brand-primary transition-colors"></i> 
                            ${m.name}
                        </button>
                    </li>
                `;
                const html = MODULES.map(mkItem).join('');
                document.getElementById('desktop-menu').innerHTML = html;
                document.getElementById('mobile-menu-list').innerHTML = html;
            },

            loadModule(id) {
                document.querySelectorAll('nav button').forEach(b => {
                    b.classList.remove('bg-dark-hover', 'text-white');
                    b.querySelector('i').classList.remove('text-brand-primary');
                });
                const btns = document.querySelectorAll(`#btn-${id}`);
                btns.forEach(b => {
                    b.classList.add('bg-dark-hover', 'text-white');
                    b.querySelector('i').classList.add('text-brand-primary');
                });

                document.getElementById('mobile-sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-menu-overlay').classList.add('hidden');

                const main = document.getElementById('main-content');
                this.state.currentModule = id;

                if (id === 'home') {
                    main.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center text-dark-muted">
                            <i class="fas fa-rocket text-6xl mb-4 text-brand-primary opacity-50"></i>
                            <h2 class="text-2xl font-bold text-white mb-2">í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                            <p>ëª¨ë“  ìœ íŠœë¸Œ ë¶„ì„ ë„êµ¬ê°€ ì´ê³³ì— í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        </div>`;
                    return;
                }

                if (id === 'keyword') {
                    keywordModule.render(main);
                    keywordModule.init();
                    return;
                }

                main.innerHTML = `
                    <div class="animate-pulse flex flex-col items-center justify-center h-full">
                        <div class="text-xl text-white mb-4"><i class="fas fa-spinner fa-spin mr-2"></i> ${MODULES.find(m => m.id === id).name} ë¡œë”© ì¤‘...</div>
                        <p class="text-sm text-dark-muted">ì´ ëª¨ë“ˆì€ ì•„ì§ í†µí•© ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
                    </div>
                `;
            },

            getApiKey(type) {
                const keys = this.state.apiKeys.filter(k => k.type === type && k.active !== false);
                if (keys.length === 0) return null;
                return keys[Math.floor(Math.random() * keys.length)].key;
            },

            listenToSettings() {
                if (!this.db) return;
                this.db.collection(DATA_COLLECTION).doc(MASTER_DOC_ID)
                    .onSnapshot(doc => {
                        this.showStatus("ë™ê¸°í™” ì™„ë£Œ");
                        if (doc.exists) {
                            const d = doc.data();
                            this.state.apiKeys = d.apiKeys || [];
                            this.renderApiKeys();
                        } else {
                            this.db.collection(DATA_COLLECTION).doc(MASTER_DOC_ID).set({
                                createdAt: new Date().toISOString(),
                                apiKeys: []
                            });
                        }
                    });
            },

            renderApiKeys() {
                const list = document.getElementById('api-keys-list');
                if (this.state.apiKeys.length === 0) {
                    list.innerHTML = `<div class="text-center text-sm text-dark-muted py-4">ë“±ë¡ëœ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    return;
                }
                list.innerHTML = this.state.apiKeys.map((k, idx) => {
                    const isActive = k.active !== false;
                    const opacityClass = isActive ? '' : 'opacity-50';
                    const activeColor = isActive ? 'text-green-400' : 'text-gray-500';
                    const activeText = isActive ? 'ì‚¬ìš© ì¤‘' : 'ë¹„í™œì„±';
                    return `
                    <div class="flex flex-col md:flex-row items-center justify-between bg-dark-bg p-3 rounded border border-dark-border gap-3 ${opacityClass} transition-all">
                        <div class="flex items-center gap-3 overflow-hidden flex-1 w-full">
                            <span class="text-xs font-bold px-2 py-1 rounded bg-gray-800 text-gray-300 uppercase w-20 text-center flex-shrink-0">${k.type}</span>
                            <div class="flex flex-col min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-white font-bold truncate">${k.name || 'API Key'}</span>
                                    <span class="text-[10px] ${activeColor} border border-gray-700 px-1 rounded">${activeText}</span>
                                </div>
                                <span class="text-xs text-dark-muted font-mono truncate">
                                    ${k.key.substring(0, 10)}...${k.key.substring(k.key.length - 4)}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 w-full md:w-auto justify-end">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" onchange="app.toggleKey('${k.key}')" ${isActive ? 'checked' : ''}>
                                <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-brand-primary"></div>
                            </label>
                            <button onclick="app.prepEditKey('${k.key}')" class="text-dark-muted hover:text-blue-400 transition-colors p-2" title="ìˆ˜ì •">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button onclick="app.removeApiKey('${k.key}')" class="text-dark-muted hover:text-red-500 transition-colors p-2" title="ì‚­ì œ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `}).join('');
            },

            prepEditKey(keyVal) {
                const k = this.state.apiKeys.find(key => key.key === keyVal);
                if (!k) return;
                document.getElementById('new-key-type').value = k.type;
                document.getElementById('new-key-value').value = k.key;
                document.getElementById('new-key-name').value = k.name || '';

                const saveBtn = document.getElementById('save-key-btn');
                saveBtn.innerText = "ìˆ˜ì • ì €ì¥";
                saveBtn.onclick = () => app.updateKeyContent(keyVal);
                saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                saveBtn.classList.remove('bg-brand-primary', 'hover:bg-brand-hover');
                document.getElementById('new-key-value').focus();
            },

            async addApiKey() {
                const type = document.getElementById('new-key-type').value;
                const key = document.getElementById('new-key-value').value.trim();
                const nameInput = document.getElementById('new-key-name').value.trim();
                const name = nameInput || "ìƒˆ API í‚¤";

                if (!key) return alert("í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                if (this.state.apiKeys.find(k => k.key === key)) return alert("ì´ë¯¸ ë“±ë¡ëœ í‚¤ì…ë‹ˆë‹¤.");

                const newKeys = [...this.state.apiKeys, { type, key, name, active: true, addedAt: Date.now() }];
                this.saveKeys(newKeys, "í‚¤ ì¶”ê°€ë¨");
                this.resetForm();
            },

            async updateKeyContent(oldKeyVal) {
                const type = document.getElementById('new-key-type').value;
                const newKeyVal = document.getElementById('new-key-value').value.trim();
                const name = document.getElementById('new-key-name').value.trim() || "API Key";

                if (!newKeyVal) return alert("í‚¤ ê°’ì€ ë¹„ì–´ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                if (oldKeyVal !== newKeyVal && this.state.apiKeys.find(k => k.key === newKeyVal)) return alert("ë³€ê²½ëœ í‚¤ ê°’ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.");

                const newKeys = this.state.apiKeys.map(k => {
                    if (k.key === oldKeyVal) return { ...k, type, name, key: newKeyVal };
                    return k;
                });
                await this.saveKeys(newKeys, "í‚¤ ìˆ˜ì •ë¨");
                this.resetForm();
            },

            async toggleKey(keyVal) {
                const k = this.state.apiKeys.find(key => key.key === keyVal);
                if (!k) return;
                const newStatus = !(k.active !== false);
                const newKeys = this.state.apiKeys.map(item => item.key === keyVal ? { ...item, active: newStatus } : item);
                await this.saveKeys(newKeys, newStatus ? "í‚¤ í™œì„±í™”ë¨" : "í‚¤ ë¹„í™œì„±í™”ë¨");
            },

            async removeApiKey(keyVal) {
                if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                const newKeys = this.state.apiKeys.filter(k => k.key !== keyVal);
                await this.saveKeys(newKeys, "í‚¤ ì‚­ì œë¨");
            },

            async saveKeys(newKeys, msg) {
                try {
                    await this.db.collection(DATA_COLLECTION).doc(MASTER_DOC_ID).set({ apiKeys: newKeys }, { merge: true });
                    this.showStatus(msg);
                } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
            },

            resetForm() {
                document.getElementById('new-key-value').value = '';
                document.getElementById('new-key-name').value = '';
                const btn = document.getElementById('save-key-btn');
                btn.innerText = "ì¶”ê°€";
                btn.onclick = () => app.addApiKey();
                btn.classList.add('bg-brand-primary', 'hover:bg-brand-hover');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            },

            toggleMobileMenu() {
                const sb = document.getElementById('mobile-sidebar');
                const overlay = document.getElementById('mobile-menu-overlay');
                if (sb.classList.contains('-translate-x-full')) {
                    sb.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sb.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            },
            openSettings() {
                const m = document.getElementById('settings-modal');
                const c = document.getElementById('settings-modal-content');
                m.classList.remove('hidden');
                setTimeout(() => { c.classList.remove('scale-95', 'opacity-0'); c.classList.add('scale-100', 'opacity-100'); }, 10);
            },
            closeSettings() {
                const m = document.getElementById('settings-modal');
                const c = document.getElementById('settings-modal-content');
                c.classList.remove('scale-100', 'opacity-100');
                c.classList.add('scale-95', 'opacity-0');
                setTimeout(() => m.classList.add('hidden'), 300);
            },
            setupEventListeners() {
                document.getElementById('settings-modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('settings-modal')) this.closeSettings();
                });
            },
            showStatus(msg) {
                const el = document.getElementById('status-bar');
                el.innerHTML = `<i class="fas fa-check mr-1"></i> ${msg}`;
                el.classList.remove('opacity-0');
                setTimeout(() => el.classList.add('opacity-0'), 2000);
            }
        };

        // --- KEYWORD MODULE ---
        const keywordModule = {
            CATS: ["ì˜í™”/ì• ë‹ˆë©”ì´ì…˜", "ìë™ì°¨/êµí†µ", "ìŒì•…", "ì• ì™„ë™ë¬¼/ë™ë¬¼", "ìŠ¤í¬ì¸ ", "ê²Œì„", "ì½”ë¯¸ë””", "ì—”í„°í…Œì¸ë¨¼íŠ¸", "ë‰´ìŠ¤/ì •ì¹˜", "ë…¸í•˜ìš°/ìŠ¤íƒ€ì¼", "êµìœ¡", "ê³¼í•™/ê¸°ìˆ ", "ì¸ë¬¼/ë¸”ë¡œê·¸", "ë¹„ì˜ë¦¬/ì‚¬íšŒìš´ë™", "ì—¬í–‰/ì´ë²¤íŠ¸"],
            CAT_IDS: { "ì˜í™”/ì• ë‹ˆë©”ì´ì…˜": "1", "ìë™ì°¨/êµí†µ": "2", "ìŒì•…": "10", "ì• ì™„ë™ë¬¼/ë™ë¬¼": "15", "ìŠ¤í¬ì¸ ": "17", "ì—¬í–‰/ì´ë²¤íŠ¸": "19", "ê²Œì„": "20", "ì¸ë¬¼/ë¸”ë¡œê·¸": "22", "ì½”ë¯¸ë””": "23", "ì—”í„°í…Œì¸ë¨¼íŠ¸": "24", "ë‰´ìŠ¤/ì •ì¹˜": "25", "ë…¸í•˜ìš°/ìŠ¤íƒ€ì¼": "26", "êµìœ¡": "27", "ê³¼í•™/ê¸°ìˆ ": "28", "ë¹„ì˜ë¦¬/ì‚¬íšŒìš´ë™": "29" },
            currentResults: [],
            sortKey: null,
            sortAsc: true,

            render(container) {
                container.innerHTML = `
                    <div class="max-w-7xl mx-auto space-y-8">
                        <div class="text-center space-y-2">
                             <h2 class="text-2xl font-bold text-white"><span class="text-brand-primary">â—</span> YouTube ë‹¤êµ­ì–´ í‚¤ì›Œë“œ ê²€ìƒ‰ê¸°</h2>
                             <p class="text-dark-muted">ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ 100ê°œì˜ ì„¸ë¶€ ì£¼ì œ ë° í‚¤ì›Œë“œë¥¼ 7ê°œ ì–¸ì–´ë¡œ ë²ˆì—­í•©ë‹ˆë‹¤.</p>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-white font-bold"><i class="fas fa-filter text-brand-primary"></i> ì¹´í…Œê³ ë¦¬ ì„ íƒ</div>
                            <div class="flex flex-wrap gap-2 justify-center" id="kw-categories"></div>
                        </div>
                        <div class="bg-dark-card p-6 rounded-xl border border-dark-border space-y-6">
                            <div class="flex flex-wrap justify-center gap-4 items-center text-sm text-dark-muted">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-calendar"></i> ê¸°ì¤€ì¼:
                                    <input type="date" id="kw-date" class="bg-dark-bg border border-dark-border rounded px-2 py-1 text-white focus:border-brand-primary outline-none">
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-globe"></i> êµ­ê°€:
                                    <select id="kw-country" class="bg-dark-bg border border-dark-border rounded px-2 py-1 text-white focus:border-brand-primary outline-none"></select>
                                </div>
                                <span class="text-xs text-gray-600">(ê³¼ê±° ë‚ ì§œ ì¡°íšŒ ì‹œ API ì†Œëª¨ëŸ‰ â†‘)</span>
                            </div>
                            <div class="flex justify-center">
                                <div class="flex w-full max-w-2xl border-2 border-brand-primary rounded-lg overflow-hidden transition-shadow focus-within:ring-2 focus-within:ring-red-900">
                                    <input type="text" id="kw-input" placeholder="í‚¤ì›Œë“œ ì…ë ¥ (ì˜ˆ: ë¨¹ë°©)" class="flex-1 bg-transparent border-none px-4 py-3 text-white placeholder-gray-600 focus:outline-none text-lg">
                                    <button onclick="keywordModule.search()" class="bg-brand-primary hover:bg-brand-hover text-white px-8 font-bold transition-colors">ê²€ìƒ‰</button>
                                </div>
                            </div>
                        </div>
                         <div class="bg-dark-card rounded-xl border border-dark-border overflow-hidden min-h-[400px] flex flex-col">
                            <div class="p-4 border-b border-dark-border flex justify-between items-center">
                                <h3 class="font-bold text-white"><i class="fas fa-list text-brand-primary mr-2"></i>í‚¤ì›Œë“œ ê²°ê³¼ (100ê°œ)</h3>
                                <div class="flex gap-2">
                                    <span id="kw-status" class="text-sm text-dark-muted self-center">ëŒ€ê¸° ì¤‘</span>
                                    <button onclick="keywordModule.downloadCSV()" id="kw-csv-btn" class="hidden bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded transition-colors"><i class="fas fa-file-csv mr-1"></i> CSV ì €ì¥</button>
                                </div>
                            </div>
                            
                            <!-- Top Scrollbar -->
                            <div id="kw-top-scroll" class="overflow-x-auto bg-dark-sidebar border-b border-dark-border relative" style="min-height: 12px;">
                                <div id="kw-top-scroll-content" class="h-1" style="width: 0px;"></div>
                            </div>

                            <div id="kw-table-container" class="overflow-x-auto flex-1">
                                <table id="kw-result-table" class="w-full text-sm text-left text-gray-400">
                                    <thead class="text-xs text-gray-200 uppercase bg-dark-sidebar sticky top-0 z-10">
                                        <tr>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('rank')">NO</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('channel')">ì±„ë„ëª…</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('subsRaw')">êµ¬ë…ì</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap min-w-[200px]" onclick="keywordModule.sort('korean')">ğŸ‡°ğŸ‡· ì˜ìƒì œëª©</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('views')">ì¡°íšŒìˆ˜</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('comments')">ëŒ“ê¸€</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('likes')">ì¢‹ì•„ìš”</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('date')">ê²Œì‹œì¼</th>
                                            <th class="px-4 py-3 whitespace-nowrap">ğŸ‡ºğŸ‡¸ ì˜ì–´</th>
                                            <th class="px-4 py-3 whitespace-nowrap">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</th>
                                            <th class="px-4 py-3 whitespace-nowrap">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ì–´</th>
                                            <th class="px-4 py-3 whitespace-nowrap">ğŸ‡ªğŸ‡¸ ìŠ¤í˜ì¸ì–´</th>
                                            <th class="px-4 py-3 whitespace-nowrap">ğŸ‡®ğŸ‡³ ì¸ë„ì–´</th>
                                            <th class="px-4 py-3 whitespace-nowrap">ğŸ‡·ğŸ‡º ëŸ¬ì‹œì•„ì–´</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kw-results-body"></tbody>
                                </table>
                            </div>
                         </div>
                    </div>
                `;
            },
            init() {
                const cBox = document.getElementById('kw-categories');
                cBox.innerHTML = this.CATS.map(c => `<span onclick="keywordModule.selectCat(this, '${c}')" class="category-pill px-4 py-2 rounded-full bg-dark-card hover:bg-dark-hover cursor-pointer border border-transparent hover:border-brand-primary text-sm text-gray-300 transition-all select-none">${c}</span>`).join('');
                document.getElementById('kw-date').valueAsDate = new Date();
                const COUNTRIES = { 'KR': 'ëŒ€í•œë¯¼êµ­', 'US': 'ë¯¸êµ­', 'GB': 'ì˜êµ­', 'JP': 'ì¼ë³¸', 'ES': 'ìŠ¤í˜ì¸', 'IN': 'ì¸ë„', 'RU': 'ëŸ¬ì‹œì•„', 'TW': 'ëŒ€ë§Œ', 'HK': 'í™ì½©', 'ID': 'ì¸ë„ë„¤ì‹œì•„' };
                const cSelect = document.getElementById('kw-country');
                cSelect.innerHTML = Object.entries(COUNTRIES).map(([code, name]) => `<option value="${code}" ${code === 'KR' ? 'selected' : ''}>${name}</option>`).join('');
                document.getElementById('kw-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') this.search(); });

                const topScroll = document.getElementById('kw-top-scroll');
                const tableContainer = document.getElementById('kw-table-container');
                if (topScroll && tableContainer) {
                    topScroll.onscroll = () => { tableContainer.scrollLeft = topScroll.scrollLeft; };
                    tableContainer.onscroll = () => { topScroll.scrollLeft = tableContainer.scrollLeft; };
                }
            },
            selectCat(el, cat) {
                document.querySelectorAll('#kw-categories .category-pill').forEach(b => {
                    b.classList.remove('bg-gray-700', 'text-white', 'border-brand-primary');
                    b.classList.add('bg-dark-card', 'text-gray-300');
                });
                el.classList.remove('bg-dark-card', 'text-gray-300');
                el.classList.add('bg-gray-700', 'text-white', 'border-brand-primary');
                this.search(null, cat);
            },
            async search(queryOverride = null, catOverride = null) {
                const q = queryOverride !== null ? queryOverride : document.getElementById('kw-input').value;
                let cat = catOverride;
                if (!cat) {
                    const activePill = document.querySelector('#kw-categories .category-pill.bg-gray-700');
                    if (activePill) cat = activePill.innerText;
                    else cat = "ì—”í„°í…Œì¸ë¨¼íŠ¸";
                }
                const msg = document.getElementById('kw-status');
                const k = app.getApiKey('youtube');
                const tk = app.getApiKey('translate');
                if (!k) return alert("ì„¤ì •ì—ì„œ YouTube API í‚¤ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.");

                msg.innerText = "ë°ì´í„° ìš”ì²­ ì¤‘...";
                msg.className = "text-sm text-brand-primary animate-pulse";
                const dateVal = document.getElementById('kw-date').value;
                const region = document.getElementById('kw-country').value;
                const isToday = (dateVal === new Date().toISOString().split('T')[0]);
                try {
                    let videoIds = [];
                    if (q || !isToday) {
                        let params = `search?part=id&type=video&maxResults=50&key=${k}&regionCode=${region}`;
                        if (q) params += `&q=${encodeURIComponent(q)}`;
                        if (!isToday) {
                            const start = new Date(dateVal + "T00:00:00Z").toISOString();
                            const end = new Date(dateVal + "T23:59:59Z").toISOString();
                            params += `&publishedAfter=${start}&publishedBefore=${end}&order=viewCount`;
                        }
                        if (!q && cat) {
                            params += `&videoCategoryId=${this.CAT_IDS[cat]}`;
                            if (isToday) params += `&order=viewCount`;
                        }
                        const r1 = await this.fetchYT(params);
                        videoIds = r1.items.map(i => i.id.videoId);
                        if (r1.nextPageToken) {
                            const r2 = await this.fetchYT(`${params}&pageToken=${r1.nextPageToken}`);
                            videoIds = [...videoIds, ...r2.items.map(i => i.id.videoId)];
                        }
                    } else {
                        const cid = this.CAT_IDS[cat];
                        try {
                            const r1 = await this.fetchYT(`videos?part=id&chart=mostPopular&regionCode=${region}&videoCategoryId=${cid}&maxResults=50&key=${k}`);
                            videoIds = r1.items.map(i => i.id);
                            if (r1.nextPageToken) {
                                const r2 = await this.fetchYT(`videos?part=id&chart=mostPopular&regionCode=${region}&videoCategoryId=${cid}&pageToken=${r1.nextPageToken}&maxResults=50&key=${k}`);
                                videoIds = [...videoIds, ...r2.items.map(i => i.id)];
                            }
                        } catch {
                            const r1 = await this.fetchYT(`search?part=id&q=${encodeURIComponent(cat)}&type=video&maxResults=50&key=${k}`);
                            videoIds = r1.items.map(i => i.id.videoId);
                        }
                    }
                    const uniqueIds = [...new Set(videoIds)].slice(0, 100);
                    let finalItems = [];
                    for (let i = 0; i < uniqueIds.length; i += 50) {
                        const chunk = uniqueIds.slice(i, i + 50).join(',');
                        const r = await this.fetchYT(`videos?part=snippet,statistics&id=${chunk}&key=${k}`);
                        finalItems = [...finalItems, ...r.items];
                    }
                    const channelIds = [...new Set(finalItems.map(i => i.snippet.channelId))];
                    const channelStats = {};
                    for (let i = 0; i < channelIds.length; i += 50) {
                        const chunk = channelIds.slice(i, i + 50).join(',');
                        try {
                            const r = await this.fetchYT(`channels?part=statistics&id=${chunk}&key=${k}`);
                            r.items.forEach(ch => { channelStats[ch.id] = ch.statistics.subscriberCount; });
                        } catch (e) { console.error(e); }
                    }
                    const titles = finalItems.map(i => i.snippet.title);
                    let trans = { en: [], ja: [], 'zh-CN': [], es: [], hi: [], ru: [] };
                    if (tk) {
                        msg.innerText = "ë²ˆì—­ API í˜¸ì¶œ ì¤‘...";
                        trans = await this.doTrans(titles, tk);
                    }
                    this.currentResults = finalItems.map((item, i) => {
                        const s = item.snippet;
                        const st = item.statistics || {};
                        const subCount = channelStats[s.channelId] || 0;
                        return {
                            rank: i + 1,
                            korean: s.title,
                            id: item.id,
                            channel: s.channelTitle,
                            channelId: s.channelId,
                            subsRaw: Number(subCount),
                            subs: Number(subCount).toLocaleString(),
                            views: Number(st.viewCount || 0).toLocaleString(),
                            comments: Number(st.commentCount || 0).toLocaleString(),
                            likes: Number(st.likeCount || 0).toLocaleString(),
                            date: (s.publishedAt || "").split('T')[0],
                            english: trans.en[i] || '-', japanese: trans.ja[i] || '-',
                            chinese: trans['zh-CN'][i] || '-', spanish: trans.es[i] || '-',
                            hindi: trans.hi[i] || '-', russian: trans.ru[i] || '-'
                        };
                    });
                    this.updateUI();
                    msg.innerText = `ì™„ë£Œ (${finalItems.length}ê°œ)`;
                    msg.className = "text-sm text-green-500 font-bold";
                } catch (e) {
                    msg.innerText = "ì˜¤ë¥˜: " + e.message;
                    msg.className = "text-sm text-red-500 font-bold";
                    alert("API ì˜¤ë¥˜: " + e.message);
                }
            },
            async fetchYT(path) {
                const r = await fetch(`https://www.googleapis.com/youtube/v3/${path}`);
                if (!r.ok) throw new Error("YouTube API Error");
                return r.json();
            },
            async doTrans(txs, k) {
                const out = {};
                const langs = ['en', 'ja', 'zh-CN', 'es', 'hi', 'ru'];
                await Promise.all(langs.map(async l => {
                    try {
                        const r = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${k}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ q: txs, target: l, format: 'text' })
                        });
                        const d = await r.json();
                        out[l] = d.data.translations.map(t => t.translatedText);
                    } catch { out[l] = Array(txs.length).fill('-'); }
                }));
                return out;
            },
            updateUI() {
                const tbody = document.getElementById('kw-results-body');
                if (!tbody) return;

                const table = document.getElementById('kw-result-table');
                const topScrollContent = document.getElementById('kw-top-scroll-content');
                if (table && topScrollContent) {
                    // Update scrollbar width logic
                    const updateWidth = () => {
                        topScrollContent.style.width = table.scrollWidth + 'px';
                    }
                    updateWidth();
                    setTimeout(updateWidth, 100); // Retry slightly later for render
                }

                tbody.innerHTML = this.currentResults.map(r => `
                    <tr class="border-b border-dark-border hover:bg-dark-card transition-colors">
                        <td class="px-4 py-3 text-center text-dark-muted">${r.rank}</td>
                        <td class="px-4 py-3"><a href="https://www.youtube.com/channel/${r.channelId}" target="_blank" class="hover:text-white hover:underline transition-colors">${r.channel}</a></td>
                        <td class="px-4 py-3 text-dark-muted">${r.subs}</td>
                        <td class="px-4 py-3 min-w-[300px]"><a href="https://www.youtube.com/watch?v=${r.id}" target="_blank" class="text-white hover:text-brand-primary font-medium hover:underline transition-colors block truncate w-full">${r.korean}</a></td>
                        <td class="px-4 py-3 text-right font-mono text-gray-300">${r.views}</td>
                        <td class="px-4 py-3 text-right font-mono text-dark-muted">${r.comments}</td>
                        <td class="px-4 py-3 text-right font-mono text-dark-muted">${r.likes}</td>
                        <td class="px-4 py-3 text-dark-muted whitespace-nowrap">${r.date}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.english}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.japanese}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.chinese}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.spanish}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.hindi}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.russian}</td>
                    </tr>`).join('');
                document.getElementById('kw-csv-btn').classList.remove('hidden');
            },
            sort(key) {
                if (this.sortKey === key) this.sortAsc = !this.sortAsc;
                else { this.sortKey = key; this.sortAsc = true; }
                this.currentResults.sort((a, b) => {
                    let va = a[key], vb = b[key];
                    if (['views', 'comments', 'likes', 'subsRaw', 'rank'].includes(key)) { va = Number(String(va).replace(/,/g, '')) || 0; vb = Number(String(vb).replace(/,/g, '')) || 0; }
                    if (va < vb) return this.sortAsc ? -1 : 1;
                    if (va > vb) return this.sortAsc ? 1 : -1;
                    return 0;
                });
                this.updateUI();
            },
            downloadCSV() {
                if (!this.currentResults.length) return alert("ë°ì´í„° ì—†ìŒ");
                const BOM = "\uFEFF";
                let csv = BOM + "Rank,Channel,Subscribers,Title,Views,Comments,Likes,Date,English,Japanese,Chinese,Spanish,Hindi,Russian,Video Link,Channel Link\n";
                this.currentResults.forEach(r => {
                    const vLink = `https://www.youtube.com/watch?v=${r.id}`;
                    const cLink = `https://www.youtube.com/channel/${r.channelId}`;
                    csv += `${r.rank},"${r.channel.replace(/"/g, '""')}",${r.subsRaw},"${r.korean.replace(/"/g, '""')}",${r.views.replace(/,/g, '')},${r.comments.replace(/,/g, '')},${r.likes.replace(/,/g, '')},${r.date},"${r.english}","${r.japanese}","${r.chinese}","${r.spanish}","${r.hindi}","${r.russian}","${vLink}","${cLink}"\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `youtube_keywords_${new Date().toISOString().slice(0, 10)}.csv`;
                a.click();
            }
        };
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>

</html>