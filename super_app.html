<!DOCTYPE html>
<html lang="ko" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super App: All-in-One Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#121212',
                            sidebar: '#1e1e1e',
                            card: '#252525',
                            border: '#333333',
                            hover: '#3a3a3a',
                            text: '#e0e0e0',
                            muted: '#a0a0a0'
                        },
                        brand: {
                            primary: '#ef4444',
                            hover: '#dc2626'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .content-area-height {
            height: calc(100vh - 64px);
        }

        @media (max-width: 768px) {
            .content-area-height {
                height: calc(100vh - 56px);
            }
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-dark-bg text-dark-text overflow-hidden">

    <div class="flex h-screen w-full">
        <!-- Sidebar (Desktop) -->
        <aside
            class="hidden md:flex flex-col w-64 bg-dark-sidebar border-r border-dark-border transition-all duration-300">
            <div class="flex items-center justify-center h-16 border-b border-dark-border">
                <h1 class="text-xl font-bold text-brand-primary"><i class="fab fa-youtube mr-2"></i>Super Tool</h1>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1 px-2" id="desktop-menu"></ul>
            </nav>
            <div class="border-t border-dark-border p-4">
                <button onclick="app.openSettings()"
                    class="flex items-center w-full px-4 py-3 text-sm font-medium text-dark-muted hover:bg-dark-hover hover:text-white rounded-lg transition-colors">
                    <i class="fas fa-cog w-5 h-5 mr-3"></i> API 설정
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
            <header
                class="md:hidden flex items-center justify-between h-14 bg-dark-sidebar border-b border-dark-border px-4 z-20">
                <h1 class="text-lg font-bold text-brand-primary">Super Tool</h1>
                <button onclick="app.toggleMobileMenu()" class="text-white focus:outline-none">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </header>

            <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"
                onclick="app.toggleMobileMenu()"></div>
            <div id="mobile-sidebar"
                class="fixed inset-y-0 left-0 w-64 bg-dark-sidebar border-r border-dark-border z-40 transform -translate-x-full transition-transform duration-300 md:hidden">
                <div class="flex items-center justify-between h-14 border-b border-dark-border px-4">
                    <h1 class="text-lg font-bold text-white">메뉴</h1>
                    <button onclick="app.toggleMobileMenu()" class="text-gray-400 hover:text-white"><i
                            class="fas fa-times"></i></button>
                </div>
                <nav class="flex-1 overflow-y-auto py-4">
                    <ul class="space-y-1 px-2" id="mobile-menu-list"></ul>
                </nav>
                <div class="border-t border-dark-border p-4">
                    <button onclick="app.openSettings(); app.toggleMobileMenu();"
                        class="flex items-center w-full px-4 py-3 text-sm font-medium text-dark-muted hover:bg-dark-hover hover:text-white rounded-lg transition-colors">
                        <i class="fas fa-cog w-5 h-5 mr-3"></i> API 설정
                    </button>
                </div>
            </div>

            <main class="flex-1 overflow-auto bg-dark-bg p-4 md:p-8 relative" id="main-content">
                <div class="flex flex-col items-center justify-center h-full text-center text-dark-muted">
                    <i class="fas fa-rocket text-6xl mb-4 text-brand-primary opacity-50"></i>
                    <h2 class="text-2xl font-bold text-white mb-2">환영합니다!</h2>
                    <p>왼쪽 메뉴에서 원하는 기능을 선택하세요.</p>
                </div>
            </main>

            <div id="status-bar"
                class="absolute bottom-4 right-8 bg-dark-card border border-dark-border px-3 py-1 rounded-full text-xs text-dark-muted opacity-0 transition-opacity duration-500 pointer-events-none">
                <i class="fas fa-sync fa-spin mr-1"></i> 동기화 중...
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm">
        <div class="bg-dark-sidebar w-full max-w-2xl rounded-xl shadow-2xl border border-dark-border transform transition-all scale-95 opacity-0"
            id="settings-modal-content">
            <div class="flex justify-between items-center p-6 border-b border-dark-border">
                <h2 class="text-xl font-bold text-white"><i class="fas fa-key mr-2 text-brand-primary"></i>통합 설정</h2>
                <div class="flex gap-2">
                    <span id="auth-status"
                        class="text-xs px-2 py-1 rounded bg-green-900 text-green-300 border border-green-700">익명
                        로그인됨</span>
                    <button onclick="app.closeSettings()" class="text-gray-400 hover:text-white transition-colors"><i
                            class="fas fa-times text-xl"></i></button>
                </div>
            </div>

            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-white mb-4 border-l-4 border-brand-primary pl-3">API 키 관리</h3>
                    <p class="text-sm text-dark-muted mb-4">모든 기능에서 공통으로 사용할 API 키를 관리합니다. 키를 활성화/비활성화하거나 수정할 수 있습니다.
                    </p>
                    <div class="space-y-4" id="api-keys-list"></div>
                    <div class="mt-4 pt-4 border-t border-dark-border space-y-3">
                        <div class="flex gap-3">
                            <select id="new-key-type"
                                class="bg-dark-card border border-dark-border text-white text-sm rounded-lg p-2.5 focus:ring-brand-primary focus:border-brand-primary w-1/3">
                                <option value="youtube">Youtube API</option>
                                <option value="gemini">Gemini API</option>
                                <option value="translate">Translate API</option>
                            </select>
                            <input type="text" id="new-key-name"
                                class="bg-dark-card border border-dark-border text-white text-sm rounded-lg p-2.5 focus:ring-brand-primary focus:border-brand-primary flex-1"
                                placeholder="키 이름 (예: 메인 계정)">
                        </div>
                        <div class="flex gap-3">
                            <input type="text" id="new-key-value"
                                class="bg-dark-card border border-dark-border text-white text-sm rounded-lg p-2.5 focus:ring-brand-primary focus:border-brand-primary flex-1"
                                placeholder="API 키 값 (sk-...)">
                            <button id="save-key-btn" onclick="app.addApiKey()"
                                class="bg-brand-primary hover:bg-brand-hover text-white font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors whitespace-nowrap"
                                style="min-width: 80px;">추가</button>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4 border-l-4 border-blue-500 pl-3">데이터 관리</h3>
                    <div class="bg-dark-card p-4 rounded-lg border border-dark-border">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-300">총 저장된 데이터:</span>
                            <span class="text-sm font-mono text-brand-primary" id="total-data-count">-</span>
                        </div>
                        <p class="text-xs text-dark-muted">모든 데이터는 'global_data' 컬렉션에 통합 관리됩니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // --- CONFIG ---
        const MASTER_DOC_ID = 'master_settings';
        const DATA_COLLECTION = 'global_data';

        const MODULES = [
            { id: 'home', name: '홈', icon: 'fas fa-home' },
            { id: 'keyword', name: '키워드 검색', icon: 'fas fa-search' },
            { id: 'channel', name: '채널 목록', icon: 'fas fa-tv' },
            { id: 'analysis', name: '영상 분석', icon: 'fas fa-chart-line' },
            { id: 'comment', name: '댓글 분석', icon: 'fas fa-comments' },
            { id: 'estimate', name: '수익 예측', icon: 'fas fa-coins' },
        ];

        // --- APP CORE ---
        const app = {
            db: null,
            state: {
                apiKeys: [],
                currentModule: null
            },

            async init() {
                this.appId = window.__app_id || 'default-app-id';
                await this.initFirebase();
                this.renderSidebar();
                this.setupEventListeners();
                this.listenToSettings();
            },

            async initFirebase() {
                try {
                    const r = await fetch('firebase-config.json');
                    if (!r.ok) throw new Error("No config");
                    const config = await r.json();
                    firebase.initializeApp(config);
                    this.db = firebase.firestore();
                    await firebase.auth().signInAnonymously();
                    console.log("Firebase Connected");
                    document.getElementById('auth-status').innerText = "Ver: Single User Mode";
                } catch (e) {
                    console.error("Firebase Init Fail", e);
                    alert("Firebase 설정 로드 실패. firebase-config.json을 확인하세요.");
                }
            },

            renderSidebar() {
                const mkItem = (m) => `
                    <li>
                        <button onclick="app.loadModule('${m.id}')" id="btn-${m.id}" class="flex items-center w-full px-4 py-3 text-sm font-medium text-dark-muted hover:bg-dark-hover hover:text-white rounded-lg transition-colors group">
                            <i class="${m.icon} w-5 h-5 mr-3 text-gray-500 group-hover:text-brand-primary transition-colors"></i> 
                            ${m.name}
                        </button>
                    </li>
                `;
                const html = MODULES.map(mkItem).join('');
                document.getElementById('desktop-menu').innerHTML = html;
                document.getElementById('mobile-menu-list').innerHTML = html;
            },

            loadModule(id) {
                document.querySelectorAll('nav button').forEach(b => {
                    b.classList.remove('bg-dark-hover', 'text-white');
                    b.querySelector('i').classList.remove('text-brand-primary');
                });
                const btns = document.querySelectorAll(`#btn-${id}`);
                btns.forEach(b => {
                    b.classList.add('bg-dark-hover', 'text-white');
                    b.querySelector('i').classList.add('text-brand-primary');
                });

                document.getElementById('mobile-sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-menu-overlay').classList.add('hidden');

                const main = document.getElementById('main-content');
                this.state.currentModule = id;

                if (id === 'home') {
                    main.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center text-dark-muted">
                            <i class="fas fa-rocket text-6xl mb-4 text-brand-primary opacity-50"></i>
                            <h2 class="text-2xl font-bold text-white mb-2">환영합니다!</h2>
                            <p>모든 유튜브 분석 도구가 이곳에 통합되었습니다.</p>
                        </div>`;
                    return;
                }


                if (id === 'keyword') {
                    keywordModule.render(main);
                    keywordModule.init();
                    return;
                }

                if (id === 'channel') {
                    channelModule.render(main);
                    channelModule.init();
                    return;
                }

                main.innerHTML = `
                    <div class="animate-pulse flex flex-col items-center justify-center h-full">
                        <div class="text-xl text-white mb-4"><i class="fas fa-spinner fa-spin mr-2"></i> ${MODULES.find(m => m.id === id).name} 로딩 중...</div>
                        <p class="text-sm text-dark-muted">이 모듈은 아직 통합 준비 중입니다.</p>
                    </div>
                `;
            },

            getApiKey(type) {
                const keys = this.state.apiKeys.filter(k => k.type === type && k.active !== false);
                if (keys.length === 0) return null;
                return keys[Math.floor(Math.random() * keys.length)].key;
            },

            listenToSettings() {
                if (!this.db) return;
                this.db.collection(DATA_COLLECTION).doc(MASTER_DOC_ID)
                    .onSnapshot(doc => {
                        this.showStatus("동기화 완료");
                        if (doc.exists) {
                            const d = doc.data();
                            this.state.apiKeys = d.apiKeys || [];
                            this.renderApiKeys();
                        } else {
                            this.db.collection(DATA_COLLECTION).doc(MASTER_DOC_ID).set({
                                createdAt: new Date().toISOString(),
                                apiKeys: []
                            });
                        }
                    });
            },

            renderApiKeys() {
                const list = document.getElementById('api-keys-list');
                if (this.state.apiKeys.length === 0) {
                    list.innerHTML = `<div class="text-center text-sm text-dark-muted py-4">등록된 키가 없습니다.</div>`;
                    return;
                }
                list.innerHTML = this.state.apiKeys.map((k, idx) => {
                    const isActive = k.active !== false;
                    const opacityClass = isActive ? '' : 'opacity-50';
                    const activeColor = isActive ? 'text-green-400' : 'text-gray-500';
                    const activeText = isActive ? '사용 중' : '비활성';
                    return `
                    <div class="flex flex-col md:flex-row items-center justify-between bg-dark-bg p-3 rounded border border-dark-border gap-3 ${opacityClass} transition-all">
                        <div class="flex items-center gap-3 overflow-hidden flex-1 w-full">
                            <span class="text-xs font-bold px-2 py-1 rounded bg-gray-800 text-gray-300 uppercase w-20 text-center flex-shrink-0">${k.type}</span>
                            <div class="flex flex-col min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-white font-bold truncate">${k.name || 'API Key'}</span>
                                    <span class="text-[10px] ${activeColor} border border-gray-700 px-1 rounded">${activeText}</span>
                                </div>
                                <span class="text-xs text-dark-muted font-mono truncate">
                                    ${k.key.substring(0, 10)}...${k.key.substring(k.key.length - 4)}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 w-full md:w-auto justify-end">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" onchange="app.toggleKey('${k.key}')" ${isActive ? 'checked' : ''}>
                                <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-brand-primary"></div>
                            </label>
                            <button onclick="app.prepEditKey('${k.key}')" class="text-dark-muted hover:text-blue-400 transition-colors p-2" title="수정">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button onclick="app.removeApiKey('${k.key}')" class="text-dark-muted hover:text-red-500 transition-colors p-2" title="삭제">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `}).join('');
            },

            prepEditKey(keyVal) {
                const k = this.state.apiKeys.find(key => key.key === keyVal);
                if (!k) return;
                document.getElementById('new-key-type').value = k.type;
                document.getElementById('new-key-value').value = k.key;
                document.getElementById('new-key-name').value = k.name || '';

                const saveBtn = document.getElementById('save-key-btn');
                saveBtn.innerText = "수정 저장";
                saveBtn.onclick = () => app.updateKeyContent(keyVal);
                saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                saveBtn.classList.remove('bg-brand-primary', 'hover:bg-brand-hover');
                document.getElementById('new-key-value').focus();
            },

            async addApiKey() {
                const type = document.getElementById('new-key-type').value;
                const key = document.getElementById('new-key-value').value.trim();
                const nameInput = document.getElementById('new-key-name').value.trim();
                const name = nameInput || "새 API 키";

                if (!key) return alert("키를 입력하세요.");
                if (this.state.apiKeys.find(k => k.key === key)) return alert("이미 등록된 키입니다.");

                const newKeys = [...this.state.apiKeys, { type, key, name, active: true, addedAt: Date.now() }];
                this.saveKeys(newKeys, "키 추가됨");
                this.resetForm();
            },

            async updateKeyContent(oldKeyVal) {
                const type = document.getElementById('new-key-type').value;
                const newKeyVal = document.getElementById('new-key-value').value.trim();
                const name = document.getElementById('new-key-name').value.trim() || "API Key";

                if (!newKeyVal) return alert("키 값은 비어있을 수 없습니다.");
                if (oldKeyVal !== newKeyVal && this.state.apiKeys.find(k => k.key === newKeyVal)) return alert("변경된 키 값이 이미 존재합니다.");

                const newKeys = this.state.apiKeys.map(k => {
                    if (k.key === oldKeyVal) return { ...k, type, name, key: newKeyVal };
                    return k;
                });
                await this.saveKeys(newKeys, "키 수정됨");
                this.resetForm();
            },

            async toggleKey(keyVal) {
                const k = this.state.apiKeys.find(key => key.key === keyVal);
                if (!k) return;
                const newStatus = !(k.active !== false);
                const newKeys = this.state.apiKeys.map(item => item.key === keyVal ? { ...item, active: newStatus } : item);
                await this.saveKeys(newKeys, newStatus ? "키 활성화됨" : "키 비활성화됨");
            },

            async removeApiKey(keyVal) {
                if (!confirm("삭제하시겠습니까?")) return;
                const newKeys = this.state.apiKeys.filter(k => k.key !== keyVal);
                await this.saveKeys(newKeys, "키 삭제됨");
            },

            async saveKeys(newKeys, msg) {
                try {
                    await this.db.collection(DATA_COLLECTION).doc(MASTER_DOC_ID).set({ apiKeys: newKeys }, { merge: true });
                    this.showStatus(msg);
                } catch (e) { alert("저장 실패"); }
            },

            resetForm() {
                document.getElementById('new-key-value').value = '';
                document.getElementById('new-key-name').value = '';
                const btn = document.getElementById('save-key-btn');
                btn.innerText = "추가";
                btn.onclick = () => app.addApiKey();
                btn.classList.add('bg-brand-primary', 'hover:bg-brand-hover');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            },

            toggleMobileMenu() {
                const sb = document.getElementById('mobile-sidebar');
                const overlay = document.getElementById('mobile-menu-overlay');
                if (sb.classList.contains('-translate-x-full')) {
                    sb.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sb.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            },
            openSettings() {
                const m = document.getElementById('settings-modal');
                const c = document.getElementById('settings-modal-content');
                m.classList.remove('hidden');
                setTimeout(() => { c.classList.remove('scale-95', 'opacity-0'); c.classList.add('scale-100', 'opacity-100'); }, 10);
            },
            closeSettings() {
                const m = document.getElementById('settings-modal');
                const c = document.getElementById('settings-modal-content');
                c.classList.remove('scale-100', 'opacity-100');
                c.classList.add('scale-95', 'opacity-0');
                setTimeout(() => m.classList.add('hidden'), 300);
            },
            setupEventListeners() {
                document.getElementById('settings-modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('settings-modal')) this.closeSettings();
                });
            },
            showStatus(msg) {
                const el = document.getElementById('status-bar');
                el.innerHTML = `<i class="fas fa-check mr-1"></i> ${msg}`;
                el.classList.remove('opacity-0');
                setTimeout(() => el.classList.add('opacity-0'), 2000);
            }
        };

        // --- CHANNEL MODULE ---
        const channelModule = {
            state: {
                view: 'list', // 'list' or 'categories'
                channels: [],
                categories: ['미분류'],
                categoryColors: {},
                currentSort: { key: 'addedAt', direction: 'desc' },
                searchTerm: '',
                categoryFilter: '전체',
                editingChannelId: null, // For category selection
                loading: false
            },
            listeners: [],

            init() {
                this.setupListeners();
                setTimeout(() => this.setupScrollSync(), 500);
            },

            setupListeners() {
                this.listeners.forEach(unsub => unsub());
                this.listeners = [];

                if (!app.db) return;

                // Revert to global_channels as requested
                const channelsCol = app.db.collection('global_channels');
                const unsubChannels = channelsCol.onSnapshot(snapshot => {
                    this.state.channels = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.render(document.getElementById('main-content'));
                    this.setupScrollSync();
                });
                this.listeners.push(unsubChannels);

                const catDoc = app.db.collection('global_data').doc('channel_categories');
                const unsubCat = catDoc.onSnapshot(doc => {
                    if (doc.exists) {
                        this.state.categories = doc.data().names || ['미분류'];
                    } else {
                        catDoc.set({ names: ['미분류'] });
                        this.state.categories = ['미분류'];
                    }
                    this.ensureCategoryColors();
                    this.render(document.getElementById('main-content'));
                });
                this.listeners.push(unsubCat);
            },

            ensureCategoryColors() {
                // Generate distinct HSL colors
                const newColors = { ...this.state.categoryColors };
                this.state.categories.forEach((cat, idx) => {
                    if (!newColors[cat]) {
                        // Spread hue across 360 degrees based on index/length (mocking uniqueness)
                        // Using a simple hash or index-based hue for stability
                        const hue = (idx * 137.508) % 360; // Golden angle approx
                        newColors[cat] = `hsl(${hue}, 70%, 40%)`;
                    }
                });
                this.state.categoryColors = newColors;
            },

            setupScrollSync() {
                if (this.state.view !== 'list') return;
                const top = document.getElementById('ch-top-scroll');
                const content = document.getElementById('ch-top-scroll-content');
                const tableContainer = document.getElementById('ch-table-container');
                const table = document.getElementById('ch-result-table');

                if (top && content && tableContainer && table) {
                    content.style.width = table.scrollWidth + 'px';
                    top.onscroll = () => { tableContainer.scrollLeft = top.scrollLeft; };
                    tableContainer.onscroll = () => { top.scrollLeft = tableContainer.scrollLeft; };
                }
            },

            render(container) {
                if (!container) return;
                if (app.state.currentModule !== 'channel') return;

                if (this.state.view === 'categories') {
                    this.renderCategoryManager(container);
                } else {
                    this.renderList(container);
                }
            },

            renderCategoryManager(container) {
                const { categories } = this.state;
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-white"><i class="fas fa-tags text-brand-primary mr-2"></i>카테고리 관리</h2>
                            <button onclick="channelModule.setView('list')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i>목록으로 돌아가기
                            </button>
                        </div>

                        <div class="bg-dark-card border border-dark-border rounded-xl p-6">
                            <div class="flex gap-2 mb-6">
                                <input type="text" id="new-category-input" placeholder="새 카테고리 이름" 
                                    class="flex-1 bg-dark-bg border border-dark-border text-white rounded-lg px-4 py-3 focus:border-brand-primary outline-none">
                                <button onclick="channelModule.addCategory()" class="bg-brand-primary hover:bg-brand-hover text-white px-6 py-3 rounded-lg font-bold">추가</button>
                            </div>

                            <div class="space-y-2" id="cat-list">
                                ${categories.map((cat, idx) => `
                                    <div class="flex items-center gap-3 bg-dark-bg p-3 rounded-lg border border-dark-border group">
                                        <div class="w-6 h-6 rounded flex-shrink-0" style="background-color: ${this.state.categoryColors[cat] || '#666'}"></div>
                                        <input type="text" value="${cat}" onchange="channelModule.updateCategoryName(${idx}, this.value)"
                                            class="flex-1 bg-transparent border-none text-white focus:ring-0 cursor-text select-text" ${cat === '미분류' ? 'disabled' : ''}>
                                        
                                        <div class="flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onclick="channelModule.moveCategory(${idx}, -1)" class="p-2 text-gray-400 hover:text-white" ${idx === 0 ? 'disabled' : ''}><i class="fas fa-chevron-up"></i></button>
                                            <button onclick="channelModule.moveCategory(${idx}, 1)" class="p-2 text-gray-400 hover:text-white" ${idx === categories.length - 1 ? 'disabled' : ''}><i class="fas fa-chevron-down"></i></button>
                                            ${cat !== '미분류' ? `<button onclick="channelModule.deleteCategory('${cat}')" class="p-2 text-red-500 hover:text-red-400 ml-2"><i class="fas fa-trash"></i></button>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <p class="text-xs text-dark-muted mt-4">* 이름을 클릭하여 수정할 수 있습니다.</p>
                        </div>
                    </div>
                `;
            },

            renderList(container) {
                const { channels, categories, currentSort, searchTerm, categoryFilter } = this.state;

                // Filter
                let filtered = channels.filter(ch => {
                    const match = searchTerm.toLowerCase();
                    const text = [
                        ch.channelName, ch.note, ch.country, ch.customCategory,
                        (ch.subscribers || 0).toString(), (ch.totalViews || 0).toString()
                    ].join(' ').toLowerCase();
                    if (searchTerm && !text.includes(match)) return false;
                    if (categoryFilter !== '전체' && ch.customCategory !== categoryFilter) return false;
                    return true;
                });

                // Sort
                filtered.sort((a, b) => {
                    let aVal = a[currentSort.key];
                    let bVal = b[currentSort.key];

                    if (['subscribers', 'totalViews', 'totalVideos', 'avgViews90d', 'avgLikes90d', 'avgComments90d'].includes(currentSort.key)) {
                        aVal = Number(aVal || 0);
                        bVal = Number(bVal || 0);
                    } else if (currentSort.key === 'avgUploadFreqDays') {
                        aVal = parseFloat(aVal) || 999999;
                        bVal = parseFloat(bVal) || 999999;
                    } else if (currentSort.key === 'channelCreationDate' || currentSort.key === 'addedAt') {
                        aVal = new Date(aVal || 0).getTime();
                        bVal = new Date(bVal || 0).getTime();
                    } else {
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }

                    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                    return 0;
                });

                const Th = (key, label, extra = '') => `
                    <th class="px-4 py-3 cursor-pointer hover:text-white whitespace-nowrap ${extra}" onclick="channelModule.sort('${key}')">
                        <div class="flex items-center gap-1">
                            ${label}
                            ${currentSort.key === key ? `<i class="fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} text-brand-primary"></i>` : ''}
                        </div>
                    </th>`;

                container.innerHTML = `
                    <div class="max-w-full space-y-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-white"><i class="fas fa-tv text-brand-primary mr-2"></i>채널 목록 관리</h2>
                            <div class="text-sm text-dark-muted">총 채널: <span class="text-white font-bold">${channels.length}</span></div>
                        </div>

                        <!-- Top Controls: Tabs & Search -->
                        <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center bg-dark-card p-4 rounded-xl border border-dark-border">
                             <div class="flex gap-2 w-full md:w-auto">
                                <button onclick="channelModule.setView('categories')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors flex items-center gap-2">
                                    <i class="fas fa-tags"></i> 카테고리 관리
                                </button>
                             </div>
                             
                             <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                                <div class="flex gap-2">
                                    <input type="text" id="ch-url-input" placeholder="URL 또는 @핸들" class="w-full md:w-64 bg-dark-bg border border-dark-border text-white rounded-lg px-4 py-2 focus:border-brand-primary outline-none">
                                    <button onclick="channelModule.addChannel()" class="bg-brand-primary hover:bg-brand-hover text-white px-4 py-2 rounded-lg font-bold whitespace-nowrap">추가</button>
                                </div>
                                <div class="relative flex-1 md:w-64">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-500"></i>
                                    <input type="text" oninput="channelModule.handleSearch(this.value)" value="${searchTerm}" placeholder="검색..." class="w-full bg-dark-bg border border-dark-border text-white rounded-lg pl-10 pr-4 py-2 focus:border-brand-primary outline-none">
                                </div>
                             </div>
                        </div>

                        <!-- Category Filters -->
                        <div class="flex flex-wrap gap-2 items-center px-2">
                                <button onclick="channelModule.setFilter('전체')" class="px-3 py-1 rounded-full text-xs transition-colors ${categoryFilter === '전체' ? 'bg-white text-black font-bold' : 'bg-dark-card text-gray-400 border border-dark-border'}">전체</button>
                                ${categories.map(cat => `
                                    <button onclick="channelModule.setFilter('${cat}')" class="px-3 py-1 rounded-full text-xs transition-colors ${categoryFilter === cat ? 'ring-2 ring-white text-white' : 'bg-dark-card text-gray-400 border border-dark-border'}" style="${categoryFilter === cat ? `background-color: ${this.state.categoryColors[cat]}` : ''}">
                                        ${cat}
                                    </button>
                                `).join('')}
                        </div>

                        <!-- Table Area -->
                        <div class="bg-dark-card rounded-xl border border-dark-border relative">
                            <!-- Top Scrollbar -->
                            <div id="ch-top-scroll" class="overflow-x-auto w-full sticky top-0 z-20 bg-dark-sidebar bg-opacity-90 h-4 custom-scrollbar">
                                <div id="ch-top-scroll-content" class="h-1"></div>
                            </div>

                            <div id="ch-table-container" class="overflow-x-auto">
                                <table id="ch-result-table" class="w-full text-sm text-left text-gray-400 whitespace-nowrap">
                                    <thead class="text-xs text-gray-200 uppercase bg-dark-sidebar sticky top-0 z-10">
                                        <tr>
                                            <th class="px-4 py-3">프로필</th>
                                            ${Th('channelName', '채널명')}
                                            <th class="px-4 py-3">링크</th>
                                            ${Th('customCategory', '카테고리 (클릭하여 변경)')}
                                            ${Th('country', '국가')}
                                            ${Th('note', '비고')}
                                            ${Th('subscribers', '구독자')}
                                            ${Th('totalViews', '총 조회수')}
                                            ${Th('totalVideos', '총 영상수')}
                                            ${Th('channelCreationDate', '채널 생성일')}
                                            <th class="px-4 py-3">경과 시간</th>
                                            ${Th('avgUploadFreqDays', '업로드 주기')}
                                            ${Th('avgViews90d', '90일 조회수')}
                                            ${Th('avgLikes90d', '90일 좋아요')}
                                            ${Th('avgComments90d', '90일 댓글')}
                                            <th class="px-4 py-3 text-right">관리</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-dark-border">
                                        ${filtered.length > 0 ? filtered.map(ch => `
                                            <tr class="hover:bg-dark-hover transition-colors">
                                                <td class="px-4 py-3"><img src="${ch.profileIconUrl}" onerror="this.src='https://placehold.co/40x40/333/ccc?text=User'" class="w-8 h-8 rounded-full"></td>
                                                <td class="px-4 py-3 font-medium text-white">${ch.channelName}</td>
                                                <td class="px-4 py-3">
                                                    <button onclick="channelModule.copyLink('${ch.channelUrl}')" class="text-green-500 hover:text-green-400 bg-dark-bg p-1 rounded border border-dark-border"><i class="fas fa-link"></i></button>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <select onchange="channelModule.changeCategory('${ch.id}', this.value)" class="bg-dark-bg text-white text-xs rounded border border-dark-border p-1 outline-none cursor-pointer" style="background-color: ${this.state.categoryColors[ch.customCategory] || '#333'}">
                                                        ${categories.map(cat => `<option value="${cat}" ${ch.customCategory === cat ? 'selected' : ''} class="bg-dark-card">${cat}</option>`).join('')}
                                                    </select>
                                                </td>
                                                <td class="px-4 py-3">${ch.country}</td>
                                                <td class="px-4 py-3 max-w-[150px] truncate cursor-pointer hover:text-white" onclick="channelModule.editNote('${ch.id}', '${(ch.note || '').replace(/'/g, "\\'")}')" title="수정하려면 클릭">${ch.note || '-'}</td>
                                                <td class="px-4 py-3 font-mono text-gray-300">${(ch.subscribers || 0).toLocaleString()}</td>
                                                <td class="px-4 py-3 font-mono text-dark-muted">${(ch.totalViews || 0).toLocaleString()}</td>
                                                <td class="px-4 py-3 font-mono text-dark-muted">${(ch.totalVideos || 0).toLocaleString()}</td>
                                                <td class="px-4 py-3 text-xs">${ch.channelCreationDate ? ch.channelCreationDate.split('T')[0] : '-'}</td>
                                                <td class="px-4 py-3 text-xs">${this.calculateElapsedTime(ch.channelCreationDate)}</td>
                                                <td class="px-4 py-3 font-mono text-brand-primary">${this.formatUploadFrequency(ch.avgUploadFreqDays, ch.totalVideos)}</td>
                                                <td class="px-4 py-3 font-mono">${(ch.avgViews90d || 0).toLocaleString()}</td>
                                                <td class="px-4 py-3 font-mono">${(ch.avgLikes90d || 0).toLocaleString()}</td>
                                                <td class="px-4 py-3 font-mono">${(ch.avgComments90d || 0).toLocaleString()}</td>
                                                <td class="px-4 py-3 text-right">
                                                    <button onclick="channelModule.deleteChannel('${ch.id}')" class="text-dark-muted hover:text-red-500 transition-colors"><i class="fas fa-trash"></i></button>
                                                </td>
                                            </tr>
                                        `).join('') : `<tr><td colspan="16" class="p-8 text-center text-dark-muted">등록된 채널이 없습니다.</td></tr>`}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                // Re-attach scroll sync
                setTimeout(() => this.setupScrollSync(), 0);
            },

            // --- Logic ---
            setView(v) { this.state.view = v; this.render(document.getElementById('main-content')); },
            handleSearch(val) { this.state.searchTerm = val; this.render(document.getElementById('main-content')); },
            setFilter(cat) { this.state.categoryFilter = cat; this.render(document.getElementById('main-content')); },
            sort(key) {
                if (this.state.currentSort.key === key) this.state.currentSort.direction = this.state.currentSort.direction === 'desc' ? 'asc' : 'desc';
                else this.state.currentSort = { key, direction: 'desc' };
                this.render(document.getElementById('main-content'));
            },

            async addChannel() {
                const url = document.getElementById('ch-url-input').value.trim();
                const k = app.getApiKey('youtube');
                if (!url) return alert("URL을 입력하세요.");
                if (!k) return alert("설정에서 YouTube API 키를 먼저 등록해주세요.");

                this.showLoading(true, "채널 정보 가져오는 중...");
                try {
                    const data = await this.fetchYouTubeData(url, k);
                    await app.db.collection('global_channels').add({
                        ...data,
                        addedAt: new Date().toISOString()
                    });
                    this.showLoading(false);
                    // Input clear happens on re-render if we were in React, but here we manually clear or rely on refresh
                } catch (e) {
                    this.showLoading(false);
                    alert("오류: " + e.message);
                }
            },

            async deleteChannel(id) {
                if (!confirm("삭제하시겠습니까?")) return;
                await app.db.collection('global_channels').doc(id).delete();
            },

            async addCategory() {
                const name = document.getElementById('new-category-input').value.trim();
                if (!name || this.state.categories.includes(name)) return;
                const newCats = [...this.state.categories, name];
                await app.db.collection('global_data').doc('channel_categories').set({ names: newCats }, { merge: true });
                this.render(document.getElementById('main-content'));
            },

            async deleteCategory(name) {
                if (!confirm(`'${name}' 카테고리를 삭제하시겠습니까?`)) return;
                const newCats = this.state.categories.filter(c => c !== name);
                await app.db.collection('global_data').doc('channel_categories').set({ names: newCats }, { merge: true });
                // Reset channels but keep them
                const batch = app.db.batch();
                this.state.channels.forEach(ch => {
                    if (ch.customCategory === name) {
                        batch.update(app.db.collection('global_channels').doc(ch.id), { customCategory: '미분류' });
                    }
                });
                await batch.commit();
            },

            async updateCategoryName(idx, newName) {
                if (!newName || newName === this.state.categories[idx]) return;
                const oldName = this.state.categories[idx];
                const newCats = [...this.state.categories];
                newCats[idx] = newName;
                await app.db.collection('global_data').doc('channel_categories').set({ names: newCats }, { merge: true });

                // Update channels
                const batch = app.db.batch();
                this.state.channels.forEach(ch => {
                    if (ch.customCategory === oldName) {
                        batch.update(app.db.collection('global_channels').doc(ch.id), { customCategory: newName });
                    }
                });
                await batch.commit();
            },

            async moveCategory(idx, dir) {
                const newCats = [...this.state.categories];
                const targetIdx = idx + dir;
                if (targetIdx < 0 || targetIdx >= newCats.length) return;

                [newCats[idx], newCats[targetIdx]] = [newCats[targetIdx], newCats[idx]]; // Swap
                await app.db.collection('global_data').doc('channel_categories').set({ names: newCats }, { merge: true });
            },

            async changeCategory(chId, newCat) {
                await app.db.collection('global_channels').doc(chId).update({ customCategory: newCat });
            },

            editNote(id, note) {
                const m = document.getElementById('note-modal');
                m.classList.remove('hidden');
                document.getElementById('note-input').value = note;
                document.getElementById('note-id').value = id;
            },

            async saveNote() {
                const id = document.getElementById('note-id').value;
                const note = document.getElementById('note-input').value;
                await app.db.collection('global_channels').doc(id).update({ note });
                document.getElementById('note-modal').classList.add('hidden');
            },

            copyLink(url) {
                const t = document.createElement('textarea');
                t.value = url;
                document.body.appendChild(t);
                t.select();
                document.execCommand('copy');
                document.body.removeChild(t);
                app.showStatus("링크 복사됨");
            },

            showLoading(show, text) {
                const el = document.getElementById('ch-loading');
                if (!el) return;
                el.classList.toggle('hidden', !show);
                if (text) document.getElementById('ch-loading-text').innerText = text;
            },

            // --- API Helpers ---
            async fetchYouTubeData(url, apiKey) {
                let id = null;
                if (url.includes('channel/')) id = url.split('channel/')[1].split('/')[0];
                else if (url.includes('@')) {
                    const handle = url.split('@')[1].split('/')[0];
                    const s = await this.fetchWithBackoff(`https://www.googleapis.com/youtube/v3/search?part=id&q=@${handle}&type=channel&key=${apiKey}`);
                    if (s.items?.[0]) id = s.items[0].id.channelId;
                }
                if (!id) throw new Error("채널 ID를 찾을 수 없습니다.");

                const chRes = await this.fetchWithBackoff(`https://www.googleapis.com/youtube/v3/channels?part=snippet,contentDetails,statistics&id=${id}&key=${apiKey}`);
                const item = chRes.items[0];
                if (!item) throw new Error("채널 정보 없음");

                const uploadsId = item.contentDetails.relatedPlaylists.uploads;
                const videos = await this.fetchRecentVideos(uploadsId, apiKey);

                let stats90 = { views: 0, likes: 0, comments: 0, count: videos.length };
                if (videos.length > 0) {
                    const chunk = videos.slice(0, 50).map(v => v.id).join(',');
                    const vRes = await this.fetchWithBackoff(`https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${chunk}&key=${apiKey}`);
                    vRes.items.forEach(v => {
                        stats90.views += Number(v.statistics.viewCount || 0);
                        stats90.likes += Number(v.statistics.likeCount || 0);
                        stats90.comments += Number(v.statistics.commentCount || 0);
                    });
                }

                const oldest = videos.length > 0 ? videos[videos.length - 1].date : item.snippet.publishedAt;
                const days = (new Date() - new Date(oldest)) / (86400000) || 1;
                const freq = videos.length > 0 ? (days / videos.length).toFixed(1) : 0;

                return {
                    channelName: item.snippet.title,
                    channelUrl: `https://youtube.com/channel/${item.id}`,
                    profileIconUrl: item.snippet.thumbnails.default.url,
                    country: item.snippet.country || 'N/A',
                    subscribers: Number(item.statistics.subscriberCount),
                    totalViews: Number(item.statistics.viewCount),
                    totalVideos: Number(item.statistics.videoCount),
                    channelCreationDate: item.snippet.publishedAt,
                    avgUploadFreqDays: freq,
                    avgViews90d: stats90.count ? Math.round(stats90.views / stats90.count) : 0,
                    avgLikes90d: stats90.count ? Math.round(stats90.likes / stats90.count) : 0,
                    avgComments90d: stats90.count ? Math.round(stats90.comments / stats90.count) : 0,
                    customCategory: '미분류',
                    note: '',
                    channelId: item.id
                };
            },

            async fetchRecentVideos(pid, k) {
                const res = await this.fetchWithBackoff(`https://www.googleapis.com/youtube/v3/playlistItems?part=contentDetails&playlistId=${pid}&maxResults=50&key=${k}`);
                const now = new Date();
                const d90 = new Date(now - 90 * 86400000);
                return res.items
                    .map(i => ({ id: i.contentDetails.videoId, date: new Date(i.contentDetails.videoPublishedAt) }))
                    .filter(v => v.date > d90);
            },

            async fetchWithBackoff(url) {
                const r = await fetch(url);
                if (!r.ok) throw new Error("API Request Failed");
                return r.json();
            },

            calculateElapsedTime(dateStr) {
                const diff = new Date() - new Date(dateStr);
                const years = Math.floor(diff / 31536000000);
                const months = Math.floor(diff / 2592000000) % 12;
                return `${years}년 ${months}개월`;
            },

            formatUploadFrequency(days, total) {
                if (!days || days === 'N/A' || total === 0) return '-';
                if (days < 1) return `1일당 ${(1 / Number(days)).toFixed(1)}개`;
                return `${Math.round(Number(days))}일당 1개`;
            }
        };


        const keywordModule = {
            CATS: ["영화/애니메이션", "자동차/교통", "음악", "애완동물/동물", "스포츠", "게임", "코미디", "엔터테인먼트", "뉴스/정치", "노하우/스타일", "교육", "과학/기술", "인물/블로그", "비영리/사회운동", "여행/이벤트"],
            CAT_IDS: { "영화/애니메이션": "1", "자동차/교통": "2", "음악": "10", "애완동물/동물": "15", "스포츠": "17", "여행/이벤트": "19", "게임": "20", "인물/블로그": "22", "코미디": "23", "엔터테인먼트": "24", "뉴스/정치": "25", "노하우/스타일": "26", "교육": "27", "과학/기술": "28", "비영리/사회운동": "29" },
            currentResults: [],
            sortKey: null,
            sortAsc: true,

            render(container) {
                container.innerHTML = `
                    <div class="max-w-7xl mx-auto space-y-8">
                        <div class="text-center space-y-2">
                             <h2 class="text-2xl font-bold text-white"><span class="text-brand-primary">●</span> YouTube 다국어 키워드 검색기</h2>
                             <p class="text-dark-muted">카테고리 선택 시 100개의 세부 주제 및 키워드를 7개 언어로 번역합니다.</p>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-white font-bold"><i class="fas fa-filter text-brand-primary"></i> 카테고리 선택</div>
                            <div class="flex flex-wrap gap-2 justify-center" id="kw-categories"></div>
                        </div>
                        <div class="bg-dark-card p-6 rounded-xl border border-dark-border space-y-6">
                            <div class="flex flex-wrap justify-center gap-4 items-center text-sm text-dark-muted">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-calendar"></i> 기준일:
                                    <input type="date" id="kw-date" class="bg-dark-bg border border-dark-border rounded px-2 py-1 text-white focus:border-brand-primary outline-none">
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-globe"></i> 국가:
                                    <select id="kw-country" class="bg-dark-bg border border-dark-border rounded px-2 py-1 text-white focus:border-brand-primary outline-none"></select>
                                </div>
                                <span class="text-xs text-gray-600">(과거 날짜 조회 시 API 소모량 ↑)</span>
                            </div>
                            <div class="flex justify-center">
                                <div class="flex w-full max-w-2xl border-2 border-brand-primary rounded-lg overflow-hidden transition-shadow focus-within:ring-2 focus-within:ring-red-900">
                                    <input type="text" id="kw-input" placeholder="키워드 입력 (예: 먹방)" class="flex-1 bg-transparent border-none px-4 py-3 text-white placeholder-gray-600 focus:outline-none text-lg">
                                    <button onclick="keywordModule.search()" class="bg-brand-primary hover:bg-brand-hover text-white px-8 font-bold transition-colors">검색</button>
                                </div>
                            </div>
                        </div>
                         <div class="bg-dark-card rounded-xl border border-dark-border overflow-hidden min-h-[400px] flex flex-col">
                            <div class="p-4 border-b border-dark-border flex justify-between items-center">
                                <h3 class="font-bold text-white"><i class="fas fa-list text-brand-primary mr-2"></i>키워드 결과 (100개)</h3>
                                <div class="flex gap-2">
                                    <span id="kw-status" class="text-sm text-dark-muted self-center">대기 중</span>
                                    <button onclick="keywordModule.downloadCSV()" id="kw-csv-btn" class="hidden bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded transition-colors"><i class="fas fa-file-csv mr-1"></i> CSV 저장</button>
                                </div>
                            </div>
                            
                            <!-- Top Scrollbar -->
                            <div id="kw-top-scroll" class="overflow-x-auto bg-dark-sidebar border-b border-dark-border relative" style="min-height: 12px;">
                                <div id="kw-top-scroll-content" class="h-1" style="width: 0px;"></div>
                            </div>

                            <div id="kw-table-container" class="overflow-x-auto flex-1">
                                <table id="kw-result-table" class="w-full text-sm text-left text-gray-400">
                                    <thead class="text-xs text-gray-200 uppercase bg-dark-sidebar sticky top-0 z-10">
                                        <tr>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('rank')">NO</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('channel')">채널명</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('subsRaw')">구독자</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('views')">조회수</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('comments')">댓글</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('likes')">좋아요</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap min-w-[200px]" onclick="keywordModule.sort('korean')">🇰🇷 영상제목</th>
                                            <th class="px-4 py-3 cursor-pointer hover:bg-dark-hover whitespace-nowrap" onclick="keywordModule.sort('date')">게시일</th>
                                            <th class="px-4 py-3 whitespace-nowrap">🇺🇸 영어</th>
                                            <th class="px-4 py-3 whitespace-nowrap">🇯🇵 일본어</th>
                                            <th class="px-4 py-3 whitespace-nowrap">🇨🇳 중국어</th>
                                            <th class="px-4 py-3 whitespace-nowrap">🇪🇸 스페인어</th>
                                            <th class="px-4 py-3 whitespace-nowrap">🇮🇳 인도어</th>
                                            <th class="px-4 py-3 whitespace-nowrap">🇷🇺 러시아어</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kw-results-body"></tbody>
                                </table>
                            </div>
                         </div>
                    </div>
                `;
            },
            init() {
                const cBox = document.getElementById('kw-categories');
                cBox.innerHTML = this.CATS.map(c => `<span onclick="keywordModule.selectCat(this, '${c}')" class="category-pill px-4 py-2 rounded-full bg-dark-card hover:bg-dark-hover cursor-pointer border border-transparent hover:border-brand-primary text-sm text-gray-300 transition-all select-none">${c}</span>`).join('');
                document.getElementById('kw-date').valueAsDate = new Date();
                const COUNTRIES = { 'KR': '대한민국', 'US': '미국', 'GB': '영국', 'JP': '일본', 'ES': '스페인', 'IN': '인도', 'RU': '러시아', 'TW': '대만', 'HK': '홍콩', 'ID': '인도네시아' };
                const cSelect = document.getElementById('kw-country');
                cSelect.innerHTML = Object.entries(COUNTRIES).map(([code, name]) => `<option value="${code}" ${code === 'KR' ? 'selected' : ''}>${name}</option>`).join('');
                document.getElementById('kw-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') this.search(); });

                const topScroll = document.getElementById('kw-top-scroll');
                const tableContainer = document.getElementById('kw-table-container');
                if (topScroll && tableContainer) {
                    topScroll.onscroll = () => { tableContainer.scrollLeft = topScroll.scrollLeft; };
                    tableContainer.onscroll = () => { topScroll.scrollLeft = tableContainer.scrollLeft; };
                }
            },
            selectCat(el, cat) {
                document.querySelectorAll('#kw-categories .category-pill').forEach(b => {
                    b.classList.remove('bg-gray-700', 'text-white', 'border-brand-primary');
                    b.classList.add('bg-dark-card', 'text-gray-300');
                });
                el.classList.remove('bg-dark-card', 'text-gray-300');
                el.classList.add('bg-gray-700', 'text-white', 'border-brand-primary');
                this.search(null, cat);
            },
            async search(queryOverride = null, catOverride = null) {
                const q = queryOverride !== null ? queryOverride : document.getElementById('kw-input').value;
                let cat = catOverride;
                if (!cat) {
                    const activePill = document.querySelector('#kw-categories .category-pill.bg-gray-700');
                    if (activePill) cat = activePill.innerText;
                    else cat = "엔터테인먼트";
                }
                const msg = document.getElementById('kw-status');
                const k = app.getApiKey('youtube');
                const tk = app.getApiKey('translate');
                if (!k) return alert("설정에서 YouTube API 키를 먼저 등록해주세요.");

                msg.innerText = "데이터 요청 중...";
                msg.className = "text-sm text-brand-primary animate-pulse";
                const dateVal = document.getElementById('kw-date').value;
                const region = document.getElementById('kw-country').value;
                const isToday = (dateVal === new Date().toISOString().split('T')[0]);
                try {
                    let videoIds = [];
                    if (q || !isToday) {
                        let params = `search?part=id&type=video&maxResults=50&key=${k}&regionCode=${region}`;
                        if (q) params += `&q=${encodeURIComponent(q)}`;
                        if (!isToday) {
                            const start = new Date(dateVal + "T00:00:00Z").toISOString();
                            const end = new Date(dateVal + "T23:59:59Z").toISOString();
                            params += `&publishedAfter=${start}&publishedBefore=${end}&order=viewCount`;
                        }
                        if (!q && cat) {
                            params += `&videoCategoryId=${this.CAT_IDS[cat]}`;
                            if (isToday) params += `&order=viewCount`;
                        }
                        const r1 = await this.fetchYT(params);
                        videoIds = r1.items.map(i => i.id.videoId);
                        if (r1.nextPageToken) {
                            const r2 = await this.fetchYT(`${params}&pageToken=${r1.nextPageToken}`);
                            videoIds = [...videoIds, ...r2.items.map(i => i.id.videoId)];
                        }
                    } else {
                        const cid = this.CAT_IDS[cat];
                        try {
                            const r1 = await this.fetchYT(`videos?part=id&chart=mostPopular&regionCode=${region}&videoCategoryId=${cid}&maxResults=50&key=${k}`);
                            videoIds = r1.items.map(i => i.id);
                            if (r1.nextPageToken) {
                                const r2 = await this.fetchYT(`videos?part=id&chart=mostPopular&regionCode=${region}&videoCategoryId=${cid}&pageToken=${r1.nextPageToken}&maxResults=50&key=${k}`);
                                videoIds = [...videoIds, ...r2.items.map(i => i.id)];
                            }
                        } catch {
                            const r1 = await this.fetchYT(`search?part=id&q=${encodeURIComponent(cat)}&type=video&maxResults=50&key=${k}`);
                            videoIds = r1.items.map(i => i.id.videoId);
                        }
                    }
                    const uniqueIds = [...new Set(videoIds)].slice(0, 100);
                    let finalItems = [];
                    for (let i = 0; i < uniqueIds.length; i += 50) {
                        const chunk = uniqueIds.slice(i, i + 50).join(',');
                        const r = await this.fetchYT(`videos?part=snippet,statistics&id=${chunk}&key=${k}`);
                        finalItems = [...finalItems, ...r.items];
                    }
                    const channelIds = [...new Set(finalItems.map(i => i.snippet.channelId))];
                    const channelStats = {};
                    for (let i = 0; i < channelIds.length; i += 50) {
                        const chunk = channelIds.slice(i, i + 50).join(',');
                        try {
                            const r = await this.fetchYT(`channels?part=statistics&id=${chunk}&key=${k}`);
                            r.items.forEach(ch => { channelStats[ch.id] = ch.statistics.subscriberCount; });
                        } catch (e) { console.error(e); }
                    }
                    const titles = finalItems.map(i => i.snippet.title);
                    let trans = { en: [], ja: [], 'zh-CN': [], es: [], hi: [], ru: [] };
                    if (tk) {
                        msg.innerText = "번역 API 호출 중...";
                        trans = await this.doTrans(titles, tk);
                    }
                    this.currentResults = finalItems.map((item, i) => {
                        const s = item.snippet;
                        const st = item.statistics || {};
                        const subCount = channelStats[s.channelId] || 0;
                        return {
                            rank: i + 1,
                            korean: s.title,
                            id: item.id,
                            channel: s.channelTitle,
                            channelId: s.channelId,
                            subsRaw: Number(subCount),
                            subs: Number(subCount).toLocaleString(),
                            views: Number(st.viewCount || 0).toLocaleString(),
                            comments: Number(st.commentCount || 0).toLocaleString(),
                            likes: Number(st.likeCount || 0).toLocaleString(),
                            date: (s.publishedAt || "").split('T')[0],
                            english: trans.en[i] || '-', japanese: trans.ja[i] || '-',
                            chinese: trans['zh-CN'][i] || '-', spanish: trans.es[i] || '-',
                            hindi: trans.hi[i] || '-', russian: trans.ru[i] || '-'
                        };
                    });
                    this.updateUI();
                    msg.innerText = `완료 (${finalItems.length}개)`;
                    msg.className = "text-sm text-green-500 font-bold";
                } catch (e) {
                    msg.innerText = "오류: " + e.message;
                    msg.className = "text-sm text-red-500 font-bold";
                    alert("API 오류: " + e.message);
                }
            },
            async fetchYT(path) {
                const r = await fetch(`https://www.googleapis.com/youtube/v3/${path}`);
                if (!r.ok) throw new Error("YouTube API Error");
                return r.json();
            },
            async doTrans(txs, k) {
                const out = {};
                const langs = ['en', 'ja', 'zh-CN', 'es', 'hi', 'ru'];
                await Promise.all(langs.map(async l => {
                    try {
                        const r = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${k}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ q: txs, target: l, format: 'text' })
                        });
                        const d = await r.json();
                        out[l] = d.data.translations.map(t => t.translatedText);
                    } catch { out[l] = Array(txs.length).fill('-'); }
                }));
                return out;
            },
            updateUI() {
                const tbody = document.getElementById('kw-results-body');
                if (!tbody) return;

                const table = document.getElementById('kw-result-table');
                const topScrollContent = document.getElementById('kw-top-scroll-content');
                if (table && topScrollContent) {
                    // Update scrollbar width logic
                    const updateWidth = () => {
                        topScrollContent.style.width = table.scrollWidth + 'px';
                    }
                    updateWidth();
                    setTimeout(updateWidth, 100); // Retry slightly later for render
                }

                tbody.innerHTML = this.currentResults.map(r => `
                    <tr class="border-b border-dark-border hover:bg-dark-card transition-colors">
                        <td class="px-4 py-3 text-center text-dark-muted">${r.rank}</td>
                        <td class="px-4 py-3"><a href="https://www.youtube.com/channel/${r.channelId}" target="_blank" class="hover:text-white hover:underline transition-colors">${r.channel}</a></td>
                        <td class="px-4 py-3 text-dark-muted">${r.subs}</td>
                        <td class="px-4 py-3 text-right font-mono text-gray-300">${r.views}</td>
                        <td class="px-4 py-3 text-right font-mono text-dark-muted">${r.comments}</td>
                        <td class="px-4 py-3 text-right font-mono text-dark-muted">${r.likes}</td>
                        <td class="px-4 py-3 min-w-[300px]"><a href="https://www.youtube.com/watch?v=${r.id}" target="_blank" class="text-white hover:text-brand-primary font-medium hover:underline transition-colors block truncate w-full">${r.korean}</a></td>
                        <td class="px-4 py-3 text-dark-muted whitespace-nowrap">${r.date}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.english}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.japanese}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.chinese}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.spanish}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.hindi}</td>
                        <td class="px-4 py-3 text-xs text-dark-muted truncate max-w-[150px]">${r.russian}</td>
                    </tr>`).join('');
                document.getElementById('kw-csv-btn').classList.remove('hidden');
            },
            sort(key) {
                if (this.sortKey === key) this.sortAsc = !this.sortAsc;
                else { this.sortKey = key; this.sortAsc = true; }
                this.currentResults.sort((a, b) => {
                    let va = a[key], vb = b[key];
                    if (['views', 'comments', 'likes', 'subsRaw', 'rank'].includes(key)) { va = Number(String(va).replace(/,/g, '')) || 0; vb = Number(String(vb).replace(/,/g, '')) || 0; }
                    if (va < vb) return this.sortAsc ? -1 : 1;
                    if (va > vb) return this.sortAsc ? 1 : -1;
                    return 0;
                });
                this.updateUI();
            },
            downloadCSV() {
                if (!this.currentResults.length) return alert("데이터 없음");
                const BOM = "\uFEFF";
                let csv = BOM + "Rank,Channel,Subscribers,Title,Views,Comments,Likes,Date,English,Japanese,Chinese,Spanish,Hindi,Russian,Video Link,Channel Link\n";
                this.currentResults.forEach(r => {
                    const vLink = `https://www.youtube.com/watch?v=${r.id}`;
                    const cLink = `https://www.youtube.com/channel/${r.channelId}`;
                    csv += `${r.rank},"${r.channel.replace(/"/g, '""')}",${r.subsRaw},"${r.korean.replace(/"/g, '""')}",${r.views.replace(/,/g, '')},${r.comments.replace(/,/g, '')},${r.likes.replace(/,/g, '')},${r.date},"${r.english}","${r.japanese}","${r.chinese}","${r.spanish}","${r.hindi}","${r.russian}","${vLink}","${cLink}"\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `youtube_keywords_${new Date().toISOString().slice(0, 10)}.csv`;
                a.click();
            }
        };
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>

</html>