<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ëŒ“ê¸€ ì‹¬ì¸µ ë¶„ì„ê¸° </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#121212', card: '#1E1E1E', border: '#333333', text: '#E0E0E0', muted: '#A0A0A0' },
                        brand: { red: '#FF4E45', blue: '#3B82F6', green: '#10B981' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #121212; color: #E0E0E0; scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 3px solid #333; border-top: 3px solid #FF4E45; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .markdown-raw { white-space: pre-wrap; line-height: 1.6; font-family: 'Menlo', 'Monaco', monospace; font-size: 0.85em; background-color: #000; color: #4ade80; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #333; overflow-x: auto; }
        .highlight-text strong { color: #FF4E45; background-color: rgba(255, 78, 69, 0.1); padding: 0 4px; border-radius: 2px; font-weight: 700; }
        .hover-card { transition: all 0.2s ease; }
        .hover-card:hover { transform: translateY(-2px); border-color: #FF4E45; }
        .custom-checkbox { appearance: none; background-color: #333; margin: 0; font: inherit; color: currentColor; width: 1.15em; height: 1.15em; border: 0.1em solid #555; border-radius: 0.15em; display: grid; place-content: center; cursor: pointer; }
        .custom-checkbox::before { content: ""; width: 0.65em; height: 0.65em; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: #FF4E45; border-color: #FF4E45; }
        .custom-checkbox:checked::before { transform: scale(1); }
        .type-badge { padding: 4px 12px; border-radius: 9999px; font-weight: 700; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 6px; }
        .type-trend { background-color: rgba(255, 78, 69, 0.15); color: #FF4E45; border: 1px solid rgba(255, 78, 69, 0.3); }
        .type-evergreen { background-color: rgba(16, 185, 129, 0.15); color: #34D399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .type-seasonal { background-color: rgba(251, 191, 36, 0.15); color: #FBBF24; border: 1px solid rgba(251, 191, 36, 0.3); }
        .comment-quote { background-color: #252525; border-left: 3px solid #555; padding: 10px 14px; margin-top: 10px; font-size: 0.9rem; color: #ccc; border-radius: 0 6px 6px 0; }
        .comment-author { font-size: 0.75rem; font-weight: 700; color: #888; margin-bottom: 4px; display: block; }
        .comment-table th { background-color: #252525; color: #bbb; font-weight: 600; padding: 1rem; text-align: left; border-bottom: 1px solid #333; }
        .comment-table td { padding: 1rem; border-bottom: 1px solid #333; color: #ddd; vertical-align: top; }
        .comment-table tr:hover td { background-color: #2a2a2a; }
        .history-table th { background-color: #252525; color: #9ca3af; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; padding: 1rem; text-align: left; white-space: nowrap; user-select: none; }
        .history-table td { padding: 1rem; border-top: 1px solid #333; vertical-align: middle; color: #e5e7eb; }
        .history-table tr:hover { background-color: #1a1a1a; }
        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus, input:-webkit-autofill:active{ -webkit-box-shadow: 0 0 0 30px #1E1E1E inset !important; -webkit-text-fill-color: white !important; }
        #scrollTopBtn { position: fixed; bottom: 30px; right: 30px; z-index: 100; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #scrollTopBtn.visible { opacity: 1; pointer-events: auto; }
        
        /* Modal Styles */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-bg.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: #1E1E1E; border: 1px solid #333; border-radius: 1rem; width: 95%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4); }
        .modal-bg.active .modal-content { transform: scale(1); }
    </style>
</head>
<body class="min-h-screen relative">

    <button id="scrollTopBtn" onclick="window.scrollTo(0,0)" class="bg-brand-red text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center hover:bg-red-600 transition">
        <i class="fas fa-arrow-up"></i>
    </button>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2 flex justify-center items-center gap-3">
                <i class="fab fa-youtube text-brand-red"></i> 
                <span>YOUTUBE <span class="text-brand-red">INSIGHT PRO</span></span>
            </h1>
            <p class="text-dark-muted text-sm md:text-base">ì‹¬ì¸µ ë…¼ìŸ ë¶„ì„ Â· ë‹¤êµ­ì–´ ìë™ ë²ˆì—­ Â· í´ë¼ìš°ë“œ ë™ê¸°í™”</p>
        </header>

        <!-- API Settings Header -->
        <div class="bg-dark-card rounded-xl p-4 mb-8 border border-dark-border shadow-lg flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-brand-blue/10 flex items-center justify-center text-brand-blue">
                    <i class="fas fa-cloud"></i>
                </div>
                <div>
                    <h2 class="text-sm font-bold text-white">API ì„¤ì • ë° ë™ê¸°í™”</h2>
                    <p class="text-xs text-dark-muted" id="activeKeyLabel">ì—°ë™ ëŒ€ê¸° ì¤‘...</p>
                </div>
            </div>
            <button onclick="openApiModal()" class="bg-[#333] hover:bg-[#444] text-white px-4 py-2 rounded-lg text-xs font-bold transition border border-dark-border flex items-center gap-2">
                <i class="fas fa-cog"></i> í‚¤ ê´€ë¦¬
            </button>
        </div>

        <div class="bg-dark-card rounded-xl border border-dark-border shadow-lg overflow-hidden min-h-[500px]">
            <div class="flex border-b border-dark-border">
                <button onclick="setMode('link')" id="tab-link" class="flex-1 py-4 text-center font-bold text-sm md:text-base transition-colors border-b-2 border-brand-red text-brand-red bg-[#252525]"><i class="fas fa-link mr-2"></i>ì˜ìƒ ë§í¬ ë¶„ì„</button>
                <button onclick="setMode('channel')" id="tab-channel" class="flex-1 py-4 text-center font-bold text-sm md:text-base text-dark-muted hover:text-white transition-colors border-b-2 border-transparent hover:bg-[#252525]"><i class="fas fa-tv mr-2"></i>ì±„ë„ ì¸ê¸° ì˜ìƒ</button>
                <button onclick="setMode('history')" id="tab-history" class="flex-1 py-4 text-center font-bold text-sm md:text-base text-dark-muted hover:text-white transition-colors border-b-2 border-transparent hover:bg-[#252525]"><i class="fas fa-history mr-2"></i>í´ë¼ìš°ë“œ íˆìŠ¤í† ë¦¬</button>
            </div>

            <div class="p-6 md:p-8">
                <div id="view-link" class="block">
                    <div class="flex flex-col md:flex-row gap-3 mb-8">
                        <input type="text" id="videoUrl" class="flex-1 bg-[#121212] border border-dark-border text-white p-3 rounded-lg focus:ring-2 focus:ring-brand-red outline-none" placeholder="https://youtu.be/...">
                        <button onclick="analyzeSingleVideo()" class="bg-brand-red hover:bg-red-600 text-white px-8 py-3 rounded-lg font-bold transition shadow-lg shadow-red-900/20">ë¶„ì„í•˜ê¸°</button>
                    </div>
                </div>

                <div id="view-channel" class="hidden">
                    <div class="flex flex-col md:flex-row gap-3 mb-6">
                        <input type="text" id="channelHandle" class="flex-1 bg-[#121212] border border-dark-border text-white p-3 rounded-lg focus:ring-2 focus:ring-brand-red outline-none" placeholder="ì±„ë„ URL, @í•¸ë“¤, ë˜ëŠ” ì±„ë„ëª…">
                        <button onclick="searchChannelVideos()" class="bg-[#333] hover:bg-[#444] text-white px-8 py-3 rounded-lg font-bold transition border border-dark-border">ì¡°íšŒí•˜ê¸°</button>
                    </div>
                    <div id="channelControls" class="hidden mb-6 p-4 bg-[#252525] rounded-lg border border-dark-border flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex gap-2 items-center flex-wrap">
                            <span class="text-xs font-bold text-dark-muted uppercase mr-1">ì •ë ¬:</span>
                            <select id="sortOption" onchange="sortChannelVideos()" class="bg-[#121212] text-white text-sm p-2 rounded border border-dark-border outline-none focus:border-brand-red">
                                <option value="viewCount">ì¡°íšŒìˆ˜</option>
                                <option value="likeCount">ì¢‹ì•„ìš”</option>
                                <option value="commentCount">ëŒ“ê¸€ìˆ˜</option>
                                <option value="date">ë‚ ì§œ</option>
                            </select>
                            <select id="orderOption" onchange="sortChannelVideos()" class="bg-[#121212] text-white text-sm p-2 rounded border border-dark-border outline-none focus:border-brand-red">
                                <option value="desc">ë‚´ë¦¼ì°¨ìˆœ (ë†’ì€ìˆœ)</option>
                                <option value="asc">ì˜¤ë¦„ì°¨ìˆœ (ë‚®ì€ìˆœ)</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="selectedCount" class="text-sm text-brand-blue font-bold">0ê°œ ì„ íƒë¨</span>
                            <button onclick="analyzeSelectedVideos()" class="bg-brand-blue hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold transition shadow-lg shadow-blue-900/20 disabled:opacity-50 disabled:cursor-not-allowed" id="btnBatchAnalyze" disabled><i class="fas fa-magic mr-1"></i> ì„ íƒ ì˜ìƒ ì¼ê´„ ë¶„ì„</button>
                        </div>
                    </div>
                    <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 mb-6"></div>
                    <div id="loadMoreContainer" class="hidden text-center mt-8">
                        <button onclick="loadMoreChannelVideos()" class="bg-[#333] hover:bg-[#444] text-white px-6 py-3 rounded-full font-bold text-sm transition border border-dark-border shadow-lg"><i class="fas fa-plus mr-2"></i> ì˜ìƒ ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                </div>

                <div id="view-history" class="hidden">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h3 class="text-white font-bold text-lg flex items-center gap-2"><i class="fas fa-list text-brand-blue"></i> ë¶„ì„ ê¸°ë¡ (Cloud)</h3>
                        <div class="flex gap-3 w-full md:w-auto items-center">
                            <div class="relative flex-1 md:w-64">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-dark-muted"></i>
                                <input type="text" id="historySearch" oninput="filterHistory()" placeholder="ê¸°ë¡ ê²€ìƒ‰" class="w-full bg-[#121212] border border-dark-border text-white pl-9 p-2 rounded text-sm focus:border-brand-blue outline-none">
                            </div>
                            <button onclick="downloadSelectedHistory()" class="bg-brand-blue hover:bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold transition whitespace-nowrap disabled:opacity-50" id="btnHistoryBatchDown" disabled><i class="fas fa-download mr-1"></i> ì„ íƒ ë‹¤ìš´ë¡œë“œ</button>
                            <button onclick="clearAllHistory()" class="text-xs text-red-400 hover:text-red-300 underline whitespace-nowrap">ì „ì²´ ì‚­ì œ</button>
                        </div>
                    </div>
                    <div id="historyLoading" class="text-center py-8 text-dark-muted hidden"><div class="loader mb-2 w-6 h-6"></div> ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    <div id="historyContainer" class="overflow-x-auto rounded-lg border border-dark-border"></div>
                    <div id="noHistoryMsg" class="text-center text-dark-muted py-10 hidden">ì €ì¥ëœ ë¶„ì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>

                <!-- mt-12 Added for spacing -->
                <div id="resultArea" class="hidden animate-fade-in mt-12 border-t border-dark-border pt-12">
                    <div id="statsDashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
                    <div id="loading" class="hidden py-12 text-center">
                        <div class="loader mb-4"></div>
                        <p class="text-dark-muted animate-pulse" id="loadingText">ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</p>
                    </div>
                    <div id="webReport" class="hidden space-y-8">
                        <div class="bg-gradient-to-r from-blue-900/20 to-transparent border-l-4 border-brand-blue p-5 rounded-r-lg">
                            <h4 class="font-bold text-brand-blue mb-3 text-lg">ğŸ“ ìƒì„¸ ìš”ì•½</h4>
                            <p id="ui-summary" class="text-gray-300 leading-relaxed highlight-text"></p>
                        </div>
                        <div id="dynamicReportContent"></div>
                    </div>
                    <!-- Raw Data Section Removed as requested -->
                </div>
            </div>
        </div>
    </div>

    <!-- API Settings Modal (Separate Management) -->
    <div id="apiModal" class="modal-bg">
        <div class="modal-content overflow-hidden flex flex-col h-[90vh]">
            <div class="p-4 border-b border-dark-border flex justify-between items-center bg-[#252525]">
                <h3 class="font-bold text-white flex items-center gap-2"><i class="fas fa-key text-brand-blue"></i> API í‚¤ ê´€ë¦¬ (ê°œë³„ ì„¤ì •)</h3>
                <button onclick="closeApiModal()" class="text-gray-400 hover:text-white transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-6 bg-[#181818]">
                
                <!-- YouTube API Section -->
                <div class="bg-[#121212] rounded-xl border border-dark-border p-4 flex flex-col">
                    <h4 class="font-bold text-white mb-4 flex items-center gap-2 text-lg"><i class="fab fa-youtube text-brand-red"></i> YouTube API</h4>
                    
                    <div class="bg-[#1E1E1E] p-3 rounded-lg border border-dark-border mb-4 space-y-2">
                        <input type="hidden" id="editId_yt">
                        <input type="text" id="alias_yt" class="w-full bg-[#121212] border border-dark-border text-white p-2 rounded text-sm focus:border-brand-red outline-none" placeholder="ë³„ì¹­ (ì˜ˆ: ë©”ì¸ ìœ íŠœë¸Œí‚¤)">
                        <input type="password" id="key_yt" class="w-full bg-[#121212] border border-dark-border text-white p-2 rounded text-sm focus:border-brand-red outline-none" placeholder="YouTube API Key" onkeydown="if(event.key === 'Enter') saveKey('yt')">
                        <button onclick="saveKey('yt')" id="btnSave_yt" class="w-full bg-brand-red hover:bg-red-600 text-white p-2 rounded font-bold text-sm transition">ì¶”ê°€í•˜ê¸°</button>
                    </div>

                    <div class="flex-1 overflow-y-auto min-h-[150px]">
                        <div id="list_yt" class="space-y-2">
                            <div class="text-center text-gray-600 text-xs py-4">í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    </div>
                </div>

                <!-- Gemini API Section -->
                <div class="bg-[#121212] rounded-xl border border-dark-border p-4 flex flex-col">
                    <h4 class="font-bold text-white mb-4 flex items-center gap-2 text-lg"><i class="fas fa-star text-brand-blue"></i> Gemini API</h4>
                    
                    <div class="bg-[#1E1E1E] p-3 rounded-lg border border-dark-border mb-4 space-y-2">
                        <input type="hidden" id="editId_gemini">
                        <input type="text" id="alias_gemini" class="w-full bg-[#121212] border border-dark-border text-white p-2 rounded text-sm focus:border-brand-blue outline-none" placeholder="ë³„ì¹­ (ì˜ˆ: ì œë¯¸ë‚˜ì´ í”„ë¡œ)">
                        <input type="password" id="key_gemini" class="w-full bg-[#121212] border border-dark-border text-white p-2 rounded text-sm focus:border-brand-blue outline-none" placeholder="Gemini API Key" onkeydown="if(event.key === 'Enter') saveKey('gemini')">
                        <button onclick="saveKey('gemini')" id="btnSave_gemini" class="w-full bg-brand-blue hover:bg-blue-600 text-white p-2 rounded font-bold text-sm transition">ì¶”ê°€í•˜ê¸°</button>
                    </div>

                    <div class="flex-1 overflow-y-auto min-h-[150px]">
                        <div id="list_gemini" class="space-y-2">
                            <div class="text-center text-gray-600 text-xs py-4">í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    </div>
                </div>

            </div>
            
            <div class="p-4 border-t border-dark-border bg-[#252525] text-right">
                <button onclick="closeApiModal()" class="bg-[#444] hover:bg-[#555] text-white px-6 py-2 rounded-lg text-sm font-bold transition">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === [ì¤‘ìš”] UI í•¨ìˆ˜ë¥¼ ë¨¼ì € ì „ì—­ì— ë“±ë¡í•˜ì—¬ ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë²„íŠ¼ì´ ë°˜ì‘í•˜ë„ë¡ í•¨ ===
        
        window.setMode = (mode) => {
            ['link', 'channel', 'history'].forEach(t => {
                const view = document.getElementById(`view-${t}`);
                const tab = document.getElementById(`tab-${t}`);
                if (t === mode) {
                    view.classList.remove('hidden');
                    tab.className = "flex-1 py-4 text-center font-bold text-sm md:text-base transition-colors border-b-2 border-brand-red text-brand-red bg-[#252525]";
                } else {
                    view.classList.add('hidden');
                    tab.className = "flex-1 py-4 text-center font-bold text-sm md:text-base transition-colors text-dark-muted hover:text-white border-b-2 border-transparent hover:bg-[#252525]";
                }
            });
            if(mode === 'history') {
                if(typeof window.filterHistory === 'function') window.filterHistory();
                else console.warn("filterHistory function is not loaded yet.");
            }
        };

        window.openApiModal = () => document.getElementById('apiModal').classList.add('active');
        window.closeApiModal = () => document.getElementById('apiModal').classList.remove('active');

        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        let app, auth, db, appId;
        
        // === Firebase ì´ˆê¸°í™” ë° ì•± ì‹¤í–‰ ===
        (async function initializeSystem() {
            let firebaseConfig = null;
            
            try {
                // 1. Canvas í™˜ê²½ ë³€ìˆ˜ í™•ì¸
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                } 
                // 2. ì™¸ë¶€ í™˜ê²½(GitHub/Local): firebase-config.json íŒŒì¼ ë¡œë“œ ì‹œë„ (ì´ë¦„ ë³€ê²½ ë°˜ì˜)
                else {
                    console.log("Detecting external environment. Looking for firebase-config.json...");
                    try {
                        const response = await fetch('./firebase-config.json');
                        if (response.ok) {
                            const configData = await response.json();
                            firebaseConfig = configData.config || configData; 
                            appId = configData.appId || 'github-web-app';
                            console.log("Config loaded from file.");
                        } else {
                            console.warn("firebase-config.json not found.");
                        }
                    } catch (e) {
                        console.warn("Failed to fetch config json:", e);
                    }
                }

                if (!firebaseConfig) {
                    console.error("Firebase Configuration is missing.");
                    const labelEl = document.getElementById('activeKeyLabel');
                    if(labelEl) labelEl.innerHTML = '<span class="text-red-500 font-bold">ì„¤ì • íŒŒì¼ ì—†ìŒ (firebase-config.json í•„ìš”)</span>';
                    // ì—¬ê¸°ì„œ returní•˜ë©´ DBê´€ë ¨ ê¸°ëŠ¥ë§Œ ì•ˆë˜ê³  UIëŠ” ì‘ë™í•´ì•¼ í•¨
                    return; 
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // ì „ì—­ ê°ì²´ì— í• ë‹¹ (ë‹¤ë¥¸ í•¨ìˆ˜ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡)
                window.db = db;
                window.auth = auth;
                window.appId = appId;

                // Auth ì‹œì‘
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Logged in as", user.uid);
                        window.currentUser = user;
                        window.dispatchEvent(new Event('auth-ready'));
                        // ë¡œê·¸ì¸ í›„ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹œë„
                        if(typeof window.loadApiConfig === 'function') await window.loadApiConfig();
                    }
                });

            } catch (error) {
                console.error("Initialization Error:", error);
                alert("ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (Console í™•ì¸ í•„ìš”)");
            }
        })();

        // Global State
        let currentMarkdownText = ""; 
        let currentVideoInfo = null; 
        let currentVideoId = null; 
        let currentAnalysisTimestamp = null; 
        let progressInterval; 
        let channelVideosCache = []; 
        let selectedVideoIds = new Set(); 
        let selectedHistoryIds = new Set(); 
        let currentChannelId = null; 
        let nextPageToken = null; 
        let currentHistoryKeys = [];
        let lastBatchZipBlob = null; 
        let lastBatchFilename = "";
        
        // API Management State
        let youtubeKeys = [];
        let geminiKeys = [];
        let activeYtId = null;
        let activeGeminiId = null;

        // History Sort State
        let historySortState = { key: 'timestamp', order: 'desc' };

        // --- Data Loading Functions ---
        window.loadApiConfig = async function() {
            if(!window.db) return;
            try {
                // Use imported 'doc' and 'getDoc' directly inside module scope is safer if window.doc fails
                // But here we use window properties set in init.
                const docRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'api_settings', 'config');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    youtubeKeys = data.youtubeKeys || [];
                    geminiKeys = data.geminiKeys || [];
                    activeYtId = data.activeYtId || null;
                    activeGeminiId = data.activeGeminiId || null;
                }
                updateApiModalUI();
            } catch (e) {
                console.error("Error loading API config:", e);
                // alert("API ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); // ë„ˆë¬´ ìì£¼ ëœ¨ë©´ ë¶ˆí¸í•˜ë¯€ë¡œ consoleë§Œ
            }
        }

        async function saveApiConfig() {
            if(!window.db) return alert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
            try {
                const docRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'api_settings', 'config');
                await setDoc(docRef, {
                    youtubeKeys,
                    geminiKeys,
                    activeYtId,
                    activeGeminiId,
                    updatedAt: serverTimestamp()
                });
                updateApiModalUI();
            } catch (e) {
                alert("ì„¤ì • ì €ì¥ ì‹¤íŒ¨: " + e.message);
                console.error(e);
            }
        }

        // type: 'yt' or 'gemini'
        window.saveKey = async function(type) {
            const aliasEl = document.getElementById(`alias_${type}`);
            const keyEl = document.getElementById(`key_${type}`);
            const editIdEl = document.getElementById(`editId_${type}`);
            
            const alias = aliasEl.value.trim();
            const key = keyEl.value.trim();
            const editId = editIdEl.value;

            if (!alias || !key) return alert("ë³„ì¹­ê³¼ í‚¤ ê°’ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            if (type === 'yt') {
                if(editId) {
                    const idx = youtubeKeys.findIndex(k => k.id === editId);
                    if(idx !== -1) youtubeKeys[idx] = { ...youtubeKeys[idx], alias, key };
                } else {
                    const newId = 'yt_' + Date.now();
                    youtubeKeys.push({ id: newId, alias, key });
                    if(!activeYtId) activeYtId = newId;
                }
            } else {
                if(editId) {
                    const idx = geminiKeys.findIndex(k => k.id === editId);
                    if(idx !== -1) geminiKeys[idx] = { ...geminiKeys[idx], alias, key };
                } else {
                    const newId = 'gem_' + Date.now();
                    geminiKeys.push({ id: newId, alias, key });
                    if(!activeGeminiId) activeGeminiId = newId;
                }
            }

            // Reset inputs
            aliasEl.value = '';
            keyEl.value = '';
            editIdEl.value = '';
            const btn = document.getElementById(`btnSave_${type}`);
            btn.innerText = "ì¶”ê°€í•˜ê¸°";
            btn.classList.remove("bg-green-600", "hover:bg-green-700");
            if(type==='yt') btn.classList.add("bg-brand-red", "hover:bg-red-600");
            else btn.classList.add("bg-brand-blue", "hover:bg-blue-600");

            await saveApiConfig();
        };

        window.deleteKey = async function(type, id) {
            if (!confirm("ì •ë§ë¡œ ì´ API í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
            
            if (type === 'yt') {
                youtubeKeys = youtubeKeys.filter(k => k.id !== id);
                if (activeYtId === id) activeYtId = youtubeKeys.length > 0 ? youtubeKeys[0].id : null;
            } else {
                geminiKeys = geminiKeys.filter(k => k.id !== id);
                if (activeGeminiId === id) activeGeminiId = geminiKeys.length > 0 ? geminiKeys[0].id : null;
            }
            await saveApiConfig();
        };

        window.setActiveKey = async function(type, id) {
            if (type === 'yt') activeYtId = id;
            else activeGeminiId = id;
            await saveApiConfig();
        };

        window.editKey = function(type, id) {
            const list = type === 'yt' ? youtubeKeys : geminiKeys;
            const item = list.find(k => k.id === id);
            if(!item) return;

            document.getElementById(`editId_${type}`).value = item.id;
            document.getElementById(`alias_${type}`).value = item.alias;
            document.getElementById(`key_${type}`).value = item.key;
            
            const btn = document.getElementById(`btnSave_${type}`);
            btn.innerText = "ìˆ˜ì • ë‚´ìš© ì €ì¥";
            btn.classList.remove("bg-brand-red", "bg-brand-blue", "hover:bg-red-600", "hover:bg-blue-600");
            btn.classList.add("bg-green-600", "hover:bg-green-700");
        };

        function updateApiModalUI() {
            // Render YouTube List
            const listYt = document.getElementById('list_yt');
            if (youtubeKeys.length === 0) listYt.innerHTML = '<div class="text-center text-gray-600 text-xs py-4">ì €ì¥ëœ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            else {
                listYt.innerHTML = youtubeKeys.map(k => `
                    <div class="bg-[#252525] border ${k.id === activeYtId ? 'border-brand-red bg-red-900/10' : 'border-dark-border'} rounded p-3 flex items-center justify-between group transition">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div onclick="setActiveKey('yt', '${k.id}')" class="cursor-pointer flex-shrink-0 w-5 h-5 rounded-full border border-gray-500 flex items-center justify-center ${k.id === activeYtId ? 'border-brand-red' : ''}">
                                ${k.id === activeYtId ? '<div class="w-3 h-3 rounded-full bg-brand-red"></div>' : ''}
                            </div>
                            <div class="text-sm overflow-hidden">
                                <div class="font-bold truncate ${k.id === activeYtId ? 'text-brand-red' : 'text-gray-300'}">${k.alias}</div>
                                <div class="text-xs text-gray-500 truncate">...${k.key.slice(-4)}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="editKey('yt', '${k.id}')" class="p-2 text-gray-500 hover:text-white transition" title="í¸ì§‘"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteKey('yt', '${k.id}')" class="p-2 text-gray-500 hover:text-red-500 transition" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            // Render Gemini List
            const listGemini = document.getElementById('list_gemini');
            if (geminiKeys.length === 0) listGemini.innerHTML = '<div class="text-center text-gray-600 text-xs py-4">ì €ì¥ëœ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            else {
                listGemini.innerHTML = geminiKeys.map(k => `
                    <div class="bg-[#252525] border ${k.id === activeGeminiId ? 'border-brand-blue bg-blue-900/10' : 'border-dark-border'} rounded p-3 flex items-center justify-between group transition">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div onclick="setActiveKey('gemini', '${k.id}')" class="cursor-pointer flex-shrink-0 w-5 h-5 rounded-full border border-gray-500 flex items-center justify-center ${k.id === activeGeminiId ? 'border-brand-blue' : ''}">
                                ${k.id === activeGeminiId ? '<div class="w-3 h-3 rounded-full bg-brand-blue"></div>' : ''}
                            </div>
                            <div class="text-sm overflow-hidden">
                                <div class="font-bold truncate ${k.id === activeGeminiId ? 'text-brand-blue' : 'text-gray-300'}">${k.alias}</div>
                                <div class="text-xs text-gray-500 truncate">...${k.key.slice(-4)}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="editKey('gemini', '${k.id}')" class="p-2 text-gray-500 hover:text-white transition" title="í¸ì§‘"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteKey('gemini', '${k.id}')" class="p-2 text-gray-500 hover:text-red-500 transition" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            // Update Label
            const labelEl = document.getElementById('activeKeyLabel');
            const activeYt = youtubeKeys.find(k => k.id === activeYtId);
            const activeGem = geminiKeys.find(k => k.id === activeGeminiId);
            
            if (activeYt && activeGem) {
                labelEl.innerHTML = `<span class="text-green-400"><i class="fas fa-check-circle mr-1"></i> ì¤€ë¹„ ì™„ë£Œ (${activeYt.alias} / ${activeGem.alias})</span>`;
            } else {
                labelEl.innerHTML = `<span class="text-red-400"><i class="fas fa-exclamation-triangle mr-1"></i> í‚¤ ì„¤ì • í•„ìš”</span>`;
            }
        }

        // --- Helpers ---
        function formatNumber(num) { return new Intl.NumberFormat('ko-KR').format(num); }
        function formatDate(isoString) { return new Date(isoString).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }); }
        function timeSince(isoString) { 
            const seconds = Math.floor((new Date() - new Date(isoString)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "ë…„ ì „";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "ê°œì›” ì „";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "ì¼ ì „";
            return "ë°©ê¸ˆ ì „";
        }
        function parseBold(text) { return text ? text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') : ""; }
        function sanitizeFilename(str) { return str.replace(/[\\/:*?"<>|]/g, "").replace(/\s+/g, "_"); }
        
        function getFormattedDate(dateObj) {
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${y}${m}${d}`;
        }

        function getReportFilename(videoInfo, analysisTs) {
            const analysisDate = getFormattedDate(new Date(analysisTs || Date.now()));
            const downloadDate = getFormattedDate(new Date());
            const safeChannel = sanitizeFilename(videoInfo.channelTitle);
            const safeTitle = sanitizeFilename(videoInfo.title);
            return `${safeChannel}_${safeTitle}_${analysisDate}_${downloadDate}.txt`;
        }

        function parseChannelInput(input) {
            if (!input) return "";
            if (input.includes('youtube.com/')) {
                const idMatch = input.match(/\/channel\/([^/?]+)/);
                if (idMatch) return idMatch[1];
                const handleMatch = input.match(/\/@([^/?]+)/);
                if (handleMatch) return handleMatch[1]; 
                const userMatch = input.match(/\/user\/([^/?]+)/);
                if (userMatch) return userMatch[1];
                const customMatch = input.match(/\/c\/([^/?]+)/);
                if (customMatch) return customMatch[1];
            }
            if (input.startsWith('@')) return input.substring(1);
            return input; 
        }

        // Updated getKeys to use separate logic
        window.getKeys = function() {
            if (!activeYtId || !activeGeminiId) {
                alert("YouTube ë˜ëŠ” Gemini API í‚¤ê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. [í‚¤ ê´€ë¦¬]ì—ì„œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
                window.openApiModal();
                return null;
            }
            const ytItem = youtubeKeys.find(k => k.id === activeYtId);
            const gemItem = geminiKeys.find(k => k.id === activeGeminiId);
            
            if (!ytItem || !gemItem) {
                alert("í™œì„±í™”ëœ í‚¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return null;
            }
            return { ytKey: ytItem.key, geminiKey: gemItem.key };
        }

        // --- Scroll Top ---
        window.addEventListener('scroll', () => {
            const btn = document.getElementById('scrollTopBtn');
            if (window.scrollY > 300) btn.classList.add('visible');
            else btn.classList.remove('visible');
        });

        // --- Loading Helpers ---
        function showLoading(text) {
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('statsDashboard').classList.add('hidden');
            document.getElementById('webReport').classList.add('hidden');
            updateLoadingText(0, text);
        }

        function updateLoadingText(percent, text) {
            const el = document.getElementById('loadingText');
            if(el) el.innerHTML = `${text} <span class="text-brand-red font-bold">(${Math.min(percent, 99)}%)</span>`;
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            if(progressInterval) clearInterval(progressInterval);
        }

        // --- Cloud History Logic ---
        
        window.saveAnalysis = async function(videoId, videoData, analysisData) {
            const timestamp = Date.now();
            try {
                if(!window.db) throw new Error("DB not initialized");
                const docRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'history', videoId);
                await setDoc(docRef, {
                    timestamp: timestamp,
                    video: videoData,
                    analysis: analysisData
                });
                
                if(document.getElementById('view-history').classList.contains('hidden') === false) {
                    window.filterHistory(); 
                }
            } catch(e) {
                console.error("Save failed:", e);
                alert("í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨: " + e.message);
            }
            return timestamp;
        }

        // --- History Management (Cloud) ---
        window.clearAllHistory = async function() {
            if(!confirm("ëª¨ë“  ë¶„ì„ ê¸°ë¡ì„ í´ë¼ìš°ë“œì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
            if(!window.db) return alert("DB ì—°ê²° ì•ˆë¨");

            try {
                const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'history'));
                const snapshot = await getDocs(q);
                
                snapshot.forEach(async (d) => {
                    await deleteDoc(d.ref);
                });
                
                selectedHistoryIds.clear();
                window.filterHistory();
                alert("ì‚­ì œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch(e) {
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜: " + e.message);
            }
        }

        window.deleteHistoryItem = async function(e, id) {
            e.stopPropagation();
            if(!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            if(!window.db) return alert("DB ì—°ê²° ì•ˆë¨");

            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'history', id));
                selectedHistoryIds.delete(id);
                window.filterHistory();
            } catch(e) {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
            }
        }

        window.fetchCloudHistory = async function() {
            if(!window.db) return {};
            document.getElementById('historyLoading').classList.remove('hidden');
            try {
                const q = query(
                    collection(window.db, 'artifacts', window.appId, 'public', 'data', 'history'),
                    orderBy('timestamp', 'desc')
                );
                const snapshot = await getDocs(q);
                const history = {};
                snapshot.forEach(doc => {
                    history[doc.id] = doc.data();
                });
                document.getElementById('historyLoading').classList.add('hidden');
                return history;
            } catch (e) {
                console.error(e);
                document.getElementById('historyLoading').classList.add('hidden');
                return {};
            }
        }

        // Sort Helper Function
        window.sortHistory = function(key) {
            if (historySortState.key === key) {
                // Toggle order
                historySortState.order = historySortState.order === 'asc' ? 'desc' : 'asc';
            } else {
                // New key, default to desc
                historySortState.key = key;
                historySortState.order = 'desc';
            }
            window.filterHistory(); // Re-filter and sort
        };

        window.filterHistory = async function() {
            const history = await window.fetchCloudHistory();
            const query = document.getElementById('historySearch').value.toLowerCase();
            let keys = Object.keys(history);
            
            // 1. Filter
            keys = keys.filter(k => {
                const item = history[k];
                if (!item || !item.video) return false;
                return item.video.title.toLowerCase().includes(query) || 
                       item.video.channelTitle.toLowerCase().includes(query);
            });

            // 2. Sort
            keys.sort((a, b) => {
                const itemA = history[a];
                const itemB = history[b];
                
                let valA, valB;

                switch(historySortState.key) {
                    case 'title':
                        valA = itemA.video.title;
                        valB = itemB.video.title;
                        return historySortState.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    case 'viewCount':
                        valA = parseInt(itemA.video.viewCount || 0);
                        valB = parseInt(itemB.video.viewCount || 0);
                        break;
                    case 'publishedAt':
                        valA = new Date(itemA.video.publishedAt).getTime();
                        valB = new Date(itemB.video.publishedAt).getTime();
                        break;
                    case 'timestamp':
                    default:
                        valA = itemA.timestamp;
                        valB = itemB.timestamp;
                        break;
                }

                if (valA < valB) return historySortState.order === 'asc' ? -1 : 1;
                if (valA > valB) return historySortState.order === 'asc' ? 1 : -1;
                return 0;
            });

            currentHistoryKeys = keys;
            renderHistoryTable(keys, history);
        }

        function renderHistoryTable(keys, history) {
            const container = document.getElementById('historyContainer');
            const noMsg = document.getElementById('noHistoryMsg');
            
            if (keys.length === 0) {
                container.classList.add('hidden');
                noMsg.classList.remove('hidden');
                window.updateHistoryBatchBtn(); 
                return;
            }
            
            container.classList.remove('hidden');
            noMsg.classList.add('hidden');

            // Helper to get sort icon class
            const getSortIcon = (key) => {
                if (historySortState.key !== key) return '<i class="fas fa-sort text-gray-600 ml-1"></i>';
                return historySortState.order === 'asc' 
                    ? '<i class="fas fa-sort-up text-brand-blue ml-1"></i>' 
                    : '<i class="fas fa-sort-down text-brand-blue ml-1"></i>';
            };

            let html = `
                <table class="w-full text-left history-table">
                    <thead>
                        <tr>
                            <th class="w-10 text-center">
                                <input type="checkbox" id="selectAllHistory" onchange="toggleAllHistorySelection()" class="custom-checkbox">
                            </th>
                            <th class="cursor-pointer hover:text-white transition-colors" onclick="sortHistory('title')">
                                ì˜ìƒ ì •ë³´ ${getSortIcon('title')}
                            </th>
                            <th class="cursor-pointer hover:text-white transition-colors" onclick="sortHistory('viewCount')">
                                í†µê³„ ${getSortIcon('viewCount')}
                            </th>
                            <th class="cursor-pointer hover:text-white transition-colors" onclick="sortHistory('publishedAt')">
                                ê²Œì‹œì¼ ${getSortIcon('publishedAt')}
                            </th>
                            <th class="cursor-pointer hover:text-white transition-colors" onclick="sortHistory('timestamp')">
                                ë¶„ì„ ì¼ì‹œ ${getSortIcon('timestamp')}
                            </th>
                            <th class="text-right">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            keys.forEach(id => {
                const item = history[id];
                const isSelected = selectedHistoryIds.has(id);
                if (!item || !item.video) return; 
                
                const filename = getReportFilename(item.video, item.timestamp);

                html += `
                    <tr class="cursor-pointer transition-colors ${isSelected ? 'bg-white/5' : ''}" onclick="loadSavedAnalysis('${id}')">
                        <td class="text-center" onclick="event.stopPropagation()">
                            <div class="flex justify-center">
                                <input type="checkbox" onchange="toggleHistorySelection('${id}')" ${isSelected ? 'checked' : ''} class="custom-checkbox">
                            </div>
                        </td>
                        <td>
                            <div class="font-bold text-white max-w-md truncate">${item.video.title}</div>
                            <div class="text-xs text-gray-400">${item.video.channelTitle}</div>
                        </td>
                        <td>
                            <div class="flex gap-3 text-xs text-gray-400">
                                <span title="ì¡°íšŒìˆ˜"><i class="fas fa-eye mr-1"></i>${formatNumber(item.video.viewCount)}</span>
                                <span title="ì¢‹ì•„ìš”"><i class="fas fa-thumbs-up mr-1"></i>${formatNumber(item.video.likeCount)}</span>
                                <span title="ëŒ“ê¸€"><i class="fas fa-comment mr-1"></i>${formatNumber(item.video.commentCount)}</span>
                            </div>
                        </td>
                        <td class="text-xs text-gray-400">${formatDate(item.video.publishedAt)}</td>
                        <td class="text-gray-500 text-xs">${new Date(item.timestamp).toLocaleString()}</td>
                        <td class="text-right">
                            <button onclick="downloadSavedReport(event, '${id}', '${filename}')" class="text-brand-blue hover:text-blue-400 mr-3" title="ë‹¤ìš´ë¡œë“œ"><i class="fas fa-download"></i></button>
                            <button onclick="deleteHistoryItem(event, '${id}')" class="text-dark-muted hover:text-red-500 transition-colors" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            
            const allCheckbox = document.getElementById('selectAllHistory');
            if(allCheckbox && keys.length > 0) {
                allCheckbox.checked = keys.every(k => selectedHistoryIds.has(k));
            }
            window.updateHistoryBatchBtn(); // Fixed: window.updateHistoryBatchBtn()
        }

        // --- Added Missing Function ---
        window.updateHistoryBatchBtn = function() {
            const btn = document.getElementById('btnHistoryBatchDown');
            if (!btn) return;
            btn.disabled = selectedHistoryIds.size === 0;
            btn.innerHTML = selectedHistoryIds.size > 0 ? 
                `<i class="fas fa-download mr-1"></i> ì„ íƒ ë‹¤ìš´ë¡œë“œ (${selectedHistoryIds.size})` : 
                `<i class="fas fa-download mr-1"></i> ì„ íƒ ë‹¤ìš´ë¡œë“œ`;
        };

        // --- Core Functions ---
        window.analyzeSingleVideo = async function() {
            const k = window.getKeys(); if (!k) return;
            const url = document.getElementById('videoUrl').value;
            const id = extractVideoId(url);
            if (!id) return alert("ì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ ë§í¬ê°€ ì•„ë‹™ë‹ˆë‹¤.");
            await window.runAnalysis(id, k);
        }

        window.runAnalysis = async function(id, k) {
            if(progressInterval) clearInterval(progressInterval);

            showLoading("ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘..."); 
            updateLoadingText(5, "ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...");

            try {
                const video = await window.fetchVideoDetails(id, k.ytKey);
                updateLoadingText(20, "ì˜ìƒ ì •ë³´ ìˆ˜ì§‘ ì™„ë£Œ");
                const comments = await window.fetchComments(id, k.ytKey);
                updateLoadingText(40, "ëŒ“ê¸€ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ");

                if (!video || !comments) throw new Error("ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨. API í‚¤ë‚˜ ì˜ìƒ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                
                window.renderStats(video); 
                
                let currentP = 40;
                progressInterval = setInterval(() => {
                    if(currentP < 95) {
                        currentP += Math.floor(Math.random() * 3) + 1; 
                        updateLoadingText(currentP, "AI ì‹¬ì¸µ ë¶„ì„ ë° ë²ˆì—­ ì§„í–‰ ì¤‘...");
                    }
                }, 500);

                const data = await window.analyzeWithGemini(video, comments, k.geminiKey);
                
                clearInterval(progressInterval);
                updateLoadingText(100, "ë¶„ì„ ì™„ë£Œ!");

                currentVideoInfo = video;
                currentVideoId = id; 
                const ts = await window.saveAnalysis(id, video, data);
                currentAnalysisTimestamp = ts; 

                setTimeout(() => {
                     hideLoading();
                     window.renderWebUI(data, id); 
                     const md = window.generateMarkdown(data, video);
                     currentMarkdownText = md;
                     // Raw Data rendering removed as requested
                     document.getElementById('webReport').scrollIntoView({behavior: 'smooth'});
                }, 500);

            } catch (e) {
                hideLoading();
                alert(e.message);
            }
        }

        window.analyzeWithGemini = async function(videoData, comments, apiKey) {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025", generationConfig: { responseMimeType: "application/json" } });

            const prompt = `
            ë„ˆëŠ” ìœ íŠœë¸Œ ë°ì´í„° ë° ì—¬ë¡  ë¶„ì„ ì „ë¬¸ê°€ì•¼. ì•„ë˜ ì˜ìƒ ì •ë³´ì™€ ëŒ“ê¸€ì„ ë¶„ì„í•˜ì—¬ JSON í˜•ì‹ìœ¼ë¡œ ë‹µí•´ì¤˜.
            
            **[ì¤‘ìš” ì§€ì¹¨]**
            1. **ë‹¤êµ­ì–´ ë²ˆì—­**: ë§Œì•½ ì˜ìƒ ì œëª©, ì„¤ëª…, ëŒ“ê¸€ì´ í•œêµ­ì–´ê°€ ì•„ë‹Œ ê²½ìš°(ì˜ì–´, ì¼ë³¸ì–´ ë“±), **ëª¨ë“  ë¶„ì„ ê²°ê³¼(ìš”ì•½, ë…¼ìŸ ë‚´ìš©, ì‹¬ë¦¬ ë¶„ì„ ë“±)ë¥¼ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì„œ** ì‘ì„±í•´ì¤˜.
            2. **ê°•ì¡° í‘œì‹œ**: ì¤‘ìš”í•œ ë¬¸ì¥ì´ë‚˜ í•µì‹¬ í‚¤ì›Œë“œëŠ” ë°˜ë“œì‹œ markdown bold(**í…ìŠ¤íŠ¸**)ì²˜ë¦¬ë¥¼ í•´ì¤˜.

            **[ì˜ìƒ ì •ë³´]**
            * ì œëª©: ${videoData.title}
            * ì±„ë„: ${videoData.channelTitle}
            * ê²Œì‹œì¼: ${videoData.publishedAt}
            * ì¡°íšŒìˆ˜: ${formatNumber(videoData.viewCount)}
            * ì¢‹ì•„ìš”: ${formatNumber(videoData.likeCount)}
            * ëŒ“ê¸€ìˆ˜: ${formatNumber(videoData.commentCount)}
            * ì„¤ëª…: ${videoData.description ? videoData.description.substring(0, 500) : 'ì—†ìŒ'}
            
            **[ëŒ“ê¸€ ë°ì´í„°]**
            ${comments.substring(0, 40000)}

            **[ë¶„ì„ ìš”ì²­ ì‚¬í•­ (JSON Key)]**
            1. summary: ì „ì²´ ìš”ì•½ (3~4ë¬¸ì¥). **í•µì‹¬ì€ ë³¼ë“œì²´**ë¡œ. (ì™¸êµ­ì–´ì¼ ê²½ìš° í•œêµ­ì–´ë¡œ ë²ˆì—­ í•„ìˆ˜)
            
            2. viral_analysis:
               - growth_trend: ì¡°íšŒìˆ˜ì™€ ê²Œì‹œê¸°ê°„ì„ ê³ ë ¤í•œ í˜„ì¬ ì„±ì¥ì„¸ ë¶„ì„ (ìˆ˜ì¹˜ í¬í•¨í•˜ì—¬ ì„¤ëª…).
               - engagement_rate: ì¢‹ì•„ìš”/ëŒ“ê¸€ ë¹„ìœ¨ ë“±ì„ ê³ ë ¤í•œ ì‹œì²­ì ì°¸ì—¬ë„(Engagement) ë¶„ì„.
               - subject_characteristics: ì£¼ì œ íŠ¹ì„±ìƒ ì™œ ë°”ì´ëŸ´ì´ ë˜ì—ˆëŠ”ì§€, ì•Œê³ ë¦¬ì¦˜ ì´ì  ë¶„ì„.

            3. content_type_analysis:
               - type: "Trend", "Seasonal", "Evergreen" ì¤‘ í•˜ë‚˜.
               - reason: ë¶„ë¥˜ ê·¼ê±°.
               - evergreen_type: (ì—ë²„ê·¸ë¦° ì‹œ) "Educational", "Listicle", "Glossary", "CaseStudy" ë“±.
               - maintenance: "Static" or "Sustainable".
               - strategy: ì—ë²„ê·¸ë¦° ì „ëµ ì¡°ì–¸. **í•µì‹¬ì€ ë³¼ë“œì²´**ë¡œ.
               - seo_keywords: SEO í‚¤ì›Œë“œ ë°°ì—´ (5ê°œ).

            4. controversy_deep_analysis: 
               ëŒ“ê¸€ ì˜ê²¬ì„ **ì°¬ì„±(ì˜ìƒ ì˜¹í˜¸/ë™ì˜)**, **ë°˜ëŒ€(ì˜ìƒ ë¹„íŒ/ë°˜ë°•)**, **ì¤‘ë¦½(ì œ3ì˜ ì‹œê°/ì ˆì¶©)**ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë¶„ì„.
               - pros: { title: "ì°¬ì„±ì¸¡ ì£¼ìš” ë…¼ë¦¬(**í•µì‹¬**)", examples: [{ user: "ì‘ì„±ìID", text: "ëŒ“ê¸€ ë‚´ìš© ìš”ì•½(í•œêµ­ì–´)" }, ...] }
               - cons: { title: "ë°˜ëŒ€ì¸¡ ì£¼ìš” ë…¼ë¦¬(**í•µì‹¬**)", examples: [{ user: "ì‘ì„±ìID", text: "ëŒ“ê¸€ ë‚´ìš© ìš”ì•½(í•œêµ­ì–´)" }, ...] }
               - neutral: { title: "ì¤‘ë¦½/ê¸°íƒ€ ë…¼ë¦¬(**í•µì‹¬**)", examples: [{ user: "ì‘ì„±ìID", text: "ëŒ“ê¸€ ë‚´ìš© ìš”ì•½(í•œêµ­ì–´)" }, ...] }

            5. psychology_analysis:
               - reason_for_enthusiasm: ì—´ê´‘ ì´ìœ  (í•´ë°©ê°, ì •ë‹¹ì„± ë¶€ì—¬ ë“±). **í•µì‹¬ ë‹¨ì–´ ë³¼ë“œì²´**.
               - reason_for_criticism: ë¹„íŒ ì´ìœ  (ë„ë•ì  ë¶„ë…¸, í˜„ì‹¤ì„± ë“±). **í•µì‹¬ ë‹¨ì–´ ë³¼ë“œì²´**.

            6. insight_analysis: ì„±ê³µ/ì‹¤íŒ¨ ìš”ì¸ ë¶„ì„. **í•µì‹¬ ë³¼ë“œì²´**.
            7. viewer_needs: ì‹œì²­ì ìš”êµ¬ì‚¬í•­.
            8. sentiment_analysis: ê°ì„± ë¶„ì„ ìƒì„¸.
            9. sentiment_pos_percent: ê¸ì • ë¹„ìœ¨ (ìˆ«ì 0~100).
            10. sentiment_neg_percent: ë¶€ì • ë¹„ìœ¨ (ìˆ«ì 0~100).
            
            11. best_comments_detailed: ëŒ“ê¸€ 5ê°œë¥¼ ì„ ì •í•˜ì—¬ ë‹¤ìŒ ê°ì²´ ë°°ì—´ë¡œ ë°˜í™˜. (ì™¸êµ­ì–´ ëŒ“ê¸€ì´ë©´ í•œêµ­ì–´ë¡œ ìš”ì•½ ë²ˆì—­)
               - type: ëŒ“ê¸€ì˜ í•µì‹¬ ìœ í˜• (ì˜ˆ: í•µì‹¬ ì£¼ì¥, ì‚¬íšŒ ë¹„íŒ, ë°˜ë¡ , í˜„ì‹¤ ëª¨ìˆœ, ê³µê° ë“±).
               - text: ëŒ“ê¸€ ë‚´ìš© (í•µì‹¬ ìš”ì•½).
               - author: ì‘ì„±ì ID.

            12. keywords_detailed: ì£¼ìš” í‚¤ì›Œë“œë¥¼ "í‚¤ì›Œë“œ (ë§¥ë½ì„¤ëª…)" í˜•íƒœë¡œ 5ê°œ ì´ìƒ ë°°ì—´.

            ì‘ë‹µì€ ì˜¤ì§ JSON ê°ì²´ë¡œë§Œ í•´ì¤˜.
            `;

            try {
                const result = await model.generateContent(prompt);
                return JSON.parse(result.response.text());
            } catch (e) { 
                let msg = e.message;
                if(msg.includes('429') || msg.includes('quota') || msg.includes('403')) {
                    throw new Error("Gemini API í• ë‹¹ëŸ‰ì„ ì´ˆê³¼í–ˆê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\nGemini API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ë³€ê²½í•´ì£¼ì„¸ìš”.");
                }
                throw new Error("Gemini API Error: " + msg); 
            }
        }

        // --- Channel & Batch Logic ---
        function updateBatchButton() {
            const btn = document.getElementById('btnBatchAnalyze');
            const countSpan = document.getElementById('selectedCount');
            const count = selectedVideoIds.size;
            
            countSpan.innerText = `${count}ê°œ ì„ íƒë¨`;
            
            btn.onclick = window.analyzeSelectedVideos;
            btn.classList.remove('bg-brand-green', 'hover:bg-emerald-600', 'bg-gray-500');
            btn.classList.add('bg-brand-blue', 'hover:bg-blue-600');
            btn.innerHTML = `<i class="fas fa-magic mr-1"></i> ì„ íƒ ì˜ìƒ ì¼ê´„ ë¶„ì„`;
            
            btn.disabled = count === 0;
            
            if(count > 0) {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        window.searchChannelVideos = async function() {
            const k = window.getKeys(); if (!k) return;
            let q = document.getElementById('channelHandle').value;
            if (!q) return alert("ì±„ë„ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-8 text-dark-muted"><div class="loader mb-2"></div>ì±„ë„ ê²€ìƒ‰ ë° ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</div>';
            document.getElementById('channelControls').classList.add('hidden');
            document.getElementById('loadMoreContainer').classList.add('hidden');
            document.getElementById('resultArea').classList.add('hidden'); 
            
            try {
                channelVideosCache = [];
                nextPageToken = null;
                selectedVideoIds.clear();
                updateBatchButton();

                let cid = q;
                const parsedQ = parseChannelInput(q);
                
                if (!q.startsWith('UC')) {
                    const s = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${parsedQ}&type=channel&key=${k.ytKey}`).then(r=>r.json());
                    if (!s.items?.length) throw new Error("ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    cid = s.items[0].id.channelId;
                }
                currentChannelId = cid;
                await window.fetchChannelVideosPage(k.ytKey);

            } catch (e) { grid.innerHTML = `<div class="col-span-full text-center text-brand-red font-bold">${e.message}</div>`; }
        }

        window.loadMoreChannelVideos = async function() {
            const k = window.getKeys(); if (!k) return;
            if (!currentChannelId) return;
            
            const btn = document.querySelector('#loadMoreContainer button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader w-4 h-4 border-2 border-white/30 border-t-white inline-block mr-2"></div> ë¡œë”© ì¤‘...';
            btn.disabled = true;

            try {
                await window.fetchChannelVideosPage(k.ytKey);
            } catch(e) {
                alert("ì¶”ê°€ ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        window.fetchChannelVideosPage = async function(apiKey) {
            const maxResults = 50; 
            let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${currentChannelId}&order=date&maxResults=${maxResults}&type=video&key=${apiKey}`;
            if (nextPageToken) url += `&pageToken=${nextPageToken}`;

            const vRes = await fetch(url);
            const vData = await vRes.json();
            
            if (!vData.items?.length) {
                if(channelVideosCache.length === 0) document.getElementById('videoGrid').innerHTML = 'No Videos';
                document.getElementById('loadMoreContainer').classList.add('hidden');
                return;
            }

            nextPageToken = vData.nextPageToken || null;
            if (nextPageToken) document.getElementById('loadMoreContainer').classList.remove('hidden');
            else document.getElementById('loadMoreContainer').classList.add('hidden');

            const videoIds = vData.items.map(i => i.id.videoId).join(',');
            const dRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${videoIds}&key=${apiKey}`);
            const dData = await dRes.json();

            const newItems = dData.items.map(item => ({
                id: item.id,
                snippet: item.snippet,
                statistics: item.statistics,
                viewCount: parseInt(item.statistics.viewCount || 0),
                likeCount: parseInt(item.statistics.likeCount || 0),
                commentCount: parseInt(item.statistics.commentCount || 0),
                date: new Date(item.snippet.publishedAt)
            }));

            channelVideosCache = [...channelVideosCache, ...newItems];
            document.getElementById('channelControls').classList.remove('hidden');
            window.sortChannelVideos(); 
        }

        window.analyzeSelectedVideos = async function() {
            const k = window.getKeys(); if (!k) return;
            const ids = Array.from(selectedVideoIds);
            if (ids.length === 0) return;

            if(!confirm(`${ids.length}ê°œì˜ ì˜ìƒì„ ìˆœì°¨ì ìœ¼ë¡œ ë¶„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‹œê°„ì´ ë‹¤ì†Œ ì†Œìš”ë  ìˆ˜ ìˆìœ¼ë©° API ì‚¬ìš©ëŸ‰ì´ ì¦ê°€í•©ë‹ˆë‹¤.`)) return;

            document.getElementById('resultArea').classList.add('hidden');
            
            const btn = document.getElementById('btnBatchAnalyze');
            btn.disabled = true;
            btn.classList.add('cursor-not-allowed', 'opacity-70');
            
            const zip = new JSZip();
            let successCount = 0;
            const batchDate = getFormattedDate(new Date());

            for (let i = 0; i < ids.length; i++) {
                const vid = ids[i];
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ë¶„ì„ ì¤‘ (${i + 1}/${ids.length})...`;

                try {
                    const video = await window.fetchVideoDetails(vid, k.ytKey);
                    const comments = await window.fetchComments(vid, k.ytKey);
                    
                    if (video && comments) {
                        await new Promise(r => setTimeout(r, 1500)); 
                        const analysis = await window.analyzeWithGemini(video, comments, k.geminiKey);
                        const ts = await window.saveAnalysis(vid, video, analysis);
                        const singleMd = window.generateMarkdown(analysis, video);
                        
                        const filename = getReportFilename(video, ts);
                        zip.file(filename, singleMd);
                        
                        successCount++;
                    }
                } catch (e) {
                    console.error(`Error analyzing ${vid}`, e);
                    zip.file(`Error_Log_${vid}.txt`, `Failed to analyze video ID ${vid}: ${e.message}`);
                }
            }

            const content = await zip.generateAsync({type:"blob"});
            lastBatchZipBlob = content;
            lastBatchFilename = `Batch_Analysis_${ids.length}Videos_${batchDate}.zip`;
            
            triggerDownloadBlob(lastBatchZipBlob, lastBatchFilename);
            
            btn.innerHTML = `<i class="fas fa-file-download mr-1"></i> ë¶„ì„ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (ZIP)`;
            btn.classList.remove('bg-brand-blue', 'hover:bg-blue-600', 'opacity-70', 'cursor-not-allowed');
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            btn.disabled = false;
            btn.onclick = () => triggerDownloadBlob(lastBatchZipBlob, lastBatchFilename);

            alert(`${successCount}/${ids.length}ê°œ ì˜ìƒ ë¶„ì„ ì™„ë£Œ. ZIP íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            selectedVideoIds.clear();
            window.renderChannelGrid(); 
        }

        // --- History Filter & Toggle ---
        window.toggleHistorySelection = async function(id) {
            if (selectedHistoryIds.has(id)) selectedHistoryIds.delete(id);
            else selectedHistoryIds.add(id);
            
            const allCheckbox = document.getElementById('selectAllHistory');
            if(allCheckbox) {
                const allSelected = currentHistoryKeys.length > 0 && currentHistoryKeys.every(k => selectedHistoryIds.has(k));
                allCheckbox.checked = allSelected;
            }
            window.updateHistoryBatchBtn();
        }

        window.toggleAllHistorySelection = async function() {
            const allCheckbox = document.getElementById('selectAllHistory');
            const isChecked = allCheckbox.checked;
            
            currentHistoryKeys.forEach(key => {
                if(isChecked) selectedHistoryIds.add(key);
                else selectedHistoryIds.delete(key);
            });
            
            window.filterHistory(); 
            window.updateHistoryBatchBtn();
        }

        window.downloadSelectedHistory = async function() {
            const ids = Array.from(selectedHistoryIds);
            if (ids.length === 0) return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
            
            const zip = new JSZip();
            const history = await window.fetchCloudHistory(); 
            const batchDate = getFormattedDate(new Date());
            let addedCount = 0;
            
            ids.forEach((vid) => {
                const item = history[vid];
                if(item) {
                    const md = window.generateMarkdown(item.analysis, item.video);
                    const filename = getReportFilename(item.video, item.timestamp);
                    zip.file(filename, md);
                    addedCount++;
                }
            });
            
            if (addedCount === 0) return alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

            const content = await zip.generateAsync({type:"blob"});
            const zipFilename = `History_Export_${ids.length}files_${batchDate}.zip`;
            
            triggerDownloadBlob(content, zipFilename);
        }

        window.loadSavedAnalysis = async function(videoId) {
            const history = await window.fetchCloudHistory();
            const saved = history[videoId];
            
            if(saved) {
                currentVideoInfo = saved.video;
                currentVideoId = videoId;
                currentAnalysisTimestamp = saved.timestamp;

                document.getElementById('resultArea').classList.remove('hidden');
                document.getElementById('webReport').classList.remove('hidden');
                // Removed Raw Data section display
                document.getElementById('statsDashboard').classList.remove('hidden');
                document.getElementById('loading').classList.add('hidden');
                window.renderStats(saved.video);
                window.renderWebUI(saved.analysis, videoId); 
                const md = window.generateMarkdown(saved.analysis, saved.video);
                currentMarkdownText = md;
                // Removed Raw Data rendering
                document.getElementById('resultArea').scrollIntoView({behavior: 'smooth'});
            }
        }

        window.downloadSavedReport = async function(e, videoId, filename) {
            e.stopPropagation();
            const history = await window.fetchCloudHistory();
            const saved = history[videoId];
            if (!saved) return alert("ë°ì´í„° ì—†ìŒ");
            const md = window.generateMarkdown(saved.analysis, saved.video);
            triggerDownload(md, filename);
        }

        window.sortChannelVideos = function() {
            const sortKey = document.getElementById('sortOption').value;
            const order = document.getElementById('orderOption').value;
            
            channelVideosCache.sort((a, b) => {
                let valA = sortKey === 'date' ? a.date : a[sortKey];
                let valB = sortKey === 'date' ? b.date : b[sortKey];
                return order === 'asc' ? valA - valB : valB - valA;
            });

            window.renderChannelGrid();
        }

        window.toggleVideoSelection = function(id) {
            if (selectedVideoIds.has(id)) selectedVideoIds.delete(id);
            else selectedVideoIds.add(id);
            window.renderChannelGrid(); 
            updateBatchButton();
        }

        window.runSingleAnalysisFromGrid = function(e, id) {
            e.stopPropagation();
            const keys = window.getKeys();
            if(!keys) return;
            
            const resultArea = document.getElementById('resultArea');
            resultArea.classList.remove('hidden');
            
            setTimeout(() => {
                resultArea.scrollIntoView({ behavior: 'smooth' });
            }, 100);

            window.runAnalysis(id, keys);
        }

        window.downloadReport = function() {
            if (!currentMarkdownText || !currentVideoInfo) return alert("ë‹¤ìš´ë¡œë“œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            const filename = getReportFilename(currentVideoInfo, currentAnalysisTimestamp);
            triggerDownload(currentMarkdownText, filename);
        };

        // --- Explicitly Assign renderChannelGrid to window ---
        window.renderChannelGrid = function() {
            const grid = document.getElementById('videoGrid');
            if (!grid) return; 
            grid.innerHTML = '';
            
            channelVideosCache.forEach(v => {
                const isSelected = selectedVideoIds.has(v.id);
                const borderClass = isSelected ? 'border-brand-blue ring-2 ring-brand-blue' : 'border-dark-border';
                
                const d = document.createElement('div');
                d.className = `bg-dark-card border ${borderClass} rounded-lg overflow-hidden cursor-pointer hover-card shadow-lg relative`;
                
                d.onclick = (e) => {
                    if(e.target.closest('.analyze-btn')) return;
                    window.toggleVideoSelection(v.id); 
                };

                d.innerHTML = `
                    <div class="absolute top-2 left-2 z-10">
                        <div class="custom-checkbox ${isSelected ? 'bg-brand-red border-brand-red' : 'bg-black/50 border-white/50'} w-6 h-6 rounded flex items-center justify-center text-white">
                            ${isSelected ? '<i class="fas fa-check text-xs"></i>' : ''}
                        </div>
                    </div>
                    <div class="relative aspect-video">
                        <img src="${v.snippet.thumbnails.medium.url}" class="w-full h-full object-cover opacity-90 hover:opacity-100 transition">
                        <button onclick="window.runSingleAnalysisFromGrid(event, '${v.id}')" class="analyze-btn absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 hover:opacity-100 transition group">
                            <span class="bg-brand-red text-white text-xs px-3 py-1.5 rounded font-bold transform translate-y-2 group-hover:translate-y-0 transition">ë‹¨ê±´ ë¶„ì„</span>
                        </button>
                    </div>
                    <div class="p-3">
                        <h4 class="font-bold text-sm text-gray-200 line-clamp-2 mb-2">${v.snippet.title}</h4>
                        <div class="flex justify-between text-xs text-dark-muted">
                            <span><i class="fas fa-eye mr-1"></i>${formatNumber(v.viewCount)}</span>
                            <span><i class="fas fa-comment mr-1"></i>${formatNumber(v.commentCount)}</span>
                        </div>
                        <div class="mt-1 text-xs text-gray-500">${new Date(v.snippet.publishedAt).toLocaleDateString()}</div>
                    </div>
                `;
                grid.appendChild(d);
            });
        }

        window.fetchVideoDetails = async function(videoId, apiKey) {
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${videoId}&key=${apiKey}`);
                const data = await res.json();
                
                if (data.error) {
                    if(data.error.code === 403) {
                         throw new Error("YouTube API í• ë‹¹ëŸ‰ì„ ì´ˆê³¼í–ˆê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\nYouTube API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ë³€ê²½í•´ì£¼ì„¸ìš”.");
                    }
                    throw new Error(data.error.message);
                }
                
                if (!data.items?.length) return null;
                return {
                    title: data.items[0].snippet.title,
                    channelTitle: data.items[0].snippet.channelTitle,
                    publishedAt: data.items[0].snippet.publishedAt,
                    viewCount: data.items[0].statistics.viewCount,
                    likeCount: data.items[0].statistics.likeCount,
                    commentCount: data.items[0].statistics.commentCount,
                    description: data.items[0].snippet.description
                };
            } catch(e) { throw e; }
        }

        window.fetchComments = async function(videoId, apiKey) {
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&maxResults=100&order=relevance&key=${apiKey}`);
                const data = await res.json();
                
                if (data.error) {
                    if(data.error.code === 403) {
                         throw new Error("YouTube API í• ë‹¹ëŸ‰ì„ ì´ˆê³¼í–ˆê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\nYouTube API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ë³€ê²½í•´ì£¼ì„¸ìš”.");
                    }
                    throw new Error(data.error.message);
                }

                return data.items ? data.items.map(i => `- ${i.snippet.topLevelComment.snippet.authorDisplayName}: ${i.snippet.topLevelComment.snippet.textDisplay.replace(/<br>/g, ' ')}`).join("\n") : null;
            } catch(e) { throw e; }
        }

        const extractVideoId = (url) => {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        function triggerDownload(content, filename) {
            const blob = new Blob([content], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function triggerDownloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        window.renderStats = function(data) {
            const dashboard = document.getElementById('statsDashboard');
            dashboard.classList.remove('hidden');
            dashboard.innerHTML = [
                { i: 'fa-eye', l: 'ì¡°íšŒìˆ˜', v: formatNumber(data.viewCount), c: 'text-brand-blue' },
                { i: 'fa-thumbs-up', l: 'ì¢‹ì•„ìš”', v: formatNumber(data.likeCount), c: 'text-brand-red' },
                { i: 'fa-comment-dots', l: 'ëŒ“ê¸€', v: formatNumber(data.commentCount), c: 'text-green-400' },
                { i: 'fa-calendar-alt', l: 'ê²Œì‹œì¼', v: formatDate(data.publishedAt), sub: timeSince(data.publishedAt), c: 'text-purple-400' }
            ].map(x => `
                <div class="bg-dark-card p-4 rounded-xl border border-dark-border shadow-md text-center hover-card">
                    <div class="${x.c} text-2xl mb-2"><i class="fas ${x.i}"></i></div>
                    <div class="text-xs text-dark-muted font-bold uppercase tracking-wide">${x.l}</div>
                    <div class="text-xl font-bold text-white mt-1">${x.v}</div>
                    ${x.sub ? `<div class="text-xs text-gray-500 mt-1">${x.sub}</div>` : ''}
                </div>
            `).join('');
        };

        window.renderWebUI = function(data, videoId) {
            document.getElementById('webReport').classList.remove('hidden');
            const setHtml = (id, text) => { 
                const el = document.getElementById(id);
                if(el) el.innerHTML = parseBold(text);
            };
            
            setHtml('ui-summary', data.summary);
            
            const d = document.getElementById('dynamicReportContent');
            const v = data.viral_analysis;
            const s = data.content_type_analysis;
            const c = data.controversy_deep_analysis;
            const fmt = (list) => (list||[]).map(e => `<div class="comment-quote"><span class="comment-author">${e.user}</span>"${e.text}"</div>`).join('');
            
            let html = '';

            if (videoId) {
                html += `
                    <div class="aspect-video w-full rounded-xl overflow-hidden shadow-lg mb-8 border border-dark-border bg-black">
                        <iframe class="w-full h-full" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                `;
            }

            html += `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-dark-card border border-dark-border p-6 rounded-xl hover-card">
                        <h4 class="font-bold text-brand-red mb-4 flex items-center text-lg"><i class="fas fa-chart-line mr-2"></i> ë°”ì´ëŸ´ ì„±ì¥ ë¶„ì„</h4>
                        <div class="space-y-4">
                            <div><div class="text-xs font-bold text-gray-500 uppercase mb-1">ì„±ì¥ ì¶”ì„¸</div><p class="text-sm text-gray-200">${parseBold(v.growth_trend)}</p></div>
                            <div><div class="text-xs font-bold text-gray-500 uppercase mb-1">ì‹œì²­ì ì°¸ì—¬ë„</div><p class="text-sm text-gray-200">${parseBold(v.engagement_rate)}</p></div>
                            <div><div class="text-xs font-bold text-gray-500 uppercase mb-1">ì•Œê³ ë¦¬ì¦˜ ì í•©ì„±</div><p class="text-sm text-gray-200">${parseBold(v.subject_characteristics)}</p></div>
                        </div>
                    </div>
                    <div class="bg-dark-card border border-dark-border p-6 rounded-xl hover-card">
                        <h4 class="font-bold text-green-500 mb-4 flex items-center text-lg"><i class="fas fa-compass mr-2"></i> ì½˜í…ì¸  ìœ í˜• & ì „ëµ</h4>
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="type-badge ${s.type === 'Trend' ? 'type-trend' : s.type === 'Evergreen' ? 'type-evergreen' : 'type-seasonal'}">
                                    ${s.type === 'Trend' ? '<i class="fas fa-bolt"></i> Trend' : s.type === 'Evergreen' ? '<i class="fas fa-tree"></i> Evergreen' : '<i class="fas fa-sun"></i> Seasonal'}
                                </span>
                                ${s.evergreen_type ? `<span class="text-xs text-gray-400 border border-gray-600 px-2 py-0.5 rounded">${s.evergreen_type}</span>` : ''}
                            </div>
                            <div><div class="text-xs font-bold text-gray-500 uppercase mb-1">ë¶„ë¥˜ ê·¼ê±°</div><p class="text-sm text-gray-400">${s.reason}</p></div>
                            <div class="bg-[#121212] p-3 rounded border border-dark-border mt-2"><div class="text-xs font-bold text-green-600 uppercase mb-1">ì „ëµ ì œì•ˆ</div><p class="text-sm text-gray-200 highlight-text">${parseBold(s.strategy)}</p></div>
                            <div class="mt-2"><span class="text-xs font-bold text-gray-500 mr-2">SEO ì¶”ì²œ:</span><span class="text-xs text-blue-400">${(s.seo_keywords || []).join(', ')}</span></div>
                        </div>
                    </div>
                </div>
                <div class="h-8"></div>
            `;

            html += `
                <div>
                    <h3 class="text-xl font-bold text-white mb-5 flex items-center"><i class="fas fa-comments text-brand-red mr-2"></i> ìŸì  ë° ë°˜ì‘</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-dark-card border border-dark-border rounded-xl p-5 hover-card"><h4 class="font-bold text-brand-blue mb-3 border-b border-dark-border pb-3">ğŸ‘ ì˜¹í˜¸</h4><p class="text-sm font-bold text-white mb-4">${parseBold(c.pros.title)}</p><div class="space-y-3">${fmt(c.pros.examples)}</div></div>
                        <div class="bg-dark-card border border-dark-border rounded-xl p-5 hover-card"><h4 class="font-bold text-brand-red mb-3 border-b border-dark-border pb-3">ğŸ‘ ë¹„íŒ</h4><p class="text-sm font-bold text-white mb-4">${parseBold(c.cons.title)}</p><div class="space-y-3">${fmt(c.cons.examples)}</div></div>
                        <div class="bg-dark-card border border-dark-border rounded-xl p-5 hover-card"><h4 class="font-bold text-dark-muted mb-3 border-b border-dark-border pb-3">âš–ï¸ ì¤‘ë¦½</h4><p class="text-sm font-bold text-white mb-4">${parseBold(c.neutral.title)}</p><div class="space-y-3">${fmt(c.neutral.examples)}</div></div>
                    </div>
                </div>
            `;

            html += `
                <div class="bg-[#121212] border border-dark-border p-6 rounded-xl mt-8">
                    <h4 class="font-bold text-white mb-5 flex items-center text-lg"><i class="fas fa-quote-left text-brand-red mr-3"></i> ë² ìŠ¤íŠ¸ ë°˜ì‘ (Top Pick)</h4>
                    <div class="overflow-x-auto rounded-lg border border-dark-border">
                        <table class="w-full text-left comment-table">
                            <thead><tr><th class="w-1/4">ìœ í˜•</th><th class="w-3/4">ë‚´ìš©</th></tr></thead>
                            <tbody>${(data.best_comments_detailed||[]).map(x => `<tr><td class="font-bold text-brand-blue">${x.type}</td><td>"${x.text}"<span class="block text-xs text-gray-500 mt-1">@${x.author}</span></td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>
            `;

            html += `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <div class="bg-dark-card border border-dark-border p-6 rounded-xl">
                        <h4 class="font-bold text-purple-400 mb-4 flex items-center text-lg"><i class="fas fa-brain mr-2"></i> ì‹¬ë¦¬ ë¶„ì„</h4>
                        <div class="space-y-5">
                            <div><div class="text-xs font-bold text-purple-500 uppercase mb-2">Why They Like It</div><p class="text-sm text-gray-300 bg-[#121212] p-4 rounded border border-dark-border highlight-text">${parseBold(data.psychology_analysis.reason_for_enthusiasm)}</p></div>
                            <div><div class="text-xs font-bold text-purple-500 uppercase mb-2">Why They Hate It</div><p class="text-sm text-gray-300 bg-[#121212] p-4 rounded border border-dark-border highlight-text">${parseBold(data.psychology_analysis.reason_for_criticism)}</p></div>
                        </div>
                    </div>
                    <div class="bg-dark-card border border-dark-border p-6 rounded-xl">
                        <h4 class="font-bold text-yellow-500 mb-4 flex items-center text-lg"><i class="fas fa-lightbulb mr-2"></i> ì„±ê³µ ìš”ì¸ & ë‹ˆì¦ˆ</h4>
                        <div class="space-y-5">
                            <div><div class="text-xs font-bold text-yellow-600 uppercase mb-2">Insight</div><p class="text-sm text-gray-300 bg-[#121212] p-4 rounded border border-dark-border highlight-text">${parseBold(data.insight_analysis)}</p></div>
                            <div><div class="text-xs font-bold text-yellow-600 uppercase mb-2">Needs</div><p class="text-sm text-gray-300 bg-[#121212] p-4 rounded border border-dark-border highlight-text">${parseBold(data.viewer_needs)}</p></div>
                        </div>
                    </div>
                </div>
            `;

            html += `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <div class="bg-dark-card border border-dark-border p-6 rounded-xl">
                        <h4 class="font-bold text-white mb-4">ğŸ“Š ê°ì„± ë¹„ìœ¨</h4>
                        <div class="flex justify-between text-sm text-dark-muted mb-2"><span class="text-brand-blue">ê¸ì • ${data.sentiment_pos_percent}%</span><span class="text-brand-red">ë¶€ì • ${data.sentiment_neg_percent}%</span></div>
                        <div class="w-full bg-[#121212] h-2 rounded-full overflow-hidden mb-4 border border-dark-border"><div class="h-full bg-gradient-to-r from-brand-blue to-brand-red" style="width:${data.sentiment_pos_percent}%"></div></div>
                        <p class="text-sm text-gray-400 highlight-text">${parseBold(data.sentiment_analysis)}</p>
                    </div>
                    <div class="bg-dark-card border border-dark-border p-6 rounded-xl">
                        <h4 class="font-bold text-white mb-4">ğŸ”‘ í•µì‹¬ í‚¤ì›Œë“œ</h4>
                        <div class="flex flex-wrap gap-2">${(data.keywords_detailed||[]).map(k=>`<span class="px-3 py-1 bg-[#252525] text-gray-300 rounded-full text-xs border border-dark-border">${k}</span>`).join('')}</div>
                    </div>
                </div>
            `;
            
            d.innerHTML = html;
        };

        window.generateMarkdown = (data, video) => {
            const v = data.viral_analysis, s = data.content_type_analysis, c = data.controversy_deep_analysis;
            const fmt = (ex) => ex.map(e => `  - **${e.user}**: "${e.text}"`).join('\n');
            const tbl = (data.best_comments_detailed||[]).map(x => `| ${x.type} | "${x.text}" (@${x.author}) |`).join('\n');

            return `# ğŸ¬ YouTube ì‹¬ì¸µ ë¶„ì„ ë¦¬í¬íŠ¸

## ğŸ“º ì˜ìƒ ì •ë³´
- ì œëª©: ${video.title}
- ì±„ë„: ${video.channelTitle}
- ê²Œì‹œì¼: ${formatDate(video.publishedAt)}
- í†µê³„: ì¡°íšŒìˆ˜ ${formatNumber(video.viewCount)} / ì¢‹ì•„ìš” ${formatNumber(video.likeCount)} / ëŒ“ê¸€ ${formatNumber(video.commentCount)}

---
## ğŸ“ˆ 1. ë°”ì´ëŸ´ ìš”ì¸ ë° ì„±ì¥ ì˜ˆì¸¡
- **ì„±ì¥ì„¸**: ${v.growth_trend}
- **ì°¸ì—¬ìœ¨**: ${v.engagement_rate}
- **ì•Œê³ ë¦¬ì¦˜**: ${v.subject_characteristics}

## ğŸ§­ 2. ì½˜í…ì¸  ì „ëµ ì§„ë‹¨
- **ìœ í˜•**: ${s.type} ${s.evergreen_type || ''}
- **ì „ëµ**: ${s.strategy}
- **SEO**: ${s.seo_keywords.join(', ')}

## âš”ï¸ 3. ì£¼ìš” ë…¼ìŸ ë° ì‹¤ì œ ë°˜ì‘
### ğŸ‘ ì°¬ì„± / ì˜¹í˜¸
**${c.pros.title}**
${fmt(c.pros.examples)}

### ğŸ‘ ë°˜ëŒ€ / ë¹„íŒ
**${c.cons.title}**
${fmt(c.cons.examples)}

### âš–ï¸ ì¤‘ë¦½ / ì ˆì¶©
**${c.neutral.title}**
${fmt(c.neutral.examples)}

## ğŸ’¡ 4. ë² ìŠ¤íŠ¸ ë°˜ì‘ ìš”ì•½
| ìœ í˜• | ë‚´ìš© |
|---|---|
${tbl}

## ğŸ§  5. ì‹œì²­ì ì‹¬ë¦¬ ë¶„ì„
- **ì—´ê´‘ ì´ìœ **: ${data.psychology_analysis.reason_for_enthusiasm}
- **ë¹„íŒ ì´ìœ **: ${data.psychology_analysis.reason_for_criticism}

## ğŸ“ 6. ìƒì„¸ ìš”ì•½ & ì¸ì‚¬ì´íŠ¸
**ìš”ì•½**: ${data.summary}
**ì„±ê³µ ìš”ì¸**: ${data.insight_analysis}
**ì‹œì²­ì ë‹ˆì¦ˆ**: ${data.viewer_needs}

## ğŸ“Š 7. ê°ì„± ë° í‚¤ì›Œë“œ
- ê¸ì •: ${data.sentiment_pos_percent}% / ë¶€ì •: ${data.sentiment_neg_percent}%
- ê°ì„± ë¶„ì„: ${data.sentiment_analysis}
- í‚¤ì›Œë“œ: ${data.keywords_detailed.join(', ')}

*Generated by YouTube Insight Pro*`;
        };

    </script>
</body>
</html>
