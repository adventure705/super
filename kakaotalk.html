<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ë‚´ìš© ë‚ ì§œë³„ ë¶„ë¦¬</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- JSZip for creating ZIP files (ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì€ ìœ ì§€í•˜ë˜, ê°œë³„ íŒŒì¼ ì €ì¥ì— ì‚¬ìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Phosphor Icons (for calendar/dark mode icon) -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/dist/umd/index.min.js"></script>
    <style>
        /* ë‹¤í¬ ëª¨ë“œ ê¸°ë³¸ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Gray-800 */
            min-height: 100vh;
            color: #d1d5db; /* Text-300 */
        }
        .container-card {
            background-color: #374151; /* Gray-700 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        .file-upload-box {
            border: 2px dashed #4b5563; /* Gray-600 */
            transition: all 0.2s;
        }
        .file-upload-box:hover {
            border-color: #6b7280; /* Gray-500 */
            background-color: #4a5568; /* Darker hover */
        }
        /* ì…ë ¥ í•„ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .dark-input {
            background-color: #1f2937; /* Gray-800 */
            border-color: #4b5563; /* Gray-600 */
            color: #f3f4f6; /* Text-50 */
        }
        .dark-input:focus {
            border-color: #60a5fa; /* Blue-400 */
            box-shadow: 0 0 0 1px #60a5fa;
        }
        /* date picker ì•„ì´ì½˜ì„ ìœ„í•œ ê°ì‹¸ëŠ” ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        /* YYYYMMDD í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œëŠ” ìˆ¨ê¸°ì§€ë§Œ ê°’ì„ ìœ ì§€ */
        #dateFrom, #dateTo {
             display: none; 
        }

        /* date input (type="date") ìŠ¤íƒ€ì¼ */
        .date-input-wrapper input[type="date"] {
            /* ë‚ ì§œ ì„ íƒ ì•„ì´ì½˜ì´ ì˜ ë³´ì´ë„ë¡ ë°°ê²½ìƒ‰ ì¡°ì • */
            background-color: #1f2937; 
            color: #f3f4f6;
            border-color: #4b5563;
        }
        .date-input-wrapper input[type="date"]:hover {
             cursor: pointer;
        }
        
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="container-card w-full max-w-2xl p-6 md:p-10 rounded-xl">
        <h1 class="text-4xl font-extrabold text-blue-300 mb-6 border-b border-gray-600 pb-3 drop-shadow-lg">
            ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ë‚´ìš© ë‚ ì§œë³„ ë¶„ë¦¬
        </h1>
        
        <!-- 1. íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="mb-8">
            <label class="block text-lg font-medium text-gray-300 mb-2">1. ì¹´ì¹´ì˜¤í†¡ TXT íŒŒì¼ ì—…ë¡œë“œ</label>
            <div class="file-upload-box flex flex-col items-center justify-center p-6 rounded-lg cursor-pointer">
                <svg class="w-10 h-10 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2a2 2 0 01-2 2h-1"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m-3-3l3 3m3-3l-3-3"></path></svg>
                <p id="fileNameDisplay" class="text-sm text-gray-400">íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš” (txt íŒŒì¼)</p>
                <input type="file" id="kakaoFile" accept=".txt" class="hidden" onchange="updateFileName(this)">
            </div>
            <p id="uploadError" class="text-sm text-red-400 mt-2 hidden">íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
        </div>

        <!-- 2. ê¸°ê°„ ì„¤ì • ë° íŒŒì¼ í˜•ì‹ ì„¹ì…˜ -->
        <div class="mb-8 p-6 bg-gray-600 rounded-lg">
            <h2 class="text-xl font-semibold text-gray-100 mb-4">2. ì¶”ì¶œ ì˜µì…˜ ì„¤ì •</h2>

            <!-- ë‚ ì§œ ê¸°ê°„ ì„¤ì • -->
            <div class="mb-4">
                <label class="block text-md font-medium text-gray-300 mb-2">ì¶”ì¶œ ê¸°ê°„ (ë‚ ì§œ ì„ íƒ)</label>
                <!-- ëª¨ë°”ì¼ ìµœì í™”ë¥¼ ìœ„í•´ ê¸°ë³¸ì€ ì„¸ë¡œ, sm ì´ìƒì—ì„œ ê°€ë¡œë¡œ ë³€ê²½ -->
                <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                    <!-- From Date Input with Date Picker -->
                    <div class="date-input-wrapper w-full">
                         <!-- dateFromPickerëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì´ëŠ” ë‹¬ë ¥ ì…ë ¥ í•„ë“œ -->
                         <input type="date" id="dateFromPicker" 
                                class="w-full p-3 border rounded-lg dark-input"
                                onchange="updateDateInput('dateFrom', this.value)">
                         <!-- dateFromì€ YYYYMMDD ê°’ì„ ì €ì¥í•˜ê³  ë¡œì§ì— ì‚¬ìš©ë¨ (display: none) -->
                        <input type="text" id="dateFrom" placeholder="ì‹œì‘ì¼ (YYYYMMDD)" maxlength="8"
                           class="w-full p-3 border rounded-lg dark-input"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    </div>

                    <span class="p-3 text-gray-400 sm:flex hidden items-center">~</span>
                    
                    <!-- To Date Input with Date Picker -->
                    <div class="date-input-wrapper w-full">
                         <!-- dateToPickerëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì´ëŠ” ë‹¬ë ¥ ì…ë ¥ í•„ë“œ -->
                        <input type="date" id="dateToPicker" 
                                class="w-full p-3 border rounded-lg dark-input"
                                onchange="updateDateInput('dateTo', this.value)">
                        <!-- dateToëŠ” YYYYMMDD ê°’ì„ ì €ì¥í•˜ê³  ë¡œì§ì— ì‚¬ìš©ë¨ (display: none) -->
                        <input type="text" id="dateTo" placeholder="ì¢…ë£Œì¼ (ì„ 9íƒ ì‚¬í•­)" maxlength="8"
                           class="w-full p-3 border rounded-lg dark-input"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    </div>
                </div>
                <p id="dateError" class="text-sm text-red-400 mt-2 hidden">ìœ íš¨í•œ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            </div>

            <!-- íŒŒì¼ í˜•ì‹ ì„ íƒ -->
            <div>
                <label class="block text-md font-medium text-gray-300 mb-2">ì¶”ì¶œ íŒŒì¼ í˜•ì‹</label>
                <div class="flex flex-col sm:flex-row sm:space-x-6 space-y-2 sm:space-y-0">
                    <label class="inline-flex items-center">
                        <input type="radio" name="fileType" value="txt" checked
                               class="form-radio h-5 w-5 text-blue-400 focus:ring-blue-400 bg-gray-700 border-gray-500">
                        <span class="ml-2 text-gray-300">TXT íŒŒì¼ (.txt)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="fileType" value="docx"
                               class="form-radio h-5 w-5 text-blue-400 focus:ring-blue-400 bg-gray-700 border-gray-500"
                               onchange="showDocxWarning()">
                        <span class="ml-2 text-gray-300">DOCX íŒŒì¼ (.docx)</span>
                    </label>
                </div>
                <p id="docxWarning" class="text-sm text-yellow-400 mt-2 hidden">
                    *DOCX ì„ íƒ ì‹œ: ë¸Œë¼ìš°ì €ì—ì„œëŠ” DOCX ìƒì„±ì— ì œí•œì´ ìˆì–´, ì„œì‹ì„ ìœ ì§€í•œ **.doc (HTML ê¸°ë°˜) íŒŒì¼**ë¡œ ì¶”ì¶œë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <!-- 3. ì¶”ì¶œ ì‹¤í–‰ ë²„íŠ¼ -->
        <div class="flex flex-col space-y-4">
            <button id="extractSelectedBtn" onclick="processFile('selected')"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg">
                <span class="flex items-center justify-center">
                    <i class="ph ph-calendar-check text-xl mr-2"></i>
                    ì„ íƒ ê¸°ê°„ ë‚ ì§œë³„ ì¶”ì¶œ (ê°œë³„ íŒŒì¼ ë‹¤ìš´ë¡œë“œ)
                </span>
            </button>
            <button id="extractAllBtn" onclick="processFile('all')"
                    class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg">
                <span class="flex items-center justify-center">
                    <i class="ph ph-list-numbers text-xl mr-2"></i>
                    ì „ì²´ ê¸°ê°„ ë‚ ì§œë³„ ì¶”ì¶œ (ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œ)
                </span>
            </button>
        </div>

        <!-- 4. ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="statusMessage" class="mt-6 p-4 rounded-lg text-center hidden"></div>
        
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        const fileInput = document.getElementById('kakaoFile');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const uploadError = document.getElementById('uploadError');
        const dateFromInput = document.getElementById('dateFrom'); // YYYYMMDD ì €ì¥
        const dateToInput = document.getElementById('dateTo');     // YYYYMMDD ì €ì¥
        const dateFromPicker = document.getElementById('dateFromPicker'); // Date Picker
        const dateToPicker = document.getElementById('dateToPicker');     // Date Picker
        const dateError = document.getElementById('dateError');
        const statusMessage = document.getElementById('statusMessage');
        const extractSelectedBtn = document.getElementById('extractSelectedBtn');
        const extractAllBtn = document.getElementById('extractAllBtn');
        const docxWarning = document.getElementById('docxWarning');
        
        /**
         * KST ê¸°ì¤€ ë‚ ì§œë¥¼ YYYYMMDDì™€ ISO í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
         * @param {number} offsetDays - ì˜¤ëŠ˜ ë‚ ì§œë¡œë¶€í„°ì˜ ì˜¤í”„ì…‹ (ì˜ˆ: ì–´ì œëŠ” -1)
         * @returns {{yyyymmdd: string, isoDate: string}} ë‚ ì§œ ê°ì²´
         */
        function getKSTDate(offsetDays = 0) {
            const now = new Date();
            // UTC ê¸°ì¤€ìœ¼ë¡œ KST (UTC+9)ë¡œ ë³€í™˜
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const kstOffset = 9 * 3600000; // 9 hours in milliseconds
            const kstDate = new Date(utc + kstOffset);
            
            // ë‚ ì§œ ì˜¤í”„ì…‹ ì ìš©
            if (offsetDays !== 0) {
                // setDate()ë¥¼ ì‚¬ìš©í•˜ë©´ ìœ¤ë…„ê³¼ ì›” ê²½ê³„ë¥¼ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                kstDate.setDate(kstDate.getDate() + offsetDays); 
            }

            const year = kstDate.getFullYear();
            const month = String(kstDate.getMonth() + 1).padStart(2, '0');
            const day = String(kstDate.getDate()).padStart(2, '0');
            
            return {
                yyyymmdd: `${year}${month}${day}`,
                isoDate: `${year}-${month}-${day}`
            };
        }

        // ì´ˆê¸°í™”: KST ì–´ì œ ë‚ ì§œë¡œ From í•„ë“œ ì„¤ì •
        document.addEventListener('DOMContentLoaded', () => {
            const yesterday = getKSTDate(-1); // ì–´ì œ ë‚ ì§œ (Offset -1)
            dateFromInput.value = yesterday.yyyymmdd;
            dateFromPicker.value = yesterday.isoDate; // Date pickerë„ ì„¤ì •
            // dateToëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë¹„ì›Œë‘ 
            dateToInput.value = '';
            dateToPicker.value = '';
        });
        
        // Date Pickerì™€ YYYYMMDD í…ìŠ¤íŠ¸ í•„ë“œ ì—°ë™ 
        function updateDateInput(targetId, isoDate) {
            const inputField = document.getElementById(targetId);
            if (isoDate) {
                // ISO ë‚ ì§œ (YYYY-MM-DD)ë¥¼ YYYYMMDDë¡œ ë³€í™˜
                const yyyymmdd = isoDate.replace(/-/g, '');
                inputField.value = yyyymmdd;
            } else {
                inputField.value = '';
            }
        }
        
        // DOCX ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ/ìˆ¨ê¸°ê¸°
        function showDocxWarning() {
            const fileType = document.querySelector('input[name="fileType"]:checked').value;
            if (fileType === 'docx') {
                docxWarning.classList.remove('hidden');
            } else {
                docxWarning.classList.add('hidden');
            }
        }

        // íŒŒì¼ ë“œë¡­ì¡´ í™œì„±í™”
        const dropZone = document.querySelector('.file-upload-box');
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-gray-500'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('bg-gray-500'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-gray-500');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                updateFileName(fileInput);
            }
        });

        // íŒŒì¼ëª… ì—…ë°ì´íŠ¸
        function updateFileName(input) {
            if (input.files.length > 0) {
                fileNameDisplay.textContent = `ì„ íƒëœ íŒŒì¼: ${input.files[0].name}`;
                uploadError.classList.add('hidden');
            } else {
                fileNameDisplay.textContent = 'íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš” (txt íŒŒì¼)';
            }
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-800', 'bg-green-800', 'bg-blue-800', 'text-red-300', 'text-green-300', 'text-blue-300');
            if (type === 'error') {
                statusMessage.classList.add('bg-red-800', 'text-red-300');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-800', 'text-green-300');
            } else {
                statusMessage.classList.add('bg-blue-800', 'text-blue-300');
            }
        }

        // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬ (YYYYMMDD í˜•ì‹)
        function isValidDate(dateStr) {
            if (!dateStr || dateStr.length !== 8) return false;
            const y = parseInt(dateStr.substring(0, 4), 10);
            const m = parseInt(dateStr.substring(4, 6), 10);
            const d = parseInt(dateStr.substring(6, 8), 10);
            
            if (m < 1 || m > 12 || d < 1 || d > 31) return false;

            const date = new Date(y, m - 1, d);
            return date.getFullYear() === y && date.getMonth() === m - 1 && date.getDate() === d;
        }
        
        // ì‚¬ìš©ìì—ê²Œ íŒŒì¼ì´ ì—¬ëŸ¬ ê°œ ë‹¤ìš´ë¡œë“œë  ê²ƒì„ì„ í™•ì¸ë°›ëŠ” ëª¨ë‹¬ ì—­í•  í•¨ìˆ˜
        function showConfirmModal(count, isZip) {
            // ZIP íŒŒì¼ì€ í•œ ë²ˆë§Œ ë‹¤ìš´ë¡œë“œë˜ë¯€ë¡œ í™•ì¸ ë¶ˆí•„ìš”
            if (isZip) {
                showStatus(`ğŸ“¦ ${count}ì¼ ë¶„ì˜ ëŒ€í™”ë¥¼ ZIP íŒŒì¼ë¡œ ì••ì¶• ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`, 'info');
                return Promise.resolve(true); 
            }
            // ê°œë³„ íŒŒì¼ì€ í™•ì¸ ë‹¨ê³„ ì—†ì´ ë°”ë¡œ ë‹¤ìš´ë¡œë“œ ì§„í–‰
            return new Promise((resolve) => {
                showStatus(`âš ï¸ ${count}ê°œì˜ ê°œë³„ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`, 'info');
                resolve(true); 
            });
        }
        
        // DOC íŒŒì¼ (HTML ê¸°ë°˜) ë‚´ìš© ìƒì„± í—¬í¼ í•¨ìˆ˜
        function generateDocContent(dateKey, rawContent) {
            // DOCX ì„ íƒ ì‹œ HTML êµ¬ì¡°ë¡œ ë˜í•‘í•˜ì—¬ Word í˜¸í™˜ì„±ì„ ë†’ì„
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${dateKey} ì¹´ì¹´ì˜¤í†¡ ëŒ€í™”</title>
</head>
<body style="font-family: Malgun Gothic, sans-serif; white-space: pre-wrap; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px;">
<div style="border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 20px;">
    <h1 style="font-size: 24px; color: #333;">ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ë‚´ìš© (${dateKey})</h1>
    <p style="font-size: 14px; color: #666;">íŒŒì¼ í˜•ì‹: HTML ê¸°ë°˜ (.doc)</p>
</div>
${rawContent.replace(/\n/g, '<br>')}
</body>
</html>
            `;
        }


        // ë©”ì¸ íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
        async function processFile(mode) {
            if (!fileInput.files.length) {
                uploadError.classList.remove('hidden');
                showStatus('ì²˜ë¦¬í•  ì¹´ì¹´ì˜¤í†¡ TXT íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™” (ë¡œë”© ìƒíƒœ)
            const originalSelectedText = extractSelectedBtn.innerHTML;
            const originalAllText = extractAllBtn.innerHTML;
            extractSelectedBtn.disabled = true;
            extractAllBtn.disabled = true;
            extractSelectedBtn.innerHTML = '<i class="ph ph-hourglass text-xl mr-2 animate-spin"></i> ì²˜ë¦¬ ì¤‘...';
            extractAllBtn.innerHTML = '<i class="ph ph-hourglass text-xl mr-2 animate-spin"></i> ì²˜ë¦¬ ì¤‘...';
            showStatus('íŒŒì¼ ë¶„ì„ ë° ì¶”ì¶œ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            dateError.classList.add('hidden');
            uploadError.classList.add('hidden');
            
            try {
                // dateFromInput, dateToInputì€ YYYYMMDD í…ìŠ¤íŠ¸ ê°’ì„ ìœ ì§€í•¨
                const dateFromStr = dateFromInput.value.trim();
                const dateToStr = dateToInput.value.trim();
                const selectedFileType = document.querySelector('input[name="fileType"]:checked').value;
                
                // 1. ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬ (ì„ íƒ ê¸°ê°„ ì¶”ì¶œ ëª¨ë“œì¼ ë•Œë§Œ)
                if (mode === 'selected') {
                    if (!dateFromStr) {
                         dateError.textContent = 'ì‹œì‘ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                         dateError.classList.remove('hidden');
                         showStatus('ì‹œì‘ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                         return;
                    }
                    if (dateFromStr && !isValidDate(dateFromStr)) {
                        dateError.textContent = 'ì‹œì‘ ë‚ ì§œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        dateError.classList.remove('hidden');
                        showStatus('ë‚ ì§œ ì…ë ¥ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                        return;
                    }
                    if (dateToStr && dateToStr.length > 0 && !isValidDate(dateToStr)) {
                        dateError.textContent = 'ì¢…ë£Œ ë‚ ì§œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        dateError.classList.remove('hidden');
                        showStatus('ë‚ ì§œ ì…ë ¥ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                        return;
                    }
                    
                    if (dateFromStr && dateToStr && dateToStr.length > 0 && dateFromStr > dateToStr) {
                         dateError.textContent = 'ì‹œì‘ ë‚ ì§œê°€ ì¢…ë£Œ ë‚ ì§œë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                        dateError.classList.remove('hidden');
                        showStatus('ë‚ ì§œ ì…ë ¥ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                        return;
                    }
                }

                // 2. íŒŒì¼ ë‚´ìš© ì½ê¸°
                const file = fileInput.files[0];
                const fileText = await file.text();
                
                // 3. ë‚ ì§œë³„ ëŒ€í™” ë‚´ìš© ë¶„ë¦¬ (í•µì‹¬ ë¡œì§)
                const chatsByDate = parseKakaoChat(fileText);
                
                // 4. í•„í„°ë§ ë¡œì§ ì ìš©
                let filteredDates = Object.keys(chatsByDate);
                let filterTitle = 'ì „ì²´ ê¸°ê°„';

                if (mode === 'selected') {
                    if (dateFromStr) {
                        filteredDates = filterDates(filteredDates, dateFromStr, dateToStr);
                        
                        const formatDisplayDate = (dateStr) => {
                             if (!dateStr || dateStr.length !== 8) return '';
                             return `${dateStr.substring(0, 4)}ë…„ ${dateStr.substring(4, 6)}ì›” ${dateStr.substring(6, 8)}ì¼`;
                        }

                        if (dateToStr && dateToStr.length > 0) {
                             filterTitle = `${formatDisplayDate(dateFromStr)} ~ ${formatDisplayDate(dateToStr)}`;
                        } else {
                            filterTitle = `${formatDisplayDate(dateFromStr)} ë‹¨ì¼ ë‚ ì§œ`;
                        }
                    } else {
                        // dateFromStrì´ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ì¶”ì¶œ ëª¨ë“œë¡œ ê°„ì£¼
                        mode = 'all'; 
                    }
                }
                
                if (filteredDates.length === 0) {
                    showStatus(`ì„ íƒí•˜ì‹  ê¸°ê°„ (${filterTitle}) ë‚´ì— ì¶”ì¶œí•  ëŒ€í™” ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.`, 'error');
                    return;
                }
                
                // 5. ë‹¤ìš´ë¡œë“œ í™•ì¸ ë° ì‹¤í–‰
                // modeê°€ 'all'ì¼ ë•Œë§Œ isZip: true ì „ë‹¬
                await showConfirmModal(filteredDates.length, mode === 'all');
                
                let downloadedCount = 0;
                
                const fileExtension = selectedFileType === 'docx' ? '.doc' : '.txt';
                const mimeType = selectedFileType === 'docx' ? 'text/html;charset=utf-8' : 'text/plain;charset=utf-8';

                // --- ë‹¤ìš´ë¡œë“œ ë¡œì§ ë¶„ê¸° ---
                if (mode === 'all') {
                    // 6a. ì „ì²´ ê¸°ê°„ ì¶”ì¶œ: ZIP íŒŒì¼ë¡œ ì••ì¶• ë° ë‹¤ìš´ë¡œë“œ
                    const zip = new JSZip();
                    
                    filteredDates.forEach(dateKey => {
                        const rawContent = chatsByDate[dateKey];
                        let finalContent;
                        
                        if (selectedFileType === 'docx') {
                            finalContent = generateDocContent(dateKey, rawContent);
                        } else {
                            finalContent = rawContent;
                        }
                        
                        const fileName = `${dateKey}_ì¹´í†¡ëŒ€í™”${fileExtension}`;
                        zip.file(fileName, finalContent);
                    });
                    
                    const zipFileName = `ì¹´ì¹´ì˜¤í†¡_ëŒ€í™”_ì „ì²´_ì¶”ì¶œ_${getKSTDate().yyyymmdd}.zip`;
                    zip.generateAsync({type:"blob"}).then(function(content) {
                        saveAs(content, zipFileName);
                        showStatus(`âœ… ëŒ€í™” ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìœ¼ë©°, ${filteredDates.length}ì¼ ë¶„ì´ ZIP íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    });
                    
                } else {
                    // 6b. ì„ íƒ ê¸°ê°„ ì¶”ì¶œ: ê°œë³„ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    
                    filteredDates.forEach(dateKey => {
                        const rawContent = chatsByDate[dateKey];
                        let finalContent;
                        
                        if (selectedFileType === 'docx') {
                            finalContent = generateDocContent(dateKey, rawContent);
                        } else {
                            finalContent = rawContent;
                        }
                        
                        const fileName = `${dateKey}_ì¹´í†¡ëŒ€í™”${fileExtension}`;
                        const blob = new Blob([finalContent], { type: mimeType });
                        
                        // FileSaver.jsë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ì €ì¥ (ê°œë³„ ë‹¤ìš´ë¡œë“œ)
                        saveAs(blob, fileName);
                        downloadedCount++;
                    });
                    
                    showStatus(`âœ… ëŒ€í™” ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìœ¼ë©°, ${downloadedCount}ê°œì˜ íŒŒì¼ì´ ê°œë³„ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }

            } catch (error) {
                console.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                showStatus(`âŒ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                extractSelectedBtn.disabled = false;
                extractAllBtn.disabled = false;
                extractSelectedBtn.innerHTML = originalSelectedText;
                extractAllBtn.innerHTML = originalAllText;
            }
        }

        /**
         * ì¹´ì¹´ì˜¤í†¡ TXT íŒŒì¼ ë‚´ìš©ì„ ë‚ ì§œë³„ë¡œ ë¶„ë¦¬í•˜ëŠ” í•¨ìˆ˜
         * @param {string} fileText - TXT íŒŒì¼ì˜ ì „ì²´ ë‚´ìš©
         * @returns {Object<string, string>} { 'YYYYMMDD': 'ëŒ€í™” ë‚´ìš©' } í˜•íƒœì˜ ê°ì²´
         */
        function parseKakaoChat(fileText) {
            const chatsByDate = {};
            // ìš”ì²­ëœ í˜•ì‹ì˜ ë‚ ì§œ êµ¬ë¶„ì„  Regex: ^--------------- YYYYë…„ MMì›” DDì¼ ìš”ì¼ ---------------$
            const dateSeparatorRegex = /^--------------- (\d{4})ë…„ (\d{1,2})ì›” (\d{1,2})ì¼ [ì›”í™”ìˆ˜ëª©ê¸ˆí† ì¼]ìš”ì¼ ---------------$/gm;
            
            // ëª¨ë“  ë‚ ì§œ êµ¬ë¶„ì„ ì„ ê¸°ì¤€ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¥¼ ë¶„í•  (ìº¡ì²˜ ê·¸ë£¹ í¬í•¨)
            const parts = fileText.split(dateSeparatorRegex);
            
            // 0: í—¤ë”, 1: YYYY, 2: MM, 3: DD, 4: Content, 5: YYYY, ...
            for (let i = 1; i < parts.length; i += 4) {
                const year = parts[i].padStart(4, '0');
                const month = parts[i + 1].padStart(2, '0');
                const day = parts[i + 2].padStart(2, '0');
                const content = parts[i + 3].trim(); 
                const dateKey = `${year}${month}${day}`;

                if (content.length > 0) {
                    // ì¶”ì¶œ íŒŒì¼ì— ë‚ ì§œ í—¤ë” ì¬êµ¬ì„±í•˜ì—¬ ì¶”ê°€
                    const dateHeader = `--------------- ${year}ë…„ ${month}ì›” ${day}ì¼ ì¶”ì¶œëœ ëŒ€í™” ë‚´ìš© ---------------\n\n`;
                    chatsByDate[dateKey] = dateHeader + content;
                }
            }
            
            return chatsByDate;
        }

        /**
         * ì§€ì •ëœ ê¸°ê°„ì— ì†í•˜ëŠ” ë‚ ì§œ í‚¤ë§Œ í•„í„°ë§í•˜ëŠ” í•¨ìˆ˜
         * @param {string[]} allDates - ëª¨ë“  ë‚ ì§œ í‚¤ (YYYYMMDD) ë°°ì—´
         * @param {string} dateFromStr - ì‹œì‘ ë‚ ì§œ (YYYYMMDD)
         * @param {string} [dateToStr=''] - ì¢…ë£Œ ë‚ ì§œ (YYYYMMDD)
         * @returns {string[]} í•„í„°ë§ëœ ë‚ ì§œ í‚¤ ë°°ì—´
         */
        function filterDates(allDates, dateFromStr, dateToStr = '') {
            dateToStr = dateToStr || dateFromStr; // ì¢…ë£Œì¼ì´ ì—†ìœ¼ë©´ ì‹œì‘ì¼ë§Œ ì¶”ì¶œ
            
            return allDates
                .filter(dateKey => dateKey >= dateFromStr && dateKey <= dateToStr)
                .sort(); // ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬
        }
    </script>
</body>
</html>
