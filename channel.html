<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> ğŸ“º YouTube ì±„ë„ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ë° ë‹¤í¬ ëª¨ë“œ */
        :root {
            font-family: 'Inter', sans-serif;
            --color-bg-primary: #111827; /* Dark Gray 900 */
            --color-text-primary: #f3f4f6; /* Light Gray 100 */
            --color-accent-primary: #4f46e5; /* Indigo 600 */
            --color-accent-secondary: #a5b4fc; /* Indigo 300 for hover text/links */
            --color-border: #374151; /* Gray 700 */
        }
        body {
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
        }
        .container {
            max-width: 1400px;
        }
        .header-cell {
            cursor: pointer;
            padding: 0.75rem 0.5rem;
            text-align: left;
            user-select: none;
            transition: color 0.2s;
            white-space: nowrap;
        }
        .header-cell:hover {
            color: var(--color-accent-secondary);
        }
        .scrollable-table {
            overflow-x: auto;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        /* Tailwind configuration for custom colors/styles */
        .tailwind-config {
            @apply bg-gray-900 text-gray-100;
        }
        /* API ì„¤ì • ë²„íŠ¼ ìœ„ì¹˜ ê³ ì • */
        #api-settings-button {
             z-index: 40; /* ëª¨ë‹¬ ì•„ë˜, ë‹¤ë¥¸ UI ìœ„ì— ìœ„ì¹˜ */
        }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ë° ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // ë°ì´í„° ê²½ë¡œëŠ” artifacts/{appId}/public/data/{collectionName} ì…ë‹ˆë‹¤.

        let app, db, auth;
        let isAuthReady = false;
        
        // --- API Key LocalStorage ì´ˆê¸°í™” ë° ìƒíƒœ ê´€ë¦¬ í—¬í¼ (Firestoreë¡œ ëŒ€ì²´ë¨) ---
        // ì´ì „ localStorage ê°’ì€ ì œê±°
        localStorage.removeItem('youtubeApiKeys');
        localStorage.removeItem('activeApiKeyName');
        
        const getActiveApiKey = (keys, activeName) => keys.find(k => k.name === activeName)?.key || '';

        // ìƒíƒœ ê´€ë¦¬
        window.state = {
            channels: [],
            categories: ['ë¯¸ë¶„ë¥˜'], // ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬
            categoryColors: {}, // { 'ì¹´í…Œê³ ë¦¬ëª…': 'bg-red-700', ... }
            
            // API Key ìƒíƒœ (Firestoreì—ì„œ ë¡œë“œ)
            apiKeys: [],
            activeApiKeyName: '',
            youtubeApiKey: '', // Derived active key

            currentSort: { key: 'subscribers', direction: 'desc' },
            searchTerm: '',
            categoryFilter: 'ì „ì²´',
            // ytCategoryFilter ì œê±°ë¨
            isCategoryModalOpen: false,
            isApiModalOpen: false, // API ëª¨ë‹¬ ìƒíƒœ ì¶”ê°€
            
            // API í‚¤ í¸ì§‘ ìƒíƒœ
            editingApiKey: { name: null, key: null, originalName: null },
            
            editingCategoryName: null,
            editingCategoryNewName: '',
            editingChannelMemoId: null,
            editingChannelMemoValue: '',
            
            // -- New states for channel category selection --
            editingChannelCategory: { id: null, current: null },
            isChannelCategoryModalOpen: false,
        };
        
        // Firestore ì—…ë°ì´íŠ¸ í›„ ìƒíƒœë¥¼ ë¡œì»¬ì—ì„œ ì§ì ‘ ì—…ë°ì´íŠ¸í•˜ëŠ” ëŒ€ì‹ ,
        // Firestore ë¦¬ìŠ¤ë„ˆë¥¼ í†µí•´ ìƒíƒœê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ë„ë¡ í•©ë‹ˆë‹¤.
        const updateApiStorage = async (newKeys, newActiveName) => {
            const apiSettingsDocRef = doc(db, `artifacts/${appId}/public/data/api_settings`, 'keys');
            try {
                await setDoc(apiSettingsDocRef, {
                    apiKeys: newKeys,
                    activeApiKeyName: newActiveName
                });
            } catch (error) {
                console.error("API ì„¤ì • Firestore ì €ì¥ ì˜¤ë¥˜:", error);
                alertModal("ì˜¤ë¥˜", "API ì„¤ì • ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        };

        // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë§¤í•‘ ë³´ì¥ í•¨ìˆ˜
        const ensureCategoryColors = () => {
            // ë‹¤ì–‘í•œ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.
            const palette = ['red', 'green', 'blue', 'yellow', 'purple', 'indigo', 'pink', 'teal'];
            const colorClasses = palette.map(p => `bg-${p}-700`);
            
            const newColors = { ...window.state.categoryColors, 'ë¯¸ë¶„ë¥˜': 'bg-gray-700' };
            const usedColors = new Set(['bg-gray-700']);
            let colorIndex = 0;

            for (const cat of window.state.categories) {
                if (cat === 'ë¯¸ë¶„ë¥˜') continue;

                if (!newColors[cat] || !usedColors.has(newColors[cat])) {
                    // ìƒˆ ì¹´í…Œê³ ë¦¬ì´ê±°ë‚˜, ì´ì „ì— í• ë‹¹ë˜ì—ˆë”ë¼ë„ í˜„ì¬ íŒ”ë ˆíŠ¸ì— ì—†ê³  ê²¹ì¹˜ì§€ ì•Šê²Œ ìƒˆë¡œ í• ë‹¹
                    let newColorClass = colorClasses[colorIndex % colorClasses.length];
                    
                    // ì´ë¯¸ í• ë‹¹ëœ ìƒ‰ìƒì´ ìˆë‹¤ë©´ ì¸ë±ìŠ¤ë¥¼ ì¦ê°€ì‹œì¼œ ë‹¤ìŒ ìƒ‰ìƒì„ ì°¾ìŠµë‹ˆë‹¤.
                    while (usedColors.has(newColorClass) && colorIndex < colorClasses.length * 2) { 
                         colorIndex++;
                         newColorClass = colorClasses[colorIndex % colorClasses.length];
                    }
                    
                    newColors[cat] = newColorClass;
                    usedColors.add(newColorClass);
                    colorIndex++; // ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ë¥¼ ìœ„í•´ ì¸ë±ìŠ¤ ì¦ê°€
                } else {
                    // ê¸°ì¡´ ìƒ‰ìƒ ìœ ì§€
                    usedColors.add(newColors[cat]);
                }
            }
            
            window.state.categoryColors = newColors;
        };


        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë Œë”ë§)
        const render = () => {
            if (!isAuthReady) return;

            ensureCategoryColors(); // ì¹´í…Œê³ ë¦¬ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ìƒ‰ìƒ ë§µì„ ê°±ì‹ 
            
            const { channels, categories, currentSort, searchTerm, categoryFilter } = window.state;

            // 1. í•„í„°ë§
            let filtered = channels.filter(channel => {
                const searchMatch = searchTerm.toLowerCase();
                
                // ê²€ìƒ‰ì–´ í•„í„° (ë¦¬ìŠ¤íŠ¸ì— ë³´ì´ëŠ” ëª¨ë“  í•„ë“œ í¬í•¨)
                // Date ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ê²€ìƒ‰ ë²”ìœ„ì— í¬í•¨
                const textContent = [
                    channel.channelName,
                    channel.note,
                    channel.country,
                    channel.customCategory,
                    // channel.ytCategory ì œê±°ë¨
                    channel.subscribers ? channel.subscribers.toString() : '',
                    channel.totalViews ? channel.totalViews.toString() : '',
                    channel.totalVideos ? channel.totalVideos.toString() : '',
                    channel.channelCreationDate ? new Date(channel.channelCreationDate).toLocaleDateString('ko-KR') : '',
                    channel.oldestVideoPostDate ? new Date(channel.oldestVideoPostDate).toLocaleDateString('ko-KR') : '',
                    channel.avgUploadFreqDays ? channel.avgUploadFreqDays.toString() : '',
                    channel.avgViews90d ? channel.avgViews90d.toString() : '',
                    channel.avgLikes90d ? channel.avgLikes90d.toString() : '',
                    channel.avgComments90d ? channel.avgComments90d.toString() : '',
                ].join(' ').toLowerCase();

                if (searchTerm && !textContent.includes(searchMatch)) return false;

                // ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬ í•„í„°
                if (categoryFilter !== 'ì „ì²´' && channel.customCategory !== categoryFilter) return false;

                // ê¸°ì¡´ YouTube ì¹´í…Œê³ ë¦¬ í•„í„° ë¡œì§ ì œê±°
                // if (ytCategoryFilter !== 'ì „ì²´' && channel.ytCategory !== ytCategoryFilter) return false;

                return true;
            });

            // 2. ì •ë ¬
            filtered.sort((a, b) => {
                const aVal = a[currentSort.key];
                const bVal = b[currentSort.key];

                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                else if (aVal < bVal) comparison = -1;

                return currentSort.direction === 'asc' ? comparison : comparison * -1;
            });

            // 3. UI ë Œë”ë§
            renderTable(filtered);
            renderFilters(channels, categories);
            renderCategoryModal();
            renderApiSettingsModal(); // API ëª¨ë‹¬ ë Œë”ë§ ì¶”ê°€
            renderChannelCategorySelectionModal(); // ìƒˆ ì±„ë„ ì¹´í…Œê³ ë¦¬ ì„ íƒ ëª¨ë‹¬ ë Œë”ë§ ì¶”ê°€
        };

        // ê²½ê³¼ ì‹œê°„ ê³„ì‚° í—¬í¼ í•¨ìˆ˜
        const calculateElapsedTime = (dateString) => {
            if (!dateString) return 'N/A';
            const now = new Date();
            const start = new Date(dateString);
            const diffTime = Math.abs(now - start);
            const diffYears = now.getFullYear() - start.getFullYear();
            const diffMonths = now.getMonth() - start.getMonth();
            
            let totalMonths = diffYears * 12 + diffMonths;
            if (now.getDate() < start.getDate()) {
                totalMonths--;
            }

            const years = Math.floor(totalMonths / 12);
            const months = totalMonths % 12;

            return `${years}ë…„ ${months}ê°œì›”`;
        };
        
        // ì—…ë¡œë“œ ì£¼ê¸° í‘œì‹œ í—¬í¼ í•¨ìˆ˜
        const formatUploadFrequency = (avgDays, totalVideos) => {
            if (!avgDays || totalVideos <= 0 || isNaN(parseFloat(avgDays))) return 'N/A';
            
            const numAvgDays = parseFloat(avgDays);
            
            // í‰ê·  ì—…ë¡œë“œ ì£¼ê¸°(ì¼)ì´ 1ì¼ ë¯¸ë§Œì¸ ê²½ìš° (ì˜ˆ: 0.5ì¼) ì²˜ë¦¬
            if (numAvgDays < 1) {
                const freq = (1 / numAvgDays).toFixed(1);
                return `1ì¼ë‹¹ ${freq}ê°œ`;
            }

            const days = Math.round(numAvgDays);
            return `${days}ì¼ë‹¹ 1ê°œ`;
        };


        const renderTable = (channels) => {
            const tbody = document.getElementById('channel-list');
            if (!tbody) return;
            tbody.innerHTML = channels.map(channel => {
                // êµ¬ë…ììˆ˜, ì¡°íšŒìˆ˜ ë“± ìˆ«ìëŠ” í¬ë§·íŒ…
                const formatNumber = (num) => num ? num.toLocaleString('ko-KR') : 'N/A';

                // D-day ê³„ì‚° (ê°€ì¥ ì˜¤ë˜ëœ ì˜ìƒ ê²Œì‹œì¼ë¡œë¶€í„°)
                const oldestVideoDate = channel.oldestVideoPostDate ? new Date(channel.oldestVideoPostDate) : null;
                const dDay = oldestVideoDate ? Math.floor((new Date() - oldestVideoDate) / (1000 * 60 * 60 * 24)) : 'N/A';
                
                // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ
                const categoryColorClass = window.state.categoryColors[channel.customCategory] || 'bg-gray-700';

                // ì±„ë„ ê²½ê³¼ ì‹œê°„ ê³„ì‚°
                const elapsedTime = calculateElapsedTime(channel.channelCreationDate);
                
                // í‰ê·  ì—…ë¡œë“œ ì£¼ê¸° í¬ë§·íŒ…
                const uploadFreqText = formatUploadFrequency(channel.avgUploadFreqDays, channel.totalVideos);


                // í…Œì´ë¸” ë¡œìš° HTML ìƒì„±
                return `
                    <tr class="border-b border-gray-700 hover:bg-gray-800 transition duration-150">
                        <!-- ì±„ë„ í”„ë¡œí•„ ì•„ì´ì½˜ (ë¶„ë¦¬ëœ ì—´) -->
                        <td class="p-2 whitespace-nowrap">
                            <img src="${channel.profileIconUrl}" alt="Profile" onerror="this.onerror=null;this.src='https://placehold.co/40x40/374151/f3f4f6?text=C'" class="w-8 h-8 rounded-full object-cover">
                        </td>
                        <!-- ì±„ë„ëª… -->
                        <td class="p-2 font-medium">
                            <a href="${channel.channelUrl}" target="_blank" class="text-indigo-400 hover:text-indigo-300 transition">${channel.channelName}</a>
                        </td>
                        <!-- ì±„ë„ë§í¬ ë³µì‚¬ ë²„íŠ¼ (ì´ˆë¡ìƒ‰) -->
                        <td class="p-2">
                            <button onclick="window.copyToClipboard('${channel.channelUrl}')" class="bg-green-700 hover:bg-green-600 text-white font-bold py-1 px-2 rounded-lg transition duration-200 shadow-md flex items-center" title="ë§í¬ ë³µì‚¬">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                        </td>
                        <!-- ì¹´í…Œê³ ë¦¬ (ì‚¬ìš©ì ì •ì˜) - ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸° -->
                        <td class="p-2 whitespace-nowrap">
                            <div class="flex items-center space-x-2">
                                <span onclick="window.startCategorySelection('${channel.id}', '${channel.customCategory}')"
                                    class="px-2 py-1 rounded-full text-xs font-semibold text-white ${categoryColorClass} cursor-pointer hover:opacity-80 transition duration-150">
                                    ${channel.customCategory}
                                </span>
                            </div>
                        </td>
                        <!-- êµ­ê°€ -->
                        <td class="p-2 whitespace-nowrap">${channel.country || 'N/A'}</td>
                        <!-- ë¹„ê³ (ë©”ëª¨) -->
                        <td class="p-2 min-w-40">
                            <span id="memo-display-${channel.id}" 
                                onclick="window.startMemoEdit('${channel.id}', '${(channel.note || '').replace(/'/g, "\\'")}')" 
                                class="cursor-pointer hover:bg-gray-700 rounded-md p-1 block">
                                ${channel.note || 'ë©”ëª¨ ì¶”ê°€...'}
                            </span>
                        </td>
                        <!-- êµ¬ë…ì ìˆ˜ -->
                        <td class="p-2 whitespace-nowrap">${formatNumber(channel.subscribers)}</td>
                        <!-- ì´ ì¡°íšŒìˆ˜ -->
                        <td class="p-2 whitespace-nowrap">${formatNumber(channel.totalViews)}</td>
                        <!-- ì´ ì˜ìƒìˆ˜ -->
                        <td class="p-2 whitespace-nowrap">${formatNumber(channel.totalVideos)}</td>
                        <!-- ì±„ë„ ìƒì„±ì¼ -->
                        <td class="p-2 whitespace-nowrap">${channel.channelCreationDate ? new Date(channel.channelCreationDate).toLocaleDateString('ko-KR') : 'N/A'}</td>
                        <!-- ì±„ë„ ê²½ê³¼ ì‹œê°„ (ìƒˆë¡œ ì¶”ê°€) -->
                        <td class="p-2 whitespace-nowrap text-gray-400">${elapsedTime}</td>
                        <!-- í‰ê·  ì—…ë¡œë“œ ì£¼ê¸° -->
                        <td class="p-2 whitespace-nowrap">${uploadFreqText}</td>
                        <!-- 90ì¼ í‰ê·  ì¡°íšŒìˆ˜ -->
                        <td class="p-2 whitespace-nowrap">${formatNumber(channel.avgViews90d)}</td>
                        <!-- 90ì¼ í‰ê·  ì¢‹ì•„ìš” ìˆ˜ -->
                        <td class="p-2 whitespace-nowrap">${formatNumber(channel.avgLikes90d)}</td>
                        <!-- 16. 90ì¼ í‰ê·  ëŒ“ê¸€ ìˆ˜ -->
                        <td class="p-2 whitespace-nowrap">${formatNumber(channel.avgComments90d)}</td>
                        <!-- ì‚­ì œ ë²„íŠ¼ -->
                        <td class="p-2">
                             <button onclick="window.deleteChannel('${channel.id}')" class="text-red-400 hover:text-red-500 transition" title="ì±„ë„ ì‚­ì œ">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="15" class="p-4 text-center text-gray-400">ë“±ë¡ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; // colspan ì¡°ì •
            
            // Lucide ì•„ì´ì½˜ ë‹¤ì‹œ ë Œë”ë§
            lucide.createIcons();
        };

        const renderFilters = (channels, categories) => {
            const filterContainer = document.getElementById('filter-container');
            if (!filterContainer) return;

            // ì¤‘ë³µ ì—†ëŠ” YouTube ì¹´í…Œê³ ë¦¬ ëª©ë¡ ìƒì„± (ì‚¬ìš©ë˜ì§€ ì•ŠìŒ: ytCategories)
            // const ytCategories = [...new Set(channels.map(c => c.ytCategory).filter(c => c))].sort();

            const customCategorySelect = document.getElementById('category-filter-select');
            const ytCategorySelect = document.getElementById('yt-category-filter-select'); // ì´ ìš”ì†Œë¥¼ ì œê±°í•˜ëŠ” ëŒ€ì‹  ìˆ¨ê¹€

            // ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬ í•„í„° ì—…ë°ì´íŠ¸
            customCategorySelect.innerHTML = `<option value="ì „ì²´">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>` + categories.map(cat => 
                `<option value="${cat}" ${window.state.categoryFilter === cat ? 'selected' : ''}>${cat}</option>`
            ).join('');

            // YouTube ì¹´í…Œê³ ë¦¬ í•„í„° ì—…ë°ì´íŠ¸ (ì œê±°ë¨, UIì—ì„œ ìˆ¨ê¹€)
            if (ytCategorySelect) {
                // ì´ì „ì— ë Œë”ë§ë˜ë˜ YouTube ì¹´í…Œê³ ë¦¬ í•„í„° ê´€ë ¨ ë¡œì§ ì œê±°
                // ytCategorySelect.innerHTML = `<option value="ì „ì²´">ì „ì²´ ìœ íŠœë¸Œ ì¹´í…Œê³ ë¦¬</option>` + ytCategories.map(cat => 
                //     `<option value="${cat}" ${window.state.ytCategoryFilter === cat ? 'selected' : ''}>${cat}</option>`
                // ).join('');
            }
        };

        const renderCategoryModal = () => {
            const modal = document.getElementById('category-modal');
            if (!modal) return;
            modal.classList.toggle('hidden', !window.state.isCategoryModalOpen);

            if (window.state.isCategoryModalOpen) {
                const list = document.getElementById('category-list-body');
                list.innerHTML = window.state.categories.map(cat => {
                    const colorClass = window.state.categoryColors[cat] || 'bg-gray-700';
                    return `
                        <li class="flex justify-between items-center p-2 border-b border-gray-700 last:border-b-0 hover:bg-gray-800 rounded-md">
                            <span id="cat-name-${cat}" class="font-medium flex items-center space-x-2">
                                <span class="px-2 py-1 rounded-full text-xs font-semibold text-white ${colorClass}">${cat}</span>
                            </span>
                            <div class="flex space-x-2">
                                <button onclick="window.startCategoryEdit('${cat}')" class="text-indigo-400 hover:text-indigo-300 transition" title="ì´ë¦„ í¸ì§‘">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.deleteCategory('${cat}')" class="text-red-400 hover:text-red-500 transition" title="ì‚­ì œ">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </li>
                        ${window.state.editingCategoryName === cat ? `
                            <li class="p-2 flex space-x-2 bg-gray-700 rounded-b-md mb-2">
                                <input type="text" id="edit-cat-input" value="${window.state.editingCategoryNewName}" 
                                    class="flex-grow bg-gray-800 text-gray-100 border border-indigo-500 rounded-lg p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <button onclick="window.saveCategoryEdit()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition">ì €ì¥</button>
                                <button onclick="window.cancelCategoryEdit()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition">ì·¨ì†Œ</button>
                            </li>
                        ` : ''}
                    `;
                }).join('');
                lucide.createIcons();
            }
        };

        const renderApiSettingsModal = () => {
            const modal = document.getElementById('api-settings-modal');
            if (!modal) return;
            modal.classList.toggle('hidden', !window.state.isApiModalOpen);
            
            if (window.state.isApiModalOpen) {
                 const { apiKeys, activeApiKeyName, editingApiKey } = window.state;
                 const list = document.getElementById('api-key-list-body');

                 list.innerHTML = apiKeys.map(item => {
                    const isEditing = editingApiKey.originalName === item.name;
                    const isActive = activeApiKeyName === item.name;

                    if (isEditing) {
                        return `
                            <li class="p-3 border-b border-gray-700 bg-gray-700 rounded-lg mb-2">
                                <div class="space-y-3">
                                    <h5 class="text-sm font-semibold text-indigo-300">í‚¤ í¸ì§‘: ${item.name}</h5>
                                    <input type="text" id="edit-api-name" value="${editingApiKey.name}" placeholder="ìƒˆ í‚¤ ì´ë¦„"
                                           class="w-full bg-gray-800 text-gray-100 border border-indigo-500 rounded-lg p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <textarea id="edit-api-key" rows="2" placeholder="ìƒˆ API í‚¤ ê°’"
                                              class="w-full bg-gray-800 text-gray-100 border border-indigo-500 rounded-lg p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500">${editingApiKey.key}</textarea>
                                    <div class="flex justify-end space-x-2">
                                        <button onclick="window.cancelEditApiKey()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition">ì·¨ì†Œ</button>
                                        <button onclick="window.saveEditApiKey()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition">ì €ì¥</button>
                                    </div>
                                </div>
                            </li>
                        `;
                    }
                    
                    return `
                        <li class="flex justify-between items-center p-3 border-b border-gray-700 last:border-b-0 hover:bg-gray-700 rounded-md transition duration-150 ${isActive ? 'bg-indigo-900/50 border border-indigo-500' : ''}">
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="active_key" value="${item.name}" 
                                    id="key-radio-${item.name}" 
                                    onchange="window.selectApiKey('${item.name}')"
                                    ${isActive ? 'checked' : ''}
                                    class="form-radio h-4 w-4 text-indigo-500 bg-gray-600 border-gray-500 focus:ring-indigo-500 cursor-pointer">
                                <label for="key-radio-${item.name}" class="font-medium cursor-pointer" title="${item.key}">
                                    ${item.name} 
                                    <span class="text-xs text-gray-400 ml-2">(${item.key.substring(0, 4)}...${item.key.substring(item.key.length - 4)})</span>
                                </label>
                                ${isActive ? '<span class="text-xs text-indigo-400 border border-indigo-400 px-1 rounded-full">í™œì„±</span>' : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="window.startEditApiKey('${item.name}')" class="text-gray-400 hover:text-indigo-400 transition" title="í¸ì§‘">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.deleteApiKey('${item.name}')" class="text-red-400 hover:text-red-500 transition" title="ì‚­ì œ">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </li>
                    `;
                 }).join('') || '<li class="p-3 text-center text-gray-400">ì €ì¥ëœ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                 lucide.createIcons();
            }
        };

        const renderChannelCategorySelectionModal = () => {
            const modal = document.getElementById('channel-category-selection-modal');
            if (!modal) return;
            modal.classList.toggle('hidden', !window.state.isChannelCategoryModalOpen);

            if (window.state.isChannelCategoryModalOpen) {
                const { id, current } = window.state.editingChannelCategory;
                const channel = window.state.channels.find(c => c.id === id);
                if (!channel) return;
                
                document.getElementById('channel-category-title').textContent = `${channel.channelName} ì±„ë„ ì¹´í…Œê³ ë¦¬ ë³€ê²½`;
                
                const list = document.getElementById('channel-category-list');
                list.innerHTML = window.state.categories.map(cat => {
                    const colorClass = window.state.categoryColors[cat] || 'bg-gray-700';
                    return `
                        <li class="p-3 hover:bg-gray-700/70 rounded-lg cursor-pointer flex items-center space-x-3 transition duration-150">
                            <input type="radio" name="new_category_select" id="cat-select-${cat}" value="${cat}"
                                ${current === cat ? 'checked' : ''}
                                class="form-radio h-4 w-4 text-indigo-500 bg-gray-600 border-gray-500 focus:ring-indigo-500 cursor-pointer">
                            <label for="cat-select-${cat}" class="flex items-center space-x-2 font-medium w-full cursor-pointer">
                                <span class="px-2 py-1 rounded-full text-xs font-semibold text-white ${colorClass}">${cat}</span>
                            </label>
                        </li>
                    `;
                }).join('');
                
                // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ Enter í‚¤ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                document.getElementById('channel-category-selection-modal').addEventListener('keydown', handleEnterKeyInModal);
            } else {
                 // ëª¨ë‹¬ì´ ë‹«í ë•Œ Enter í‚¤ ë¦¬ìŠ¤ë„ˆ ì œê±°
                document.getElementById('channel-category-selection-modal').removeEventListener('keydown', handleEnterKeyInModal);
            }
        };

        const handleEnterKeyInModal = (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                window.saveChannelCategorySelection();
            }
        };


        const renderMemoModal = () => {
             const modal = document.getElementById('memo-modal');
            if (!modal) return;
            modal.classList.toggle('hidden', !window.state.editingChannelMemoId);

            if (window.state.editingChannelMemoId) {
                document.getElementById('memo-input').value = window.state.editingChannelMemoValue;
                // í¬ì»¤ìŠ¤ ì„¤ì •
                setTimeout(() => document.getElementById('memo-input').focus(), 100);
            }
        }
        
        window.render = render; // ì „ì—­ ë…¸ì¶œ

        // --- Firebase CRUD Functions ---

        // Firebase ì´ˆê¸°í™” ë° ì¸ì¦
        const setupFirebase = async () => {
            let config = firebaseConfig; // Tries to use injected config first
            const loadingElement = document.getElementById('initial-loading');

            // Canvas í™˜ê²½ ì™¸ë¶€ì—ì„œ ì‹¤í–‰ë  ê²½ìš° configê°€ null/undefinedì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            if (!config) {
                try {
                    loadingElement.textContent = "GitHub í™˜ê²½ ê°ì§€: firebase-config.json íŒŒì¼ì„ ë¡œë“œ ì¤‘...";
                    const response = await fetch('firebase-config.json');
                    
                    if (response.ok) {
                        config = await response.json();
                    } else {
                         throw new Error(`Failed to load firebase-config.json. Status: ${response.status}`);
                    }
                } catch (error) {
                    console.error("Firebase config ë¡œë“œ ì˜¤ë¥˜:", error);
                    loadingElement.textContent = "ì˜¤ë¥˜: Firebase ì„¤ì • íŒŒì¼(firebase-config.json)ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ í™•ì¸í•˜ê±°ë‚˜ Canvas í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.";
                    return;
                }
            }


            // ìµœì¢…ì ìœ¼ë¡œ configê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
            if (!config) {
                console.error("Firebase config is not available.");
                loadingElement.textContent = "Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.";
                return;
            }

            try {
                // setLogLevel('debug'); // ë””ë²„ê·¸ ë¡œê·¸ í™œì„±í™”
                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);

                // ì¸ì¦ ì²˜ë¦¬ (ìµëª… ë¡œê·¸ì¸ ë˜ëŠ” ì»¤ìŠ¤í…€ í† í° ë¡œê·¸ì¸)
                await new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                // Firebase ì„¤ì • ì™„ë£Œ ë©”ì‹œì§€ ì œê±° (ìš”ì²­ ë°˜ì˜)
                loadingElement.classList.add('hidden');
                
                // Firestore ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupListeners();

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                loadingElement.textContent = `ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`;
                loadingElement.classList.remove('hidden');
            }
        };

        // ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const setupListeners = () => {
            if (!isAuthReady) return;

            // 1. ì±„ë„ ëª©ë¡ ë¦¬ìŠ¤ë„ˆ: ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const channelsCollection = collection(db, `artifacts/${appId}/public/data/channels`);
            onSnapshot(channelsCollection, (snapshot) => {
                window.state.channels = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => {
                console.error("ì±„ë„ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
            });

            // 2. ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¦¬ìŠ¤ë„ˆ (ë‹¨ì¼ ë¬¸ì„œ): ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const categoriesDocRef = doc(db, `artifacts/${appId}/public/data/categories`, 'customCategories');
            onSnapshot(categoriesDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    window.state.categories = docSnapshot.data().names || ['ë¯¸ë¶„ë¥˜'];
                } else {
                    // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±
                    setDoc(categoriesDocRef, { names: ['ë¯¸ë¶„ë¥˜'] });
                    window.state.categories = ['ë¯¸ë¶„ë¥˜'];
                }
                render();
            }, (error) => {
                console.error("ì¹´í…Œê³ ë¦¬ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
            });
            
            // 3. API ì„¤ì • ë¦¬ìŠ¤ë„ˆ (ìƒˆë¡œ ì¶”ê°€): ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const apiSettingsDocRef = doc(db, `artifacts/${appId}/public/data/api_settings`, 'keys');
            onSnapshot(apiSettingsDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    window.state.apiKeys = data.apiKeys || [];
                    window.state.activeApiKeyName = data.activeApiKeyName || '';
                    window.state.youtubeApiKey = getActiveApiKey(window.state.apiKeys, window.state.activeApiKeyName);
                } else {
                    // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±
                    setDoc(apiSettingsDocRef, { apiKeys: [], activeApiKeyName: '' });
                    window.state.apiKeys = [];
                    window.state.activeApiKeyName = '';
                    window.state.youtubeApiKey = '';
                }
                render();
            }, (error) => {
                console.error("API ì„¤ì • ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
            });
        };

        // --- YouTube Data API Implementation ---
        const YOUTUBE_API_BASE = "https://www.googleapis.com/youtube/v3";
        const DAYS_90 = 90 * 24 * 60 * 60 * 1000;
        const RETRY_COUNT = 3;
        
        // Fetcher utility with exponential backoff
        async function fetchWithBackoff(url, retries = RETRY_COUNT) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: response.statusText }));
                        if (response.status === 403 || response.status === 429) {
                             // Quota or Permission error
                             throw new Error(`YouTube API Error (${response.status}): ${errorData.error.message || errorData.message}`);
                        }
                        throw new Error(`API Request Failed: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                } catch (error) {
                    if (i === retries - 1) throw error; // Rethrow on final attempt
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        /**
         * ë‹¤ì–‘í•œ í˜•íƒœì˜ URLì—ì„œ ì±„ë„ ID ë˜ëŠ” í•¸ë“¤ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
         */
        const extractChannelIdentifier = (url) => {
            try {
                // ì…ë ¥ëœ URLì´ í•¸ë“¤(@name) í˜•íƒœì¸ ê²½ìš°, URL ê°ì²´ ìƒì„± ì „ì— ìŠ¤í‚¤ë§ˆë¥¼ ì¶”ê°€í•˜ì—¬ íŒŒì‹± ì˜¤ë¥˜ ë°©ì§€
                const normalizedUrl = url.includes('http') || url.startsWith('@') ? url : `https://${url}`;
                
                // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì™€ #fragmentë¥¼ ì œê±°
                const urlParts = normalizedUrl.split('?')[0].split('#')[0];
                const urlObj = new URL(urlParts);
                const pathname = urlObj.pathname.toLowerCase();
                const pathParts = pathname.split('/').filter(p => p);
                
                // 1. í‘œì¤€ ì±„ë„ ID: /channel/UCXXXXX
                if (pathname.includes('/channel/') && pathParts.length >= 2) {
                    return { type: 'channelId', value: pathParts[pathParts.indexOf('channel') + 1] };
                }

                // 2. ë ˆê±°ì‹œ ì‚¬ìš©ì ì´ë¦„: /user/username
                if (pathname.includes('/user/') && pathParts.length >= 2) {
                    return { type: 'username', value: pathParts[pathParts.indexOf('user') + 1] };
                }
                
                // 3. í•¸ë“¤: /@handle, /@handle/shorts, /@handle/videos ë“±
                if (pathname.includes('/@') || url.startsWith('@')) {
                    // pathPartsì—ì„œ '@'ë¡œ ì‹œì‘í•˜ëŠ” ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ì°¾ê±°ë‚˜, ì²« ë²ˆì§¸ ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ì‚¬ìš©
                    const handleSegment = pathParts.find(p => p.startsWith('@')) || (pathParts.length > 0 && pathParts[0].startsWith('@') ? pathParts[0] : '');
                    
                    if (handleSegment) {
                         // %ED%95%9C%EA%B5%AD ë“± ì¸ì½”ë”©ëœ ë¬¸ìì—´ì„ ë””ì½”ë”©í•˜ì—¬ í•¸ë“¤ë¡œ ì‚¬ìš©
                         const handle = decodeURIComponent(handleSegment.startsWith('@') ? handleSegment.substring(1) : handleSegment);
                         return { type: 'handle', value: handle };
                    } else if (url.startsWith('@')) {
                        // ì…ë ¥ì´ ìˆœìˆ˜í•œ @handle ì¼ ê²½ìš° (URL ê°ì²´ ìƒì„± ê³¼ì •ì—ì„œ @ê°€ ê²½ë¡œë¡œ ì¸ì‹ ì•ˆë  ìˆ˜ ìˆìŒ)
                        return { type: 'handle', value: decodeURIComponent(url.substring(1)) };
                    }
                }

                // 4. ë‹¨ì¶• URL (youtu.be) ì²˜ë¦¬: video ID ì¶”ì¶œ í›„ search APIë¡œ ì±„ë„ ê²€ìƒ‰
                if (urlObj.hostname.includes('youtu.be')) {
                     // ë‹¨ì¶• ë§í¬ëŠ” ë¹„ë””ì˜¤ IDê°€ ê²½ë¡œì˜ ì²« ë²ˆì§¸ ë¶€ë¶„ì…ë‹ˆë‹¤.
                     const videoId = pathParts[0];
                     if (videoId) {
                         // video IDë¥¼ ì¿¼ë¦¬í•˜ì—¬ ì±„ë„ IDë¥¼ ì°¾ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
                         return { type: 'query', value: videoId };
                     }
                }
                
                // 5. ë£¨íŠ¸ URLì— í•¸ë“¤ë§Œ ë‚¨ì€ ê²½ìš° (https://youtube.com/handle)
                let potentialHandle = null;
                if (pathParts.length > 0) {
                     let normalizedPath = pathParts[0].toLowerCase();
                     if (normalizedPath !== 'watch' && normalizedPath !== 'shorts' && normalizedPath !== 'videos') {
                         potentialHandle = decodeURIComponent(pathParts[0]);
                     }
                }

                if (potentialHandle) {
                    // IDê°€ ì•„ë‹ ê°€ëŠ¥ì„±ì´ ë†’ì„ ë•Œë§Œ í•¸ë“¤ë¡œ ê°„ì£¼
                    if (!potentialHandle.match(/^[a-z0-9]{24}$/i)) {
                         return { type: 'handle', value: potentialHandle };
                    }
                }
                
            } catch (e) {
                // URL íŒŒì‹± ì‹¤íŒ¨
                return { type: 'error', value: e.message };
            }
            
            // ì¶”ì¶œ ì‹¤íŒ¨ ì‹œ, ì „ì²´ URLì„ ì¿¼ë¦¬ë¡œ ì‚¬ìš©í•˜ë„ë¡ ê¸°ë³¸ ì²˜ë¦¬
            return { type: 'query', value: url };
        };


        window.fetchYouTubeData = async (url) => {
            const apiKey = window.state.youtubeApiKey;
            if (!apiKey) {
                throw new Error("YouTube API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. API ì„¤ì • ëª¨ë‹¬ì„ í†µí•´ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }

            const loadingElement = document.getElementById('add-channel-loading-modal');
            
            // --- Step 1: URLì—ì„œ ì±„ë„ ID ì¶”ì¶œ ---
            const identifier = extractChannelIdentifier(url);
            let channelId = '';
            
            loadingElement.querySelector('span').textContent = `ì±„ë„ ì‹ë³„ì ì¶”ì¶œ ë° ID ë³€í™˜ ì¤‘...`;

            if (identifier.type === 'error') {
                 throw new Error(`ìœ íš¨í•˜ì§€ ì•Šì€ URL í˜•ì‹ì…ë‹ˆë‹¤: ${identifier.value}`);
            }

            if (identifier.type === 'channelId') {
                 channelId = identifier.value;
            } else if (identifier.type === 'username') {
                // ë ˆê±°ì‹œ usernameìœ¼ë¡œ ID ê²€ìƒ‰
                const searchUrl = `${YOUTUBE_API_BASE}/channels?key=${apiKey}&forUsername=${identifier.value}&part=id`;
                const searchData = await fetchWithBackoff(searchUrl);
                channelId = searchData.items[0]?.id;
            } else if (identifier.type === 'handle' || identifier.type === 'query') {
                // í•¸ë“¤ì´ë‚˜ ë³µì¡í•œ URL (ë˜ëŠ” video ID/query)ë¡œ ì±„ë„ ê²€ìƒ‰
                const queryTerm = identifier.value;
                
                // search APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•ë„ë¥¼ ë†’ì´ê³ , ì±„ë„ ì œëª©ì´ë‚˜ ì„¤ëª…ì— í•¸ë“¤ ì´ë¦„ì´ í¬í•¨ëœ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                // maxResults=1ë¡œ ì„¤ì •í•˜ì—¬ ì¿¼í„° ì†Œëª¨ë¥¼ ìµœì†Œí™”í•˜ë˜, ì •í™•í•œ ë§¤ì¹­ì„ ìš°ì„ ì‹œí•˜ëŠ” ë¡œì§ì„ ì ìš©í•©ë‹ˆë‹¤.
                const searchUrl = `${YOUTUBE_API_BASE}/search?key=${apiKey}&q=${encodeURIComponent(queryTerm)}&type=channel&part=snippet&maxResults=5`; 
                const searchData = await fetchWithBackoff(searchUrl);
                
                const inputNameLower = queryTerm.toLowerCase();
                
                let bestMatchItem = null;
                
                if (searchData.items && searchData.items.length > 0) {
                     // 1. í•¸ë“¤ ì…ë ¥ì¸ ê²½ìš°, "ê°€ì¥ ì •í™•íˆ ì¼ì¹˜"í•˜ê±°ë‚˜ "ì œëª©ì´ í•¸ë“¤ë¡œ ì‹œì‘"í•˜ëŠ” ì±„ë„ì„ ìš°ì„  ì„ íƒ
                     bestMatchItem = searchData.items.find(item => {
                         const titleLower = item.snippet.title.toLowerCase();
                         return titleLower === inputNameLower || titleLower.startsWith(inputNameLower);
                     });
                     
                     // 2. ì •í™•í•œ ì¼ì¹˜ í•­ëª©ì´ ì—†ìœ¼ë©´, êµ¬ë…ì ìˆ˜ë‚˜ í™œë™ì„±ì„ ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ê·¸ëƒ¥ APIê°€ ë­í‚¹í•œ ì²« ë²ˆì§¸ ê²°ê³¼ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                     if (!bestMatchItem) {
                         bestMatchItem = searchData.items[0];
                     }
                }
                
                channelId = bestMatchItem?.id?.channelId;
            }
            
            if (!channelId) {
                throw new Error("ìœ íš¨í•œ YouTube ì±„ë„ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }


            // --- Step 2: ì±„ë„ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ---
            loadingElement.querySelector('span').textContent = `ì±„ë„ ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘... (ID: ${channelId})`;
            const channelInfoUrl = `${YOUTUBE_API_BASE}/channels?key=${apiKey}&id=${channelId}&part=snippet,contentDetails,statistics,brandingSettings`;
            const channelDataResponse = await fetchWithBackoff(channelInfoUrl);
            const channelItem = channelDataResponse.items[0];

            if (!channelItem) {
                throw new Error(`ì±„ë„ ìƒì„¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ID: ${channelId})`);
            }
            
            const stats = channelItem.statistics;
            const snippet = channelItem.snippet;

            const uploadPlaylistId = channelItem.contentDetails.relatedPlaylists.uploads;
            const creationDate = snippet.publishedAt;


            // --- Step 3: ìµœê·¼ 90ì¼ í†µê³„ ê³„ì‚° ---
            loadingElement.querySelector('span').textContent = `90ì¼ í†µê³„ ê³„ì‚°ì„ ìœ„í•œ ì˜ìƒ ëª©ë¡ ë¡œë”© ì¤‘...`;
            const cutoffDate = new Date(Date.now() - DAYS_90).toISOString();
            
            // 3-1. ìµœê·¼ 90ì¼ ë™ì•ˆì˜ ì˜ìƒ ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (Uploads Playlist ì´ìš©)
            let videoIds = [];
            let nextPageToken = null;
            let videoCount = 0;
            let oldestVideoDate = null;
            let videosApiUrl = `${YOUTUBE_API_BASE}/playlistItems?key=${apiKey}&playlistId=${uploadPlaylistId}&part=contentDetails&maxResults=50`; // 50ê°œì”© í˜ì´ì§•

            while (videoCount < 1000) { // ì•ˆì „ì„ ìœ„í•´ ìµœëŒ€ 1000ê°œì˜ ì˜ìƒë§Œ í™•ì¸
                const playlistResponse = await fetchWithBackoff(videosApiUrl + (nextPageToken ? `&pageToken=${nextPageToken}` : ''));
                
                for (const item of playlistResponse.items) {
                    const videoPublishedAt = item.contentDetails.videoPublishedAt;
                    if (videoPublishedAt > cutoffDate) {
                        videoIds.push(item.contentDetails.videoId);
                        videoCount++;
                    } else {
                        // 90ì¼ ì´ì „ ì˜ìƒ ë°œê²¬. ì—¬ê¸°ì„œ ë°˜ë³µ ì¤‘ë‹¨ (ê°€ì¥ ì˜¤ë˜ëœ ì˜ìƒ ê²Œì‹œì¼ë„ ì €ì¥)
                        if (!oldestVideoDate || videoPublishedAt < oldestVideoDate) {
                            oldestVideoDate = videoPublishedAt;
                        }
                        // 90ì¼ ì´ì „ ì˜ìƒì´ë©´ì„œ, ì•„ì§ oldestVideoDateê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì„¤ì •
                        if (oldestVideoDate === null) {
                            oldestVideoDate = videoPublishedAt;
                        }
                        nextPageToken = null; // 90ì¼ ì´ì „ ì˜ìƒì´ë¯€ë¡œ, ë‹¤ìŒ í˜ì´ì§€ëŠ” ë³¼ í•„ìš” ì—†ìŒ
                        break;
                    }
                }
                
                nextPageToken = playlistResponse.nextPageToken;
                if (!nextPageToken || videoIds.length === 0) break;

                // ë‹¤ìŒ í˜ì´ì§€ URL ì—…ë°ì´íŠ¸
                videosApiUrl = `${YOUTUBE_API_BASE}/playlistItems?key=${apiKey}&playlistId=${uploadPlaylistId}&part=contentDetails&maxResults=50`;
            }
            
            // 3-2. ì˜ìƒ í†µê³„ ê°€ì ¸ì™€ì„œ í•©ì‚°
            let totalViews90d = 0;
            let totalLikes90d = 0;
            let totalComments90d = 0;
            const videosFetched = videoIds.length;
            
            if (videosFetched > 0) {
                 loadingElement.querySelector('span').textContent = `${videosFetched}ê°œ ì˜ìƒ í†µê³„ í•©ì‚° ì¤‘...`;

                 // YouTube APIëŠ” í•œ ë²ˆì— ìµœëŒ€ 50ê°œì˜ ë¹„ë””ì˜¤ IDë§Œ í—ˆìš©
                 const videoIdChunks = [];
                 for (let i = 0; i < videosFetched; i += 50) {
                     videoIdChunks.push(videoIds.slice(i, i + 50).join(','));
                 }
                 
                 for (const chunk of videoIdChunks) {
                     const videoStatsUrl = `${YOUTUBE_API_BASE}/videos?key=${apiKey}&id=${chunk}&part=statistics`;
                     const videoStatsResponse = await fetchWithBackoff(videoStatsUrl);
                     
                     for (const videoItem of videoStatsResponse.items) {
                         const vStats = videoItem.statistics;
                         totalViews90d += parseInt(vStats.viewCount || 0);
                         totalLikes90d += parseInt(vStats.likeCount || 0);
                         totalComments90d += parseInt(vStats.commentCount || 0);
                     }
                 }
            }
            
            // 3-3. í‰ê·  ê³„ì‚°
            // ê°€ì¥ ì˜¤ë˜ëœ ì˜ìƒ ê²Œì‹œì¼ì´ ì—†ìœ¼ë©´ (ì˜ìƒ 0ê°œ), ì±„ë„ ìƒì„±ì¼ì„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const videosForAvgFreq = parseInt(stats.videoCount || 0);
            let avgUploadFreqDays = 0;
            if (videosForAvgFreq > 0) {
                const effectiveStartDate = oldestVideoDate || creationDate;
                const totalDays = Math.floor((new Date() - new Date(effectiveStartDate)) / (1000 * 60 * 60 * 24)) || 1;
                avgUploadFreqDays = (totalDays / videosForAvgFreq).toFixed(1);
            } else {
                avgUploadFreqDays = 'N/A';
            }


            // --- Step 4: ê²°ê³¼ ë°ì´í„° ê°ì²´ ë°˜í™˜ ---
            return {
                channelUrl: url,
                profileIconUrl: snippet.thumbnails.default.url || '', // ê¸°ë³¸ ì¸ë„¤ì¼ URL ì‚¬ìš©
                channelName: snippet.title,
                ytCategory: channelItem.brandingSettings?.channel?.keywords?.split('"').join('').split(',')[0] || 'N/A', // Branding keywordsì—ì„œ ì²«ë²ˆì§¸ í•­ëª© ì‚¬ìš© (ì¹´í…Œê³ ë¦¬ ì •ë³´ê°€ channel APIì— ëª…ì‹œì ì´ì§€ ì•ŠìŒ)
                country: snippet.country || 'N/A',
                subscribers: parseInt(stats.subscriberCount || 0),
                totalViews: parseInt(stats.viewCount || 0),
                totalVideos: parseInt(stats.videoCount || 0),
                channelCreationDate: creationDate,
                oldestVideoPostDate: oldestVideoDate || creationDate, // ê°€ì¥ ì˜¤ë˜ëœ ì˜ìƒ ê²Œì‹œì¼
                avgUploadFreqDays: avgUploadFreqDays, 
                avgViews90d: videosFetched > 0 ? Math.round(totalViews90d / videosFetched) : 0,
                avgLikes90d: videosFetched > 0 ? Math.round(totalLikes90d / videosFetched) : 0,
                avgComments90d: videosFetched > 0 ? Math.round(totalComments90d / videosFetched) : 0,
                note: '',
                customCategory: 'ë¯¸ë¶„ë¥˜',
                channelId: channelId,
            };
        };


        // --- Event Handlers (Globalized for HTML calls) ---

        // API ì„¤ì • ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        window.toggleApiSettingsModal = (open) => {
            window.state.isApiModalOpen = open;
            if (!open) {
                window.state.editingApiKey = { name: null, key: null, originalName: null }; // í¸ì§‘ ìƒíƒœ ì´ˆê¸°í™”
            }
            render();
        };

        // ìƒˆ API í‚¤ ì¶”ê°€
        window.addApiKey = () => {
            const nameInput = document.getElementById('new-api-name-input');
            const keyInput = document.getElementById('new-api-key-input');
            const name = nameInput.value.trim();
            const key = keyInput.value.trim();

            if (!name || !key) {
                alertModal("ê²½ê³ ", "í‚¤ ì´ë¦„ê³¼ API í‚¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (window.state.apiKeys.some(k => k.name === name)) {
                alertModal("ê²½ê³ ", `"${name}" ì´ë¦„ì˜ í‚¤ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
                return;
            }
            
            // í‚¤ ì¶”ê°€
            const newKeys = [...window.state.apiKeys, { name, key }];
            let newActiveName = window.state.activeApiKeyName;
            
            // ì²˜ìŒ ì¶”ê°€ ì‹œ í™œì„±í™”
            if (newKeys.length === 1) {
                newActiveName = name;
            }

            updateApiStorage(newKeys, newActiveName);
            nameInput.value = '';
            keyInput.value = '';
            alertModal("ì„±ê³µ", `API í‚¤ "${name}"ì´(ê°€) ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };

        // í™œì„± API í‚¤ ì„ íƒ (í† ê¸€ ë°©ì‹)
        window.selectApiKey = (name) => {
            let newActiveName = '';
            // í˜„ì¬ í™œì„± í‚¤ë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë¹„í™œì„±í™”
            if (window.state.activeApiKeyName === name) {
                newActiveName = ''; // Deactivate
            } else {
                newActiveName = name; // Activate the selected key
            }
            
            updateApiStorage(window.state.apiKeys, newActiveName);
            alertModal("í™œì„± í‚¤ ë³€ê²½", newActiveName ? `í™œì„± API í‚¤ê°€ "${newActiveName}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.` : "í™œì„± API í‚¤ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        };
        
        // API í‚¤ í¸ì§‘ ì‹œì‘
        window.startEditApiKey = (name) => {
            const keyToEdit = window.state.apiKeys.find(k => k.name === name);
            if (!keyToEdit) return;

            window.state.editingApiKey = {
                name: keyToEdit.name,
                key: keyToEdit.key,
                originalName: keyToEdit.name
            };
            render();
        };

        // API í‚¤ í¸ì§‘ ì·¨ì†Œ
        window.cancelEditApiKey = () => {
            window.state.editingApiKey = { name: null, key: null, originalName: null };
            render();
        };
        
        // API í‚¤ í¸ì§‘ ì €ì¥
        window.saveEditApiKey = () => {
            const originalName = window.state.editingApiKey.originalName;
            const newName = document.getElementById('edit-api-name').value.trim();
            const newKey = document.getElementById('edit-api-key').value.trim();

            if (!newName || !newKey) {
                alertModal("ê²½ê³ ", "í‚¤ ì´ë¦„ê³¼ API í‚¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            // ì´ë¦„ ì¤‘ë³µ ê²€ì‚¬ (ì´ë¦„ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ)
            if (newName !== originalName && window.state.apiKeys.some(k => k.name === newName)) {
                alertModal("ê²½ê³ ", `"${newName}" ì´ë¦„ì˜ í‚¤ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
                return;
            }
            
            const newKeys = window.state.apiKeys.map(key => {
                if (key.name === originalName) {
                    return { name: newName, key: newKey };
                }
                return key;
            });

            let newActiveName = window.state.activeApiKeyName;
            // í™œì„± í‚¤ ì´ë¦„ì´ ë³€ê²½ëœ ê²½ìš° í™œì„± í‚¤ ì´ë¦„ë„ ì—…ë°ì´íŠ¸
            if (newActiveName === originalName) {
                newActiveName = newName;
            }

            updateApiStorage(newKeys, newActiveName);
            window.cancelEditApiKey(); // í¸ì§‘ ìƒíƒœ ì´ˆê¸°í™”
            alertModal("ì €ì¥ ì™„ë£Œ", `API í‚¤ "${newName}"ì´(ê°€) ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };

        // API í‚¤ ì‚­ì œ
        window.deleteApiKey = async (name) => {
            if (await customConfirm("API í‚¤ ì‚­ì œ", `ì •ë§ë¡œ "${name}" í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                
                if (name === window.state.activeApiKeyName) {
                    alertModal("ê²½ê³ ", "í™œì„±í™”ëœ API í‚¤ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ë¥¼ ì„ íƒí•œ í›„ ì‚­ì œí•´ì£¼ì„¸ìš”.");
                    return;
                }
                
                const newKeys = window.state.apiKeys.filter(k => k.name !== name);
                let newActiveName = window.state.activeApiKeyName;
                
                // ì‚­ì œ í›„ ëª©ë¡ì´ ë¹„ì–´ ìˆìœ¼ë©´ í™œì„± ì´ë¦„ ì´ˆê¸°í™”
                if (newKeys.length === 0) {
                     newActiveName = '';
                } else if (!newKeys.some(k => k.name === newActiveName)) {
                    // í˜„ì¬ í™œì„± ì´ë¦„ì´ ì‚­ì œëœ ê²½ìš°, ëª©ë¡ì˜ ì²« ë²ˆì§¸ í‚¤ë¥¼ í™œì„±í™” (ì„ íƒ ì‚¬í•­)
                    newActiveName = newKeys[0]?.name || '';
                }
                
                await updateApiStorage(newKeys, newActiveName);
                alertModal("ì‚­ì œ ì™„ë£Œ", `API í‚¤ "${name}"ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        };
        
        // ì±„ë„ ì¶”ê°€
        window.handleAddChannel = async (event) => {
            event.preventDefault();
            const urlInput = document.getElementById('youtube-url-input');
            const url = urlInput.value.trim();

            if (!url) {
                alertModal("ê²½ê³ ", "ìœ íŠœë¸Œ ì±„ë„ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            if (!window.state.youtubeApiKey) {
                alertModal("ê²½ê³ ", "í™œì„±í™”ëœ YouTube API Keyê°€ ì—†ìŠµë‹ˆë‹¤. API ì„¤ì •ì—ì„œ í‚¤ë¥¼ ë“±ë¡/ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            // ëª¨ë‹¬ í‘œì‹œ
            const addModal = document.getElementById('add-channel-loading-modal');
            addModal.classList.remove('hidden');

            try {
                // 1. YouTube APIë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹¤ì œ API í˜¸ì¶œ)
                const channelData = await window.fetchYouTubeData(url);
                
                // 2. Firestoreì— ì €ì¥: ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const channelsCollection = collection(db, `artifacts/${appId}/public/data/channels`);
                await addDoc(channelsCollection, {
                    ...channelData,
                    addedDate: new Date().toISOString(),
                    // Firestore ì •ë ¬ì„ ìœ„í•´ ìˆ«ìí˜• í•„ë“œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥
                    subscribers: channelData.subscribers,
                    totalViews: channelData.totalViews,
                    totalVideos: channelData.totalVideos,
                });

                urlInput.value = ''; // ì„±ê³µ ì‹œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                alertModal("ì„±ê³µ", `${channelData.channelName} ì±„ë„ì´ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            } catch (error) {
                console.error("ì±„ë„ ì¶”ê°€ ì˜¤ë¥˜:", error);
                alertModal("ì˜¤ë¥˜", `ì±„ë„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                addModal.classList.add('hidden'); // ëª¨ë‹¬ ìˆ¨ê¹€
            }
        };
        
        // ì •ë ¬ ì²˜ë¦¬
        window.handleSort = (key) => {
            const current = window.state.currentSort;
            let direction = 'desc';

            if (current.key === key) {
                direction = current.direction === 'desc' ? 'asc' : 'desc';
            }

            window.state.currentSort = { key, direction };
            render();
        };

        // ê²€ìƒ‰ì–´ ë³€ê²½
        window.handleSearchChange = (event) => {
            window.state.searchTerm = event.target.value;
            render();
        };

        // í•„í„° ë³€ê²½
        window.handleFilterChange = (type, value) => {
            if (type === 'custom') {
                window.state.categoryFilter = value;
            } 
            // ytCategoryFilter ë¡œì§ ì œê±°ë¨
            // else if (type === 'yt') {
            //     window.state.ytCategoryFilter = value;
            // }
            render();
        };

        // ì¹´í…Œê³ ë¦¬ (Firestore ì €ì¥ë§Œ ë‹´ë‹¹)
        window.handleCategoryChange = async (channelId, newCategory) => {
            try {
                // ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const channelRef = doc(db, `artifacts/${appId}/public/data/channels`, channelId);
                await updateDoc(channelRef, { customCategory: newCategory });
            } catch (error) {
                console.error("ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
                // ëª¨ë‹¬ ë‚´ì—ì„œëŠ” ì˜¤ë¥˜ë¥¼ ë˜ì ¸ì„œ ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í•©ë‹ˆë‹¤.
                throw new Error("ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };
        
        // ì¹´í…Œê³ ë¦¬ ì„ íƒ ëª¨ë‹¬ ì‹œì‘
        window.startCategorySelection = (id, current) => {
            window.state.editingChannelCategory = { id, current };
            window.state.isChannelCategoryModalOpen = true;
            render();
        };

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ ëª¨ë‹¬ ì·¨ì†Œ
        window.cancelChannelCategorySelection = () => {
            window.state.editingChannelCategory = { id: null, current: null };
            window.state.isChannelCategoryModalOpen = false;
            render();
        };
        
        // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì €ì¥
        window.saveChannelCategorySelection = async () => {
            const id = window.state.editingChannelCategory.id;
            const selectedRadio = document.querySelector('input[name="new_category_select"]:checked');
            
            if (!id || !selectedRadio) {
                window.cancelChannelCategorySelection();
                return;
            }
            
            const newCategory = selectedRadio.value;
            
            try {
                // ê¸°ì¡´ handleCategoryChange ë¡œì§ ì¬ì‚¬ìš©
                await window.handleCategoryChange(id, newCategory);
                alertModal("ì €ì¥ ì™„ë£Œ", `ì±„ë„ ì¹´í…Œê³ ë¦¬ê°€ '${newCategory}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error("ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error); 
                alertModal("ì˜¤ë¥˜", "ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                window.cancelChannelCategorySelection();
            }
        };


        // ì±„ë„ ì‚­ì œ
        window.deleteChannel = async (channelId) => {
            if (await customConfirm("ì±„ë„ ì‚­ì œ", "ì •ë§ë¡œ ì´ ì±„ë„ì„ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                 try {
                    // ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    const channelRef = doc(db, `artifacts/${appId}/public/data/channels`, channelId);
                    await deleteDoc(channelRef);
                    alertModal("ì‚­ì œ ì™„ë£Œ", "ì±„ë„ì´ ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (error) {
                    console.error("ì±„ë„ ì‚­ì œ ì˜¤ë¥˜:", error);
                    alertModal("ì˜¤ë¥˜", "ì±„ë„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }
        }
        
        // ë©”ëª¨ í¸ì§‘ ì‹œì‘
        window.startMemoEdit = (id, currentValue) => {
            // ì£¼ì˜: HTML ì†ì„±ì— ë”°ì˜´í‘œê°€ í¬í•¨ë  ê²½ìš° ì¸ì½”ë”© í•„ìš”
            window.state.editingChannelMemoId = id;
            window.state.editingChannelMemoValue = currentValue.replace(/\\'/g, "'");
            renderMemoModal();
        }

        // ë©”ëª¨ í¸ì§‘ ì €ì¥
        window.saveMemoEdit = async () => {
            const id = window.state.editingChannelMemoId;
            const newValue = document.getElementById('memo-input').value.trim();

            if (!id) {
                window.state.editingChannelMemoId = null;
                renderMemoModal();
                return;
            }

            try {
                // ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const channelRef = doc(db, `artifacts/${appId}/public/data/channels`, id);
                // ë¹ˆ ë¬¸ìì—´ë„ ì €ì¥ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •
                await updateDoc(channelRef, { note: newValue });
                window.state.editingChannelMemoId = null;
                alertModal("ì €ì¥ ì™„ë£Œ", "ë©”ëª¨ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (error) {
                console.error("ë©”ëª¨ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
                alertModal("ì˜¤ë¥˜", "ë©”ëª¨ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                renderMemoModal();
            }
        }

        // ë©”ëª¨ í¸ì§‘ ì·¨ì†Œ
        window.cancelMemoEdit = () => {
            window.state.editingChannelMemoId = null;
            renderMemoModal();
        }

        // ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        window.toggleCategoryModal = (open) => {
            window.state.isCategoryModalOpen = open;
            window.state.editingCategoryName = null; // í¸ì§‘ ìƒíƒœ ì´ˆê¸°í™”
            render();
        };

        // ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
        window.addCategory = async () => {
            const input = document.getElementById('new-category-input');
            const newCat = input.value.trim();
            if (!newCat || window.state.categories.includes(newCat)) return;

            try {
                // ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const categoriesDocRef = doc(db, `artifacts/${appId}/public/data/categories`, 'customCategories');
                await setDoc(categoriesDocRef, { names: [...window.state.categories, newCat] }, { merge: true });
                input.value = '';
            } catch (error) {
                console.error("ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì˜¤ë¥˜:", error);
                alertModal("ì˜¤ë¥˜", "ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };

        // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì‹œì‘
        window.startCategoryEdit = (name) => {
            window.state.editingCategoryName = name;
            window.state.editingCategoryNewName = name;
            render();
        };

        // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì·¨ì†Œ
        window.cancelCategoryEdit = () => {
            window.state.editingCategoryName = null;
            window.state.editingCategoryNewName = '';
            render();
        };

        // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì €ì¥ (ì´ë¦„ ë³€ê²½)
        window.saveCategoryEdit = async () => {
            const oldName = window.state.editingCategoryName;
            const newName = document.getElementById('edit-cat-input').value.trim();

            if (!oldName || !newName || oldName === newName || window.state.categories.includes(newName)) {
                alertModal("ê²½ê³ ", "ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ ì´ë¦„ì…ë‹ˆë‹¤.");
                return;
            }
            
            // 1. Firestoreì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì—…ë°ì´íŠ¸: ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const newCategories = window.state.categories.map(cat => cat === oldName ? newName : cat);
            const categoriesDocRef = doc(db, `artifacts/${appId}/public/data/categories`, 'customCategories');
            
            // 2. ëª¨ë“  ì±„ë„ ë¬¸ì„œì—ì„œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì—…ë°ì´íŠ¸: ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const batchPromises = window.state.channels
                .filter(c => c.customCategory === oldName)
                .map(c => {
                    const channelRef = doc(db, `artifacts/${appId}/public/data/channels`, c.id);
                    return updateDoc(channelRef, { customCategory: newName });
                });

            try {
                // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ëª©ë¡ ì €ì¥
                await setDoc(categoriesDocRef, { names: newCategories });
                // ì±„ë„ ì—…ë°ì´íŠ¸ ë°°ì¹˜ ì²˜ë¦¬ (ì—…ë°ì´íŠ¸ëŠ” ë¦¬ìŠ¤ë„ˆë¡œ ìë™ ë°˜ì˜ë¨)
                await Promise.all(batchPromises);
                
                alertModal("ì„±ê³µ", `'${oldName}' ì¹´í…Œê³ ë¦¬ê°€ '${newName}'ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error("ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë³€ê²½ ì˜¤ë¥˜:", error);
                alertModal("ì˜¤ë¥˜", "ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                window.state.editingCategoryName = null;
                window.state.editingCategoryNewName = '';
                render();
            }
        };

        // ì¹´í…Œê³ ë¦¬ ì‚­ì œ
        window.deleteCategory = async (name) => {
            if (name === 'ë¯¸ë¶„ë¥˜') {
                alertModal("ê²½ê³ ", "'ë¯¸ë¶„ë¥˜' ì¹´í…Œê³ ë¦¬ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            if (await customConfirm("ì¹´í…Œê³ ë¦¬ ì‚­ì œ", `'${name}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì¹´í…Œê³ ë¦¬ì— í• ë‹¹ëœ ëª¨ë“  ì±„ë„ì€ 'ë¯¸ë¶„ë¥˜'ë¡œ ìë™ ë³€ê²½ë©ë‹ˆë‹¤.`)) {
                
                // 1. ì¹´í…Œê³ ë¦¬ ëª©ë¡ì—ì„œ ì œê±°: ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const newCategories = window.state.categories.filter(cat => cat !== name);
                const categoriesDocRef = doc(db, `artifacts/${appId}/public/data/categories`, 'customCategories');

                // 2. ëª¨ë“  ì±„ë„ ë¬¸ì„œì—ì„œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ 'ë¯¸ë¶„ë¥˜'ë¡œ ì—…ë°ì´íŠ¸: ê³µê°œ(Public) ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const batchPromises = window.state.channels
                    .filter(c => c.customCategory === name)
                    .map(c => {
                        const channelRef = doc(db, `artifacts/${appId}/public/data/channels`, c.id);
                        return updateDoc(channelRef, { customCategory: 'ë¯¸ë¶„ë¥˜' });
                    });
                
                try {
                    await setDoc(categoriesDocRef, { names: newCategories });
                    await Promise.all(batchPromises);
                    alertModal("ì‚­ì œ ì™„ë£Œ", `'${name}' ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ê³  ê´€ë ¨ ì±„ë„ì´ 'ë¯¸ë¶„ë¥˜'ë¡œ ì¬í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } catch (error) {
                    console.error("ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì˜¤ë¥˜:", error);
                    alertModal("ì˜¤ë¥˜", "ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }
        }
        
        // --- Utility Functions ---

        // í´ë¦½ë³´ë“œ ë³µì‚¬
        window.copyToClipboard = (text) => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alertModal("ë³µì‚¬ ì™„ë£Œ", "ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alertModal("ë³µì‚¬ ì‹¤íŒ¨", "í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
            document.body.removeChild(textarea);
        };
        
        // ì»¤ìŠ¤í…€ Confirm ëª¨ë‹¬
        const customConfirm = (title, message) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('confirm-yes-btn');
                const cancelBtn = document.getElementById('confirm-no-btn');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                modal.classList.remove('hidden');

                const cleanup = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                };

                const onConfirm = () => {
                    cleanup();
                    resolve(true);
                };

                const onCancel = () => {
                    cleanup();
                    resolve(false);
                };

                confirmBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);
            });
        };

        // ì»¤ìŠ¤í…€ Alert ëª¨ë‹¬ (Enter í‚¤ ì‘ë™ ë¡œì§ ì¶”ê°€)
        window.alertModal = (title, message) => {
            const modal = document.getElementById('alert-modal');
            const closeBtn = document.getElementById('alert-close-btn');

            // Define the close action and listener function
            const closeModal = () => {
                modal.classList.add('hidden');
                document.removeEventListener('keydown', handleAlertEnter);
            };

            // Listener function to handle Enter key press
            const handleAlertEnter = (event) => {
                // Ensure only one listener is active (optional, but good practice)
                if (event.key === 'Enter') {
                    event.preventDefault();
                    closeModal();
                }
            };

            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            modal.classList.remove('hidden');

            // 1. Set the click handler to the close function
            closeBtn.onclick = closeModal;
            
            // 2. Add the Enter key listener to the document
            document.addEventListener('keydown', handleAlertEnter);

            // Set focus to the button/modal
            setTimeout(() => closeBtn.focus(), 0);
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase ì´ˆê¸°í™”
        window.onload = setupFirebase;
    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div class="container mx-auto">
        <div class="flex justify-between items-start mb-6">
             <!-- ìœ íŠœë¸Œ ì•„ì´ì½˜ ì¶”ê°€ -->
             <div class="flex items-center space-x-3">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.0121 2.5C11.9796 2.5 11.9472 2.5 11.9147 2.50024C6.27315 2.5638 2.5 6.00282 2.5 11.9147C2.5 17.6534 6.27315 21.5003 11.9147 21.5C17.5843 21.5 21.5 17.6534 21.5 11.9147C21.5
