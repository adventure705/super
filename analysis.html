<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” YouTube ì±„ë„ ì‹¬ì¸µ ë¶„ì„ê¸°</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” (ë‹¤í¬ëª¨ë“œì— ë§ì¶¤) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a2e; /* ë°°ê²½ìƒ‰ */
        }
        ::-webkit-scrollbar-thumb {
            background: #383b6e; /* ìŠ¤í¬ë¡¤ë°” ìƒ‰ìƒ */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #e94560; /* í˜¸ë²„ ì‹œ ê°•ì¡°ìƒ‰ */
        }

        /* í°íŠ¸ ì„¤ì • (Inter í°íŠ¸ ì‚¬ìš©) */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* í…Œì´ë¸” ì…€ ë‚´ë¶€ì— íƒœê·¸ê°€ ë§ì„ ê²½ìš° ì¤„ë°”ê¿ˆì„ í—ˆìš© */
        #videoListTableBody td:nth-child(11) { 
            white-space: normal;
        }
        /* ìº˜ë¦°ë” ì…€ ìŠ¤íƒ€ì¼ */
        .calendar-cell {
            width: 100%; 
            padding: 4px;
            text-align: center;
            font-size: 0.75rem;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid #383b6e;
            border-radius: 4px;
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½ */
            transition: background-color 0.2s;
        }
        /* Shorts ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ */
        .shorts-scroll-container {
            position: relative; /* í™”ì‚´í‘œ ë°°ì¹˜ë¥¼ ìœ„í•´ */
        }
        .shorts-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        .shorts-content {
            overflow-x: auto;
            scroll-behavior: smooth;
            white-space: nowrap;
        }
        .scroll-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            background: rgba(40, 42, 77, 0.8); /* card-bg semi-transparent */
            border-radius: 9999px;
            padding: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background 0.3s;
            display: none; /* Mobile hidden */
        }
        @media (min-width: 768px) {
            .scroll-button {
                display: block; /* PC show */
            }
        }
        /* í•„í„° ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .filter-dropdown {
            z-index: 50;
            min-width: 250px;
        }
    </style>
    <script>
        // Tailwind Config for custom colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': '#1a1a2e',      // 1. Deep Blue/Purple Dark Background
                        'primary-accent': '#e94560', // 2. Vivid Red/Pink Accent
                        'text-light': '#f8f8f8',    // 3. Off-White/Light Gray Text
                        'card-bg': '#282a4d',      // 4. Slightly Lighter Dark Blue Card Background
                        'success-status': '#6aff7b', // 5. Light Green Success/Status
                        'warning-star': '#fbbf24', // Yellow for stars
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-bg-dark text-text-light min-h-screen transition-colors duration-500">

    <!-- í—¤ë” ì„¹ì…˜ -->
    <header id="top" class="p-4 sm:p-6 bg-card-bg shadow-lg sticky top-0 z-10 rounded-b-xl">
        <h1 class="text-2xl sm:text-3xl font-extrabold text-primary-accent text-center">
            YouTube ì±„ë„ ì‹¬ì¸µ ë¶„ì„ê¸°
        </h1>
    </header>

    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-10">

        <!-- ì…ë ¥ ë° ì œì–´ íŒ¨ë„ -->
        <section class="bg-card-bg p-6 rounded-xl shadow-2xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b border-primary-accent/50 pb-2">ë¶„ì„ ì„¤ì •</h2>
            
            <!-- API í‚¤ ì…ë ¥ ë° ì œì–´ ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="mb-4">
                <label for="apiKey" class="block text-sm font-medium mb-1">YouTube Data API Key</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="password" id="apiKey" placeholder="ì—¬ê¸°ì— API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                           class="w-full p-3 rounded-lg bg-bg-dark border border-card-bg focus:border-primary-accent focus:ring-1 focus:ring-primary-accent text-text-light transition duration-200">
                    
                    <!-- API í‚¤ ì´ˆê¸°í™” ë²„íŠ¼ -->
                    <button id="clearApiKeyButton" 
                            class="w-full sm:w-auto px-4 py-3 bg-card-bg border border-primary-accent text-primary-accent font-medium rounded-lg hover:bg-primary-accent/10 transition duration-300 whitespace-nowrap"
                            onclick="clearApiKey()">
                        ğŸ”‘ í‚¤ ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- ì±„ë„ ë§í¬/ID ì…ë ¥ -->
            <div class="mb-6">
                <label for="channelId" class="block text-sm font-medium mb-1">ì±„ë„ ID ë˜ëŠ” ì˜ìƒ ë§í¬ (ì˜ˆ: @username, youtu.be/...) </label>
                <input type="text" id="channelId" placeholder="ì±„ë„ ID, í•¸ë“¤, ë˜ëŠ” ì˜ìƒ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                       class="w-full p-3 rounded-lg bg-bg-dark border border-card-bg focus:border-primary-accent focus:ring-1 focus:ring-primary-accent text-text-light transition duration-200">
            </div>

            <!-- ë¶„ì„ ë²„íŠ¼ -->
            <button id="analyzeButton" 
                    class="w-full py-3 px-4 bg-primary-accent hover:bg-primary-accent/80 text-white font-bold rounded-xl transition duration-300 shadow-lg shadow-primary-accent/30 disabled:opacity-50"
                    onclick="startAnalysis()">
                <span id="buttonText">ì±„ë„ ë¶„ì„ ì‹œì‘</span>
            </button>

            <!-- ìƒíƒœ ë©”ì‹œì§€ -->
            <p id="statusMessage" class="mt-4 text-center text-sm font-medium"></p>
        </section>

        <!-- ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <section id="resultsSection" class="hidden">
            <h2 class="text-2xl font-bold mb-6 text-primary-accent">ë¶„ì„ ê²°ê³¼ ìš”ì•½ (ì •ëŸ‰ì  ì§€í‘œ)</h2>
            
            <!-- ì±„ë„ ê¸°ë³¸ ì •ë³´ ì¹´ë“œ -->
            <div id="channelInfo" class="grid md:grid-cols-2 gap-6 mb-8">
                <!-- ì •ë³´ëŠ” JSë¥¼ í†µí•´ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
            </div>

            <!-- í†µê³„ ì¹´ë“œ (ì „ì²´) -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-4">
                <div class="bg-card-bg p-5 rounded-xl shadow-xl">
                    <p class="text-3xl font-bold text-success-status" id="statSubscribers">0</p>
                    <p class="text-sm mt-1 text-text-light/80">êµ¬ë…ì ìˆ˜</p>
                </div>
                <div class="bg-card-bg p-5 rounded-xl shadow-xl">
                    <p class="text-3xl font-bold text-success-status" id="statViews">0</p>
                    <p class="text-sm mt-1 text-text-light/80">ì´ ì¡°íšŒìˆ˜</p>
                </div>
                <div class="bg-card-bg p-5 rounded-xl shadow-xl">
                    <p class="text-3xl font-bold text-success-status" id="statVideos">0</p>
                    <p class="text-sm mt-1 text-text-light/80">ì´ ì˜ìƒ ìˆ˜</p>
                </div>
            </div>

            <!-- í†µê³„ ì¹´ë“œ (90ì¼ í‰ê· ) - NEW -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-8">
                <div class="bg-card-bg p-4 rounded-xl shadow-xl border border-primary-accent/30">
                    <p class="text-xl font-bold text-primary-accent" id="avgViews90Days">0</p>
                    <p class="text-xs mt-1 text-text-light/70">90ì¼ í‰ê·  ì¡°íšŒìˆ˜</p>
                </div>
                <div class="bg-card-bg p-4 rounded-xl shadow-xl border border-primary-accent/30">
                    <p class="text-xl font-bold text-primary-accent" id="avgLikes90Days">0</p>
                    <p class="text-xs mt-1 text-text-light/70">90ì¼ í‰ê·  ì¢‹ì•„ìš” ìˆ˜</p>
                </div>
                <div class="bg-card-bg p-4 rounded-xl shadow-xl border border-primary-accent/30">
                    <p class="text-xl font-bold text-primary-accent" id="avgComments90Days">0</p>
                    <p class="text-xs mt-1 text-text-light/70">90ì¼ í‰ê·  ëŒ“ê¸€ ìˆ˜</p>
                </div>
            </div>


            <!-- ë²¤ì¹˜ë§ˆí‚¹ ì‹¬ì¸µ ë¶„ì„ ê°€ì´ë“œ (ì •ì„±ì  ë¶„ì„ ì˜ì—­) -->
            <h2 class="text-2xl font-bold mb-6 text-primary-accent mt-10">ğŸ› ï¸ ì‹¬ì¸µ ë²¤ì¹˜ë§ˆí‚¹ ê°€ì´ë“œ (ì§ì ‘ ë¶„ì„ í•„ìš”)</h2>
            <p class="text-sm text-text-light/80 mb-6">ì•„ë˜ í•­ëª©ë“¤ì€ APIë¡œ ì œê³µë˜ì§€ ì•ŠëŠ” <b>ì„±ê³µ ì „ëµ í•µì‹¬ ì˜ì—­</b>ì…ë‹ˆë‹¤. ìƒë‹¨ì˜ ì •ëŸ‰ì  ë°ì´í„°ì™€ í•¨ê»˜ ì±„ë„ì„ ì§ì ‘ ê´€ì°°í•˜ë©° ë¶„ì„í•´ ë³´ì„¸ìš”.</p>

            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <!-- ì½˜í…ì¸  ë° ê¸°íšë ¥ ë¶„ì„ (2ë‹¨ê³„) -->
                <div class="bg-card-bg p-6 rounded-xl shadow-xl">
                    <h3 class="text-lg font-bold text-success-status mb-3">ğŸ’¡ 2ë‹¨ê³„: ì½˜í…ì¸  ê¸°íšë ¥ ë¶„ì„</h3>
                    <ul class="list-disc ml-5 text-sm space-y-2 text-text-light/80">
                        <li><b>í‚¬ëŸ¬ ì½˜í…ì¸ :</b> ì˜ìƒë“¤ì„ ì£¼ì œë³„ë¡œ ë¶„ë¥˜í•˜ì—¬ ì±„ë„ì˜ ì£¼ë ¥ ì½˜í…ì¸ (ê°€ì¥ ì„±ê³¼ ì¢‹ì€)ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.</li>
                        <li><b>í¬ë§· ë° ê¸¸ì´:</b> ì„±ê³µì ì¸ ì˜ìƒì˜ í‰ê·  ê¸¸ì´ì™€ í¬ë§· ìœ í˜•(Vlog, íŠœí† ë¦¬ì–¼ ë“±)ì„ ê¸°ë¡í•©ë‹ˆë‹¤.</li>
                        <li><b>ì˜ìƒ êµ¬ì¡°:</b> ê¸°ìŠ¹ì „ê²° ë“± ì˜ìƒ ë‚´ë¶€ì˜ ì¼ê´€ëœ êµ¬ì¡°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</li>
                        <li><b>ì „ë‹¬ ë°©ì‹:</b> ê°ì • ìœ ë°œ, ì •ë³´ ì „ë‹¬ ë“± í•µì‹¬ ì „ë‹¬ ìš”ì†Œë¥¼ ì •ì˜í•©ë‹ˆë‹¤.</li>
                        <li><b>ì°¨ë³„í™”:</b> ì´ ì±„ë„ë§Œì´ ê°€ì§„ ê³ ìœ í•œ ê´€ì ì´ë‚˜ ì •ë³´ ì „ë‹¬ ë°©ì‹ì„ ì •ì˜í•©ë‹ˆë‹¤.</li>
                    </ul>
                </div>

                <!-- ì‹œê°/í¸ì§‘ ìŠ¤íƒ€ì¼ ë¶„ì„ (3ë‹¨ê³„) -->
                <div class="bg-card-bg p-6 rounded-xl shadow-xl">
                    <h3 class="text-lg font-bold text-success-status mb-3">ğŸ¬ 3ë‹¨ê³„: ì‹œê°/í¸ì§‘ ìŠ¤íƒ€ì¼ ë¶„ì„</h3>
                    <ul class="list-disc ml-5 text-sm space-y-2 text-text-light/80">
                        <li><b>ì¸ë„¤ì¼ ì „ëµ:</b> ì£¼ëœ ìƒ‰ìƒ, í°íŠ¸, ê¶ê¸ˆì¦ì„ ìœ ë°œí•˜ëŠ” ë¬¸êµ¬ ìŠ¤íƒ€ì¼ì„ íŒŒì•…í•©ë‹ˆë‹¤.</li>
                        <li><b>í¸ì§‘ ì†ë„:</b> ì»· ì „í™˜ ì†ë„, í™”ë©´ ë¶„í• , ì§€ë£¨í•¨ì„ ì¤„ì´ëŠ” í¸ì§‘ ê¸°ë²•ì„ ë¶„ì„í•©ë‹ˆë‹¤.</li>
                        <li>ğŸ—£ï¸ <b>ì‚¬ìš´ë“œ/í˜¸ìŠ¤íŠ¸:</b> BGM ì„ íƒ ê¸°ì¤€, íš¨ê³¼ìŒ ì‚¬ìš©ì˜ ì ì ˆì„±, í˜¸ìŠ¤íŠ¸ì˜ í†¤ì•¤ë§¤ë„ˆë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</li>
                    </ul>
                </div>

                <!-- ì°¸ì—¬ ë° SEO ë¶„ì„ (4, 5ë‹¨ê³„) -->
                <div class="bg-card-bg p-6 rounded-xl shadow-xl md:col-span-2">
                    <h3 class="text-lg font-bold text-success-status mb-3">ğŸ” 4 & 5ë‹¨ê³„: ì°¸ì—¬, ì»¤ë®¤ë‹ˆí‹° ë° SEO ë¶„ì„</h3>
                    <ul class="list-disc ml-5 text-sm space-y-2 text-text-light/80">
                        <li><b>ì°¸ì—¬ìœ¨ ì¶”ì •:</b> ì•„ë˜ ë°ì´í„°(ì¡°íšŒìˆ˜, ì¢‹ì•„ìš”, ëŒ“ê¸€)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì°¸ì—¬ìœ¨ì„ ì¶”ì •í•©ë‹ˆë‹¤.</li>
                        <li><b>ëŒ“ê¸€ ë°˜ì‘:</b> ì‹œì²­ìë“¤ì´ ì£¼ë¡œ ë‚¨ê¸°ëŠ” í•µì‹¬ ë‚´ìš©(ì§ˆë¬¸, ì¹­ì°¬)ì„ íŒŒì•…í•˜ì—¬ ë‹ˆì¦ˆë¥¼ ì •ì˜í•©ë‹ˆë‹¤.</li>
                        <li><b>SEO í•µì‹¬:</b> ì œëª©ê³¼ ì„¤ëª…ë€ì˜ í‚¤ì›Œë“œ ë°°ì¹˜ ì „ëµ ë° í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ êµ¬ì„±ì„ ë¶„ì„í•©ë‹ˆë‹¤.</li>
                        <li><b>ì»¤ë®¤ë‹ˆí‹° í™œìš©:</b> ì»¤ë®¤ë‹ˆí‹° íƒ­ í™œìš© ë°©ì‹(íˆ¬í‘œ, Q&A)ì„ ì§ì ‘ í™•ì¸í•˜ê³  ë²¤ì¹˜ë§ˆí‚¹í•©ë‹ˆë‹¤.</li>
                    </ul>
                </div>
            </div>

            <!-- ì—…ë¡œë“œ ìº˜ë¦°ë” ì˜ì—­ (ì¶”ê°€ë¨) -->
            <h3 class="text-xl font-semibold mb-4 border-b border-primary-accent/50 pb-2 mt-10">
                ì¼ë³„ ì—…ë¡œë“œ ë¹ˆë„ (ì›”ë³„ íƒìƒ‰)
                <button id="resetFilterBtn" class="py-1 px-3 bg-success-status/20 text-success-status text-xs rounded-lg ml-2 hidden" onclick="resetVideoFilter()">
                    âŒ ë‚ ì§œ í•„í„° í•´ì œ
                </button>
            </h3>
            <div id="calendarContainer" class="bg-card-bg p-4 rounded-xl shadow-xl mb-8">
                <!-- Navigation Header -->
                <div id="calendarNavHeader" class="flex justify-between items-center mb-4 px-2">
                    <!-- Buttons and Month/Year will be inserted here by JS -->
                </div>
                
                <div class="grid grid-cols-7 gap-1 border-b border-383b6e pb-1">
                    <!-- ìš”ì¼ í—¤ë” (Permanent) -->
                    <div class="text-center font-bold text-xs text-primary-accent">ì¼</div>
                    <div class="text-center font-bold text-xs text-text-light/70">ì›”</div>
                    <div class="text-center font-bold text-xs text-text-light/70">í™”</div>
                    <div class="text-center font-bold text-xs text-text-light/70">ìˆ˜</div>
                    <div class="text-center font-bold text-xs text-text-light/70">ëª©</div>
                    <div class="text-center font-bold text-xs text-text-light/70">ê¸ˆ</div>
                    <div class="text-center font-bold text-xs text-primary-accent">í† </div>
                </div>
                
                <!-- Calendar Body (Dynamic Cells) -->
                <div id="calendarBody" class="grid grid-cols-7 gap-1 mt-2">
                    <!-- ìº˜ë¦°ë” ì…€ì€ JSë¡œ ì±„ì›Œì§ -->
                </div>
            </div>

            <!-- Shorts ìŠ¤í¬ë¡¤ ì„¹ì…˜ (ì¶”ê°€ë¨) -->
            <h3 class="text-xl font-semibold mb-4 border-b border-primary-accent/50 pb-2 mt-10 flex justify-between items-center">
                <span>ğŸ”¥ ìµœì‹  Shorts (1ë¶„ ì´í•˜ ì˜ìƒ) ë¯¸ë¦¬ë³´ê¸°</span>
                <select id="shortsSortBy" class="p-2 rounded-lg bg-bg-dark border border-card-bg text-text-light text-sm" onchange="renderShortsPreview()">
                    <option value="publishedAt" selected>ìµœì‹ ìˆœ</option>
                    <option value="viewCount">ì¸ê¸°ìˆœ (ì¡°íšŒìˆ˜)</option>
                    <option value="likeCount">ì¢‹ì•„ìš”ìˆœ</option>
                    <option value="commentCount">ëŒ“ê¸€ìˆœ</option>
                </select>
            </h3>
            <div id="shortsContainer" class="shorts-scroll-container py-4 -mx-4 px-4 bg-bg-dark/50 rounded-xl shadow-inner hidden">
                <!-- Shorts Scroll Buttons (PC Only) -->
                <!-- Added IDs here for JS selection -->
                <button id="shortsLeftBtn" class="scroll-button left-4 text-text-light hover:text-success-status" onclick="scrollShorts(-300)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div id="shortsContent" class="shorts-content whitespace-nowrap">
                    <!-- Shorts cards will be inserted here by JS -->
                </div>
                <button id="shortsRightBtn" class="scroll-button right-4 text-text-light hover:text-success-status" onclick="scrollShorts(300)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>


            <!-- ì „ì²´ ë¹„ë””ì˜¤ ë¶„ì„ í…Œì´ë¸” -->
            <h3 class="text-xl font-semibold mb-4 border-b border-primary-accent/50 pb-2 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <span>ì±„ë„ ì „ì²´ ë¹„ë””ì˜¤ ìƒì„¸ ë¶„ì„ ë°ì´í„° (<span id="totalVideosCount">0</span>ê°œ)</span>
                
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full md:w-auto">
                    <!-- CSV ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
                    <button id="downloadCsvBtn" 
                            class="w-full sm:w-auto py-2 px-3 bg-success-status text-bg-dark font-bold rounded-lg hover:bg-success-status/80 transition duration-200"
                            onclick="exportToCSV()" disabled>
                        â¬‡ï¸ CSV ë‹¤ìš´ë¡œë“œ
                    </button>

                    <!-- í•„í„° ë²„íŠ¼ ë° ë©”ë‰´ -->
                    <div class="relative inline-block text-left w-full sm:w-auto z-50">
                        <button id="filterToggleBtn" onclick="toggleFilterMenu()" class="w-full sm:w-auto flex justify-between items-center py-2 px-3 bg-card-bg border border-text-light/20 rounded-lg text-text-light hover:bg-card-bg/80 transition duration-200">
                            <span>ğŸ” í•„í„° ì„¤ì •</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <!-- í•„í„° ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
                        <div id="filterMenu" class="hidden absolute right-0 mt-2 w-full sm:w-64 bg-card-bg border border-text-light/20 rounded-lg shadow-2xl p-4 filter-dropdown origin-top-right">
                            <div class="mb-4">
                                <h4 class="font-bold text-primary-accent mb-2 text-sm border-b border-text-light/10 pb-1">ì˜ìƒ ë¶„ë¥˜</h4>
                                <label class="flex items-center space-x-2 mb-1 cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-type" value="short" checked> <span class="text-sm">ìˆí¼ (1ë¶„ ì´í•˜)</span></label>
                                <label class="flex items-center space-x-2 mb-1 cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-type" value="mid" checked> <span class="text-sm">ë¯¸ë“œí¼ (1~3ë¶„)</span></label>
                                <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-type" value="long" checked> <span class="text-sm">ë¡±í¼ (3ë¶„ ì´ìƒ)</span></label>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-bold text-primary-accent mb-2 text-sm border-b border-text-light/10 pb-1">L/V ë¹„ìœ¨ ë“±ê¸‰ (ì¢‹ì•„ìš”)</h4>
                                <div class="grid grid-cols-5 gap-1 text-center">
                                    <label class="cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-like" value="1" checked><br><span class="text-xs">1â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-like" value="2" checked><br><span class="text-xs">2â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-like" value="3" checked><br><span class="text-xs">3â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-like" value="4" checked><br><span class="text-xs">4â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-like" value="5" checked><br><span class="text-xs">5â˜…</span></label>
                                </div>
                            </div>
                            <div class="mb-2">
                                <h4 class="font-bold text-primary-accent mb-2 text-sm border-b border-text-light/10 pb-1">C/V ë¹„ìœ¨ ë“±ê¸‰ (ëŒ“ê¸€)</h4>
                                <div class="grid grid-cols-5 gap-1 text-center">
                                    <label class="cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-comment" value="1" checked><br><span class="text-xs">1â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-comment" value="2" checked><br><span class="text-xs">2â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-comment" value="3" checked><br><span class="text-xs">3â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-comment" value="4" checked><br><span class="text-xs">4â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" onchange="updateFilters()" class="filter-comment" value="5" checked><br><span class="text-xs">5â˜…</span></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì •ë ¬ ì»¨íŠ¸ë¡¤ -->
                    <div id="sortControls" class="flex items-center space-x-2 w-full sm:w-auto">
                        <select id="sortBy" class="flex-grow sm:flex-grow-0 p-2 rounded-lg bg-bg-dark border border-card-bg text-text-light" onchange="renderVideoList()">
                            <option value="publishedAt">ê²Œì‹œì¼</option>
                            <option value="viewCount">ì¡°íšŒìˆ˜</option>
                            <option value="likeCount">ì¢‹ì•„ìš”</option>
                            <option value="commentCount">ëŒ“ê¸€ ìˆ˜</option>
                            <option value="durationSeconds">ì˜ìƒ ê¸¸ì´</option>
                            <option value="likeRatio">ì¢‹ì•„ìš” ë¹„ìœ¨</option>
                            <option value="commentRatio">ëŒ“ê¸€ ë¹„ìœ¨</option>
                        </select>
                        <button id="sortDirectionBtn" class="p-2 bg-primary-accent hover:bg-primary-accent/80 rounded-lg text-white" onclick="toggleSortDirection()">
                            <svg id="sortIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block transform rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414l-2.293 2.293a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zM10 17a1 1 0 01-.707-.293l-3-3a1 1 0 011.414-1.414L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3A1 1 0 0110 17z" clip-rule="evenodd" /></svg>
                            <!-- FIX: span íƒœê·¸ ë³µêµ¬ -->
                            <span id="sortDirectionText" class="hidden sm:inline-block">ë‚´ë¦¼ì°¨ìˆœ</span>
                        </button>
                    </div>
                </div>
            </h3>
            <div class="overflow-x-auto bg-card-bg rounded-xl shadow-2xl">
                <table class="min-w-full divide-y divide-bg-dark">
                    <thead class="bg-bg-dark">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-text-light/70 uppercase tracking-wider hidden md:table-cell">ë²ˆí˜¸</th>
                            <!-- ì¸ë„¤ì¼ ì»¬ëŸ¼ ì œê±°ë¨ -->
                            <th class="px-3 py-3 text-left text-xs font-medium text-text-light/70 uppercase tracking-wider w-1/3">ì œëª©</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-text-light/70 uppercase tracking-wider">ê²Œì‹œì¼</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-text-light/70 uppercase tracking-wider">ì¡°íšŒìˆ˜</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-text-light/70 uppercase tracking-wider hidden sm:table-cell">ê¸¸ì´</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-text-light/70 uppercase tracking-wider hidden md:table-cell">ë¶„ë¥˜</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-text-light/70 uppercase tracking-wider hidden sm:table-cell">L/V ë¹„ìœ¨ (5)</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-text-light/70 uppercase tracking-wider hidden md:table-cell">C/V ë¹„ìœ¨ (5)</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-text-light/70 uppercase tracking-wider hidden lg:table-cell">ì¢‹ì•„ìš”</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-text-light/70 uppercase tracking-wider hidden xl:table-cell">ëŒ“ê¸€ ìˆ˜</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-text-light/70 uppercase tracking-wider hidden 2xl:table-cell">íƒœê·¸</th> <!-- íƒœê·¸ ìˆ¨ê¹€ ê¸°ì¤€ ë³€ê²½ -->
                        </tr>
                    </thead>
                    <tbody id="videoListTableBody" class="divide-y divide-card-bg/50">
                        <!-- ë¹„ë””ì˜¤ ë°ì´í„°ëŠ” JSë¡œ ì±„ì›Œì§ -->
                    </tbody>
                </table>
                <p id="noVideosMessage" class="hidden text-center text-text-light/50 py-10">ë¹„ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </section>

    </main>

    <!-- ìƒë‹¨ìœ¼ë¡œ ë°”ë¡œê°€ê¸° ë²„íŠ¼ -->
    <button id="backToTopBtn" 
            class="fixed bottom-6 right-6 p-3 bg-primary-accent hover:bg-primary-accent/80 text-white rounded-full shadow-xl transition-all duration-300 opacity-0 transform translate-y-4 z-20"
            onclick="scrollToTop()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <script>
        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const apiKeyInput = document.getElementById('apiKey');
        const channelIdInput = document.getElementById('channelId');
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('buttonText');
        const statusMessage = document.getElementById('statusMessage');
        const resultsSection = document.getElementById('resultsSection');
        const channelInfoDiv = document.getElementById('channelInfo');
        const statSubscribers = document.getElementById('statSubscribers');
        const statViews = document.getElementById('statViews');
        const statVideos = document.getElementById('statVideos');
        const avgViews90Days = document.getElementById('avgViews90Days');
        const avgLikes90Days = document.getElementById('avgLikes90Days');
        const avgComments90Days = document.getElementById('avgComments90Days');
        const totalVideosCount = document.getElementById('totalVideosCount');
        const videoListTableBody = document.getElementById('videoListTableBody');
        const noVideosMessage = document.getElementById('noVideosMessage');
        const backToTopBtn = document.getElementById('backToTopBtn');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const calendarBodyElement = document.getElementById('calendarBody'); // ìº˜ë¦°ë” ë°”ë”” ìš”ì†Œ
        const calendarNavHeader = document.getElementById('calendarNavHeader'); // ìº˜ë¦°ë” íƒìƒ‰ í—¤ë”
        const resetFilterBtn = document.getElementById('resetFilterBtn'); // í•„í„° ì´ˆê¸°í™” ë²„íŠ¼
        const shortsContainer = document.getElementById('shortsContainer'); // Shorts ì»¨í…Œì´ë„ˆ
        // shortsContentElement ë³€ìˆ˜ ì‚­ì œ, í•¨ìˆ˜ ë‚´ì—ì„œ document.getElementByIdë¡œ ì§ì ‘ ì¡°íšŒí•˜ë„ë¡ ë³€ê²½
        const shortsSortBy = document.getElementById('shortsSortBy');
        const filterMenu = document.getElementById('filterMenu');

        // ì •ë ¬ ë° ìº˜ë¦°ë” ê´€ë ¨ ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        let allVideosData = []; 
        let channelMetadata = null; 
        let sortKey = 'publishedAt'; 
        let sortDirection = 'desc'; 
        let monthlyCalendarData = {}; 
        let availableMonths = [];     
        let currentCalendarDate = null; 
        let currentFilterDate = null; 

        // [NEW] í•„í„° ìƒíƒœ ì €ì¥ ê°ì²´
        let currentFilters = {
            duration: ['short', 'mid', 'long'],
            likeRating: [1, 2, 3, 4, 5],
            commentRating: [1, 2, 3, 4, 5]
        };

        // YouTube Data API ê¸°ë³¸ URL
        const API_BASE_URL = 'https://www.googleapis.com/youtube/v3/';

        // ----------------------------------------------------
        // API í˜¸ì¶œ ë° ì˜¤ë¥˜ ì²˜ë¦¬ í•¨ìˆ˜
        // ----------------------------------------------------

        async function checkResponse(response) {
            if (!response.ok) {
                const errorBody = await response.json();
                const errorMessage = errorBody.error ? errorBody.error.message : response.statusText;
                throw new Error(`API ì˜¤ë¥˜: ${response.status} - ${errorMessage}`);
            }
            return response.json();
        }

        async function fetchWithRetry(url, options = {}, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { 
                        return response;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìš”ì²­ì´ ë„ˆë¬´ ë§ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
        }


        // ----------------------------------------------------
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ì „ì—­ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ ìƒë‹¨ì— ë°°ì¹˜)
        // ----------------------------------------------------
        
        /**
         * ì„¤ëª… í–‰ì˜ í‘œì‹œ ìƒíƒœë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
         */
        function toggleDescription(videoId) {
            const descRow = document.getElementById(`desc-row-${videoId}`);
            const icon = document.getElementById(`toggle-icon-${videoId}`);
            
            if (descRow.classList.contains('hidden')) {
                descRow.classList.remove('hidden');
                icon.classList.remove('rotate-0');
                icon.classList.add('rotate-90');
            } else {
                descRow.classList.add('hidden');
                icon.classList.remove('rotate-90');
                icon.classList.add('rotate-0');
            }
        }
        window.toggleDescription = toggleDescription; 

        // [NEW] í•„í„° ë©”ë‰´ í† ê¸€
        function toggleFilterMenu() {
            filterMenu.classList.toggle('hidden');
        }
        window.toggleFilterMenu = toggleFilterMenu;

        // [NEW] í•„í„° ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ëª©ë¡ ê°±ì‹ 
        function updateFilters() {
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì½ê¸°
            currentFilters.duration = Array.from(document.querySelectorAll('.filter-type:checked')).map(el => el.value);
            currentFilters.likeRating = Array.from(document.querySelectorAll('.filter-like:checked')).map(el => parseInt(el.value));
            currentFilters.commentRating = Array.from(document.querySelectorAll('.filter-comment:checked')).map(el => parseInt(el.value));
            
            // í•„í„°ë§ ì ìš©í•˜ì—¬ ëª©ë¡ ê°±ì‹ 
            renderVideoList();
        }
        window.updateFilters = updateFilters;

        // ì™¸ë¶€ í´ë¦­ ì‹œ í•„í„° ë©”ë‰´ ë‹«ê¸°
        window.onclick = function(event) {
            if (!event.target.closest('#filterToggleBtn') && !event.target.closest('#filterMenu')) {
                filterMenu.classList.add('hidden');
            }
        }

        // [NEW] ì˜ìƒ ID ì¶”ì¶œ í•¨ìˆ˜
        function extractVideoId(input) {
            // ë‹¤ì–‘í•œ ìœ íŠœë¸Œ URL í¬ë§·ì„ ì§€ì›í•˜ëŠ” ì •ê·œì‹
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([^"&?\/\s]{11})/;
            const match = input.match(regex);
            return match ? match[1] : null;
        }

        function extractChannelId(input) {
            // FIX: URL ë’¤ì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ë¨¼ì € ì œê±°í•˜ê³  í•¸ë“¤/ID ì¶”ì¶œì„ ì‹œë„
            const cleanedInput = input.split('?')[0].split('&')[0].trim();

            // 1. Handle/Channel/User/Custom URL extraction
            // Looks for pattern after channel/, user/, c/, or @
            // Stops at /, ?, or &
            const urlMatch = cleanedInput.match(/(?:channel\/|user\/|c\/|@)([^/]+)/);
            if (urlMatch && urlMatch[1]) {
                return urlMatch[1];
            }
            
            // 2. Fallback: If it's a direct ID/Handle
            return cleanedInput;
        }

        function parseDurationToSeconds(isoDuration) {
            if (!isoDuration) return 0;
            const regex = /P(?:(\d+)Y)?(?:(\d+)M)?(?:(\d+)W)?(?:(\d+)D)?T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
            const matches = isoDuration.match(regex);
            if (!matches) return 0;

            const parts = matches.slice(1).map(x => parseInt(x) || 0);
            
            const seconds = 
                parts[4] * 3600 + // Hours
                parts[5] * 60 +   // Minutes
                parts[6];         // Seconds
            
            return seconds;
        }

        function formatTime(totalSeconds) {
            if (totalSeconds === 0) return '0:00';
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;

            let result = '';
            if (h > 0) {
                result += h + ':';
                result += (m < 10 ? '0' : '') + m + ':';
            } else {
                result += m + ':';
            }
            result += (s < 10 ? '0' : '') + s;
            
            return result;
        }

        function classifyDuration(seconds) {
            if (seconds <= 60) {
                return '<span class="text-primary-accent">ìˆí¼ (Short)</span>'; 
            } else if (seconds < 180) {
                return '<span class="text-text-light/80">ë¯¸ë“œí¼ (Mid)</span>';
            } else {
                return '<span class="text-success-status">ë¡±í¼ (Long)</span>';
            }
        }
        
        function copyToClipboard(text, event) {
            event.stopPropagation(); 
            
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    setStatus('âœ”ï¸ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', false);
                } else {
                    throw new Error('ë³µì‚¬ ì‹¤íŒ¨');
                }
            } catch (err) {
                setStatus('ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.', true);
            }
            
            document.body.removeChild(tempInput);
        }

        function calculateEngagementRatings(videos) {
            if (videos.length === 0) return;

            const likeRatios = [];
            const commentRatios = [];

            videos.forEach(video => {
                const views = parseInt(video.viewCount || 0);
                const likes = parseInt(video.likeCount || 0);
                const comments = parseInt(video.commentCount || 0);

                const likeRatio = views > 0 ? (likes / views) * 100 : 0;
                const commentRatio = views > 0 ? (comments / views) * 100 : 0;

                if (views > 0) { 
                    likeRatios.push(likeRatio);
                    commentRatios.push(commentRatio);
                }
                
                video.likeRatio = likeRatio;
                video.commentRatio = commentRatio;
                video.likeRating = 1; 
                video.commentRating = 1; 
            });

            if (likeRatios.length > 0) {
                likeRatios.sort((a, b) => a - b);
                const lLength = likeRatios.length;
                const thresholds = [
                    likeRatios[Math.floor(lLength * 0.2)] || 0,
                    likeRatios[Math.floor(lLength * 0.4)] || 0,
                    likeRatios[Math.floor(lLength * 0.6)] || 0,
                    likeRatios[Math.floor(lLength * 0.8)] || 0
                ];
                
                videos.forEach(video => {
                    if (video.likeRatio >= thresholds[3]) video.likeRating = 5;
                    else if (video.likeRatio >= thresholds[2]) video.likeRating = 4;
                    else if (video.likeRatio >= thresholds[1]) video.likeRating = 3;
                    else if (video.likeRatio >= thresholds[0]) video.likeRating = 2;
                });
            }

            if (commentRatios.length > 0) {
                commentRatios.sort((a, b) => a - b);
                const cLength = commentRatios.length;
                const thresholds = [
                    commentRatios[Math.floor(cLength * 0.2)] || 0,
                    commentRatios[Math.floor(cLength * 0.4)] || 0,
                    commentRatios[Math.floor(cLength * 0.6)] || 0,
                    commentRatios[Math.floor(cLength * 0.8)] || 0
                ];
                
                videos.forEach(video => {
                    if (video.commentRatio >= thresholds[3]) video.commentRating = 5;
                    else if (video.commentRatio >= thresholds[2]) video.commentRating = 4;
                    else if (video.commentRatio >= thresholds[1]) video.commentRating = 3;
                    else if (video.commentRatio >= thresholds[0]) video.commentRating = 2;
                });
            }
        }

        function renderRatingStars(rating) {
            let stars = '';
            const fullStar = 'â˜…';
            const emptyStar = 'â˜†';
            for (let i = 0; i < 5; i++) {
                stars += `<span class="${i < rating ? 'text-warning-star' : 'text-gray-600'}">${fullStar}</span>`;
            }
            return stars;
        }


        function setStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `mt-4 text-center text-sm font-medium ${isError ? 'text-primary-accent' : 'text-success-status'}`;
        }
        
        function clearApiKey() {
            apiKeyInput.value = '';
            setStatus('API í‚¤ ì…ë ¥ í•„ë“œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.', false);
        }
        window.clearApiKey = clearApiKey; // ì „ì—­ ë“±ë¡

        function formatNumber(num) {
            if (num === '0' || num === undefined || num === null || num === 'N/A') return 'N/A';
            try {
                return new Intl.NumberFormat('ko-KR').format(parseFloat(num));
            } catch (e) {
                return 'N/A';
            }
        }
        
        function exportToCSV() {
            if (allVideosData.length === 0 || !channelMetadata) {
                setStatus('ë‹¤ìš´ë¡œë“œí•  ë¹„ë””ì˜¤ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì±„ë„ ë©”íƒ€ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', true);
                return;
            }

            const channelRows = [
                ['--- ì±„ë„ ë©”íƒ€ë°ì´í„° ---'],
                ['ì±„ë„ ì´ë¦„', channelMetadata.title],
                ['ì±„ë„ ID', channelMetadata.id],
                ['êµ¬ë…ì ìˆ˜', channelMetadata.subscribers],
                ['ì´ ì¡°íšŒìˆ˜', channelMetadata.totalViews],
                ['ì´ ì˜ìƒ ìˆ˜', channelMetadata.totalVideos],
                ['ì†Œê°œ', `"${(channelMetadata.description || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`],
                ['ì±„ë„ ìƒì„±ì¼', new Date(channelMetadata.publishedAt).toISOString()],
                ['ì±„ë„ êµ­ê°€', channelMetadata.country],
                ['--- ë¹„ë””ì˜¤ ë°ì´í„° ---']
            ].map(row => row.join(','));


            const videoHeader = ['ì œëª©', 'ë¹„ë””ì˜¤ID', 'ìœ íŠœë¸Œ ë§í¬', 'ê²Œì‹œì¼', 'ì¡°íšŒìˆ˜', 'ì¢‹ì•„ìš”', 'ëŒ“ê¸€ìˆ˜', 'ì¢‹ì•„ìš” ë¹„ìœ¨ (%)', 'ëŒ“ê¸€ ë¹„ìœ¨ (%)', 'ì˜ìƒ ê¸¸ì´ (ì´ˆ)', 'í¼ ë¶„ë¥˜', 'íƒœê·¸', 'ì„¤ëª…'];
            
            const csvRows = allVideosData.map(video => {
                const tagsString = video.tags ? video.tags.join('|') : '';
                const videoLink = `https://youtu.be/${video.videoId}`; 
                
                const rawCategory = video.durationCategory ? video.durationCategory.replace(/<[^>]*>?/gm, '').trim() : 'N/A';
                
                const escapedDescription = `"${(video.description || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`; 
                
                const values = [
                    `"${video.title.replace(/"/g, '""')}"`, 
                    video.videoId,
                    videoLink,
                    new Date(video.publishedAt).toISOString(),
                    video.viewCount,
                    video.likeCount,
                    video.commentCount,
                    video.likeRatio.toFixed(3),
                    video.commentRatio.toFixed(3),
                    video.durationSeconds,
                    rawCategory,
                    `"${tagsString.replace(/"/g, '""')}"`,
                    escapedDescription 
                ];
                return values.join(',');
            });

            const csvContent = [
                ...channelRows,
                videoHeader.join(','),
                ...csvRows
            ].join('\n');

            const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            const channelTitle = channelMetadata.title || 'YouTube_Analysis';
            a.setAttribute('download', `${channelTitle}_ë¹„ë””ì˜¤_ë¶„ì„_${new Date().toISOString().slice(0, 10)}.csv`);
            a.click();
            URL.revokeObjectURL(url);

            setStatus('CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', false);
        }
        
        function generateUploadCalendarData(videos) {
            const uploadCounts = {};
            
            videos.forEach(video => {
                const publishedDate = new Date(video.publishedAt);
                const dateKey = publishedDate.toISOString().slice(0, 10);
                
                if (!uploadCounts[dateKey]) {
                    uploadCounts[dateKey] = 0;
                }
                uploadCounts[dateKey]++;
            });

            const monthlyData = {};
            const availableMonthsSet = new Set();
            
            Object.keys(uploadCounts).forEach(dateKey => {
                const monthKey = dateKey.slice(0, 7); // YYYY-MM
                availableMonthsSet.add(monthKey);
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = new Map();
                }
                monthlyData[monthKey].set(dateKey, uploadCounts[dateKey]);
            });

            availableMonths = Array.from(availableMonthsSet).sort((a, b) => b.localeCompare(a));
            
            return monthlyData;
        }

        function navigateCalendar(direction) {
            if (!currentCalendarDate || availableMonths.length === 0) return;

            const currentIndex = availableMonths.indexOf(currentCalendarDate);
            let newIndex = currentIndex + direction; 
            
            if (newIndex >= 0 && newIndex < availableMonths.length) {
                currentCalendarDate = availableMonths[newIndex];
                renderCalendar(monthlyCalendarData);
            }
        }
        window.navigateCalendar = navigateCalendar; // ì „ì—­ ë“±ë¡

        function filterVideosByDate(dateKey, count, event) {
            event.stopPropagation();
            if (count === 0) {
                setStatus(`ì„ íƒí•˜ì‹  ${dateKey}ì—ëŠ” ì—…ë¡œë“œëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.`, false);
                return;
            }
            
            currentFilterDate = dateKey;
            
            document.querySelectorAll('.calendar-cell').forEach(cell => {
                cell.classList.remove('ring-2', 'ring-success-status');
            });
            event.currentTarget.classList.add('ring-2', 'ring-success-status');
            
            renderVideoList();
            
            resetFilterBtn.classList.remove('hidden');
            setStatus(`${dateKey}ì— ì—…ë¡œë“œëœ ì˜ìƒë§Œ í•„í„°ë§í•©ë‹ˆë‹¤.`, false);
        }
        window.filterVideosByDate = filterVideosByDate; // ì „ì—­ ë“±ë¡

        function resetVideoFilter() {
            currentFilterDate = null;
            resetFilterBtn.classList.add('hidden');
            document.querySelectorAll('.calendar-cell').forEach(cell => {
                cell.classList.remove('ring-2', 'ring-success-status');
            });
            renderVideoList();
            setStatus('ì „ì²´ ì˜ìƒ ëª©ë¡ì„ ë‹¤ì‹œ í‘œì‹œí•©ë‹ˆë‹¤.', false);
        }
        window.resetVideoFilter = resetVideoFilter; // ì „ì—­ ë“±ë¡

        function renderCalendar(fullMonthlyData) {
            const container = calendarBodyElement;
            const navHeader = calendarNavHeader;
            container.innerHTML = '';
            
            if (Object.keys(fullMonthlyData).length === 0) {
                navHeader.innerHTML = '';
                container.innerHTML = `<div class="col-span-7 text-center py-4 text-text-light/50">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }
            
            if (!currentCalendarDate || !fullMonthlyData[currentCalendarDate]) {
                currentCalendarDate = availableMonths[0]; 
            }
            
            const dayData = fullMonthlyData[currentCalendarDate] || new Map();
            const [year, month] = currentCalendarDate.split('-').map(Number);
            const monthStr = String(month).padStart(2, '0');
            
            const currentIndex = availableMonths.indexOf(currentCalendarDate);
            const hasPrev = currentIndex < availableMonths.length - 1; 
            const hasNext = currentIndex > 0; 
            
            navHeader.innerHTML = `
                <button onclick="navigateCalendar(1)" ${!hasPrev ? 'disabled' : ''} class="px-3 py-1 bg-card-bg/50 border border-card-bg rounded-lg text-primary-accent hover:bg-primary-accent/10 disabled:text-text-light/30 disabled:hover:bg-card-bg/50 transition">
                    &larr; ì´ì „
                </button>
                <span class="text-lg font-bold text-text-light">${year}ë…„ ${month}ì›”</span>
                <button onclick="navigateCalendar(-1)" ${!hasNext ? 'disabled' : ''} class="px-3 py-1 bg-card-bg/50 border border-card-bg rounded-lg text-primary-accent hover:bg-primary-accent/10 disabled:text-text-light/30 disabled:hover:bg-card-bg/50 transition">
                    ë‹¤ìŒ &rarr;
                </button>
            `;

            const firstDayOfMonth = new Date(year, month - 1, 1);
            const firstDayOfWeek = firstDayOfMonth.getDay(); 
            const lastDayOfMonth = new Date(year, month, 0).getDate(); 
            
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-cell bg-card-bg/20 border-card-bg text-text-light/30';
                emptyCell.textContent = '';
                container.appendChild(emptyCell);
            }

            for (let day = 1; day <= lastDayOfMonth; day++) {
                const dateKey = `${year}-${monthStr}-${String(day).padStart(2, '0')}`;
                const count = dayData.get(dateKey) || 0;

                let bgColor = 'bg-card-bg/50';
                let textColor = 'text-text-light/70';
                let countColor = 'text-primary-accent';
                let tooltip = `${dateKey} ì—…ë¡œë“œ: ${count}ê°œ`;

                if (count >= 3) {
                    bgColor = 'bg-primary-accent'; 
                    textColor = 'text-white';
                    countColor = 'text-white';
                } else if (count > 0) {
                    const intensity = Math.min(count, 5);
                    const opacity = 0.5 + intensity * 0.1; 
                    bgColor = `bg-primary-accent/${Math.round(opacity * 100)}`;
                    textColor = 'text-text-light';
                    countColor = 'text-text-light';
                }
                
                const cell = document.createElement('div');
                const fontWeight = count >= 3 ? 'font-extrabold' : '';
                cell.className = `calendar-cell ${bgColor} ${textColor} ${fontWeight} hover:shadow-lg hover:ring-2 ring-success-status/50 transition-all`;
                cell.title = tooltip;
                cell.onclick = (e) => filterVideosByDate(dateKey, count, e); 

                const daySpan = document.createElement('span');
                daySpan.className = 'font-bold leading-none';
                daySpan.textContent = day;
                cell.appendChild(daySpan);

                if (count > 0) {
                    const countSpan = document.createElement('span');
                    countSpan.className = `text-xs leading-none mt-1 ${countColor}`;
                    countSpan.textContent = `${count}ê°œ`;
                    cell.appendChild(countSpan);
                } else {
                    const countSpan = document.createElement('span');
                    countSpan.className = 'text-xs leading-none mt-1 text-text-light/30';
                    countSpan.textContent = '-';
                    cell.appendChild(countSpan);
                }
                
                if (currentFilterDate === dateKey) {
                    cell.classList.add('ring-2', 'ring-success-status');
                    resetFilterBtn.classList.remove('hidden');
                }

                container.appendChild(cell);
            }
        }

        function sortVideos(videosToSort) {
            const directionMultiplier = sortDirection === 'asc' ? 1 : -1;
            const currentSortKey = document.getElementById('sortBy').value; 

            videosToSort.sort((a, b) => {
                let valA, valB;

                if (currentSortKey === 'publishedAt') {
                    valA = new Date(a[currentSortKey] || 0); 
                    valB = new Date(b[currentSortKey] || 0);
                } else if (currentSortKey === 'durationSeconds' || currentSortKey === 'likeRatio' || currentSortKey === 'commentRatio') {
                    valA = a[currentSortKey] || 0;
                    valB = b[currentSortKey] || 0;
                } else {
                    valA = parseInt(a[currentSortKey] || 0, 10);
                    valB = parseInt(b[currentSortKey] || 0, 10);
                }

                if (valA < valB) return -1 * directionMultiplier;
                if (valA > valB) return 1 * directionMultiplier;
                return 0;
            });
        }

        // ì •ë ¬ ë°©í–¥ í† ê¸€
        function toggleSortDirection() {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            const sortDirectionText = document.getElementById('sortDirectionText');
            const sortIcon = document.getElementById('sortIcon');
            
            if (sortDirection === 'desc') {
                sortDirectionText.textContent = 'ë‚´ë¦¼ì°¨ìˆœ';
                sortIcon.classList.add('rotate-180');
            } else {
                sortDirectionText.textContent = 'ì˜¤ë¦„ì°¨ìˆœ';
                sortIcon.classList.remove('rotate-180');
            }
            renderVideoList();
        }
        window.toggleSortDirection = toggleSortDirection; // ì „ì—­ ë“±ë¡

        function renderVideoList() {
            videoListTableBody.innerHTML = '';
            
            // 1. ì „ì²´ ë°ì´í„°ì—ì„œ í•„í„°ë§
            let displayList = allVideosData.filter(video => {
                // (1) ë‚ ì§œ í•„í„° (ìº˜ë¦°ë”)
                if (currentFilterDate && !video.publishedAt.startsWith(currentFilterDate)) {
                    return false;
                }

                // (2) ì†ì„± í•„í„° (ì²´í¬ë°•ìŠ¤)
                // - ë¶„ë¥˜ í•„í„°
                let type = '';
                if (video.durationSeconds <= 60) type = 'short';
                else if (video.durationSeconds < 180) type = 'mid';
                else type = 'long';
                
                if (!currentFilters.duration.includes(type)) return false;

                // - L/V ë“±ê¸‰ í•„í„°
                if (!currentFilters.likeRating.includes(video.likeRating)) return false;

                // - C/V ë“±ê¸‰ í•„í„°
                if (!currentFilters.commentRating.includes(video.commentRating)) return false;

                return true;
            });

            // 2. í•„í„°ëœ ëª©ë¡ ì •ë ¬ (ì˜¤ë¦„ì°¨ìˆœ/ë‚´ë¦¼ì°¨ìˆœ ë°˜ì˜)
            sortVideos(displayList);

            totalVideosCount.textContent = formatNumber(displayList.length);

            if (displayList.length === 0) {
                 noVideosMessage.classList.remove('hidden');
                 downloadCsvBtn.disabled = true;
                 return;
            }
            noVideosMessage.classList.add('hidden');
            downloadCsvBtn.disabled = false;

            // window.copyToClipboard, window.toggleDescription ë“±ì€ ì´ë¯¸ ì „ì—­ ë“±ë¡ë˜ì–´ ìˆìŒ

            displayList.forEach((video, index) => {
                const videoId = video.videoId;
                const videoUrl = `https://youtu.be/${videoId}`;
                
                const mainRow = document.createElement('tr');
                mainRow.className = 'hover:bg-card-bg/70 transition duration-150 cursor-pointer md:align-middle'; 
                mainRow.setAttribute('onclick', `toggleDescription('${videoId}')`); 

                const tagsDisplay = video.tags && video.tags.length > 0
                    ? video.tags.map(tag => `<span class="inline-block bg-primary-accent/30 text-primary-accent text-xs font-medium mr-1 mb-1 px-1.5 py-0.5 rounded-full">${tag}</span>`).join('')
                    : '<span class="text-text-light/50">-</span>';
                
                const formattedDuration = formatTime(video.durationSeconds);
                const durationCategory = video.durationCategory;


                mainRow.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-text-light/70 hidden md:table-cell text-center align-middle">${index + 1}</td>
                    
                    <!-- ì¸ë„¤ì¼ ì»¬ëŸ¼ ì œê±°ë¨ -->

                    <td class="px-3 py-3 text-sm font-medium text-text-light truncate max-w-xs sm:max-w-md flex items-center space-x-2">
                        <a href="${videoUrl}" target="_blank" onclick="event.stopPropagation()" class="hover:text-primary-accent transition block flex-grow truncate">${video.title}</a>
                        <button class="text-success-status hover:text-primary-accent transition duration-150 flex-shrink-0 mr-2" title="ë§í¬ ë³µì‚¬" 
                                onclick="copyToClipboard('${videoUrl}', event)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                                <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2h2V5a2 2 0 012-2h6a2 2 0 00-2-2H5z" />
                            </svg>
                        </button>
                        <button class="text-primary-accent hover:text-success-status transition duration-150 flex-shrink-0" title="ì„¤ëª… ë³´ê¸°/ìˆ¨ê¸°ê¸°" onclick="event.stopPropagation(); toggleDescription('${videoId}')">
                            <svg id="toggle-icon-${videoId}" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform rotate-0 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-text-light/70 text-right md:text-center align-middle">${new Date(video.publishedAt).toLocaleDateString('ko-KR')}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-success-status font-bold text-right md:text-center align-middle">${formatNumber(video.viewCount)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-text-light/80 text-right md:text-center hidden sm:table-cell align-middle">${formattedDuration}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-text-light/80 text-right md:text-center hidden md:table-cell align-middle">${durationCategory}</td>
                    
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-text-light/80 text-right md:text-center hidden sm:table-cell align-middle" title="ì¡°íšŒìˆ˜ ëŒ€ë¹„ ì¢‹ì•„ìš” ë¹„ìœ¨: ${video.likeRatio.toFixed(3)}%">
                        ${renderRatingStars(video.likeRating)}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-text-light/80 text-right md:text-center hidden md:table-cell align-middle" title="ì¡°íšŒìˆ˜ ëŒ€ë¹„ ëŒ“ê¸€ ë¹„ìœ¨: ${video.commentRatio.toFixed(3)}%">
                        ${renderRatingStars(video.commentRating)}
                    </td>
                    
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-text-light/80 text-right md:text-center hidden lg:table-cell align-middle">${formatNumber(video.likeCount)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-text-light/80 text-right md:text-center hidden xl:table-cell align-middle">${formatNumber(video.commentCount)}</td>
                    <td class="px-3 py-3 text-sm text-text-light/70 hidden 2xl:table-cell align-middle">${tagsDisplay}</td>
                `;
                videoListTableBody.appendChild(mainRow);
                
                const descRow = document.createElement('tr');
                descRow.id = `desc-row-${videoId}`;
                descRow.classList.add('hidden', 'bg-card-bg/50');
                descRow.innerHTML = `
                    <td colspan="11" class="p-4 text-sm text-text-light/80 border-t border-bg-dark">
                        <h4 class="font-bold text-primary-accent mb-2">ì„¤ëª…:</h4>
                        <pre class="whitespace-pre-wrap font-sans text-xs">${video.description || 'ì„¤ëª… ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</pre>
                    </td>
                `;
                videoListTableBody.appendChild(descRow);
            });
        }
        window.renderVideoList = renderVideoList; // ì „ì—­ ë“±ë¡
        
        function renderShortsPreview() {
            const sortBy = shortsSortBy ? shortsSortBy.value : 'publishedAt';
            const contentDiv = document.getElementById('shortsContent');
            const shortsContainer = document.getElementById('shortsContainer');
            const leftBtn = document.getElementById('shortsLeftBtn');
            const rightBtn = document.getElementById('shortsRightBtn');
            
            if (!contentDiv || !shortsContainer) return;

            let shorts = allVideosData
                .filter(video => video.durationSeconds <= 60);

            shorts.sort((a, b) => {
                let valA, valB;

                if (sortBy === 'publishedAt') {
                    valA = new Date(a.publishedAt);
                    valB = new Date(b.publishedAt);
                    return valB - valA; 
                } else {
                    valA = parseInt(a[sortBy] || 0, 10);
                    valB = parseInt(b[sortBy] || 0, 10);
                    return valB - valA; 
                }
            });

            contentDiv.innerHTML = ''; 

            if (shorts.length === 0) {
                contentDiv.innerHTML = '<div class="w-full text-center py-4"><p class="text-text-light/50 inline-block whitespace-normal">1ë¶„ ì´í•˜ì˜ Shorts ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                
                shortsContainer.classList.remove('hidden');
                
                if(leftBtn) leftBtn.style.display = 'none';
                if(rightBtn) rightBtn.style.display = 'none';
                
                return;
            }
            
            shortsContainer.classList.remove('hidden');
            if(leftBtn) leftBtn.style.display = ''; 
            if(rightBtn) rightBtn.style.display = '';
            
            shorts.forEach(video => {
                const videoId = video.videoId;
                const videoUrl = `https://youtu.be/${videoId}`;
                const thumbnailSrc = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
                const publishedDate = new Date(video.publishedAt).toLocaleDateString('ko-KR');
                
                const card = document.createElement('div');
                card.className = 'inline-block w-40 sm:w-48 bg-card-bg/70 rounded-lg overflow-hidden shadow-lg mr-3 align-top flex-shrink-0 hover:ring-2 ring-primary-accent transition duration-200';
                
                card.innerHTML = `
                    <a href="${videoUrl}" target="_blank" title="${video.title}">
                        <img src="${thumbnailSrc}" onerror="this.onerror=null;this.src='https://placehold.co/320x180/282a4d/f8f8f8?text=NO+IMG';" 
                             class="w-full h-24 object-cover">
                    </a>
                    <div class="p-2 text-xs">
                        <p class="font-medium text-text-light truncate">${video.title}</p>
                        <p class="text-text-light/60 mt-1">
                            <span class="text-success-status font-bold">ì¡°íšŒìˆ˜ ${formatNumber(video.viewCount)}</span> â€¢ ${publishedDate}
                        </p>
                        <div class="flex space-x-3 mt-1 text-text-light/80">
                            <span title="ì¢‹ì•„ìš” ìˆ˜" class="flex items-center">ğŸ‘ ${formatNumber(video.likeCount)}</span>
                            <span title="ëŒ“ê¸€ ìˆ˜" class="flex items-center">ğŸ’¬ ${formatNumber(video.commentCount)}</span>
                        </div>
                    </div>
                `;
                contentDiv.appendChild(card);
            });
            
            if (contentDiv.lastChild) {
                contentDiv.lastChild.classList.remove('mr-3');
            }
        }
        window.renderShortsPreview = renderShortsPreview; 

        function scrollShorts(distance) {
            const contentDiv = document.getElementById('shortsContent');
            if (contentDiv) {
                contentDiv.scrollLeft += distance;
            }
        }
        window.scrollShorts = scrollShorts; 


        async function fetchAllVideoIds(apiKey, uploadsPlaylistId, videosArray = [], pageToken = null) {
            let url = `${API_BASE_URL}playlistItems?part=snippet,contentDetails&playlistId=${uploadsPlaylistId}&maxResults=50&key=${apiKey}`;
            if (pageToken) {
                url += `&pageToken=${pageToken}`;
            }

            setStatus(`[${videosArray.length}ê°œ] ë¹„ë””ì˜¤ IDë¥¼ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤... (API í• ë‹¹ëŸ‰ ì†Œë¹„)`, false);
            
            const response = await fetchWithRetry(url);
            const data = await checkResponse(response);
            
            data.items.forEach(item => {
                if (item.snippet.title !== 'Deleted video' && item.contentDetails.videoId) {
                    videosArray.push({
                        videoId: item.contentDetails.videoId,
                        title: item.snippet.title,
                        publishedAt: item.snippet.publishedAt,
                        tags: [], 
                        viewCount: 'N/A',
                        likeCount: 'N/A',
                        commentCount: 'N/A',
                        description: '', 
                        durationSeconds: 0,
                        durationCategory: 'N/A',
                        likeRatio: 0,
                        commentRatio: 0,
                        likeRating: 1,
                        commentRating: 1,
                    });
                }
            });

            if (data.nextPageToken) {
                return fetchAllVideoIds(apiKey, uploadsPlaylistId, videosArray, data.nextPageToken);
            }
            return videosArray;
        }

        async function fetchVideoStatsBatch(apiKey, videoIds) {
            const batchSize = 50;
            const allStats = [];

            for (let i = 0; i < videoIds.length; i += batchSize) {
                const batchIds = videoIds.slice(i, i + batchSize);
                const idsString = batchIds.join(',');

                setStatus(`ë¹„ë””ì˜¤ ìƒì„¸ í†µê³„/íƒœê·¸ ë°°ì¹˜ [${i / batchSize + 1}] ìˆ˜ì§‘ ì¤‘...`, false);

                const statsUrl = `${API_BASE_URL}videos?part=snippet,statistics,contentDetails&id=${idsString}&key=${apiKey}`;
                const response = await fetchWithRetry(statsUrl);
                const data = await checkResponse(response);
                
                allStats.push(...data.items);
            }
            return allStats;
        }


        function extractChannelId(input) {
            // FIX: URL ë’¤ì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ë¨¼ì € ì œê±°í•˜ê³  í•¸ë“¤/ID ì¶”ì¶œì„ ì‹œë„
            const cleanedInput = input.split('?')[0].split('&')[0].trim();

            // 1. Handle/Channel/User/Custom URL extraction
            // Looks for pattern after channel/, user/, c/, or @
            // Stops at /, ?, or &
            const urlMatch = cleanedInput.match(/(?:channel\/|user\/|c\/|@)([^/]+)/);
            if (urlMatch && urlMatch[1]) {
                return urlMatch[1];
            }
            
            // 2. Fallback: If it's a direct ID/Handle
            return cleanedInput;
        }

        function calculate90DayAverages(videos) {
            const ninetyDaysAgo = new Date();
            ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
            
            const recentVideos = videos.filter(video => new Date(video.publishedAt) >= ninetyDaysAgo);
            
            if (recentVideos.length === 0) {
                return { avgViews: 0, avgLikes: 0, avgComments: 0 };
            }

            const totalViews = recentVideos.reduce((sum, v) => sum + parseInt(v.viewCount || 0), 0);
            const totalLikes = recentVideos.reduce((sum, v) => sum + parseInt(v.likeCount || 0), 0);
            const totalComments = recentVideos.reduce((sum, v) => sum + parseInt(v.commentCount || 0), 0);
            
            const count = recentVideos.length;
            
            return {
                avgViews: Math.round(totalViews / count),
                avgLikes: Math.round(totalLikes / count),
                avgComments: Math.round(totalComments / count)
            };
        }


        async function startAnalysis() {
            const apiKey = apiKeyInput.value.trim();
            const rawInput = channelIdInput.value.trim();
            let channelId = extractChannelId(rawInput);
            let uploadsPlaylistId = '';

            if (!apiKey || !channelId) {
                setStatus('API í‚¤ì™€ ì±„ë„ ID ë˜ëŠ” ë§í¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.', true);
                return;
            }

            analyzeButton.disabled = true;
            buttonText.textContent = 'ë¶„ì„ ì¤‘...';
            setStatus('ìœ íŠœë¸Œ APIë¥¼ í˜¸ì¶œí•˜ê³  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.', false);
            resultsSection.classList.add('hidden');
            channelInfoDiv.innerHTML = '';
            videoListTableBody.innerHTML = '';
            allVideosData = []; 
            downloadCsvBtn.disabled = true;
            monthlyCalendarData = {};
            currentCalendarDate = null;
            currentFilterDate = null;
            resetFilterBtn.classList.add('hidden');
            renderCalendar({}); 
            renderShortsPreview(); 
            avgViews90Days.textContent = avgLikes90Days.textContent = avgComments90Days.textContent = '0'; 


            try {
                let channelItem;
                
                // [NEW] Check for Video ID first
                const videoId = extractVideoId(rawInput);
                let fetchChannelByVideo = false;

                if (videoId) {
                    setStatus('ì˜ìƒ ID ê°ì§€ë¨. ì±„ë„ ì •ë³´ë¥¼ ì°¾ëŠ” ì¤‘...', false);
                    const videoUrl = `${API_BASE_URL}videos?part=snippet&id=${videoId}&key=${apiKey}`;
                    const videoResponse = await fetchWithRetry(videoUrl);
                    const videoData = await checkResponse(videoResponse);

                    if (videoData.items && videoData.items.length > 0) {
                        channelId = videoData.items[0].snippet.channelId;
                        fetchChannelByVideo = true;
                    } else {
                        throw new Error('í•´ë‹¹ ì˜ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }

                const partList = 'snippet,statistics,contentDetails';
                
                // If channelId is already found via video, skip handle check
                if (fetchChannelByVideo) {
                     setStatus('ì±„ë„ IDë¡œ ê¸°ë³¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', false);
                     const channelUrl = `${API_BASE_URL}channels?part=${partList}&id=${channelId}&key=${apiKey}`;
                     const channelResponse = await fetchWithRetry(channelUrl);
                     const channelData = await checkResponse(channelResponse);

                     if (!channelData.items || channelData.items.length === 0) {
                        throw new Error('ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì˜ëª»ëœ IDì…ë‹ˆë‹¤.');
                    }
                    channelItem = channelData.items[0];

                } else if (!channelId.startsWith('UC')) {
                     setStatus('ì‚¬ìš©ì ì´ë¦„(@username)ìœ¼ë¡œ ì±„ë„ IDë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...', false);
                     const searchHandle = channelId.startsWith('@') ? channelId : `@${channelId}`; // @ ì¶”ê°€
                     const searchUrl = `${API_BASE_URL}channels?part=${partList}&forHandle=${searchHandle}&key=${apiKey}`;
                     const searchResponse = await fetchWithRetry(searchUrl);
                     const searchData = await checkResponse(searchResponse);
                     
                     if (!searchData.items || searchData.items.length === 0) {
                         throw new Error('í•´ë‹¹ ì‚¬ìš©ì ì´ë¦„(@)ì„ ê°€ì§„ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                     }
                     channelId = searchData.items[0].id; 
                     channelItem = searchData.items[0]; 
                } else {
                    setStatus('ì±„ë„ IDë¡œ ê¸°ë³¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', false);
                    const channelUrl = `${API_BASE_URL}channels?part=${partList}&id=${channelId}&key=${apiKey}`;
                    const channelResponse = await fetchWithRetry(channelUrl);
                    const channelData = await checkResponse(channelResponse);
                    
                    if (!channelData.items || channelData.items.length === 0) {
                        throw new Error('ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì˜ëª»ëœ IDì…ë‹ˆë‹¤.');
                    }
                    channelItem = channelData.items[0]; 
                }

                uploadsPlaylistId = channelItem.contentDetails.relatedPlaylists.uploads;


                const channelSnippet = channelItem.snippet;
                const channelStats = channelItem.statistics;

                channelMetadata = {
                    title: channelSnippet.title,
                    id: channelId,
                    subscribers: channelStats.subscriberCount,
                    totalViews: channelStats.viewCount,
                    totalVideos: channelStats.videoCount,
                    description: channelSnippet.description,
                    publishedAt: channelSnippet.publishedAt,
                    country: channelSnippet.country || 'N/A'
                };
                
                channelInfoDiv.innerHTML = `
                    <div class="flex items-start space-x-4 p-4 bg-bg-dark rounded-xl shadow-inner col-span-full md:col-span-1">
                        <img src="${channelSnippet.thumbnails.default.url}" alt="${channelSnippet.title} ì¸ë„¤ì¼" 
                             class="w-20 h-20 rounded-full object-cover border-4 border-primary-accent flex-shrink-0">
                        <div class="min-w-0">
                            <p class="text-xl font-bold">${channelSnippet.title}</p>
                            <a href="https://youtube.com/channel/${channelId}" target="_blank" class="text-xs text-text-light/60 hover:text-primary-accent transition block truncate">
                                ì±„ë„ ID: ${channelId}
                            </a>
                        </div>
                    </div>
                    <div class="md:col-span-1 p-4 bg-bg-dark rounded-xl shadow-inner">
                        <p class="text-sm italic text-text-light/80 line-clamp-3">${channelSnippet.description}</p>
                        <p class="text-xs mt-3 text-text-light/50">ì±„ë„ ìƒì„±ì¼: ${new Date(channelSnippet.publishedAt).toLocaleDateString('ko-KR')}</p>
                    </div>
                `;

                statSubscribers.textContent = formatNumber(channelStats.subscriberCount);
                statViews.textContent = formatNumber(channelStats.viewCount);
                statVideos.textContent = formatNumber(channelStats.videoCount);
                totalVideosCount.textContent = formatNumber(channelStats.videoCount);

                allVideosData = await fetchAllVideoIds(apiKey, uploadsPlaylistId);
                
                if (allVideosData.length === 0) {
                    renderCalendar({}); 
                    throw new Error('ì±„ë„ì— ê³µê°œëœ ë¹„ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const videoIdsToFetch = allVideosData.map(v => v.videoId);

                const allStats = await fetchVideoStatsBatch(apiKey, videoIdsToFetch);
                
                const statsMap = new Map();
                allStats.forEach(item => {
                    const durationSeconds = parseDurationToSeconds(item.contentDetails.duration);
                    
                    statsMap.set(item.id, {
                        viewCount: item.statistics.viewCount,
                        likeCount: item.statistics.likeCount,
                        commentCount: item.statistics.commentCount,
                        tags: item.snippet.tags || [],
                        description: item.snippet.description || '', 
                        durationSeconds: durationSeconds,
                        durationCategory: classifyDuration(durationSeconds),
                    });
                });
                
                allVideosData = allVideosData.map(video => {
                    const stats = statsMap.get(video.videoId) || {};
                    return {
                        ...video,
                        viewCount: stats.viewCount || '0',
                        likeCount: stats.likeCount || '0',
                        commentCount: stats.commentCount || '0',
                        tags: stats.tags || [],
                        description: stats.description || '', 
                        durationSeconds: stats.durationSeconds || 0,
                        durationCategory: stats.durationCategory || 'N/A',
                        likeRatio: 0,
                        commentRatio: 0,
                        likeRating: 1,
                        commentRating: 1,
                    };
                });
                
                calculateEngagementRatings(allVideosData);
                const avg90Days = calculate90DayAverages(allVideosData);

                avgViews90Days.textContent = formatNumber(avg90Days.avgViews);
                avgLikes90Days.textContent = formatNumber(avg90Days.avgLikes);
                avgComments90Days.textContent = formatNumber(avg90Days.avgComments);


                monthlyCalendarData = generateUploadCalendarData(allVideosData);
                renderCalendar(monthlyCalendarData); 
                renderShortsPreview(); 
                renderVideoList(); 
                
                resultsSection.classList.remove('hidden');
                setStatus(`ë¶„ì„ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ ${formatNumber(allVideosData.length)}ê°œì˜ ë¹„ë””ì˜¤ ë¶„ì„ ì™„ë£Œ.`, false);
                downloadCsvBtn.disabled = false;

            } catch (error) {
                console.error('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                
                let userFriendlyError = error.message;
                if (error.message.includes('API key not valid')) {
                    userFriendlyError = 'API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.';
                } else if (error.message.includes('channelId')) {
                    userFriendlyError = 'ì±„ë„ IDê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ í•´ë‹¹ ì±„ë„ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (error.message.includes('Quota exceeded')) {
                    userFriendlyError = 'API í• ë‹¹ëŸ‰ì´ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‚  ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ í• ë‹¹ëŸ‰ì„ ëŠ˜ë ¤ì£¼ì„¸ìš”.';
                }
                
                setStatus(`ë¶„ì„ ì‹¤íŒ¨: ${userFriendlyError}`, true);
                resultsSection.classList.add('hidden');
                downloadCsvBtn.disabled = true;
            } finally {
                analyzeButton.disabled = false;
                buttonText.textContent = 'ì±„ë„ ë¶„ì„ ì‹œì‘';
            }
        }
        window.startAnalysis = startAnalysis; // ì „ì—­ ë“±ë¡

        
        window.onload = () => {
             setStatus('API í‚¤ì™€ ë¶„ì„í•  ì±„ë„ ID ë˜ëŠ” ë§í¬ë¥¼ ì…ë ¥í•˜ê³  "ì±„ë„ ë¶„ì„ ì‹œì‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
        };
        
        window.onscroll = function() {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                backToTopBtn.classList.remove('opacity-0', 'translate-y-4');
                backToTopBtn.classList.add('opacity-100', 'translate-y-0');
            } else {
                backToTopBtn.classList.remove('opacity-100', 'translate-y-0');
                backToTopBtn.classList.add('opacity-0', 'translate-y-4');
            }
        };

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>

