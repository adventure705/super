<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOUTUBE ì±„ë„ ì‹¬ì¸µ ë¶„ì„ê¸°</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: #383b6e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #e94560; }

        body { font-family: 'Inter', sans-serif; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        #videoListTableBody td { vertical-align: middle; }
        
        /* ìº˜ë¦°ë” ì…€ ìŠ¤íƒ€ì¼ */
        .calendar-cell {
            width: 100%; padding: 4px; text-align: center; font-size: 0.75rem; height: 40px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: 1px solid #383b6e; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;
        }

        /* Shorts ìŠ¤í¬ë¡¤ */
        .shorts-scroll-container { position: relative; }
        .shorts-content { overflow-x: auto; scroll-behavior: smooth; white-space: nowrap; padding-bottom: 10px; }
        
        /* ìŠ¤í¬ë¡¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
        .scroll-button {
            @apply absolute top-1/2 -translate-y-1/2 z-20 rounded-full p-3 shadow-lg transition-all duration-200 hidden md:flex items-center justify-center font-bold text-lg;
            width: 40px; height: 40px;
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ ê°œì„  - ë ˆë“œ ê³„ì—´ ê°•ì¡° */
        .tab-btn { 
            @apply flex-1 py-4 text-center font-bold text-text-light/40 transition-all duration-300 rounded-t-xl border-b-4 border-transparent bg-[#10101a] text-sm sm:text-base; /* ë¹„í™œì„± */
        }
        .tab-btn:hover {
            @apply bg-[#1f1f2e] text-text-light/70;
        }
        .tab-btn.active { 
            @apply text-white bg-primary-accent border-primary-accent shadow-[0_-4px_15px_-3px_rgba(233,69,96,0.4)]; /* í™œì„±: ë ˆë“œ(#e94560) */
        }
        .tab-container {
            @apply flex gap-2 border-b border-card-bg mb-6;
        }

        /* ë³„ì  ìƒ‰ìƒ */
        .star-filled { color: #fbbf24; }
        .star-empty { color: #4b5563; }

        /* ëª¨ë‹¬ */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 100;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #1a1a2e; padding: 2rem; border-radius: 1rem;
            max-width: 90%; max-height: 90%; overflow-y: auto;
        }
        
        /* ì •ë ¬ í—¤ë” ì»¤ì„œ */
        .sortable-header { cursor: pointer; user-select: none; transition: color 0.2s; }
        .sortable-header:hover { color: #e94560; }
        
        /* ìƒì„¸ ì„¤ëª… í–‰ ì• ë‹ˆë©”ì´ì…˜ */
        .detail-row { transition: all 0.3s ease-in-out; }

        /* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 17px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* Top ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #scrollToTopBtn {
            transition: opacity 0.3s, transform 0.3s;
        }
        #scrollToTopBtn:active {
            transform: scale(0.9);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': '#1a1a2e',
                        'primary-accent': '#e94560', // Red/Pink Accent
                        'text-light': '#f8f8f8',
                        'card-bg': '#282a4d',
                        'success-status': '#6aff7b',
                        'warning-star': '#fbbf24',
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-bg-dark text-text-light min-h-screen transition-colors duration-500 relative">

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div id="toast">í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</div>

    <!-- Top ë²„íŠ¼ -->
    <button id="scrollToTopBtn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
            class="fixed bottom-6 right-6 p-3 bg-primary-accent text-white rounded-full shadow-lg hover:bg-primary-accent/80 opacity-0 pointer-events-none z-50 flex items-center justify-center w-12 h-12 md:w-14 md:h-14">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <!-- API ì„¤ì • ëª¨ë‹¬ -->
    <div id="apiSettingsModal" class="modal hidden">
        <div class="modal-content w-full md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-bold mb-4 text-primary-accent border-b border-primary-accent/50 pb-2">API í‚¤ ì„¤ì •</h2>
            
            <!-- Firebase Config Manual Input (Fallback) -->
            <div id="firebaseConfigSection" class="bg-card-bg p-4 rounded-lg mb-6 shadow-lg border border-red-500/30 hidden">
                <h3 class="text-sm font-semibold mb-2 text-red-400">âš ï¸ Firebase ì„¤ì • ë¡œë“œ ì‹¤íŒ¨</h3>
                <p class="text-xs text-text-light/70 mb-2">firebase-config.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì— ì„¤ì •ì„ ì§ì ‘ ë¶™ì—¬ë„£ê³  [ì„¤ì • ì ìš©]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                <textarea id="manualConfigInput" placeholder='{"apiKey": "...", "authDomain": "...", ...}' class="w-full p-2 rounded bg-bg-dark border border-card-bg text-text-light text-xs font-mono h-24 mb-2"></textarea>
                <button onclick="applyManualConfig()" class="w-full py-2 bg-primary-accent text-white font-bold rounded hover:bg-primary-accent/80 transition text-sm">ì„¤ì • ì ìš© ë° ì¬ì‹œë„</button>
            </div>

            <div class="bg-card-bg p-4 rounded-lg mb-6 shadow-lg">
                <h3 class="text-sm font-semibold mb-2 text-text-light/70">ìƒˆ í‚¤ ì¶”ê°€ / í¸ì§‘</h3>
                <input type="text" id="newKeyName" placeholder="í‚¤ ì´ë¦„ (ì˜ˆ: ê¸°ë³¸ í‚¤)" class="w-full p-3 mb-2 rounded bg-bg-dark border border-card-bg text-text-light focus:border-primary-accent outline-none transition">
                <input type="password" id="newKeyValue" placeholder="YouTube Data API Key" class="w-full p-3 mb-3 rounded bg-bg-dark border border-card-bg text-text-light focus:border-primary-accent outline-none transition">
                <div class="flex gap-2">
                    <button id="saveKeyBtn" onclick="saveApiKey()" class="flex-1 py-2 bg-success-status text-bg-dark font-bold rounded hover:bg-success-status/80 transition">ì €ì¥</button>
                    <button id="cancelEditBtn" onclick="resetEditMode()" class="flex-1 py-2 bg-gray-600 text-white font-bold rounded hover:bg-gray-500 transition hidden">ì·¨ì†Œ</button>
                </div>
            </div>
            
            <h3 class="text-sm font-semibold mb-2 text-text-light/70">ì €ì¥ëœ í‚¤ ëª©ë¡</h3>
            <div id="apiKeyList" class="space-y-3 mb-4 max-h-60 overflow-y-auto pr-1"></div>
            
            <button onclick="document.getElementById('apiSettingsModal').classList.add('hidden')" class="w-full py-3 bg-card-bg border border-text-light/10 rounded-lg text-text-light hover:bg-card-bg/80 transition font-medium">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- í—¤ë” -->
    <header id="top" class="p-4 bg-card-bg shadow-lg sticky top-0 z-20 flex justify-between items-center rounded-b-lg">
        <h1 class="text-lg md:text-xl font-extrabold text-primary-accent truncate w-full text-center">YOUTUBE ì±„ë„ ì‹¬ì¸µ ë¶„ì„ê¸°</h1>
        <button onclick="document.getElementById('apiSettingsModal').classList.remove('hidden')" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-xs md:text-sm bg-bg-dark px-3 py-1.5 rounded-full border border-primary-accent text-primary-accent hover:bg-primary-accent hover:text-white transition whitespace-nowrap">âš™ï¸ API ì„¤ì •</button>
    </header>

    <main class="container mx-auto p-3 sm:p-6 lg:p-10">

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-container">
            <button id="tab-analyze" onclick="switchTab('analyze')" class="tab-btn active">
                <span class="mr-1 md:mr-2">ğŸ”</span> ë¶„ì„ ë° ê²€ìƒ‰
            </button>
            <button id="tab-saved" onclick="switchTab('saved')" class="tab-btn">
                <span class="mr-1 md:mr-2">ğŸ“‚</span> ì €ì¥ëœ ì±„ë„
            </button>
        </div>

        <!-- íƒ­ 1: ë¶„ì„ ë° ê²°ê³¼ -->
        <div id="content-analyze">
            <!-- ì…ë ¥ íŒ¨ë„ -->
            <section class="bg-card-bg p-4 md:p-6 rounded-xl shadow-2xl mb-8">
                <div class="flex flex-col md:flex-row gap-3">
                    <!-- ì—”í„°í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” JSì—ì„œ ì¶”ê°€ -->
                    <input type="text" id="channelId" placeholder="ì±„ë„ ID, í•¸ë“¤(@), ë˜ëŠ” ì˜ìƒ ë§í¬" class="flex-grow p-3 rounded-lg bg-bg-dark border border-card-bg focus:border-primary-accent text-text-light outline-none transition placeholder-text-light/30">
                    <button id="analyzeButton" onclick="startAnalysis()" class="w-full md:w-auto py-3 px-6 bg-primary-accent text-white font-bold rounded-lg hover:bg-primary-accent/80 transition shadow-lg whitespace-nowrap flex justify-center items-center">
                        <span id="buttonText">ë¶„ì„ ì‹œì‘</span>
                    </button>
                </div>
                <p id="statusMessage" class="mt-4 text-center text-sm font-medium animate-pulse"></p>
            </section>

            <!-- ë¶„ì„ ê²°ê³¼ -->
            <section id="resultsSection" class="hidden animate-fade-in-up">
                
                <!-- ì±„ë„ ì •ë³´ -->
                <div id="channelInfo" class="grid md:grid-cols-2 gap-6 mb-8"></div>

                <!-- í†µê³„ ì¹´ë“œ -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-4">
                    <div class="bg-card-bg p-5 rounded-xl shadow-xl"><p class="text-3xl font-bold text-success-status" id="statSubscribers">0</p><p class="text-sm mt-1 text-text-light/70">êµ¬ë…ì</p></div>
                    <div class="bg-card-bg p-5 rounded-xl shadow-xl"><p class="text-3xl font-bold text-success-status" id="statViews">0</p><p class="text-sm mt-1 text-text-light/70">ì´ ì¡°íšŒìˆ˜</p></div>
                    <div class="bg-card-bg p-5 rounded-xl shadow-xl"><p class="text-3xl font-bold text-success-status" id="statVideos">0</p><p class="text-sm mt-1 text-text-light/70">ì´ ì˜ìƒ</p></div>
                </div>

                <!-- 90ì¼ í†µê³„ -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-8">
                    <div class="bg-card-bg p-4 rounded-xl border border-primary-accent/30"><p class="text-xl font-bold text-primary-accent" id="avgViews90Days">0</p><p class="text-xs mt-1 text-text-light/60">90ì¼ í‰ê·  ì¡°íšŒìˆ˜</p></div>
                    <div class="bg-card-bg p-4 rounded-xl border border-primary-accent/30"><p class="text-xl font-bold text-primary-accent" id="avgLikes90Days">0</p><p class="text-xs mt-1 text-text-light/60">90ì¼ í‰ê·  ì¢‹ì•„ìš”</p></div>
                    <div class="bg-card-bg p-4 rounded-xl border border-primary-accent/30"><p class="text-xl font-bold text-primary-accent" id="avgComments90Days">0</p><p class="text-xs mt-1 text-text-light/60">90ì¼ í‰ê·  ëŒ“ê¸€</p></div>
                </div>

                <!-- ë²¤ì¹˜ë§ˆí‚¹ ê°€ì´ë“œ -->
                <div class="bg-card-bg p-4 md:p-6 rounded-xl shadow-xl mb-10">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-primary-accent">ğŸ› ï¸ ì‹¬ì¸µ ë²¤ì¹˜ë§ˆí‚¹ ê°€ì´ë“œ (ì§ì ‘ ë¶„ì„ í•„ìš”)</h2>
                    <p class="text-xs md:text-sm text-text-light/80 mb-6">ì•„ë˜ í•­ëª©ë“¤ì€ APIë¡œ ì œê³µë˜ì§€ ì•ŠëŠ” <b>ì„±ê³µ ì „ëµ í•µì‹¬ ì˜ì—­</b>ì…ë‹ˆë‹¤. ìƒë‹¨ì˜ ì •ëŸ‰ì  ë°ì´í„°ì™€ í•¨ê»˜ ì±„ë„ì„ ì§ì ‘ ê´€ì°°í•˜ë©° ë¶„ì„í•´ ë³´ì„¸ìš”.</p>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-bg-dark/50 p-4 rounded-lg shadow-inner">
                            <h3 class="text-lg font-bold text-success-status mb-3">ğŸ’¡ 2ë‹¨ê³„: ì½˜í…ì¸  ê¸°íšë ¥ ë¶„ì„</h3>
                            <ul class="list-disc ml-5 text-sm space-y-2 text-text-light/80">
                                <li><b>í‚¬ëŸ¬ ì½˜í…ì¸ :</b> ì˜ìƒë“¤ì„ ì£¼ì œë³„ë¡œ ë¶„ë¥˜í•˜ì—¬ ì±„ë„ì˜ ì£¼ë ¥ ì½˜í…ì¸ (ê°€ì¥ ì„±ê³¼ ì¢‹ì€)ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.</li>
                                <li><b>í¬ë§· ë° ê¸¸ì´:</b> ì„±ê³µì ì¸ ì˜ìƒì˜ í‰ê·  ê¸¸ì´ì™€ í¬ë§· ìœ í˜•(Vlog, íŠœí† ë¦¬ì–¼ ë“±)ì„ ê¸°ë¡í•©ë‹ˆë‹¤.</li>
                                <li><b>ì˜ìƒ êµ¬ì¡°:</b> ê¸°ìŠ¹ì „ê²° ë“± ì˜ìƒ ë‚´ë¶€ì˜ ì¼ê´€ëœ êµ¬ì¡°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</li>
                                <li><b>ì „ë‹¬ ë°©ì‹:</b> ê°ì • ìœ ë°œ, ì •ë³´ ì „ë‹¬ ë“± í•µì‹¬ ì „ë‹¬ ìš”ì†Œë¥¼ ì •ì˜í•©ë‹ˆë‹¤.</li>
                                <li><b>ì°¨ë³„í™”:</b> ì´ ì±„ë„ë§Œì´ ê°€ì§„ ê³ ìœ í•œ ê´€ì ì´ë‚˜ ì •ë³´ ì „ë‹¬ ë°©ì‹ì„ ì •ì˜í•©ë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                        <div class="bg-bg-dark/50 p-4 rounded-lg shadow-inner">
                            <h3 class="text-lg font-bold text-success-status mb-3">ğŸ¬ 3ë‹¨ê³„: ì‹œê°/í¸ì§‘ ìŠ¤íƒ€ì¼ ë¶„ì„</h3>
                            <ul class="list-disc ml-5 text-sm space-y-2 text-text-light/80">
                                <li><b>ì¸ë„¤ì¼ ì „ëµ:</b> ì£¼ëœ ìƒ‰ìƒ, í°íŠ¸, ê¶ê¸ˆì¦ì„ ìœ ë°œí•˜ëŠ” ë¬¸êµ¬ ìŠ¤íƒ€ì¼ì„ íŒŒì•…í•©ë‹ˆë‹¤.</li>
                                <li><b>í¸ì§‘ ì†ë„:</b> ì»· ì „í™˜ ì†ë„, í™”ë©´ ë¶„í• , ì§€ë£¨í•¨ì„ ì¤„ì´ëŠ” í¸ì§‘ ê¸°ë²•ì„ ë¶„ì„í•©ë‹ˆë‹¤.</li>
                                <li><b>ğŸ—£ï¸ ì‚¬ìš´ë“œ/í˜¸ìŠ¤íŠ¸:</b> BGM ì„ íƒ ê¸°ì¤€, íš¨ê³¼ìŒ ì‚¬ìš©ì˜ ì ì ˆì„±, í˜¸ìŠ¤íŠ¸ì˜ í†¤ì•¤ë§¤ë„ˆë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                        <div class="bg-bg-dark/50 p-4 rounded-lg shadow-inner md:col-span-2">
                            <h3 class="text-lg font-bold text-success-status mb-3">ğŸ” 4 & 5ë‹¨ê³„: ì°¸ì—¬, ì»¤ë®¤ë‹ˆí‹° ë° SEO ë¶„ì„</h3>
                            <ul class="list-disc ml-5 text-sm space-y-2 text-text-light/80">
                                <li><b>ì°¸ì—¬ìœ¨ ì¶”ì •:</b> ì•„ë˜ ë°ì´í„°(ì¡°íšŒìˆ˜, ì¢‹ì•„ìš”, ëŒ“ê¸€)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì°¸ì—¬ìœ¨ì„ ì¶”ì •í•©ë‹ˆë‹¤.</li>
                                <li><b>ëŒ“ê¸€ ë°˜ì‘:</b> ì‹œì²­ìë“¤ì´ ì£¼ë¡œ ë‚¨ê¸°ëŠ” í•µì‹¬ ë‚´ìš©(ì§ˆë¬¸, ì¹­ì°¬)ì„ íŒŒì•…í•˜ì—¬ ë‹ˆì¦ˆë¥¼ ì •ì˜í•©ë‹ˆë‹¤.</li>
                                <li><b>SEO í•µì‹¬:</b> ì œëª©ê³¼ ì„¤ëª…ë€ì˜ í‚¤ì›Œë“œ ë°°ì¹˜ ì „ëµ ë° í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ êµ¬ì„±ì„ ë¶„ì„í•©ë‹ˆë‹¤.</li>
                                <li><b>ì»¤ë®¤ë‹ˆí‹° í™œìš©:</b> ì»¤ë®¤ë‹ˆí‹° íƒ­ í™œìš© ë°©ì‹(íˆ¬í‘œ, Q&A)ì„ ì§ì ‘ í™•ì¸í•˜ê³  ë²¤ì¹˜ë§ˆí‚¹í•©ë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- ìº˜ë¦°ë” -->
                <h3 class="text-xl font-semibold mb-4 border-b border-primary-accent/50 pb-2 flex justify-between items-center">
                    <span>ğŸ“… ì—…ë¡œë“œ ë¹ˆë„</span>
                    <button id="resetFilterBtn" class="ml-2 text-xs bg-bg-dark px-3 py-1 rounded hidden text-text-light border border-text-light/20 hover:bg-card-bg" onclick="resetVideoFilter()">í•„í„° í•´ì œ</button>
                </h3>
                <div id="calendarContainer" class="bg-card-bg p-4 rounded-xl shadow-xl mb-10 overflow-x-auto">
                    <div id="calendarNavHeader" class="flex justify-between items-center mb-4 px-2 min-w-[300px]"></div>
                    <div id="calendarBody" class="grid grid-cols-7 gap-1 min-w-[300px]"></div>
                </div>

                <!-- Shorts ë¯¸ë¦¬ë³´ê¸° (ì •ë ¬ ê¸°ëŠ¥ ë° ë²„íŠ¼ ìœ„ì¹˜ ìˆ˜ì •ë¨) -->
                <h3 class="text-xl font-semibold mb-4 border-b border-primary-accent/50 pb-2 flex flex-col sm:flex-row justify-between items-center gap-2">
                    <span>ğŸ”¥ ìµœì‹  Shorts (1ë¶„ ì´í•˜)</span>
                    <div class="flex gap-2 text-sm items-center">
                        <select id="shortsSortBy" onchange="updateShortsSort()" class="bg-bg-dark border border-text-light/20 rounded p-1 text-text-light text-xs focus:outline-none focus:border-primary-accent">
                            <option value="publishedAt">ìµœì‹ ìˆœ</option>
                            <option value="viewCount">ì¡°íšŒìˆ˜ìˆœ</option>
                            <option value="likeCount">ì¢‹ì•„ìš”ìˆœ</option>
                            <option value="commentCount">ëŒ“ê¸€ìˆœ</option>
                        </select>
                        <button id="shortsSortDirBtn" onclick="toggleShortsSortDir()" class="bg-bg-dark border border-text-light/20 rounded p-1 px-2 text-text-light hover:bg-card-bg text-xs">
                            â¬‡ï¸
                        </button>
                    </div>
                </h3>
                <div id="shortsContainer" class="shorts-scroll-container group relative py-4 px-10 bg-card-bg rounded-xl shadow-inner mb-10 hidden">
                    <!-- ë²„íŠ¼ ìœ„ì¹˜ ìˆ˜ì •: ë¹¨ê°„ìƒ‰ ê°•ì¡° -->
                    <button class="scroll-button left-2 bg-primary-accent text-white hover:bg-primary-accent/80" onclick="scrollShorts(-300)">â—€</button>
                    <div id="shortsContent" class="shorts-content flex space-x-4 px-1 overflow-x-auto scrollbar-hide"></div>
                    <button class="scroll-button right-2 bg-primary-accent text-white hover:bg-primary-accent/80" onclick="scrollShorts(300)">â–¶</button>
                </div>

                <!-- ë¹„ë””ì˜¤ ë¦¬ìŠ¤íŠ¸ & í•„í„° & ë‹¤ìš´ë¡œë“œ -->
                <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                    <h3 class="text-xl font-semibold">
                        ì „ì²´ ë¹„ë””ì˜¤ (<span id="totalVideosCount">0</span>ê°œ)
                    </h3>
                    <div class="flex gap-2 items-center flex-wrap w-full md:w-auto justify-end">
                        <!-- í•„í„° ë“œë¡­ë‹¤ìš´ -->
                        <div class="relative group">
                            <button class="px-4 py-2 bg-card-bg border border-text-light/20 rounded text-sm hover:bg-card-bg/80 text-text-light flex items-center">
                                ğŸ” í•„í„° ì„¤ì •
                            </button>
                            <div class="absolute right-0 mt-2 w-64 bg-bg-dark border border-text-light/20 rounded-lg shadow-2xl p-4 hidden group-hover:block z-50">
                                <h4 class="text-xs font-bold text-primary-accent mb-2">ì˜ìƒ ê¸¸ì´</h4>
                                <div class="space-y-1 mb-3">
                                    <label class="flex items-center space-x-2 text-sm text-text-light cursor-pointer"><input type="checkbox" class="filter-type" value="Short" checked onchange="renderVideoList()"> <span>ìˆí¼ (1ë¶„â†“)</span></label>
                                    <label class="flex items-center space-x-2 text-sm text-text-light cursor-pointer"><input type="checkbox" class="filter-type" value="Mid" checked onchange="renderVideoList()"> <span>ë¯¸ë“œí¼ (1~3ë¶„)</span></label>
                                    <label class="flex items-center space-x-2 text-sm text-text-light cursor-pointer"><input type="checkbox" class="filter-type" value="Long" checked onchange="renderVideoList()"> <span>ë¡±í¼ (3ë¶„â†‘)</span></label>
                                </div>
                                <h4 class="text-xs font-bold text-primary-accent mb-2">L/V ë“±ê¸‰ (ì¢‹ì•„ìš” ë¹„ìœ¨)</h4>
                                <div class="grid grid-cols-5 gap-1 text-center mb-3 text-text-light">
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-like" value="1" checked onchange="renderVideoList()"><br><span class="text-xs">1â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-like" value="2" checked onchange="renderVideoList()"><br><span class="text-xs">2â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-like" value="3" checked onchange="renderVideoList()"><br><span class="text-xs">3â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-like" value="4" checked onchange="renderVideoList()"><br><span class="text-xs">4â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-like" value="5" checked onchange="renderVideoList()"><br><span class="text-xs">5â˜…</span></label>
                                </div>
                                <h4 class="text-xs font-bold text-primary-accent mb-2 mt-3">C/V ë“±ê¸‰ (ëŒ“ê¸€ ë¹„ìœ¨)</h4>
                                <div class="grid grid-cols-5 gap-1 text-center mb-3 text-text-light">
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-comment" value="1" checked onchange="renderVideoList()"><br><span class="text-xs">1â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-comment" value="2" checked onchange="renderVideoList()"><br><span class="text-xs">2â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-comment" value="3" checked onchange="renderVideoList()"><br><span class="text-xs">3â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-comment" value="4" checked onchange="renderVideoList()"><br><span class="text-xs">4â˜…</span></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-comment" value="5" checked onchange="renderVideoList()"><br><span class="text-xs">5â˜…</span></label>
                                </div>
                            </div>
                        </div>
                        <button id="downloadCsvBtn" class="px-4 py-2 bg-success-status text-bg-dark font-bold rounded text-sm hover:bg-success-status/80" onclick="exportToCSV()" disabled>â¬‡ï¸ CSV</button>
                    </div>
                </div>

                <!-- í…Œì´ë¸” (í’€ ì»¬ëŸ¼) -->
                <div class="overflow-x-auto bg-card-bg rounded-xl shadow-2xl">
                    <table class="min-w-full divide-y divide-bg-dark table-fixed">
                        <thead class="bg-bg-dark">
                            <tr>
                                <th class="px-2 py-3 text-left text-xs font-medium text-text-light/70 uppercase w-12">No</th>
                                <!-- ì œëª© ì—´ ë„ˆë¹„ í™•ì¥ -->
                                <th class="px-2 py-3 text-left text-xs font-medium text-text-light/70 uppercase w-64 md:w-80 lg:w-96 sortable-header" onclick="setVideoSort('title')">ì œëª© â†•</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-text-light/70 uppercase w-24 sortable-header" onclick="setVideoSort('publishedAt')">ê²Œì‹œì¼ â†•</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-text-light/70 uppercase w-20 sortable-header" onclick="setVideoSort('viewCount')">ì¡°íšŒìˆ˜ â†•</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-text-light/70 uppercase w-16 sortable-header" onclick="setVideoSort('durationSeconds')">ê¸¸ì´ â†•</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-text-light/70 uppercase w-16 sortable-header" onclick="setVideoSort('durationCategory')">ë¶„ë¥˜ â†•</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-text-light/70 uppercase w-24 sortable-header" onclick="setVideoSort('likeRatio')">L/V(5â˜…) â†•</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-text-light/70 uppercase w-24 sortable-header" onclick="setVideoSort('commentRatio')">C/V(5â˜…) â†•</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-text-light/70 uppercase w-20 sortable-header" onclick="setVideoSort('likeCount')">ì¢‹ì•„ìš” â†•</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-text-light/70 uppercase w-20 sortable-header" onclick="setVideoSort('commentCount')">ëŒ“ê¸€ â†•</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-text-light/70 uppercase w-16">ë”ë³´ê¸°</th>
                            </tr>
                        </thead>
                        <tbody id="videoListTableBody" class="divide-y divide-card-bg/50 text-sm"></tbody>
                    </table>
                    <p id="noVideosMessage" class="hidden text-center text-text-light/50 py-10">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </section>
        </div>

        <!-- íƒ­ 2: ì €ì¥ëœ ëª©ë¡ -->
        <div id="content-saved" class="hidden">
            <section class="mb-12">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xs text-text-light/50 ml-auto">í—¤ë”ë¥¼ í´ë¦­í•˜ì—¬ ì •ë ¬í•˜ì„¸ìš”</span>
                </div>
                <div class="overflow-x-auto bg-card-bg rounded-xl shadow-xl">
                    <table class="min-w-full divide-y divide-bg-dark">
                        <thead class="bg-bg-dark">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-text-light/70 uppercase sortable-header min-w-[200px]" onclick="setSavedSort('title')">ì±„ë„ ì •ë³´ â†•</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-text-light/70 uppercase sortable-header min-w-[100px]" onclick="setSavedSort('subscribers')">êµ¬ë…ì â†•</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-text-light/70 uppercase sortable-header min-w-[120px]" onclick="setSavedSort('lastUpdated')">ì—…ë°ì´íŠ¸ â†•</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-text-light/70 uppercase min-w-[100px]">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="savedChannelsListBody" class="divide-y divide-bg-dark/50 text-sm"></tbody>
                    </table>
                    <p id="emptySavedListMsg" class="text-center py-8 text-text-light/30 hidden">ì €ì¥ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </section>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, onSnapshot, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Vars
        const API_BASE_URL = 'https://www.googleapis.com/youtube/v3/';
        let db, auth, masterUserId, currentApiKey = '';
        let editingKeyName = null; // API í‚¤ ìˆ˜ì • ëª¨ë“œ ìƒíƒœ
        
        let allVideosData = [];
        let channelMetadata = null;
        let savedChannelsData = [];
        
        // Sorting States
        let videoSortState = { key: 'publishedAt', dir: 'desc' };
        let savedSortState = { key: 'lastUpdated', dir: 'desc' };
        // Shorts Sorting State
        let shortsSortState = { key: 'publishedAt', dir: 'desc' };

        let currentCalendarDate = null;
        let currentFilterDate = null;
        let monthlyCalendarData = {};
        let availableMonths = [];
        let expandedRowId = null;

        // Firebase Setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // [NEW] Manual Config Application
        window.applyManualConfig = async () => {
            const input = document.getElementById('manualConfigInput').value;
            try {
                const config = JSON.parse(input);
                await initFirebase(config);
                document.getElementById('firebaseConfigSection').classList.add('hidden');
                setStatus('Firebase ì„¤ì •ì´ ìˆ˜ë™ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.', false);
            } catch (e) {
                alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error(e);
            }
        };

        async function initFirebase(config) {
            try {
                const app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // [CRITICAL] ê¸°ê¸° ê°„ ë°ì´í„° ê³µìœ ë¥¼ ìœ„í•´ ê³ ì • ID ì‚¬ìš©
                        masterUserId = 'master_user_shared'; 
                        fetchApiKeys();
                        subscribeToSavedChannels();
                        setStatus('Firebase ì—°ê²° ë° ì¸ì¦ ì„±ê³µ.', false);
                    } else {
                        try {
                            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                            else await signInAnonymously(auth);
                        } catch(e) {
                            console.error("Sign-in failed:", e);
                            setStatus('Firebase ì¸ì¦ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.', true);
                        }
                    }
                });
            } catch(e) {
                console.error("Firebase Init Error:", e);
                throw e;
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // Scroll to Top Logic
            const scrollBtn = document.getElementById('scrollToTopBtn');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    scrollBtn.classList.remove('opacity-0', 'pointer-events-none');
                } else {
                    scrollBtn.classList.add('opacity-0', 'pointer-events-none');
                }
            });

            // ì—”í„°í‚¤ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ëª…ì‹œì  - keydownìœ¼ë¡œ ë³€ê²½)
            const inputEl = document.getElementById('channelId');
            if (inputEl) {
                inputEl.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); 
                        startAnalysis();
                    }
                });
            }

            // Firebase Config Loading
            let firebaseConfig = initialConfig;
            if (!firebaseConfig) {
                try {
                    // [FIX] Cache busting to ensure fresh fetch
                    const res = await fetch('./firebase-config.json?t=' + new Date().getTime());
                    if (res.ok) {
                        firebaseConfig = await res.json();
                        console.log("Loaded firebase-config.json");
                    } else {
                        console.warn("firebase-config.json not found.");
                    }
                } catch(e) {
                    console.error("Config fetch error:", e);
                }
            }

            if (firebaseConfig) {
                await initFirebase(firebaseConfig);
            } else {
                setStatus('âš ï¸ firebase-config.json ë¡œë“œ ì‹¤íŒ¨. API ì„¤ì •ì—ì„œ êµ¬ì„±ì„ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', true);
                document.getElementById('firebaseConfigSection').classList.remove('hidden');
            }
        });

        // --- Tabs Logic ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            document.getElementById('content-analyze').classList.add('hidden');
            document.getElementById('content-saved').classList.add('hidden');
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
        }
        window.switchTab = switchTab;

        // --- Saved Channels Logic ---
        function subscribeToSavedChannels() {
            if (!db || !masterUserId) return;
            
            onSnapshot(collection(db, 'artifacts', appId, 'users', masterUserId, 'channels'), (snap) => {
                savedChannelsData = [];
                snap.forEach(doc => savedChannelsData.push(doc.data()));
                renderSavedChannelsList();
            });
        }

        function setSavedSort(key) {
            if (savedSortState.key === key) {
                savedSortState.dir = savedSortState.dir === 'asc' ? 'desc' : 'asc';
            } else {
                savedSortState.key = key;
                savedSortState.dir = 'desc'; 
            }
            renderSavedChannelsList();
        }
        window.setSavedSort = setSavedSort;

        function renderSavedChannelsList() {
            const tbody = document.getElementById('savedChannelsListBody');
            tbody.innerHTML = '';
            
            if (savedChannelsData.length === 0) {
                document.getElementById('emptySavedListMsg').classList.remove('hidden');
                return;
            }
            document.getElementById('emptySavedListMsg').classList.add('hidden');

            savedChannelsData.sort((a, b) => {
                let valA, valB;
                const key = savedSortState.key;
                
                if (key === 'title') { valA = a.metadata.title; valB = b.metadata.title; }
                else if (key === 'subscribers') { valA = parseInt(a.metadata.subscribers); valB = parseInt(b.metadata.subscribers); }
                else if (key === 'lastUpdated') { valA = new Date(a.lastUpdated); valB = new Date(b.lastUpdated); }

                if (valA < valB) return savedSortState.dir === 'asc' ? -1 : 1;
                if (valA > valB) return savedSortState.dir === 'asc' ? 1 : -1;
                return 0;
            });

            savedChannelsData.forEach(ch => {
                const meta = ch.metadata;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-bg-dark/50 cursor-pointer transition border-b border-bg-dark/50';
                tr.onclick = () => loadChannelFromCache(ch);
                
                tr.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <img src="${meta.thumbnail}" class="w-10 h-10 rounded-full mr-3 bg-gray-700 object-cover" onerror="this.src='https://placehold.co/40'">
                            <div>
                                <div class="font-bold text-text-light">${meta.title}</div>
                                <div class="text-xs text-text-light/50">${meta.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center text-success-status font-bold">${formatNumber(meta.subscribers)}</td>
                    <td class="px-4 py-3 text-center text-text-light/60 text-xs">${new Date(ch.lastUpdated).toLocaleString('ko-KR')}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="event.stopPropagation(); refreshChannel('${meta.id}')" class="text-primary-accent hover:bg-primary-accent/10 p-2 rounded mr-1">ğŸ”„</button>
                        <button onclick="event.stopPropagation(); deleteSavedChannel('${meta.id}')" class="text-gray-500 hover:text-red-500 p-2 rounded">ğŸ—‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function loadChannelFromCache(data) {
            allVideosData = data.videos || [];
            channelMetadata = data.metadata;
            const stats90 = data.stats90 || { avgViews: 0, avgLikes: 0, avgComments: 0 };

            renderAnalysisUI(stats90);
            switchTab('analyze');
            setStatus(`ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${channelMetadata.title}`, false);
        }

        async function refreshChannel(id) {
            document.getElementById('channelId').value = id;
            switchTab('analyze');
            await startAnalysis(true);
        }
        window.refreshChannel = refreshChannel;

        async function deleteSavedChannel(id) {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', masterUserId, 'channels', id));
        }
        window.deleteSavedChannel = deleteSavedChannel;

        // --- Main Analysis & Rendering ---

        async function checkResponse(response) {
            if (!response.ok) {
                const errorBody = await response.json();
                const errorMessage = errorBody.error ? errorBody.error.message : response.statusText;
                throw new Error(`API ì˜¤ë¥˜: ${response.status} - ${errorMessage}`);
            }
            return response.json();
        }

        async function startAnalysis(isRefresh = false) {
            const input = document.getElementById('channelId').value.trim();
            
            if (!currentApiKey) {
                alert('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. [API ì„¤ì •] ë©”ë‰´ì—ì„œ í‚¤ë¥¼ ì¶”ê°€í•˜ê³  í™œì„±í™”í•´ì£¼ì„¸ìš”.');
                return setStatus('API í‚¤ í•„ìš”', true);
            }
            if (!input) {
                alert('ì±„ë„ IDë‚˜ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return setStatus('ID ì…ë ¥ í•„ìš”', true);
            }

            setStatus('ë°ì´í„° ìˆ˜ì§‘ ì¤‘...', false);
            document.getElementById('analyzeButton').disabled = true;
            document.getElementById('buttonText').textContent = 'ë¶„ì„ ì¤‘...';

            try {
                const chData = await fetchChannelData(input);
                
                if (!chData || !chData.items || !chData.items.length) {
                    throw new Error('ì±„ë„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const chItem = chData.items[0];
                const meta = {
                    id: chItem.id,
                    title: chItem.snippet.title,
                    description: chItem.snippet.description,
                    subscribers: chItem.statistics.subscriberCount,
                    totalViews: chItem.statistics.viewCount,
                    totalVideos: chItem.statistics.videoCount,
                    thumbnail: chItem.snippet.thumbnails.default.url,
                    publishedAt: chItem.snippet.publishedAt,
                    country: chItem.snippet.country || 'N/A'
                };

                const uploadsId = chItem.contentDetails.relatedPlaylists.uploads;
                let videos = await fetchAllVideos(uploadsId);
                const vidIds = videos.map(v => v.videoId);
                const stats = await fetchVideoStats(vidIds);
                
                videos = mergeVideoData(videos, stats);
                calculateEngagementRatings(videos);
                
                const stats90 = calc90DayStats(videos);
                
                if (!db || !masterUserId) {
                    setStatus('ë¶„ì„ ì™„ë£Œ, ê·¸ëŸ¬ë‚˜ Firebase ì—°ê²° ë¬¸ì œë¡œ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', true);
                } else {
                    const saveRef = doc(db, 'artifacts', appId, 'users', masterUserId, 'channels', meta.id);
                    await setDoc(saveRef, {
                        metadata: meta, videos: videos, stats90: stats90, lastUpdated: new Date().toISOString()
                    });
                }


                channelMetadata = meta;
                allVideosData = videos;
                renderAnalysisUI(stats90);
                setStatus('ë¶„ì„ ì™„ë£Œ', false);

            } catch (e) {
                console.error(e);
                setStatus(`ì˜¤ë¥˜: ${e.message}`, true);
            } finally {
                document.getElementById('analyzeButton').disabled = false;
                document.getElementById('buttonText').textContent = 'ë¶„ì„ ì‹œì‘';
            }
        }
        window.startAnalysis = startAnalysis;

        function renderAnalysisUI(stats90) {
            document.getElementById('resultsSection').classList.remove('hidden');
            
            document.getElementById('channelInfo').innerHTML = `
                <div class="flex p-4 bg-bg-dark rounded-lg">
                    <img src="${channelMetadata.thumbnail}" class="w-20 h-20 md:w-24 md:h-24 rounded-full border-4 border-primary-accent mr-4 flex-shrink-0">
                    <div class="overflow-hidden">
                        <h2 class="text-xl md:text-2xl font-bold truncate">${channelMetadata.title}</h2>
                        <p class="text-sm text-text-light/60 truncate">ID: ${channelMetadata.id} / ${channelMetadata.country}</p>
                        <p class="text-sm text-text-light/60">ê°œì„¤: ${new Date(channelMetadata.publishedAt).toLocaleDateString()}</p>
                    </div>
                </div>
                <div class="p-4 bg-bg-dark rounded-lg text-sm text-text-light/80 overflow-y-auto max-h-32 whitespace-pre-wrap">${channelMetadata.description}</div>
            `;

            document.getElementById('statSubscribers').textContent = formatNumber(channelMetadata.subscribers);
            document.getElementById('statViews').textContent = formatNumber(channelMetadata.totalViews);
            document.getElementById('statVideos').textContent = formatNumber(channelMetadata.totalVideos);
            
            document.getElementById('avgViews90Days').textContent = formatNumber(stats90.avgViews);
            document.getElementById('avgLikes90Days').textContent = formatNumber(stats90.avgLikes);
            document.getElementById('avgComments90Days').textContent = formatNumber(stats90.avgComments);

            monthlyCalendarData = generateCalendarData(allVideosData);
            currentCalendarDate = availableMonths[0];
            
            renderCalendar(); 
            renderShorts();   
            renderVideoList(); 
        }

        // --- Shorts Sort Logic ---
        function updateShortsSort() {
            shortsSortState.key = document.getElementById('shortsSortBy').value;
            renderShorts();
        }
        window.updateShortsSort = updateShortsSort;

        function toggleShortsSortDir() {
            shortsSortState.dir = shortsSortState.dir === 'desc' ? 'asc' : 'desc';
            document.getElementById('shortsSortDirBtn').textContent = shortsSortState.dir === 'desc' ? 'â¬‡ï¸' : 'â¬†ï¸';
            renderShorts();
        }
        window.toggleShortsSortDir = toggleShortsSortDir;

        // --- Render Helpers ---

        function renderCalendar() {
            const container = document.getElementById('calendarBody');
            const nav = document.getElementById('calendarNavHeader');
            container.innerHTML = '';
            
            if (!monthlyCalendarData[currentCalendarDate]) {
                nav.innerHTML = 'ë°ì´í„° ì—†ìŒ';
                return;
            }

            const [y, m] = currentCalendarDate.split('-');
            nav.innerHTML = `
                <button onclick="changeMonth(1)" class="p-1 hover:bg-white/10 rounded text-text-light">â—€</button>
                <span class="font-bold text-text-light">${y}ë…„ ${m}ì›”</span>
                <button onclick="changeMonth(-1)" class="p-1 hover:bg-white/10 rounded text-text-light">â–¶</button>
            `;

            const firstDay = new Date(y, m-1, 1).getDay();
            const lastDate = new Date(y, m, 0).getDate();
            
            for(let i=0; i<firstDay; i++) container.appendChild(document.createElement('div'));
            
            const map = monthlyCalendarData[currentCalendarDate];
            for(let d=1; d<=lastDate; d++) {
                const dateKey = `${y}-${m}-${String(d).padStart(2,'0')}`;
                const count = map.get(dateKey)||0;
                const cell = document.createElement('div');
                cell.className = `calendar-cell ${count ? 'bg-primary-accent/50 text-white font-bold' : 'text-text-light/30'}`;
                if (currentFilterDate === dateKey) cell.classList.add('ring-2', 'ring-success-status');
                cell.innerHTML = `<span>${d}</span>${count ? `<span class="text-[10px]">${count}</span>` : ''}`;
                cell.onclick = () => {
                    currentFilterDate = dateKey;
                    document.getElementById('resetFilterBtn').classList.remove('hidden');
                    renderCalendar();
                    renderVideoList();
                };
                container.appendChild(cell);
            }
        }

        function renderShorts() {
            const container = document.getElementById('shortsContent');
            container.innerHTML = '';
            
            let shorts = allVideosData.filter(v => v.durationCategory === 'Short');
            
            // Sort
            shorts.sort((a, b) => {
                const key = shortsSortState.key;
                let valA = a[key], valB = b[key];
                
                // Numeric or Date convert
                if (key === 'publishedAt') {
                    valA = new Date(valA).getTime();
                    valB = new Date(valB).getTime();
                } else {
                    valA = Number(valA);
                    valB = Number(valB);
                }

                if (valA < valB) return shortsSortState.dir === 'asc' ? -1 : 1;
                if (valA > valB) return shortsSortState.dir === 'asc' ? 1 : -1;
                return 0;
            });

            if (shorts.length === 0) {
                document.getElementById('shortsContainer').classList.add('hidden');
                return;
            }
            document.getElementById('shortsContainer').classList.remove('hidden');

            shorts.forEach(s => {
                const el = document.createElement('div');
                el.className = 'inline-block w-40 md:w-48 bg-bg-dark rounded-lg overflow-hidden shadow-lg flex-shrink-0 border border-card-bg hover:border-primary-accent transition';
                el.innerHTML = `
                    <div class="relative pb-[177%]">
                        <a href="https://youtu.be/${s.videoId}" target="_blank">
                            <img src="https://img.youtube.com/vi/${s.videoId}/mqdefault.jpg" class="absolute h-full w-full object-cover">
                        </a>
                        <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 to-transparent p-2">
                            <p class="text-xs font-bold text-white truncate">${s.title}</p>
                            <p class="text-[10px] text-text-light/80">ğŸ‘ï¸ ${formatNumber(s.viewCount)} â€¢ ğŸ‘ ${formatNumber(s.likeCount)}</p>
                            <p class="text-[10px] text-text-light/60">${s.publishedAt.split('T')[0]}</p>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function renderVideoList() {
            const tbody = document.getElementById('videoListTableBody');
            tbody.innerHTML = '';

            const durationFilters = Array.from(document.querySelectorAll('.filter-type:checked')).map(c => c.value);
            const likeFilters = Array.from(document.querySelectorAll('.filter-like:checked')).map(c => parseInt(c.value));
            const commentFilters = Array.from(document.querySelectorAll('.filter-comment:checked')).map(c => parseInt(c.value));
            
            let filtered = allVideosData.filter(v => {
                if (currentFilterDate && !v.publishedAt.startsWith(currentFilterDate)) return false;
                if (!durationFilters.includes(v.durationCategory)) return false;
                const lRate = v.likeRating || 1;
                if (!likeFilters.includes(lRate)) return false;
                const cRate = v.commentRating || 1;
                if (!commentFilters.includes(cRate)) return false;
                return true;
            });

            document.getElementById('totalVideosCount').textContent = formatNumber(filtered.length);
            if (filtered.length === 0) {
                document.getElementById('noVideosMessage').classList.remove('hidden');
                return;
            }
            document.getElementById('noVideosMessage').classList.add('hidden');
            document.getElementById('downloadCsvBtn').disabled = false;

            filtered.sort((a, b) => {
                const key = videoSortState.key;
                let valA = a[key], valB = b[key];
                if (['viewCount','likeCount','commentCount','durationSeconds','likeRatio','commentRatio','likeRating','commentRating'].includes(key)) {
                    valA = Number(valA); valB = Number(valB);
                }
                if (valA < valB) return videoSortState.dir === 'asc' ? -1 : 1;
                if (valA > valB) return videoSortState.dir === 'asc' ? 1 : -1;
                return 0;
            });

            filtered.slice(0, 200).forEach((v, idx) => {
                const rowId = `row-${idx}`;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-bg-dark/30 border-t border-bg-dark/50';
                
                const catColor = getColorForCategory(v.durationCategory);
                const lStar = v.likeRating || 1;
                const cStar = v.commentRating || 1;

                tr.innerHTML = `
                    <td class="px-2 py-3 text-text-light/50 text-center">${idx + 1}</td>
                    <!-- ì œëª© ì—´ í™•ì¥: max-w ì œê±° ë° whitespace-normal ì ìš© -->
                    <td class="px-2 py-3 font-medium min-w-[200px] break-words whitespace-normal">
                        <div class="flex flex-col">
                            <span class="leading-tight">${v.title}</span>
                            <button onclick="copyToClipboard('https://youtu.be/${v.videoId}')" class="text-primary-accent hover:text-white flex-shrink-0 mt-1 text-xs self-start" title="ë§í¬ ë³µì‚¬">ğŸ”— ë§í¬ë³µì‚¬</button>
                        </div>
                    </td>
                    <td class="px-2 py-3 text-right text-xs text-text-light/60">${v.publishedAt.split('T')[0]}</td>
                    <td class="px-2 py-3 text-right text-success-status font-bold">${formatNumber(v.viewCount)}</td>
                    <td class="px-2 py-3 text-right text-xs">${formatTime(v.durationSeconds)}</td>
                    <td class="px-2 py-3 text-center text-xs font-bold ${catColor}">${v.durationCategory}</td>
                    <td class="px-2 py-3 text-center text-xs whitespace-nowrap" title="${v.likeRatio.toFixed(2)}%">
                        <div class="flex justify-center">${renderStars(lStar)}</div>
                    </td>
                    <td class="px-2 py-3 text-center text-xs whitespace-nowrap" title="${v.commentRatio.toFixed(2)}%">
                        <div class="flex justify-center">${renderStars(cStar)}</div>
                    </td>
                    <td class="px-2 py-3 text-right text-text-light/60 text-xs">${formatNumber(v.likeCount)}</td>
                    <td class="px-2 py-3 text-right text-text-light/60 text-xs">${formatNumber(v.commentCount)}</td>
                    <td class="px-2 py-3 text-center">
                        <button id="btn-${idx}" onclick="toggleDetailRow('${idx}')" class="text-xs bg-bg-dark px-2 py-1 rounded border border-text-light/10 hover:bg-primary-accent hover:text-white transition">â–¼</button>
                    </td>
                `;
                tbody.appendChild(tr);

                const trDetail = document.createElement('tr');
                trDetail.id = `detail-${idx}`;
                trDetail.className = 'detail-row hidden bg-bg-dark/40';
                trDetail.innerHTML = `
                    <td colspan="11" class="p-4 text-xs text-text-light/80">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold text-primary-accent mb-2">ğŸ“Œ íƒœê·¸</h4>
                                <div class="flex flex-wrap gap-1 max-h-32 overflow-y-auto">
                                    ${v.tags.length ? v.tags.map(t => `<span class="bg-card-bg px-2 py-1 rounded text-text-light/70">#${t}</span>`).join('') : '<span class="text-text-light/30">íƒœê·¸ ì—†ìŒ</span>'}
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-primary-accent mb-2">ğŸ“ ì„¤ëª…</h4>
                                <div class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-bg-dark/50 p-2 rounded border border-card-bg/50">${v.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(trDetail);
            });
        }
        
        window.renderVideoList = renderVideoList;
        window.renderCalendar = renderCalendar;
        window.renderShorts = renderShorts;

        function setVideoSort(key) {
            if (videoSortState.key === key) {
                videoSortState.dir = videoSortState.dir === 'asc' ? 'desc' : 'asc';
            } else {
                videoSortState.key = key;
                videoSortState.dir = 'desc';
            }
            renderVideoList();
        }
        window.setVideoSort = setVideoSort;

        function toggleDetailRow(id) {
            const row = document.getElementById(`detail-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            if (row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                btn.textContent = 'â–²';
            } else {
                row.classList.add('hidden');
                btn.textContent = 'â–¼';
            }
        }
        window.toggleDetailRow = toggleDetailRow;

        function scrollShorts(val) {
            document.getElementById('shortsContent').scrollBy({ left: val, behavior: 'smooth' });
        }
        window.scrollShorts = scrollShorts;

        function changeMonth(dir) {
            const idx = availableMonths.indexOf(currentCalendarDate);
            if (availableMonths[idx+dir]) {
                currentCalendarDate = availableMonths[idx+dir];
                renderCalendar();
            }
        }
        window.changeMonth = changeMonth;

        function resetVideoFilter() {
            currentFilterDate = null;
            document.getElementById('resetFilterBtn').classList.add('hidden');
            renderCalendar();
            renderVideoList();
        }
        window.resetVideoFilter = resetVideoFilter;

        function copyToClipboard(text) {
            const temp = document.createElement('textarea');
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            const toast = document.getElementById("toast");
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }
        window.copyToClipboard = copyToClipboard;

        // --- Logic Helpers ---

        async function fetchChannelData(query) {
            let id = query;
            if (query.includes('youtu')) {
                const vid = query.match(/v=([\w-]+)/) || query.match(/\/([\w-]+)$/);
                if (vid) {
                    const vRes = await fetch(`${API_BASE_URL}videos?part=snippet&id=${vid[1]}&key=${currentApiKey}`);
                    const vData = await checkResponse(vRes);
                    id = vData.items[0].snippet.channelId;
                }
            } else if (!query.startsWith('UC')) {
                const handle = query.startsWith('@') ? query : '@' + query;
                const hRes = await fetch(`${API_BASE_URL}channels?part=id&forHandle=${handle}&key=${currentApiKey}`);
                const hData = await checkResponse(hRes);
                id = hData.items[0].id;
            }
            const res = await fetch(`${API_BASE_URL}channels?part=snippet,contentDetails,statistics&id=${id}&key=${currentApiKey}`);
            const data = await checkResponse(res);
            if (!data.items?.length) throw new Error('ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return data;
        }

        async function fetchAllVideos(playlistId, videos = [], token = '') {
            const res = await fetch(`${API_BASE_URL}playlistItems?part=snippet,contentDetails&playlistId=${playlistId}&maxResults=50&pageToken=${token}&key=${currentApiKey}`);
            const data = await res.json();
            if (!data.items) return videos;
            data.items.forEach(i => {
                if (i.snippet.title !== 'Deleted video') {
                    videos.push({
                        videoId: i.contentDetails.videoId,
                        title: i.snippet.title,
                        publishedAt: i.snippet.publishedAt
                    });
                }
            });
            if (data.nextPageToken) return fetchAllVideos(playlistId, videos, data.nextPageToken);
            return videos;
        }

        async function fetchVideoStats(ids) {
            const stats = [];
            while (ids.length) {
                const batch = ids.splice(0, 50);
                const res = await fetch(`${API_BASE_URL}videos?part=statistics,contentDetails,snippet&id=${batch.join(',')}&key=${currentApiKey}`);
                const data = await res.json();
                if (data.items) stats.push(...data.items);
            }
            return stats;
        }

        function mergeVideoData(videos, statsList) {
            const map = new Map(statsList.map(s => [s.id, s]));
            return videos.map(v => {
                const s = map.get(v.videoId);
                if (!s) return v;
                const dur = parseDuration(s.contentDetails.duration);
                const views = parseInt(s.statistics.viewCount || 0);
                const likes = parseInt(s.statistics.likeCount || 0);
                const comments = parseInt(s.statistics.commentCount || 0);
                return {
                    ...v,
                    viewCount: views, likeCount: likes, commentCount: comments,
                    durationSeconds: dur,
                    durationCategory: dur <= 60 ? 'Short' : (dur < 180 ? 'Mid' : 'Long'),
                    tags: s.snippet.tags || [],
                    description: s.snippet.description,
                    likeRatio: views ? (likes/views)*100 : 0,
                    commentRatio: views ? (comments/views)*100 : 0,
                    likeRating: 1,
                    commentRating: 1
                };
            });
        }

        function calculateEngagementRatings(videos) {
            if (!videos.length) return;
            const assignStars = (list, keyRatio, keyRating) => {
                const sorted = list.map(v => v[keyRatio]).sort((a, b) => a - b);
                const len = sorted.length;
                if (len === 0) return;
                const p20 = sorted[Math.floor(len * 0.2)];
                const p40 = sorted[Math.floor(len * 0.4)];
                const p60 = sorted[Math.floor(len * 0.6)];
                const p80 = sorted[Math.floor(len * 0.8)];
                list.forEach(v => {
                    const val = v[keyRatio];
                    if (val >= p80) v[keyRating] = 5;
                    else if (val >= p60) v[keyRating] = 4;
                    else if (val >= p40) v[keyRating] = 3;
                    else if (val >= p20) v[keyRating] = 2;
                    else v[keyRating] = 1;
                });
            };
            assignStars(videos, 'likeRatio', 'likeRating');
            assignStars(videos, 'commentRatio', 'commentRating');
        }

        function calc90DayStats(videos) {
            const d = new Date(); d.setDate(d.getDate()-90);
            const recent = videos.filter(v => new Date(v.publishedAt) >= d);
            if (!recent.length) return { avgViews:0, avgLikes:0, avgComments:0 };
            const sum = k => recent.reduce((a,b) => a + (b[k]||0), 0);
            return {
                avgViews: Math.round(sum('viewCount')/recent.length),
                avgLikes: Math.round(sum('likeCount')/recent.length),
                avgComments: Math.round(sum('commentCount')/recent.length)
            };
        }

        function generateCalendarData(videos) {
            const data = {};
            videos.forEach(v => {
                const m = v.publishedAt.slice(0, 7);
                if (!data[m]) data[m] = new Map();
                const date = v.publishedAt.slice(0, 10);
                data[m].set(date, (data[m].get(date)||0)+1);
            });
            availableMonths = Object.keys(data).sort().reverse();
            return data;
        }

        function formatNumber(num) { return new Intl.NumberFormat('ko-KR').format(num); }
        function parseDuration(pt) {
            const m = pt.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            const h = parseInt(m[1])||0, min = parseInt(m[2])||0, sec = parseInt(m[3])||0;
            return h*3600 + min*60 + sec;
        }
        function formatTime(sec) {
            const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
            return h>0 ? `${h}:${m}:${s}` : `${m}:${s}`;
        }
        function setStatus(msg, err) {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = `mt-4 text-center text-sm font-medium ${err ? 'text-primary-accent' : 'text-success-status'}`;
        }
        function getColorForCategory(cat) {
            if (cat === 'Short') return 'text-primary-accent'; 
            if (cat === 'Mid') return 'text-text-light/80';    
            if (cat === 'Long') return 'text-success-status';  
            return '';
        }
        function renderStars(rating) {
            let html = '';
            for(let i=0; i<5; i++) {
                html += i < rating ? '<span class="star-filled">â˜…</span>' : '<span class="star-empty">â˜†</span>';
            }
            return html;
        }

        // --- CSV Export ---
        window.exportToCSV = () => {
            if (!allVideosData.length) return alert('ë°ì´í„° ì—†ìŒ');
            const bom = "\uFEFF";
            const header = "ì œëª©,ê²Œì‹œì¼,ì¡°íšŒìˆ˜,ì¢‹ì•„ìš”,ëŒ“ê¸€,ê¸¸ì´(ì´ˆ),ë¶„ë¥˜,íƒœê·¸,ì„¤ëª…\n";
            const rows = allVideosData.map(v => {
                const safeTitle = `"${v.title.replace(/"/g, '""')}"`;
                const safeDesc = `"${(v.description||'').replace(/"/g, '""').replace(/\n/g, ' ')}"`;
                const safeTags = `"${(v.tags||[]).join('|')}"`;
                return `${safeTitle},${v.publishedAt},${v.viewCount},${v.likeCount},${v.commentCount},${v.durationSeconds},${v.durationCategory},${safeTags},${safeDesc}`;
            }).join("\n");
            const blob = new Blob([bom + header + rows], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${channelMetadata.title}_analysis.csv`;
            a.click();
        };

        // --- API Keys Management ---
        window.fetchApiKeys = () => {
            // [FIX] db, masterUserId ìœ íš¨ì„± í™•ì¸ ì¶”ê°€
            if (!db || !masterUserId) return;

            onSnapshot(collection(db, 'artifacts', appId, 'users', masterUserId, 'apiKeys'), snap => {
                const el = document.getElementById('apiKeyList');
                el.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.active) currentApiKey = d.value;
                    
                    const div = document.createElement('div');
                    // Style adjustments based on active state
                    div.className = `flex justify-between items-center p-3 rounded text-sm text-text-light border transition-all duration-300 ${d.active ? 'border-primary-accent bg-bg-dark shadow-[0_0_10px_rgba(233,69,96,0.3)] opacity-100' : 'border-transparent bg-bg-dark/30 opacity-70 hover:opacity-100 hover:bg-bg-dark hover:border-card-bg'}`;
                    
                    div.innerHTML = `
                        <div class="flex flex-col overflow-hidden mr-2">
                            <span class="font-bold truncate ${d.active ? 'text-primary-accent' : 'text-text-light/70'}">${d.name}</span>
                            <span class="text-xs ${d.active ? 'text-text-light' : 'text-text-light/30'} truncate">${d.active ? 'âœ… í˜„ì¬ ì‚¬ìš© ì¤‘' : 'ë¹„í™œì„±'}</span>
                        </div>
                        <div class="flex gap-2 flex-shrink-0">
                            ${!d.active ? `<button onclick="activateApiKey('${d.name}')" class="px-3 py-1 bg-card-bg border border-text-light/20 rounded hover:bg-success-status hover:text-bg-dark hover:border-transparent transition text-xs">í™œì„±í™”</button>` : ''}
                            <button onclick="editApiKey('${d.name}', '${d.value}')" class="px-2 py-1 text-text-light/50 hover:text-primary-accent transition text-xs">âœï¸</button>
                            <button onclick="deleteApiKey('${d.name}')" class="px-2 py-1 text-text-light/50 hover:text-red-500 transition text-xs">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    el.appendChild(div);
                });
            });
        };

        window.activateApiKey = async (id) => {
            if (!db || !masterUserId) {
                alert('Firebase ì—°ê²° ë¬¸ì œë¡œ í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return;
            }
            const snapshot = await getDocs(collection(db, 'artifacts', appId, 'users', masterUserId, 'apiKeys'));
            const batch = writeBatch(db);
            snapshot.forEach(doc => {
                batch.update(doc.ref, { active: doc.id === id });
            });
            await batch.commit();
        };

        window.deleteApiKey = async (id) => {
            if (!db || !masterUserId) {
                alert('Firebase ì—°ê²° ë¬¸ì œë¡œ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return;
            }
            if(!confirm("ì´ í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', masterUserId, 'apiKeys', id));
            // ë§Œì•½ ì‚­ì œí•œ í‚¤ê°€ í¸ì§‘ ì¤‘ì´ì—ˆë‹¤ë©´ ë¦¬ì…‹
            if(editingKeyName === id) resetEditMode();
        };

        window.editApiKey = (id, val) => {
            document.getElementById('newKeyName').value = id;
            document.getElementById('newKeyValue').value = val;
            document.getElementById('newKeyName').disabled = true; // í‚¤ IDëŠ” ìˆ˜ì • ë¶ˆê°€
            document.getElementById('newKeyName').classList.add('opacity-50', 'cursor-not-allowed');
            
            editingKeyName = id;
            document.getElementById('saveKeyBtn').textContent = "ìˆ˜ì • ì €ì¥";
            document.getElementById('cancelEditBtn').classList.remove('hidden');
        };

        window.resetEditMode = () => {
            editingKeyName = null;
            document.getElementById('newKeyName').value = '';
            document.getElementById('newKeyValue').value = '';
            document.getElementById('newKeyName').disabled = false;
            document.getElementById('newKeyName').classList.remove('opacity-50', 'cursor-not-allowed');
            
            document.getElementById('saveKeyBtn').textContent = "ì €ì¥";
            document.getElementById('cancelEditBtn').classList.add('hidden');
        };
        window.resetEditMode = resetEditMode; // Expose globally

        window.saveApiKey = async () => {
            const name = document.getElementById('newKeyName').value.trim();
            const val = document.getElementById('newKeyValue').value.trim();
            
            if(!name || !val) return alert('ì´ë¦„ê³¼ ê°’ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            // [FIX] Firebase ì—°ê²° ë¬¸ì œ ë°©ì–´ ë¡œì§ ì¶”ê°€
            if (!db || !masterUserId) {
                 alert('Firebase ì„¤ì •ì´ ëˆ„ë½ë˜ì–´ í‚¤ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                 setStatus('í‚¤ ì €ì¥ ì‹¤íŒ¨: Firebase ì„¤ì • ë° ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.', true);
                 return;
            }

            if (editingKeyName) {
                // ìˆ˜ì • ëª¨ë“œ: ê°’ë§Œ ì—…ë°ì´íŠ¸
                await setDoc(doc(db, 'artifacts', appId, 'users', masterUserId, 'apiKeys', name), { value: val }, { merge: true });
                resetEditMode();
            } else {
                // ì‹ ê·œ ëª¨ë“œ
                const snapshot = await getDocs(collection(db, 'artifacts', appId, 'users', masterUserId, 'apiKeys'));
                const isFirst = snapshot.empty;
                
                await setDoc(doc(db, 'artifacts', appId, 'users', masterUserId, 'apiKeys', name), { 
                    name, 
                    value: val, 
                    active: isFirst 
                });
                
                document.getElementById('newKeyName').value = '';
                document.getElementById('newKeyValue').value = '';
            }
        };
    </script>
</body>
</html>
