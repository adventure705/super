<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘‘ ìŠˆí¼ í˜ì´ì§€</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* ë°ì€ ë°°ê²½ */
        }
        .link-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            cursor: pointer; /* ì¼ë°˜ ëª¨ë“œ */
        }
        .link-button:hover:not(.selected-for-delete) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        /* ë“œë˜ê·¸ ê°€ëŠ¥ ì•„ì´í…œ */
        .link-button.edit-mode-active {
            cursor: grab; /* í¸ì§‘ ëª¨ë“œ */
        }
        .link-button.edit-mode-active:active {
            cursor: grabbing;
        }
        .link-button.dragging {
            opacity: 0.5;
            border: 2px dashed #9ca3af;
        }

        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transform: translateY(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-open .modal-content {
            transform: translateY(0);
        }

        /* í¸ì§‘ ëª¨ë“œì—ì„œ ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .selected-for-delete {
            background-color: #fef2f2; /* Red-50 */
            border-color: #f87171 !important; /* Red-400 */
        }
        /* ì„ íƒ ì¸ë””ì¼€ì´í„° ìŠ¤íƒ€ì¼ (ì´ì œ Flexì— í†µí•©ë¨) */
        .selection-indicator {
            width: 24px;
            height: 24px;
            border-radius: 9999px; /* rounded-full */
            border: 2px solid #9ca3af; /* border-gray-400 */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .selected-for-delete .selection-indicator {
            background-color: #ef4444; /* Red-500 */
            border-color: #ef4444;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loadingIndicator" class="absolute inset-0 bg-white/70 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-indigo-600 font-medium">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
        </div>
    </div>
    
    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="w-full max-w-lg">
        <header class="text-center mb-6">
            <!-- ì œëª© ë³€ê²½ -->
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">ğŸ‘‘ ìŠˆí¼ í˜ì´ì§€</h1>
        </header>

        <!-- í¸ì§‘/ì‚­ì œ ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ìƒˆ ìœ„ì¹˜) -->
        <div id="control-panel" class="mb-6 flex justify-end space-x-2">
            <button id="deleteSelectedBtn" class="px-3 py-1 text-sm font-bold text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 transition duration-150 hidden disabled:opacity-50 disabled:cursor-not-allowed">
                ì‚­ì œ (0)
            </button>
            <button id="editToggleBtn" class="px-3 py-1 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                í¸ì§‘
            </button>
        </div>

        <!-- ë§í¬ ë²„íŠ¼ ì˜ì—­ (Firebaseì—ì„œ ë™ì ìœ¼ë¡œ ë¡œë“œë¨) -->
        <div id="links-container" class="space-y-4">
            <!-- ê¸°ë³¸ ì˜ˆì‹œ ë§í¬ (ë°ì´í„° ë¡œë“œ ì „ê¹Œì§€ í‘œì‹œ) -->
            <div id="initial-links">
                <div class="link-button bg-white border border-gray-200 py-4 px-6 rounded-xl animate-pulse"></div>
                <div class="link-button bg-white border border-gray-200 py-4 px-6 rounded-xl animate-pulse"></div>
            </div>
        </div>

        <!-- ìƒˆ ë§í¬ ì¶”ê°€ ë²„íŠ¼ -->
        <div class="mt-8 pt-4 border-t border-gray-200 text-center">
            <button id="addLinkBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-200 ease-in-out">
                + ìƒˆ ë§í¬ ì¶”ê°€
            </button>
        </div>
    </div>
    
    <!-- ëª¨ë‹¬: ìƒˆ ë§í¬ ì¶”ê°€ í¼ -->
    <div id="addLinkModal" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-gray-800">ìƒˆ ê¸°ëŠ¥ ë§í¬ ì¶”ê°€</h2>
            <form id="linkForm">
                <div class="mb-4">
                    <label for="linkName" class="block text-sm font-medium text-gray-700 mb-1">ë§í¬ ì´ë¦„ (ì˜ˆ: ë©”ëª¨ì¥ ì•±)</label>
                    <input type="text" id="linkName" name="linkName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ì•± ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="mb-6">
                    <label for="linkUrl" class="block text-sm font-medium text-gray-700 mb-1">URL (ì˜ˆ: https://example.com/app)</label>
                    <input type="url" id="linkUrl" name="linkUrl" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ì „ì²´ URLì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="closeModalBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">ì·¨ì†Œ</button>
                    <button type="submit" id="saveLinkBtn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">ì €ì¥</button>
                </div>
            </form>
            <p id="errorMessage" class="text-red-500 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ì‚­ì œ í™•ì¸ ë©”ì‹œì§€ -->
    <div id="deleteConfirmModal" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-xs p-6 rounded-2xl shadow-2xl text-center">
            <h2 class="text-xl font-bold mb-4 text-gray-800">ë§í¬ ì‚­ì œ í™•ì¸</h2>
            <p class="text-gray-600 mb-6">ì„ íƒí•œ <span id="deleteCountDisplay" class="font-bold text-red-600">0</span>ê°œì˜ ë§í¬ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex justify-center space-x-3">
                <button type="button" id="cancelDeleteBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">ì·¨ì†Œ</button>
                <button type="button" id="confirmDeleteBtn" class="px-4 py-2 text-sm font-bold text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-lg">ì˜êµ¬ ì‚­ì œ</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase ëª¨ë“ˆ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // deleteDoc, updateDoc, writeBatchë¥¼ ì¶”ê°€ ì„í¬íŠ¸í•©ë‹ˆë‹¤.
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, deleteDoc, updateDoc, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ***************************************************************
        // [í•„ìˆ˜ ì„¤ì •] ì™¸ë¶€ í™˜ê²½(GitHub ë“±)ì— ë°°í¬í•  ë•Œë§Œ í•„ìš”í•©ë‹ˆë‹¤.
        // ì´ ì„¤ì •ì€ 'firebase-config.json' íŒŒì¼ì—ì„œ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.
        // ***************************************************************
        
        // ì „ì—­ ë³€ìˆ˜ ë° DOM ìš”ì†Œ ì„¤ì •
        const linksContainer = document.getElementById('links-container');
        const addLinkModal = document.getElementById('addLinkModal');
        const addLinkBtn = document.getElementById('addLinkBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const linkForm = document.getElementById('linkForm');
        const linkNameInput = document.getElementById('linkName');
        const linkUrlInput = document.getElementById('linkUrl');
        const errorMessageDisplay = document.getElementById('errorMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // í¸ì§‘ ë° ì‚­ì œ ê´€ë ¨ DOM ìš”ì†Œ
        const editToggleBtn = document.getElementById('editToggleBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const deleteCountDisplay = document.getElementById('deleteCountDisplay');


        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let isEditMode = false; // í¸ì§‘ ëª¨ë“œ ìƒíƒœ
        let selectedLinkIds = new Set(); // ì„ íƒëœ ë§í¬ IDë¥¼ ì¶”ì  (Set ì‚¬ìš©)
        let cachedLinks = []; // Firestoreì—ì„œ ë¡œë“œëœ ë§í¬ ë°ì´í„°ë¥¼ ìºì‹œ
        let dragSrcEl = null; // ë“œë˜ê·¸ ì‹œì‘ ìš”ì†Œ

        // Firestore ì»¬ë ‰ì…˜ ê²½ë¡œ ìƒì„± í•¨ìˆ˜
        function getLinksCollectionRef(db, userId, appId) {
            const isCanvasEnvironment = typeof __firebase_config !== 'undefined' && __firebase_config;

            if (isCanvasEnvironment) {
                // Canvas í™˜ê²½: ê¸°ì¡´ ê²½ë¡œ ì‚¬ìš© (ì‚¬ìš©ìë³„ ë¶„ë¦¬)
                return collection(db, `artifacts/${appId}/users/${userId}/links`);
            } else {
                // ì™¸ë¶€ í™˜ê²½ (GitHub): ê³µìš© ê²½ë¡œ ì‚¬ìš© (ëª¨ë“  ê¸°ê¸° ë™ê¸°í™”)
                return collection(db, `myLinks`);
            }
        }
        
        // ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ (ê°„ë‹¨í•œ URL ê²€ì‚¬)
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (e) {
                return false;
            }
        }

        // ------------------ UI ê´€ë ¨ í•¨ìˆ˜ ------------------

        // ë§í¬ ë²„íŠ¼ ìƒì„± í•¨ìˆ˜ (í¸ì§‘ ëª¨ë“œ ë¡œì§ í¬í•¨)
        function createLinkElement(link) {
            const url = link.url.startsWith('http') ? link.url : `https://${link.url}`; // í”„ë¡œí† ì½œ ë³´ì¥
            const linkId = link.id;

            const a = document.createElement('a');
            a.id = `link-${linkId}`;
            a.dataset.id = linkId; // ë“œë˜ê·¸ ì•¤ ë“œë¡­ì„ ìœ„í•´ id ì¶”ê°€
            a.className = "link-button block bg-white hover:bg-indigo-50 border border-gray-200 text-gray-800 font-semibold py-4 px-6 rounded-xl text-center text-lg md:text-xl transform transition duration-200 ease-in-out relative";
            
            // ì¼ë°˜/í¸ì§‘ ëª¨ë“œ í´ë˜ìŠ¤ ì„¤ì •
            if (isEditMode) {
                a.classList.add('edit-mode-active');
                a.href = "javascript:void(0)"; // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ë§í¬ í´ë¦­ ë°©ì§€
                a.target = "_self";
                a.draggable = true; // ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
            } else {
                a.href = url;
                a.target = "_blank"; // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
                a.draggable = false;
                a.classList.remove('edit-mode-active');
            }

            // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (selectedLinkIds.has(linkId)) {
                a.classList.add('selected-for-delete', 'ring-2', 'ring-red-500');
            } else {
                a.classList.remove('selected-for-delete', 'ring-2', 'ring-red-500');
            }


            // ë‚´ë¶€ ì½˜í…ì¸  êµ¬ì„±
            const contentDiv = document.createElement('div');
            // flex-rowë¡œ ì•„ì´í…œì„ ê°€ë¡œë¡œ ì •ë ¬í•˜ê³ , space-x-4ë¡œ ê°„ê²©ì„ ì¤ë‹ˆë‹¤.
            contentDiv.className = "flex items-center justify-between"; 

            const span = document.createElement('span');
            span.textContent = link.name; 
            contentDiv.appendChild(span);
            
            
            // ì˜¤ë¥¸ìª½ ì•„ì´ì½˜/ì»¨íŠ¸ë¡¤ ê·¸ë£¹
            const rightControls = document.createElement('div');
            rightControls.className = "flex items-center space-x-3 flex-shrink-0";
            
            if (isEditMode) {
                // 1. ì²´í¬ë°•ìŠ¤/ì„ íƒ ì¸ë””ì¼€ì´í„° (ì‚­ì œìš©)
                const isSelected = selectedLinkIds.has(linkId);
                const selectionIndicator = `
                    <div class="selection-indicator ${isSelected ? 'bg-red-500 border-red-500' : 'hover:border-red-500'}">
                        <!-- ì²´í¬ë§ˆí¬ SVG -->
                        <svg class="w-4 h-4 text-white ${isSelected ? '' : 'hidden'}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                `;
                rightControls.innerHTML += selectionIndicator;

                // 2. ë“œë˜ê·¸ í•¸ë“¤ ì•„ì´ì½˜ (ìˆœì„œ ë³€ê²½ìš©)
                const dragHandleIcon = `
                    <div class="drag-handle w-6 h-6 text-gray-400 hover:text-gray-600 transition duration-150">
                        <!-- ë“œë˜ê·¸ í•¸ë“¤ ì•„ì´ì½˜ (3ì¤„) -->
                        <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </div>
                `;
                rightControls.innerHTML += dragHandleIcon;

                // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í¸ì§‘ ëª¨ë“œì—ì„œë§Œ)
                a.addEventListener('dragstart', handleDragStart);
                a.addEventListener('dragenter', handleDragEnter);
                a.addEventListener('dragleave', handleDragLeave);
                a.addEventListener('dragover', handleDragOver);
                a.addEventListener('drop', handleDrop);
                a.addEventListener('dragend', handleDragEnd);

            } else {
                // ì¼ë°˜ ëª¨ë“œ: ë§í¬ ì•„ì´ì½˜
                const linkIcon = `<svg class="w-6 h-6 text-indigo-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>`;
                rightControls.innerHTML += linkIcon;
            }
            
            contentDiv.appendChild(rightControls);
            a.appendChild(contentDiv);

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ ì„ íƒ ê¸°ëŠ¥ì„ ì²˜ë¦¬)
            a.addEventListener('click', (e) => {
                if (isEditMode) {
                    e.preventDefault();
                    toggleLinkSelection(linkId);
                }
            });

            return a;
        }

        // ë§í¬ ëª©ë¡ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ (ìƒíƒœì— ë”°ë¼ createLinkElement í˜¸ì¶œ)
        function renderLinks(links) {
            linksContainer.innerHTML = '';
            
            if (links.length === 0) {
                linksContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">ì•„ì§ ì¶”ê°€ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë§í¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!</p>`;
            } else {
                links.forEach(link => {
                    linksContainer.appendChild(createLinkElement(link));
                });
            }
        }

        // ì‚­ì œ ë²„íŠ¼ì˜ ìƒíƒœ(í…ìŠ¤íŠ¸ ë° í™œì„±í™”/ë¹„í™œì„±í™”)ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateDeleteButtonState() {
            const count = selectedLinkIds.size;
            deleteSelectedBtn.textContent = `ì‚­ì œ (${count})`;
            deleteSelectedBtn.disabled = count === 0;
        }

        // íŠ¹ì • ë§í¬ì˜ ì„ íƒ ìƒíƒœë¥¼ í† ê¸€í•˜ëŠ” í•¨ìˆ˜
        function toggleLinkSelection(linkId) {
            const linkElement = document.getElementById(`link-${linkId}`);
            
            if (selectedLinkIds.has(linkId)) {
                // ì„ íƒ í•´ì œ
                selectedLinkIds.delete(linkId);
                linkElement.classList.remove('selected-for-delete', 'ring-2', 'ring-red-500');
            } else {
                // ì„ íƒ
                selectedLinkIds.add(linkId);
                linkElement.classList.add('selected-for-delete', 'ring-2', 'ring-red-500');
            }

            // onSnapshotìœ¼ë¡œ ì¸í•´ ì „ì²´ ë Œë”ë§ì´ ì¼ì–´ë‚˜ë¯€ë¡œ, ë¡œì»¬ DOM ì—…ë°ì´íŠ¸ ëŒ€ì‹  ìƒíƒœë§Œ ì—…ë°ì´íŠ¸í•˜ê³ 
            // onSnapshotì´ DOM ì—…ë°ì´íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ í•˜ëŠ” ê²ƒì´ ë” ì•ˆì •ì ì…ë‹ˆë‹¤.
            // í•˜ì§€ë§Œ ì¦‰ê°ì ì¸ í”¼ë“œë°±ì„ ìœ„í•´ ë¡œì»¬ DOMì„ ì§ì ‘ ì¡°ì‘í•©ë‹ˆë‹¤.
            const indicator = linkElement.querySelector('.selection-indicator');
            const checkmark = indicator.querySelector('svg');

            if (selectedLinkIds.has(linkId)) {
                indicator.classList.add('bg-red-500', 'border-red-500');
                indicator.classList.remove('hover:border-red-500');
                checkmark.classList.remove('hidden');
            } else {
                indicator.classList.remove('bg-red-500', 'border-red-500');
                indicator.classList.add('hover:border-red-500');
                checkmark.classList.add('hidden');
            }


            updateDeleteButtonState();
        }

        // í¸ì§‘ ëª¨ë“œë¥¼ ì¼œê³  ë„ëŠ” í•¨ìˆ˜
        function toggleEditMode() {
            isEditMode = !isEditMode;
            selectedLinkIds.clear(); // ëª¨ë“œ ì „í™˜ ì‹œ ì„ íƒ ì´ˆê¸°í™”

            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° ìŠ¤íƒ€ì¼ ë³€ê²½
            editToggleBtn.textContent = isEditMode ? 'ì™„ë£Œ' : 'í¸ì§‘';
            editToggleBtn.classList.toggle('bg-gray-200', !isEditMode);
            editToggleBtn.classList.toggle('bg-red-600', isEditMode);
            editToggleBtn.classList.toggle('text-white', isEditMode);
            editToggleBtn.classList.toggle('hover:bg-red-700', isEditMode);
            editToggleBtn.classList.toggle('hover:bg-gray-300', !isEditMode);
            editToggleBtn.classList.toggle('text-gray-700', !isEditMode);

            // ì‚­ì œ ë²„íŠ¼ ê°€ì‹œì„± ë° ìƒíƒœ ì—…ë°ì´íŠ¸
            deleteSelectedBtn.classList.toggle('hidden', !isEditMode);
            updateDeleteButtonState();

            // ë§í¬ ì „ì²´ë¥¼ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ëª¨ë“œ ë³€ê²½ ë° ë“œë˜ê·¸ ê°€ëŠ¥ ì—¬ë¶€ ì ìš©
            renderLinks(cachedLinks);
        }

        // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° í•¨ìˆ˜ (ìƒˆ ë§í¬ ì¶”ê°€)
        function openAddLinkModal() {
            addLinkModal.classList.remove('hidden');
            addLinkModal.classList.add('flex');
            setTimeout(() => addLinkModal.classList.add('modal-open'), 10); 
            errorMessageDisplay.classList.add('hidden');
        }

        function closeAddLinkModal() {
            addLinkModal.classList.remove('modal-open');
            setTimeout(() => {
                addLinkModal.classList.remove('flex');
                addLinkModal.classList.add('hidden');
                linkForm.reset(); 
            }, 300);
        }

        // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° í•¨ìˆ˜ (ì‚­ì œ í™•ì¸)
        function openDeleteConfirmModal() {
            if (selectedLinkIds.size === 0) return;

            deleteCountDisplay.textContent = selectedLinkIds.size;
            deleteConfirmModal.classList.remove('hidden');
            deleteConfirmModal.classList.add('flex');
            setTimeout(() => deleteConfirmModal.classList.add('modal-open'), 10);
        }

        function closeDeleteConfirmModal() {
            deleteConfirmModal.classList.remove('modal-open');
            setTimeout(() => {
                deleteConfirmModal.classList.remove('flex');
                deleteConfirmModal.classList.add('hidden');
            }, 300);
        }

        // ------------------ Drag & Drop í•¨ìˆ˜ ------------------

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault(); // ë“œë¡­ í—ˆìš©
            e.dataTransfer.dropEffect = 'move';
            // ì‹œê°ì  í”¼ë“œë°±
            if (this !== dragSrcEl) {
                this.classList.add('border-indigo-400', 'border-2');
            }
        }

        function handleDragEnter(e) {
            if (this !== dragSrcEl) {
                 this.classList.add('border-indigo-400', 'border-2');
            }
        }

        function handleDragLeave() {
            this.classList.remove('border-indigo-400', 'border-2');
        }

        async function handleDrop(e) {
            e.stopPropagation(); // ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ë¦¬ë””ë ‰ì…˜ ë°©ì§€

            if (dragSrcEl !== this) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const sourceId = dragSrcEl.dataset.id;
                const targetId = this.dataset.id;

                const sourceIndex = cachedLinks.findIndex(link => link.id === sourceId);
                const targetIndex = cachedLinks.findIndex(link => link.id === targetId);

                // 1. ë¡œì»¬ ìºì‹œì—ì„œ ìˆœì„œ ë³€ê²½
                const [draggedLink] = cachedLinks.splice(sourceIndex, 1);
                cachedLinks.splice(targetIndex, 0, draggedLink);

                // 2. ìƒˆë¡œìš´ ìˆœì„œì— ë”°ë¼ Firestoreì˜ 'createdAt' (ìˆœì„œ) í•„ë“œë¥¼ ì—…ë°ì´íŠ¸
                await persistNewOrder(appId);
                
                // onSnapshotì´ ì—…ë°ì´íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë¯€ë¡œ ë³„ë„ì˜ renderLinks í˜¸ì¶œì€ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
            }
            this.classList.remove('border-indigo-400', 'border-2');
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            // ë“œë˜ê·¸ ìƒíƒœê°€ ì¢…ë£Œë˜ë©´ ëª¨ë“  ì‹œê°ì  í”¼ë“œë°± ì œê±°
            document.querySelectorAll('.link-button').forEach(item => {
                item.classList.remove('border-indigo-400', 'border-2');
            });
            dragSrcEl = null;
        }

        // ë³€ê²½ëœ ìˆœì„œë¥¼ Firestoreì— ì €ì¥ (createdAt í•„ë“œë¥¼ ìƒˆë¡œìš´ ìˆœì„œëŒ€ë¡œ ì—…ë°ì´íŠ¸)
        async function persistNewOrder(appId) {
            if (!db || !userId) return;

            const batch = writeBatch(db);
            const baseTimestamp = Date.now();
            const linksCount = cachedLinks.length;
            
            // ìºì‹œëœ ë§í¬ ëª©ë¡ì˜ ì—­ìˆœìœ¼ë¡œ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í• ë‹¹í•˜ì—¬ ìˆœì„œ ìœ ì§€ (ìµœìƒìœ„ê°€ ê°€ì¥ í° ê°’)
            for (let i = 0; i < linksCount; i++) {
                const link = cachedLinks[i];
                // getLinksCollectionRefë¥¼ í†µí•´ ì–»ì€ ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const docRef = doc(db, getLinksCollectionRef(db, userId, appId).path, link.id);
                // ìƒˆë¡œìš´ íƒ€ì„ìŠ¤íƒ¬í”„: base - (i * 1000)
                const newTimestamp = baseTimestamp - (i * 1000); 
                batch.update(docRef, { createdAt: newTimestamp });
            }

            try {
                await batch.commit();
                // console.log("ë§í¬ ìˆœì„œê°€ Firestoreì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (error) {
                console.error("ìˆœì„œ ì €ì¥ ì˜¤ë¥˜:", error);
                // alert("ìˆœì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }


        // ------------------ Firebase/ë°ì´í„° ê´€ë ¨ í•¨ìˆ˜ ------------------
        
        // Firestoreì—ì„œ ë§í¬ ë¡œë“œ ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì„¤ì •
        function loadLinks() {
            if (!db || !userId) return;

            const linkRef = getLinksCollectionRef(db, userId, typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
            const q = query(linkRef); 

            onSnapshot(q, (snapshot) => {
                const links = [];
                snapshot.forEach((doc) => {
                    links.push({ id: doc.id, ...doc.data() });
                });

                // ë°ì´í„° ìºì‹œ ë° ì •ë ¬ (createdAt ë‚´ë¦¼ì°¨ìˆœ: ìµœì‹ /ìµœìƒìœ„ê°€ ê°€ì¥ í° ê°’)
                // ë§Œì•½ createdAtì´ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ ëª©ë¡ì˜ ë§¨ ì•„ë˜ë¡œ ë³´ëƒ„
                cachedLinks = links.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

                // ë§í¬ ëª©ë¡ ë Œë”ë§
                renderLinks(cachedLinks);
                
                // ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
                loadingIndicator.classList.add('opacity-0');
                setTimeout(() => loadingIndicator.classList.add('hidden'), 300);
            }, (error) => {
                console.error("ë§í¬ ë¡œë“œ ì˜¤ë¥˜:", error);
                errorMessageDisplay.textContent = `ë§í¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                errorMessageDisplay.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
            });
        }

        // ë§í¬ ì €ì¥ í•¨ìˆ˜
        async function saveLink(event) {
            event.preventDefault();
            
            const name = linkNameInput.value.trim();
            let url = linkUrlInput.value.trim();
            
            errorMessageDisplay.classList.add('hidden');

            if (!name || !url) {
                errorMessageDisplay.textContent = 'ë§í¬ ì´ë¦„ê³¼ URLì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                errorMessageDisplay.classList.remove('hidden');
                return;
            }

            if (!url.match(/^(http|https):\/\//)) {
                 url = `https://${url}`;
            }
            if (!isValidUrl(url)) {
                 errorMessageDisplay.textContent = 'ìœ íš¨í•œ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ì˜ˆ: https://example.com';
                 errorMessageDisplay.classList.remove('hidden');
                 return;
            }

            if (!db || !userId) {
                errorMessageDisplay.textContent = 'ì‚¬ìš©ì ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ë§í¬ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                errorMessageDisplay.classList.remove('hidden');
                return;
            }
            
            // ìƒˆë¡œìš´ ë§í¬ì˜ createdAtì€ ê°€ì¥ ìµœì‹  ê°’ (ê°€ì¥ ë†’ì€ ê°’)ì„ ê°–ë„ë¡ ì„¤ì •
            const newCreatedAt = Date.now();

            try {
                const linkRef = getLinksCollectionRef(db, userId, typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
                
                await addDoc(linkRef, {
                    name: name,
                    url: url,
                    createdAt: newCreatedAt
                });
                
                closeAddLinkModal();

            } catch (error) {
                console.error("ë§í¬ ì €ì¥ ì˜¤ë¥˜:", error);
                errorMessageDisplay.textContent = `ë§í¬ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                errorMessageDisplay.classList.remove('hidden');
            }
        }

        // ì„ íƒëœ ë§í¬ë“¤ì„ Firestoreì—ì„œ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
        async function deleteSelectedLinks() {
            if (!db || !userId || selectedLinkIds.size === 0) {
                closeDeleteConfirmModal();
                return;
            }
            
            confirmDeleteBtn.disabled = true;
            cancelDeleteBtn.disabled = true;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            try {
                const deletionPromises = [];
                for (const linkId of selectedLinkIds) {
                    // getLinksCollectionRefë¥¼ í†µí•´ ì–»ì€ ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    const docRef = doc(db, getLinksCollectionRef(db, userId, appId).path, linkId);
                    deletionPromises.push(deleteDoc(docRef));
                }
                
                await Promise.all(deletionPromises);
                
                selectedLinkIds.clear(); // ë¡œì»¬ ì„ íƒ ì´ˆê¸°í™”
                toggleEditMode(); // ì‚­ì œ í›„ í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ (ìë™ ì¬ë Œë”ë§ì€ onSnapshotì´ ì²˜ë¦¬)
                
            } catch (error) {
                console.error("ì„ íƒëœ ë§í¬ ì‚­ì œ ì˜¤ë¥˜:", error);
                // ì‚¬ìš©ìì—ê²Œ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
            } finally {
                confirmDeleteBtn.disabled = false;
                cancelDeleteBtn.disabled = false;
                closeDeleteConfirmModal();
            }
        }

        // Firebase ì´ˆê¸°í™” ë° ì¸ì¦
        async function initFirebase() {
            setLogLevel('error');

            const isCanvasEnvironment = typeof __firebase_config !== 'undefined' && __firebase_config;
            let config;

            if (isCanvasEnvironment) {
                // 1. Canvas í™˜ê²½: í”Œë«í¼ì´ ì œê³µí•˜ëŠ” ì„¤ì •ì„ ì‚¬ìš©
                try {
                    config = JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("Canvas Firebase config parsing error:", e);
                    return;
                }
            } else {
                // 2. ì™¸ë¶€ í™˜ê²½ (GitHub): firebase-config.json íŒŒì¼ì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì • ë¡œë“œ
                try {
                    loadingIndicator.querySelector('p').textContent = 'ì„¤ì • íŒŒì¼ ë¡œë“œ ì¤‘...';
                    const response = await fetch('./firebase-config.json');
                    
                    if (!response.ok) {
                        // 404 ë“± ì˜¤ë¥˜ ë°œìƒ ì‹œ
                        throw new Error(`Failed to load firebase-config.json. Status: ${response.statusText}`);
                    }
                    config = await response.json();
                } catch (error) {
                    console.error("Firebase ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:", error);
                    loadingIndicator.classList.add('hidden');
                    linksContainer.innerHTML = `<p class="text-center text-red-500 mt-8">Firebase ì—°ê²° ì‹¤íŒ¨: 'firebase-config.json' íŒŒì¼ì„ í™•ì¸í•˜ê±°ë‚˜ ëˆ„ë½ëœ ê²½ìš° ìƒì„±í•´ ì£¼ì„¸ìš”. (ì˜¤ë¥˜: ${error.message})</p>`;
                    return;
                }

                if (!config || !config.projectId) {
                    console.error("Firebase ì—°ê²°ì„ ìœ„í•œ ì„¤ì • ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadingIndicator.classList.add('hidden');
                    linksContainer.innerHTML = `<p class="text-center text-red-500 mt-8">Firebase ì—°ê²° ì‹¤íŒ¨: 'firebase-config.json' íŒŒì¼ì— projectIdê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>`;
                    return;
                }
            }


            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);

                // ì¸ì¦ ì²˜ë¦¬
                if (isCanvasEnvironment && typeof __initial_auth_token !== 'undefined') {
                    // Canvas í™˜ê²½: ì»¤ìŠ¤í…€ í† í°ìœ¼ë¡œ ì¸ì¦
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // ì™¸ë¶€ í™˜ê²½: ìµëª… ì¸ì¦ (ëª¨ë“  ê¸°ê¸°ê°€ ë™ì¼í•œ ìµëª… ê³„ì •ìœ¼ë¡œ ì ‘ê·¼í•˜ë„ë¡ ì²˜ë¦¬)
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        loadLinks(); 
                    } else {
                        userId = null;
                        isAuthReady = true;
                        loadingIndicator.classList.add('hidden');
                        linksContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">ì¸ì¦ ì˜¤ë¥˜ë¡œ ì¸í•´ ë§í¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                loadingIndicator.classList.add('hidden');
                linksContainer.innerHTML = `<p class="text-center text-red-500 mt-8">Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
            }
        }
        
        // ------------------ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ------------------
        addLinkBtn.addEventListener('click', openAddLinkModal);
        closeModalBtn.addEventListener('click', closeAddLinkModal);
        linkForm.addEventListener('submit', saveLink);
        
        // ìƒˆ ë§í¬ ì¶”ê°€ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        addLinkModal.addEventListener('click', (e) => {
            if (e.target === addLinkModal) {
                closeAddLinkModal();
            }
        });

        // í¸ì§‘ ë° ì‚­ì œ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        editToggleBtn.addEventListener('click', toggleEditMode);
        deleteSelectedBtn.addEventListener('click', openDeleteConfirmModal);
        
        confirmDeleteBtn.addEventListener('click', deleteSelectedLinks);
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);

        // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        deleteConfirmModal.addEventListener('click', (e) => {
             if (e.target === deleteConfirmModal) {
                closeDeleteConfirmModal();
            }
        });

        // ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
        window.onload = initFirebase;
    </script>
</body>
</html>
