<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘‘ ìŠˆí¼ í˜ì´ì§€</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            /* ë‹¤í¬ ëª¨ë“œ ë°°ê²½ */
            color: #ffffff;
            /* ë‹¤í¬ ëª¨ë“œ í…ìŠ¤íŠ¸ */
        }

        .link-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            /* ì¼ë°˜ ëª¨ë“œ */
            background-color: #1e1e1e;
            /* ë‹¤í¬ ëª¨ë“œ ì¹´ë“œ ë°°ê²½ */
            color: #ffffff;
            border-color: #333;
        }

        .link-button:hover:not(.selected-for-delete) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
            background-color: #2a2a2a;
        }

        /* ë“œë˜ê·¸ ê°€ëŠ¥ ì•„ì´í…œ */
        .link-button.edit-mode-active {
            cursor: grab;
            /* í¸ì§‘ ëª¨ë“œ */
        }

        .link-button.edit-mode-active:active {
            cursor: grabbing;
        }

        .link-button.dragging {
            opacity: 0.5;
            border: 2px dashed #666;
        }

        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #222;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(3px);
            transition: opacity 0.3s ease;
        }

        .modal-content {
            transform: translateY(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            background-color: #1e1e1e;
            color: white;
            border: 1px solid #333;
        }

        .modal-open .modal-content {
            transform: translateY(0);
        }

        /* í¸ì§‘ ëª¨ë“œì—ì„œ ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .selected-for-delete {
            background-color: #2d1a1a !important;
            /* Redish Dark */
            border-color: #ef4444 !important;
            /* Red-500 */
        }

        /* ì„ íƒ ì¸ë””ì¼€ì´í„° ìŠ¤íƒ€ì¼ (ì´ì œ Flexì— í†µí•©ë¨) */
        .selection-indicator {
            width: 24px;
            height: 24px;
            border-radius: 9999px;
            /* rounded-full */
            border: 2px solid #666;
            /* border-gray-400 */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .selected-for-delete .selection-indicator {
            background-color: #ef4444;
            /* Red-500 */
            border-color: #ef4444;
        }

        /* Input Styles for Dark Mode */
        input[type="text"],
        input[type="url"] {
            background-color: #2a2a2a;
            color: white;
            border-color: #444;
        }

        input[type="text"]:focus,
        input[type="url"]:focus {
            border-color: #6366f1;
            /* Indigo-500 */
            ring-color: #6366f1;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loadingIndicator"
        class="absolute inset-0 bg-black/80 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
            <p class="mt-4 text-indigo-400 font-medium">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="w-full max-w-lg">
        <header class="text-center mb-6">
            <!-- ì œëª© ë³€ê²½ -->
            <h1 class="text-3xl font-extrabold text-white mb-2">ğŸ‘‘ ìŠˆí¼ í˜ì´ì§€</h1>
        </header>

        <!-- í¸ì§‘/ì‚­ì œ ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ìƒˆ ìœ„ì¹˜) -->
        <div id="control-panel" class="mb-6 flex justify-end space-x-2">
            <button id="deleteSelectedBtn"
                class="px-3 py-1 text-sm font-bold text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 transition duration-150 hidden disabled:opacity-50 disabled:cursor-not-allowed">
                ì‚­ì œ (0)
            </button>
            <button id="editToggleBtn"
                class="px-3 py-1 text-sm font-medium text-gray-300 bg-gray-800 rounded-lg hover:bg-gray-700 transition duration-150 border border-gray-700">
                í¸ì§‘
            </button>
        </div>

        <!-- ë§í¬ ë²„íŠ¼ ì˜ì—­ (Firebaseì—ì„œ ë™ì ìœ¼ë¡œ ë¡œë“œë¨) -->
        <div id="links-container" class="space-y-4">
            <!-- ê¸°ë³¸ ì˜ˆì‹œ ë§í¬ (ë°ì´í„° ë¡œë“œ ì „ê¹Œì§€ í‘œì‹œ) -->
            <div id="initial-links">
                <div class="link-button bg-[#1e1e1e] border border-gray-700 py-4 px-6 rounded-xl animate-pulse h-16">
                </div>
                <div class="link-button bg-[#1e1e1e] border border-gray-700 py-4 px-6 rounded-xl animate-pulse h-16">
                </div>
            </div>
        </div>

        <!-- ìƒˆ ë§í¬ ì¶”ê°€ ë²„íŠ¼ -->
        <div class="mt-8 pt-4 border-t border-gray-800 text-center">
            <button id="addLinkBtn"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-200 ease-in-out transform hover:scale-105">
                + ìƒˆ ë§í¬ ì¶”ê°€
            </button>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ìƒˆ ë§í¬ ì¶”ê°€/ìˆ˜ì • í¼ -->
    <div id="addLinkModal" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50" aria-modal="true"
        role="dialog">
        <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-2xl">
            <h2 id="modalTitle" class="text-xl font-bold mb-4 text-white">ìƒˆ ê¸°ëŠ¥ ë§í¬ ì¶”ê°€</h2>
            <form id="linkForm">
                <input type="hidden" id="editLinkId">
                <div class="mb-4">
                    <label for="linkName" class="block text-sm font-medium text-gray-300 mb-1">ë§í¬ ì´ë¦„ (ì˜ˆ: ë©”ëª¨ì¥ ì•±)</label>
                    <input type="text" id="linkName" name="linkName" required
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="ì•± ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="mb-6">
                    <label for="linkUrl" class="block text-sm font-medium text-gray-300 mb-1">URL (ì˜ˆ:
                        https://example.com/app)</label>
                    <input type="url" id="linkUrl" name="linkUrl" required
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="ì „ì²´ URLì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="closeModalBtn"
                        class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-150">ì·¨ì†Œ</button>
                    <button type="submit" id="saveLinkBtn"
                        class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg">ì €ì¥</button>
                </div>
            </form>
            <p id="errorMessage" class="text-red-400 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ì‚­ì œ í™•ì¸ ë©”ì‹œì§€ -->
    <div id="deleteConfirmModal" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50"
        aria-modal="true" role="dialog">
        <div class="modal-content w-full max-w-xs p-6 rounded-2xl shadow-2xl text-center">
            <h2 class="text-xl font-bold mb-4 text-white">ë§í¬ ì‚­ì œ í™•ì¸</h2>
            <p class="text-gray-300 mb-6">ì„ íƒí•œ <span id="deleteCountDisplay" class="font-bold text-red-500">0</span>ê°œì˜
                ë§í¬ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex justify-center space-x-3">
                <button type="button" id="cancelDeleteBtn"
                    class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-150">ì·¨ì†Œ</button>
                <button type="button" id="confirmDeleteBtn"
                    class="px-4 py-2 text-sm font-bold text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-lg">ì˜êµ¬
                    ì‚­ì œ</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase ëª¨ë“ˆ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, deleteDoc, updateDoc, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ì „ì—­ ë³€ìˆ˜ ë° DOM ìš”ì†Œ ì„¤ì •
        const linksContainer = document.getElementById('links-container');
        const addLinkModal = document.getElementById('addLinkModal');
        const addLinkBtn = document.getElementById('addLinkBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const linkForm = document.getElementById('linkForm');
        const linkNameInput = document.getElementById('linkName');
        const linkUrlInput = document.getElementById('linkUrl');
        const editLinkIdInput = document.getElementById('editLinkId'); // Hidden Input
        const modalTitle = document.getElementById('modalTitle');
        const errorMessageDisplay = document.getElementById('errorMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // í¸ì§‘ ë° ì‚­ì œ ê´€ë ¨ DOM ìš”ì†Œ
        const editToggleBtn = document.getElementById('editToggleBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const deleteCountDisplay = document.getElementById('deleteCountDisplay');


        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let isEditMode = false; // í¸ì§‘ ëª¨ë“œ ìƒíƒœ
        let selectedLinkIds = new Set(); // ì„ íƒëœ ë§í¬ IDë¥¼ ì¶”ì  (Set ì‚¬ìš©)
        let cachedLinks = []; // Firestoreì—ì„œ ë¡œë“œëœ ë§í¬ ë°ì´í„°ë¥¼ ìºì‹œ
        let dragSrcEl = null; // ë“œë˜ê·¸ ì‹œì‘ ìš”ì†Œ

        // Firestore ì»¬ë ‰ì…˜ ê²½ë¡œ ìƒì„± í•¨ìˆ˜
        function getLinksCollectionRef(db, userId, appId) {
            const isCanvasEnvironment = typeof __firebase_config !== 'undefined' && __firebase_config;

            if (isCanvasEnvironment) {
                return collection(db, `artifacts/${appId}/users/${userId}/links`);
            } else {
                return collection(db, `myLinks`);
            }
        }

        // ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (e) {
                return false;
            }
        }

        // ------------------ UI ê´€ë ¨ í•¨ìˆ˜ ------------------

        // ë§í¬ ë²„íŠ¼ ìƒì„± í•¨ìˆ˜ (í¸ì§‘ ëª¨ë“œ ë¡œì§ í¬í•¨)
        function createLinkElement(link) {
            const url = link.url.startsWith('http') ? link.url : `https://${link.url}`;
            const linkId = link.id;

            const a = document.createElement('a');
            a.id = `link-${linkId}`;
            a.dataset.id = linkId;
            a.className = "link-button block hover:bg-[#2a2a2a] border border-gray-700 font-semibold py-4 px-6 rounded-xl text-center text-lg md:text-xl transform transition duration-200 ease-in-out relative";

            // ì¼ë°˜/í¸ì§‘ ëª¨ë“œ í´ë˜ìŠ¤ ì„¤ì •
            if (isEditMode) {
                a.classList.add('edit-mode-active');
                a.href = "javascript:void(0)";
                a.target = "_self";
                a.draggable = true;
            } else {
                a.href = url;
                a.target = "_blank";
                a.draggable = false;
                a.classList.remove('edit-mode-active');
            }

            // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (selectedLinkIds.has(linkId)) {
                a.classList.add('selected-for-delete', 'ring-2', 'ring-red-500');
            } else {
                a.classList.remove('selected-for-delete', 'ring-2', 'ring-red-500');
            }

            // ë‚´ë¶€ ì½˜í…ì¸  êµ¬ì„±
            const contentDiv = document.createElement('div');
            contentDiv.className = "flex items-center justify-between";

            const span = document.createElement('span');
            span.textContent = link.name;
            span.className = "text-gray-100";
            contentDiv.appendChild(span);


            // ì˜¤ë¥¸ìª½ ì•„ì´ì½˜/ì»¨íŠ¸ë¡¤ ê·¸ë£¹
            const rightControls = document.createElement('div');
            rightControls.className = "flex items-center space-x-3 flex-shrink-0";

            if (isEditMode) {
                // [NEW] í¸ì§‘ ë²„íŠ¼ (Pencil)
                const editBtn = document.createElement('button');
                editBtn.className = "p-1 text-gray-400 hover:text-indigo-400 transition";
                editBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>`;
                editBtn.onclick = (e) => {
                    e.stopPropagation(); // ë¶€ëª¨ í´ë¦­ ë°©ì§€ (ì„ íƒ í† ê¸€ ë°©ì§€)
                    e.preventDefault();
                    // í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
                    openAddLinkModal(link);
                };
                rightControls.appendChild(editBtn);


                // 1. ì²´í¬ë°•ìŠ¤/ì„ íƒ ì¸ë””ì¼€ì´í„° (ì‚­ì œìš©)
                const isSelected = selectedLinkIds.has(linkId);
                const selectionIndicator = document.createElement('div');
                selectionIndicator.className = `selection-indicator ${isSelected ? 'bg-red-500 border-red-500' : 'hover:border-red-500'}`;
                selectionIndicator.innerHTML = `<svg class="w-4 h-4 text-white ${isSelected ? '' : 'hidden'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                rightControls.appendChild(selectionIndicator);

                // 2. ë“œë˜ê·¸ í•¸ë“¤ ì•„ì´ì½˜
                const dragHandleIcon = document.createElement('div');
                dragHandleIcon.className = "drag-handle w-6 h-6 text-gray-500 hover:text-gray-400 transition duration-150 cursor-grab";
                dragHandleIcon.innerHTML = `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>`;
                rightControls.appendChild(dragHandleIcon);

                // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í¸ì§‘ ëª¨ë“œì—ì„œë§Œ)
                a.addEventListener('dragstart', handleDragStart);
                a.addEventListener('dragenter', handleDragEnter);
                a.addEventListener('dragleave', handleDragLeave);
                a.addEventListener('dragover', handleDragOver);
                a.addEventListener('drop', handleDrop);
                a.addEventListener('dragend', handleDragEnd);

            } else {
                // ì¼ë°˜ ëª¨ë“œ: ë§í¬ ì•„ì´ì½˜
                const linkIcon = `<svg class="w-6 h-6 text-indigo-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>`;
                rightControls.innerHTML += linkIcon;
            }

            contentDiv.appendChild(rightControls);
            a.appendChild(contentDiv);

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ ì„ íƒ ê¸°ëŠ¥ì„ ì²˜ë¦¬)
            a.addEventListener('click', (e) => {
                if (isEditMode) {
                    e.preventDefault();
                    toggleLinkSelection(linkId);
                }
            });

            return a;
        }

        // ë§í¬ ëª©ë¡ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderLinks(links) {
            linksContainer.innerHTML = '';

            if (links.length === 0) {
                linksContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">ì•„ì§ ì¶”ê°€ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë§í¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!</p>`;
            } else {
                links.forEach(link => {
                    linksContainer.appendChild(createLinkElement(link));
                });
            }
        }

        function updateDeleteButtonState() {
            const count = selectedLinkIds.size;
            deleteSelectedBtn.textContent = `ì‚­ì œ (${count})`;
            deleteSelectedBtn.disabled = count === 0;
        }

        function toggleLinkSelection(linkId) {
            const linkElement = document.getElementById(`link-${linkId}`);

            if (selectedLinkIds.has(linkId)) {
                selectedLinkIds.delete(linkId);
                linkElement.classList.remove('selected-for-delete', 'ring-2', 'ring-red-500');
            } else {
                selectedLinkIds.add(linkId);
                linkElement.classList.add('selected-for-delete', 'ring-2', 'ring-red-500');
            }

            const indicator = linkElement.querySelector('.selection-indicator');
            const checkmark = indicator.querySelector('svg');

            if (selectedLinkIds.has(linkId)) {
                indicator.classList.add('bg-red-500', 'border-red-500');
                indicator.classList.remove('hover:border-red-500');
                checkmark.classList.remove('hidden');
            } else {
                indicator.classList.remove('bg-red-500', 'border-red-500');
                indicator.classList.add('hover:border-red-500');
                checkmark.classList.add('hidden');
            }

            updateDeleteButtonState();
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            selectedLinkIds.clear();

            editToggleBtn.textContent = isEditMode ? 'ì™„ë£Œ' : 'í¸ì§‘';
            editToggleBtn.classList.toggle('bg-gray-800', !isEditMode);
            editToggleBtn.classList.toggle('border-gray-700', !isEditMode);
            editToggleBtn.classList.toggle('bg-red-600', isEditMode);
            editToggleBtn.classList.toggle('text-white', isEditMode);
            editToggleBtn.classList.toggle('hover:bg-red-700', isEditMode);
            editToggleBtn.classList.toggle('hover:bg-gray-700', !isEditMode);
            editToggleBtn.classList.toggle('text-gray-300', !isEditMode);

            deleteSelectedBtn.classList.toggle('hidden', !isEditMode);
            updateDeleteButtonState();
            renderLinks(cachedLinks);
        }

        // ëª¨ë‹¬ ì—´ê¸° (ìƒì„± ë˜ëŠ” ìˆ˜ì •)
        function openAddLinkModal(editLink = null) {
            addLinkModal.classList.remove('hidden');
            addLinkModal.classList.add('flex');
            setTimeout(() => addLinkModal.classList.add('modal-open'), 10);
            errorMessageDisplay.classList.add('hidden');

            if (editLink && editLink.id) {
                // ìˆ˜ì • ëª¨ë“œ
                modalTitle.textContent = "ë§í¬ ìˆ˜ì •";
                linkNameInput.value = editLink.name;
                linkUrlInput.value = editLink.url;
                editLinkIdInput.value = editLink.id; // ID ì €ì¥
                document.getElementById('saveLinkBtn').textContent = "ìˆ˜ì • ì™„ë£Œ";
            } else {
                // ìƒì„± ëª¨ë“œ
                modalTitle.textContent = "ìƒˆ ê¸°ëŠ¥ ë§í¬ ì¶”ê°€";
                linkForm.reset();
                editLinkIdInput.value = ""; // ID ì´ˆê¸°í™”
                document.getElementById('saveLinkBtn').textContent = "ì €ì¥";
            }
        }

        function closeAddLinkModal() {
            addLinkModal.classList.remove('modal-open');
            setTimeout(() => {
                addLinkModal.classList.remove('flex');
                addLinkModal.classList.add('hidden');
                linkForm.reset();
                editLinkIdInput.value = "";
            }, 300);
        }

        function openDeleteConfirmModal() {
            if (selectedLinkIds.size === 0) return;
            deleteCountDisplay.textContent = selectedLinkIds.size;
            deleteConfirmModal.classList.remove('hidden');
            deleteConfirmModal.classList.add('flex');
            setTimeout(() => deleteConfirmModal.classList.add('modal-open'), 10);
        }

        function closeDeleteConfirmModal() {
            deleteConfirmModal.classList.remove('modal-open');
            setTimeout(() => {
                deleteConfirmModal.classList.remove('flex');
                deleteConfirmModal.classList.add('hidden');
            }, 300);
        }

        // ------------------ Drag & Drop í•¨ìˆ˜ ------------------

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this !== dragSrcEl) {
                this.classList.add('border-indigo-500', 'border-2');
            }
        }

        function handleDragEnter(e) {
            if (this !== dragSrcEl) {
                this.classList.add('border-indigo-500', 'border-2');
            }
        }

        function handleDragLeave() {
            this.classList.remove('border-indigo-500', 'border-2');
        }

        async function handleDrop(e) {
            e.stopPropagation();

            if (dragSrcEl !== this) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const sourceId = dragSrcEl.dataset.id;
                const targetId = this.dataset.id;

                const sourceIndex = cachedLinks.findIndex(link => link.id === sourceId);
                const targetIndex = cachedLinks.findIndex(link => link.id === targetId);

                const [draggedLink] = cachedLinks.splice(sourceIndex, 1);
                cachedLinks.splice(targetIndex, 0, draggedLink);

                await persistNewOrder(appId);
            }
            this.classList.remove('border-indigo-500', 'border-2');
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.link-button').forEach(item => {
                item.classList.remove('border-indigo-500', 'border-2');
            });
            dragSrcEl = null;
        }

        async function persistNewOrder(appId) {
            if (!db || !userId) return;

            const batch = writeBatch(db);
            const baseTimestamp = Date.now();
            const linksCount = cachedLinks.length;

            for (let i = 0; i < linksCount; i++) {
                const link = cachedLinks[i];
                const docRef = doc(db, getLinksCollectionRef(db, userId, appId).path, link.id);
                const newTimestamp = baseTimestamp - (i * 1000);
                batch.update(docRef, { createdAt: newTimestamp });
            }

            try {
                await batch.commit();
            } catch (error) {
                console.error("ìˆœì„œ ì €ì¥ ì˜¤ë¥˜:", error);
            }
        }


        // ------------------ Firebase/ë°ì´í„° ê´€ë ¨ í•¨ìˆ˜ ------------------

        function loadLinks() {
            if (!db || !userId) return;

            const linkRef = getLinksCollectionRef(db, userId, typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
            const q = query(linkRef);

            onSnapshot(q, (snapshot) => {
                const links = [];
                snapshot.forEach((doc) => {
                    links.push({ id: doc.id, ...doc.data() });
                });

                cachedLinks = links.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                renderLinks(cachedLinks);

                loadingIndicator.classList.add('opacity-0');
                setTimeout(() => loadingIndicator.classList.add('hidden'), 300);
            }, (error) => {
                console.error("ë§í¬ ë¡œë“œ ì˜¤ë¥˜:", error);
                errorMessageDisplay.textContent = `ë§í¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                errorMessageDisplay.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
            });
        }

        // ë§í¬ ì €ì¥/ìˆ˜ì • í•¨ìˆ˜
        async function saveLink(event) {
            event.preventDefault();

            const name = linkNameInput.value.trim();
            let url = linkUrlInput.value.trim();
            const editId = editLinkIdInput.value; // ID í™•ì¸ (ìˆ˜ì • ì—¬ë¶€)

            errorMessageDisplay.classList.add('hidden');

            if (!name || !url) {
                errorMessageDisplay.textContent = 'ë§í¬ ì´ë¦„ê³¼ URLì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                errorMessageDisplay.classList.remove('hidden');
                return;
            }

            if (!url.match(/^(http|https):\/\//)) {
                url = `https://${url}`;
            }
            if (!isValidUrl(url)) {
                errorMessageDisplay.textContent = 'ìœ íš¨í•œ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ì˜ˆ: https://example.com';
                errorMessageDisplay.classList.remove('hidden');
                return;
            }

            if (!db || !userId) {
                errorMessageDisplay.textContent = 'ì‚¬ìš©ì ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ë§í¬ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                errorMessageDisplay.classList.remove('hidden');
                return;
            }

            try {
                const linkRef = getLinksCollectionRef(db, userId, typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');

                if (editId) {
                    // [UPDATE] ê¸°ì¡´ ë§í¬ ìˆ˜ì •
                    const docToUpdate = doc(linkRef, editId);
                    await updateDoc(docToUpdate, {
                        name: name,
                        url: url
                        // createdAtì€ ìœ ì§€
                    });
                } else {
                    // [CREATE] ìƒˆ ë§í¬ ìƒì„±
                    const newCreatedAt = Date.now();
                    await addDoc(linkRef, {
                        name: name,
                        url: url,
                        createdAt: newCreatedAt
                    });
                }

                closeAddLinkModal();

            } catch (error) {
                console.error("ë§í¬ ì €ì¥ ì˜¤ë¥˜:", error);
                errorMessageDisplay.textContent = `ë§í¬ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                errorMessageDisplay.classList.remove('hidden');
            }
        }

        async function deleteSelectedLinks() {
            if (!db || !userId || selectedLinkIds.size === 0) {
                closeDeleteConfirmModal();
                return;
            }

            confirmDeleteBtn.disabled = true;
            cancelDeleteBtn.disabled = true;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            try {
                const deletionPromises = [];
                for (const linkId of selectedLinkIds) {
                    const docRef = doc(db, getLinksCollectionRef(db, userId, appId).path, linkId);
                    deletionPromises.push(deleteDoc(docRef));
                }

                await Promise.all(deletionPromises);

                selectedLinkIds.clear();
                toggleEditMode();

            } catch (error) {
                console.error("ì„ íƒëœ ë§í¬ ì‚­ì œ ì˜¤ë¥˜:", error);
            } finally {
                confirmDeleteBtn.disabled = false;
                cancelDeleteBtn.disabled = false;
                closeDeleteConfirmModal();
            }
        }

        async function initFirebase() {
            setLogLevel('error');

            const isCanvasEnvironment = typeof __firebase_config !== 'undefined' && __firebase_config;
            let config;

            if (isCanvasEnvironment) {
                try {
                    config = JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("Canvas Firebase config parsing error:", e);
                    return;
                }
            } else {
                try {
                    loadingIndicator.querySelector('p').textContent = 'ì„¤ì • íŒŒì¼ ë¡œë“œ ì¤‘...';
                    const response = await fetch('./firebase-config.json');

                    if (!response.ok) {
                        throw new Error(`Failed to load firebase-config.json. Status: ${response.statusText}`);
                    }
                    config = await response.json();
                } catch (error) {
                    console.error("Firebase ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:", error);
                    loadingIndicator.classList.add('hidden');
                    linksContainer.innerHTML = `<p class="text-center text-red-500 mt-8">Firebase ì—°ê²° ì‹¤íŒ¨: 'firebase-config.json' íŒŒì¼ì„ í™•ì¸í•˜ê±°ë‚˜ ëˆ„ë½ëœ ê²½ìš° ìƒì„±í•´ ì£¼ì„¸ìš”. (ì˜¤ë¥˜: ${error.message})</p>`;
                    return;
                }

                if (!config || !config.projectId) {
                    console.error("Firebase ì—°ê²°ì„ ìœ„í•œ ì„¤ì • ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadingIndicator.classList.add('hidden');
                    linksContainer.innerHTML = `<p class="text-center text-red-500 mt-8">Firebase ì—°ê²° ì‹¤íŒ¨: 'firebase-config.json' íŒŒì¼ì— projectIdê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>`;
                    return;
                }
            }


            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);

                if (isCanvasEnvironment && typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        loadLinks();
                    } else {
                        userId = null;
                        isAuthReady = true;
                        loadingIndicator.classList.add('hidden');
                        linksContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">ì¸ì¦ ì˜¤ë¥˜ë¡œ ì¸í•´ ë§í¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                loadingIndicator.classList.add('hidden');
                linksContainer.innerHTML = `<p class="text-center text-red-500 mt-8">Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
            }
        }

        // ------------------ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ------------------
        addLinkBtn.addEventListener('click', () => openAddLinkModal());
        closeModalBtn.addEventListener('click', closeAddLinkModal);
        linkForm.addEventListener('submit', saveLink);

        editToggleBtn.addEventListener('click', toggleEditMode);
        deleteSelectedBtn.addEventListener('click', openDeleteConfirmModal);

        confirmDeleteBtn.addEventListener('click', deleteSelectedLinks);
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);

        window.onload = initFirebase;
    </script>
</body>

</html>